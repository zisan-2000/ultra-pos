[{"filePath":"E:\\pos\\pos-app-supabase\\app\\(auth)\\forgot-password\\ForgotPasswordClient.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\(auth)\\forgot-password\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\(auth)\\login\\LoginClient.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\(auth)\\login\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\(auth)\\register\\RegisterClient.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\(auth)\\register\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\(auth)\\reset-password\\ResetPasswordClient.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\(auth)\\reset-password\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\about\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\actions\\auth.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\actions\\billing.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\actions\\business-product-templates.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\actions\\business-types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\actions\\cash.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\actions\\customers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\actions\\expenses.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\actions\\products.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\actions\\profile.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\actions\\purchases.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\actions\\rbac-admin.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\actions\\reports.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\actions\\sales.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\actions\\shops.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\actions\\suppliers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\actions\\system-settings.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\actions\\user-management.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\admin\\dashboard\\AdminDashboardClient.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\admin\\dashboard\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\admin\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\agent\\dashboard\\AgentDashboardClient.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\agent\\dashboard\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\agent\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\api\\admin\\user-creation-log\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\api\\auth\\[...betterauth]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\api\\auth\\password\\forgot\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\api\\auth\\password\\reset\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\api\\auth\\session-rbac\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\api\\cron\\billing\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\api\\due\\customers\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\api\\due\\payment\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\api\\due\\statement\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\api\\due\\summary\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\api\\health\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\api\\offline\\cash\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\api\\offline\\expense\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\api\\offline\\product\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\api\\purchases\\pay\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\api\\purchases\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\api\\rbac\\me\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\api\\reports\\cash\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\api\\reports\\expenses\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\api\\reports\\low-stock\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\api\\reports\\payment-method\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\api\\reports\\profit-trend\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\api\\reports\\sales\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\api\\reports\\summary\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\api\\reports\\today-mini\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\api\\reports\\today-summary\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\api\\reports\\top-products\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\api\\suppliers\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\api\\sync\\admin\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\api\\sync\\cash\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\api\\sync\\due\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\api\\sync\\expenses\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\api\\sync\\products\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\api\\sync\\sales\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\DashboardChrome.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'setShop' and 'shopId'. Either include them or remove the dependency array.","line":262,"column":6,"nodeType":"ArrayExpression","endLine":262,"endColumn":18,"suggestions":[{"desc":"Update the dependencies array to be: [safeShopId, setShop, shopId]","fix":{"range":[8521,8533],"text":"[safeShopId, setShop, shopId]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\DashboardClientShell.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\DashboardLayoutWrapper.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\DashboardShell.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\PosShell.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\admin\\billing\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\admin\\business-product-library\\BusinessProductLibraryClient.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\pos\\pos-app-supabase\\app\\dashboard\\admin\\business-product-library\\BusinessProductLibraryClient.tsx:446:9\n  444 |     if (online) {\n  445 |       if (Array.isArray(initialTemplates) && initialTemplates.length > 0) {\n> 446 |         setTemplates(initialTemplates);\n      |         ^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  447 |         try {\n  448 |           safeLocalStorageSet(templatesKey, JSON.stringify(initialTemplates));\n  449 |         } catch {","line":446,"column":9,"nodeType":null,"endLine":446,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// app/dashboard/admin/business-product-library/BusinessProductLibraryClient.tsx\r\n\r\n\"use client\";\n\nimport {\n  type FormEvent,\n  useCallback,\n  useEffect,\n  useMemo,\n  useRef,\n  useState,\n  useTransition,\n} from \"react\";\nimport { useRouter } from \"next/navigation\";\r\nimport { useOnlineStatus } from \"@/lib/sync/net-status\";\nimport { useSyncStatus } from \"@/lib/sync/sync-status\";\nimport { queueAdminAction } from \"@/lib/sync/queue\";\nimport { businessOptions } from \"@/lib/productFormConfig\";\nimport { safeLocalStorageGet, safeLocalStorageSet } from \"@/lib/storage\";\n\r\ntype BusinessTypeRow = { key: string; label: string };\r\n\r\ntype TemplateRow = {\n  id: string;\n  businessType: string;\n  name: string;\n  category?: string | null;\n  defaultSellPrice?: string | number | null;\n  isActive: boolean;\n};\n\ntype ImportTemplateInput = {\n  businessType?: string | null;\n  name?: string | null;\n  category?: string | null;\n  defaultSellPrice?: string | number | null;\n  isActive?: boolean | null;\n};\n\ntype ImportResult = {\n  createdCount: number;\n  skippedCount: number;\n  invalidCount: number;\n};\n\ntype Props = {\n  initialTemplates: TemplateRow[];\n  initialBusinessTypes: BusinessTypeRow[];\n  error?: string | null;\n  onCreateTemplate: (formData: FormData) => void | Promise<void>;\n  onUpdateTemplate: (formData: FormData) => void | Promise<void>;\n  onDeleteTemplate: (formData: FormData) => void | Promise<void>;\n  onImportTemplates: (input: {\n    items: ImportTemplateInput[];\n    defaultBusinessType?: string | null;\n  }) => Promise<ImportResult>;\n};\n\nconst MAX_IMPORT_ERRORS = 4;\n\nfunction parseImportPayload(raw: string, defaultBusinessType?: string | null) {\n  const errors: string[] = [];\n  const trimmed = raw.trim();\n  if (!trimmed) {\n    return {\n      items: [] as ImportTemplateInput[],\n      errors: [\"Paste JSON first.\"],\n      duplicateCount: 0,\n    };\n  }\n\n  let parsed: unknown;\n  try {\n    parsed = JSON.parse(trimmed);\n  } catch {\n    return {\n      items: [] as ImportTemplateInput[],\n      errors: [\"Invalid JSON.\"],\n      duplicateCount: 0,\n    };\n  }\n\n  if (!Array.isArray(parsed)) {\n    return {\n      items: [] as ImportTemplateInput[],\n      errors: [\"JSON must be an array of objects.\"],\n      duplicateCount: 0,\n    };\n  }\n\n  const items: ImportTemplateInput[] = [];\n  const seen = new Set<string>();\n  let duplicateCount = 0;\n\n  parsed.forEach((entry, index) => {\n    const row = index + 1;\n    if (!entry || typeof entry !== \"object\") {\n      errors.push(`Row ${row}: must be an object`);\n      return;\n    }\n\n    const record = entry as Record<string, unknown>;\n    const itemErrors: string[] = [];\n\n    const rawBusinessType = record.businessType ?? defaultBusinessType ?? \"\";\n    const businessType =\n      typeof rawBusinessType === \"string\" ? rawBusinessType.trim() : \"\";\n    if (!businessType) {\n      itemErrors.push(\"businessType is required\");\n    }\n\n    const name = typeof record.name === \"string\" ? record.name.trim() : \"\";\n    if (!name) {\n      itemErrors.push(\"name is required\");\n    }\n\n    let category: string | null = null;\n    if (record.category !== undefined) {\n      if (record.category === null) {\n        category = null;\n      } else if (typeof record.category === \"string\") {\n        const trimmedCategory = record.category.trim();\n        category = trimmedCategory ? trimmedCategory : null;\n      } else {\n        itemErrors.push(\"category must be a string\");\n      }\n    }\n\n    let defaultSellPrice: string | number | null = null;\n    if (record.defaultSellPrice !== undefined) {\n      if (record.defaultSellPrice === null || record.defaultSellPrice === \"\") {\n        defaultSellPrice = null;\n      } else if (\n        typeof record.defaultSellPrice === \"number\" ||\n        typeof record.defaultSellPrice === \"string\"\n      ) {\n        const numericValue = Number(record.defaultSellPrice);\n        if (!Number.isFinite(numericValue) || numericValue < 0) {\n          itemErrors.push(\"defaultSellPrice must be a non-negative number\");\n        } else {\n          defaultSellPrice = record.defaultSellPrice;\n        }\n      } else {\n        itemErrors.push(\"defaultSellPrice must be a number or string\");\n      }\n    }\n\n    let isActive = true;\n    if (record.isActive !== undefined && record.isActive !== null) {\n      if (typeof record.isActive !== \"boolean\") {\n        itemErrors.push(\"isActive must be boolean\");\n      } else {\n        isActive = record.isActive;\n      }\n    }\n\n    if (itemErrors.length > 0) {\n      errors.push(`Row ${row}: ${itemErrors.join(\", \")}`);\n      return;\n    }\n\n    const key = `${businessType.toLowerCase()}|${name.toLowerCase()}`;\n    if (seen.has(key)) {\n      duplicateCount += 1;\n      return;\n    }\n    seen.add(key);\n\n    items.push({\n      businessType,\n      name,\n      category,\n      defaultSellPrice,\n      isActive,\n    });\n  });\n\n  return { items, errors, duplicateCount };\n}\n\nexport default function BusinessProductLibraryClient({\n  initialTemplates,\n  initialBusinessTypes,\n  error,\n  onCreateTemplate,\n  onUpdateTemplate,\n  onDeleteTemplate,\n  onImportTemplates,\n}: Props) {\n  const online = useOnlineStatus();\n  const router = useRouter();\n  const { pendingCount, syncing, lastSyncAt } = useSyncStatus();\n  const [importing, startImport] = useTransition();\n  const [templates, setTemplates] = useState<TemplateRow[]>(initialTemplates || []);\n  const [businessTypes, setBusinessTypes] = useState<BusinessTypeRow[]>(\n    initialBusinessTypes || []\n  );\n  const [importPayload, setImportPayload] = useState(\"\");\n  const [importBusinessType, setImportBusinessType] = useState(\"\");\n  const [importError, setImportError] = useState<string | null>(null);\n  const [importNotice, setImportNotice] = useState<string | null>(null);\n  const refreshInFlightRef = useRef(false);\n  const lastRefreshAtRef = useRef(0);\n  const REFRESH_MIN_INTERVAL_MS = 15_000;\n  const serverSnapshotRef = useRef({\r\n    templates: initialTemplates,\r\n    businessTypes: initialBusinessTypes,\r\n  });\r\n\r\n  const templatesKey = \"admin:product-library:templates\";\r\n  const typesKey = \"admin:product-library:types\";\r\n\r\n  const updateTemplates = useCallback(\r\n    (updater: (prev: TemplateRow[]) => TemplateRow[]) => {\r\n      setTemplates((prev) => {\n        const next = updater(prev);\n        try {\n          safeLocalStorageSet(templatesKey, JSON.stringify(next));\n        } catch {\n          // ignore cache errors\n        }\n        return next;\n      });\n    },\r\n    [templatesKey],\r\n  );\r\n\r\n  const handleOfflineCreate = useCallback(\r\n    async (event: FormEvent<HTMLFormElement>) => {\r\n      if (online) return;\r\n      event.preventDefault();\r\n      const formData = new FormData(event.currentTarget);\r\n      const businessType = (formData.get(\"businessType\") as string | null)?.trim();\r\n      const name = (formData.get(\"name\") as string | null)?.trim();\r\n      if (!businessType || !name) return;\r\n      const category = (formData.get(\"category\") as string | null)?.trim() || null;\r\n      const rawPrice = (formData.get(\"defaultSellPrice\") as string | null)?.trim();\r\n      const defaultSellPrice = rawPrice ? rawPrice : null;\r\n      const isActive = formData.get(\"isActive\") === \"on\";\r\n      const id =\r\n        typeof crypto !== \"undefined\" && \"randomUUID\" in crypto\r\n          ? crypto.randomUUID()\r\n          : `${businessType}-${Date.now()}`;\r\n\r\n      updateTemplates((prev) => [\r\n        ...prev,\r\n        {\r\n          id,\r\n          businessType,\r\n          name,\r\n          category,\r\n          defaultSellPrice,\r\n          isActive,\r\n        },\r\n      ]);\r\n\r\n      await queueAdminAction(\"business_template_create\", {\r\n        id,\r\n        businessType,\r\n        name,\r\n        category,\r\n        defaultSellPrice,\r\n        isActive,\r\n      });\r\n      alert(\"Offline: template queued.\");\r\n      event.currentTarget.reset();\r\n    },\r\n    [online, updateTemplates],\r\n  );\r\n\r\n  const handleOfflineUpdate = useCallback(\r\n    async (event: FormEvent<HTMLFormElement>) => {\r\n      if (online) return;\r\n      event.preventDefault();\r\n      const formData = new FormData(event.currentTarget);\r\n      const id = (formData.get(\"id\") as string | null)?.trim();\r\n      if (!id) return;\r\n      const businessType = (formData.get(\"businessType\") as string | null)?.trim();\r\n      const name = (formData.get(\"name\") as string | null)?.trim();\r\n      const category = (formData.get(\"category\") as string | null)?.trim() || null;\r\n      const rawPrice = (formData.get(\"defaultSellPrice\") as string | null)?.trim();\r\n      const defaultSellPrice = rawPrice ? rawPrice : null;\r\n      const isActive = formData.get(\"isActive\") === \"on\";\r\n\r\n      updateTemplates((prev) =>\r\n        prev.map((template) =>\r\n          template.id === id\r\n            ? {\r\n                ...template,\r\n                businessType: businessType || template.businessType,\r\n                name: name || template.name,\r\n                category,\r\n                defaultSellPrice,\r\n                isActive,\r\n              }\r\n            : template,\r\n        ),\r\n      );\r\n\r\n      await queueAdminAction(\"business_template_update\", {\r\n        id,\r\n        businessType,\r\n        name,\r\n        category,\r\n        defaultSellPrice,\r\n        isActive,\r\n      });\r\n      alert(\"Offline: template update queued.\");\r\n    },\r\n    [online, updateTemplates],\r\n  );\r\n\r\n  const handleOfflineDelete = useCallback(\n    async (event: FormEvent<HTMLFormElement>) => {\n      if (online) return;\n      event.preventDefault();\n      const formData = new FormData(event.currentTarget);\n      const id = (formData.get(\"id\") as string | null)?.trim();\r\n      if (!id) return;\r\n      updateTemplates((prev) => prev.filter((template) => template.id !== id));\r\n      await queueAdminAction(\"business_template_delete\", { id });\r\n      alert(\"Offline: delete queued.\");\r\n    },\r\n    [online, updateTemplates],\n  );\n\n  const handleImport = useCallback(\n    async (event: FormEvent<HTMLFormElement>) => {\n      event.preventDefault();\n      setImportError(null);\n      setImportNotice(null);\n\n      const defaultType = importBusinessType.trim() || null;\n      const { items, errors, duplicateCount } = parseImportPayload(\n        importPayload,\n        defaultType,\n      );\n\n      if (errors.length > 0) {\n        setImportError(errors.slice(0, MAX_IMPORT_ERRORS).join(\" | \"));\n        return;\n      }\n\n      if (items.length === 0) {\n        setImportError(\"No valid templates found.\");\n        return;\n      }\n\n      if (!online) {\n        const existing = new Set(\n          templates.map(\n            (template) =>\n              `${template.businessType.toLowerCase()}|${template.name.toLowerCase()}`,\n          ),\n        );\n        const created: TemplateRow[] = [];\n        let skipped = 0;\n\n        for (const item of items) {\n          const businessType = item.businessType?.toString().trim() || \"\";\n          const name = item.name?.toString().trim() || \"\";\n          const key = `${businessType.toLowerCase()}|${name.toLowerCase()}`;\n          if (!businessType || !name || existing.has(key)) {\n            skipped += 1;\n            continue;\n          }\n          existing.add(key);\n          const id =\n            typeof crypto !== \"undefined\" && \"randomUUID\" in crypto\n              ? crypto.randomUUID()\n              : `${businessType}-${Date.now()}`;\n          const category = item.category ?? null;\n          const defaultSellPrice = item.defaultSellPrice ?? null;\n          const isActive = item.isActive ?? true;\n\n          created.push({\n            id,\n            businessType,\n            name,\n            category,\n            defaultSellPrice,\n            isActive,\n          });\n        }\n\n        if (created.length > 0) {\n          updateTemplates((prev) => [...prev, ...created]);\n          await Promise.all(\n            created.map((item) =>\n              queueAdminAction(\"business_template_create\", {\n                id: item.id,\n                businessType: item.businessType,\n                name: item.name,\n                category: item.category ?? null,\n                defaultSellPrice: item.defaultSellPrice ?? null,\n                isActive: item.isActive,\n              }),\n            ),\n          );\n        }\n\n        const skippedTotal = skipped + duplicateCount;\n        const parts = [`${created.length} templates queued`];\n        if (skippedTotal) parts.push(`${skippedTotal} skipped`);\n        setImportNotice(`Offline: ${parts.join(\". \")}.`);\n        setImportPayload(\"\");\n        return;\n      }\n\n      startImport(async () => {\n        try {\n          const result = await onImportTemplates({\n            items,\n            defaultBusinessType: defaultType,\n          });\n          const skippedTotal = result.skippedCount + duplicateCount;\n          const parts = [`${result.createdCount} templates imported`];\n          if (skippedTotal) parts.push(`${skippedTotal} skipped`);\n          setImportNotice(parts.join(\". \") + \".\");\n          setImportPayload(\"\");\n          router.refresh();\n        } catch (err) {\n          const message =\n            err instanceof Error && err.message\n              ? err.message\n              : \"Import failed.\";\n          setImportError(message);\n        }\n      });\n    },\n    [\n      importBusinessType,\n      importPayload,\n      online,\n      onImportTemplates,\n      router,\n      startImport,\n      templates,\n      updateTemplates,\n    ],\n  );\n\n  useEffect(() => {\n    if (online) {\n      if (Array.isArray(initialTemplates) && initialTemplates.length > 0) {\n        setTemplates(initialTemplates);\n        try {\n          safeLocalStorageSet(templatesKey, JSON.stringify(initialTemplates));\n        } catch {\n          // ignore cache errors\n        }\n      } else if (error) {\n        try {\n          const raw = safeLocalStorageGet(templatesKey);\n          if (raw) {\n            const parsed = JSON.parse(raw);\n            if (Array.isArray(parsed)) {\n              setTemplates(parsed);\n            }\n          }\r\n        } catch {\r\n          // ignore cache errors\r\n        }\r\n      }\r\n\r\n      if (Array.isArray(initialBusinessTypes) && initialBusinessTypes.length > 0) {\n        setBusinessTypes(initialBusinessTypes);\n        try {\n          safeLocalStorageSet(typesKey, JSON.stringify(initialBusinessTypes));\n        } catch {\n          // ignore cache errors\n        }\n      }\n      return;\n    }\n\n    try {\n      const raw = safeLocalStorageGet(templatesKey);\n      if (raw) {\n        const parsed = JSON.parse(raw);\n        if (Array.isArray(parsed)) {\n          setTemplates(parsed);\n        }\r\n      }\r\n    } catch {\r\n      // ignore cache errors\r\n    }\r\n\r\n    try {\n      const raw = safeLocalStorageGet(typesKey);\n      if (raw) {\n        const parsed = JSON.parse(raw);\n        if (Array.isArray(parsed)) {\n          setBusinessTypes(parsed);\n        }\r\n      }\r\n    } catch {\r\n      // ignore cache errors\r\n    }\r\n  }, [online, initialTemplates, initialBusinessTypes, error]);\r\n\r\n  useEffect(() => {\r\n    if (\r\n      serverSnapshotRef.current.templates !== initialTemplates ||\r\n      serverSnapshotRef.current.businessTypes !== initialBusinessTypes\r\n    ) {\r\n      serverSnapshotRef.current = {\r\n        templates: initialTemplates,\r\n        businessTypes: initialBusinessTypes,\r\n      };\r\n      refreshInFlightRef.current = false;\r\n    }\r\n  }, [initialTemplates, initialBusinessTypes]);\r\n\r\n  useEffect(() => {\n    if (!online || !lastSyncAt || syncing || pendingCount > 0) return;\n    if (refreshInFlightRef.current) return;\n    const now = Date.now();\n    if (now - lastRefreshAtRef.current < REFRESH_MIN_INTERVAL_MS) return;\n    lastRefreshAtRef.current = now;\n    refreshInFlightRef.current = true;\n    router.refresh();\n  }, [online, lastSyncAt, syncing, pendingCount, router]);\n\r\n  const mergedBusinessTypes = useMemo(() => {\r\n    return [\r\n      ...businessTypes.map((t) => ({ id: t.key, label: t.label })),\r\n      ...businessOptions.filter((opt) => !businessTypes.some((t) => t.key === opt.id)),\r\n    ];\r\n  }, [businessTypes]);\r\n\r\n  const labelMap = useMemo(\r\n    () => new Map(mergedBusinessTypes.map((opt) => [opt.id, opt.label] as const)),\r\n    [mergedBusinessTypes]\r\n  );\r\n\r\n  const grouped = useMemo(() => {\r\n    return templates.reduce<Record<string, TemplateRow[]>>((acc, template) => {\r\n      const key = template.businessType;\r\n      if (!acc[key]) acc[key] = [];\r\n      acc[key].push(template);\r\n      return acc;\r\n    }, {});\r\n  }, [templates]);\r\n\r\n  const showError = online && error;\r\n  const showOfflineEmpty = !online && templates.length === 0;\r\n\r\n  return (\r\n    <div className=\"max-w-5xl mx-auto space-y-6 py-6\">\r\n      {!online && (\r\n        <div className=\"border border-warning/30 bg-warning-soft text-warning rounded-lg p-3 text-xs font-semibold\">\r\n          অফলাইন: আগের Business Product Library ডাটা দেখানো হচ্ছে।\r\n        </div>\r\n      )}\r\n\r\n      <div>\r\n        <h1 className=\"text-2xl font-bold text-foreground\">Business Product Library</h1>\r\n        <p className=\"text-muted-foreground\">\r\n          Super Admin can manage default products for each business type. These power quick add in\r\n          the product list.\r\n        </p>\r\n      </div>\r\n\r\n      {showError ? (\r\n        <div className=\"border border-danger/30 bg-danger-soft text-danger rounded-lg p-4\">\r\n          {error}\r\n        </div>\r\n      ) : null}\r\n\r\n      {showOfflineEmpty ? (\r\n        <div className=\"border border-border rounded-lg p-4 text-sm text-muted-foreground\">\r\n          Offline: cached templates not available.\r\n        </div>\r\n      ) : null}\r\n\r\n      <fieldset className=\"space-y-6\">\r\n        <div className=\"border border-border rounded-xl p-4 space-y-3 bg-card\">\n          <h2 className=\"text-lg font-semibold text-foreground\">Add new template</h2>\n          <form\n            action={onCreateTemplate}\n            onSubmit={handleOfflineCreate}\n            className=\"grid grid-cols-1 lg:grid-cols-5 gap-3\"\r\n          >\r\n            <select\r\n              name=\"businessType\"\r\n              required\r\n              className=\"border border-border rounded-md px-3 py-2 text-sm bg-card text-foreground focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n              defaultValue=\"\"\r\n            >\r\n              <option value=\"\" disabled>\r\n                Business type\r\n              </option>\r\n              {mergedBusinessTypes.map((opt) => (\r\n                <option key={opt.id} value={opt.id}>\r\n                  {opt.label} ({opt.id})\r\n                </option>\r\n              ))}\r\n            </select>\r\n            <input\r\n              name=\"name\"\r\n              type=\"text\"\r\n              required\r\n              className=\"border border-border rounded-md px-3 py-2 text-sm bg-card text-foreground focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n              placeholder=\"Product name\"\r\n            />\r\n            <input\r\n              name=\"category\"\r\n              type=\"text\"\r\n              className=\"border border-border rounded-md px-3 py-2 text-sm bg-card text-foreground focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n              placeholder=\"Category (optional)\"\r\n            />\r\n            <input\r\n              name=\"defaultSellPrice\"\r\n              type=\"number\"\r\n              step=\"0.01\"\r\n              min=\"0\"\r\n              className=\"border border-border rounded-md px-3 py-2 text-sm bg-card text-foreground focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n              placeholder=\"Default sell price\"\r\n            />\r\n            <div className=\"flex items-center gap-3\">\r\n              <label className=\"inline-flex items-center gap-2 text-sm text-foreground\">\r\n                <input type=\"checkbox\" name=\"isActive\" className=\"w-4 h-4\" defaultChecked />\r\n                <span>Active</span>\r\n              </label>\r\n              <button\r\n                type=\"submit\"\r\n                className=\"ml-auto px-4 py-2 rounded-md bg-primary-soft text-primary border border-primary/30 font-semibold hover:bg-primary/15 hover:border-primary/40\"\r\n              >\r\n                Add\r\n              </button>\r\n            </div>\n          </form>\n        </div>\n\n        <div className=\"border border-border rounded-xl p-4 space-y-3 bg-card\">\n          <div>\n            <h2 className=\"text-lg font-semibold text-foreground\">Import templates (JSON)</h2>\n            <p className=\"text-xs text-muted-foreground\">\n              Paste a JSON array. Include businessType per item or select a default.\n            </p>\n          </div>\n          <form onSubmit={handleImport} className=\"space-y-3\">\n            <select\n              name=\"defaultBusinessType\"\n              className=\"border border-border rounded-md px-3 py-2 text-sm bg-card text-foreground focus:outline-none focus:ring-2 focus:ring-primary/30\"\n              value={importBusinessType}\n              onChange={(event) => {\n                setImportBusinessType(event.currentTarget.value);\n                if (importError) setImportError(null);\n                if (importNotice) setImportNotice(null);\n              }}\n            >\n              <option value=\"\">Default business type (optional)</option>\n              {mergedBusinessTypes.map((opt) => (\n                <option key={opt.id} value={opt.id}>\n                  {opt.label} ({opt.id})\n                </option>\n              ))}\n            </select>\n\n            <textarea\n              name=\"payload\"\n              rows={8}\n              spellCheck={false}\n              className=\"w-full border border-border rounded-md px-3 py-2 text-sm bg-card text-foreground focus:outline-none focus:ring-2 focus:ring-primary/30 font-mono\"\n              placeholder='[{\"businessType\":\"grocery\",\"name\":\"Rice\",\"category\":\"Staple\",\"defaultSellPrice\":50,\"isActive\":true}]'\n              value={importPayload}\n              onChange={(event) => {\n                setImportPayload(event.currentTarget.value);\n                if (importError) setImportError(null);\n                if (importNotice) setImportNotice(null);\n              }}\n            />\n\n            {importError ? (\n              <div className=\"border border-danger/30 bg-danger-soft text-danger rounded-lg p-3 text-xs font-semibold\">\n                {importError}\n              </div>\n            ) : null}\n\n            {importNotice ? (\n              <div className=\"border border-success/30 bg-success-soft text-success rounded-lg p-3 text-xs font-semibold\">\n                {importNotice}\n              </div>\n            ) : null}\n\n            <div className=\"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between\">\n              <span className=\"text-[11px] text-muted-foreground\">\n                Duplicates are skipped. Prices accept numbers or strings.\n              </span>\n              <button\n                type=\"submit\"\n                disabled={importing || importPayload.trim().length === 0}\n                className=\"inline-flex items-center justify-center px-4 py-2 rounded-md bg-primary-soft text-primary border border-primary/30 font-semibold hover:bg-primary/15 hover:border-primary/40 disabled:opacity-60 disabled:cursor-not-allowed\"\n              >\n                {importing ? \"Importing...\" : \"Import JSON\"}\n              </button>\n            </div>\n          </form>\n        </div>\n\n        {templates.length === 0 ? (\n          <div className=\"border border-border rounded-xl p-4 text-sm text-muted-foreground\">\n            No templates yet. Add a few above to enable quick add for shops.\n          </div>\n        ) : (\n          <div className=\"space-y-4\">\r\n            {Object.entries(grouped).map(([businessType, items]) => (\r\n              <div key={businessType} className=\"border border-border rounded-xl p-4 bg-card space-y-3\">\r\n                <div className=\"flex items-center justify-between\">\r\n                  <div>\r\n                    <div className=\"text-sm text-muted-foreground font-mono\">{businessType}</div>\r\n                    <div className=\"text-lg font-semibold text-foreground\">\r\n                      {labelMap.get(businessType) || businessType}\r\n                    </div>\r\n                  </div>\r\n                  <span className=\"text-xs text-muted-foreground\">{items.length} templates</span>\r\n                </div>\r\n\r\n                <div className=\"space-y-3\">\r\n                  {items.map((template) => (\r\n                    <div\r\n                      key={template.id}\r\n                      className=\"border border-border rounded-lg p-3 grid grid-cols-1 lg:grid-cols-6 gap-3 items-start\"\r\n                    >\r\n                      <form\r\n                        action={onUpdateTemplate}\r\n                        onSubmit={handleOfflineUpdate}\r\n                        className=\"grid grid-cols-1 lg:grid-cols-6 gap-3 lg:col-span-5\"\r\n                      >\r\n                        <input type=\"hidden\" name=\"id\" value={template.id} />\r\n                        <input\r\n                          name=\"name\"\r\n                          type=\"text\"\r\n                          className=\"border border-border rounded-md px-3 py-2 text-sm bg-card text-foreground focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n                          defaultValue={template.name}\r\n                        />\r\n                        <input\r\n                          name=\"category\"\r\n                          type=\"text\"\r\n                          className=\"border border-border rounded-md px-3 py-2 text-sm bg-card text-foreground focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n                          defaultValue={template.category ?? \"\"}\r\n                          placeholder=\"Category\"\r\n                        />\r\n                        <input\r\n                          name=\"defaultSellPrice\"\r\n                          type=\"number\"\r\n                          step=\"0.01\"\r\n                          min=\"0\"\r\n                          className=\"border border-border rounded-md px-3 py-2 text-sm bg-card text-foreground focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n                          defaultValue={template.defaultSellPrice ?? \"\"}\r\n                          placeholder=\"Default price\"\r\n                        />\r\n                        <label className=\"inline-flex items-center gap-2 text-sm text-foreground\">\r\n                          <input type=\"checkbox\" name=\"isActive\" className=\"w-4 h-4\" defaultChecked={template.isActive} />\r\n                          <span>Active</span>\r\n                        </label>\r\n                        <button\r\n                          type=\"submit\"\r\n                          className=\"px-3 py-2 rounded-md bg-primary-soft text-primary border border-primary/30 font-semibold hover:bg-primary/15 hover:border-primary/40\"\r\n                        >\r\n                          Save\r\n                        </button>\r\n                      </form>\r\n                      <form\r\n                        action={onDeleteTemplate}\r\n                        onSubmit={handleOfflineDelete}\r\n                        className=\"lg:col-span-1 flex justify-end\"\r\n                      >\r\n                        <input type=\"hidden\" name=\"id\" value={template.id} />\r\n                        <button\r\n                          type=\"submit\"\r\n                          className=\"px-3 py-2 rounded-md bg-danger-soft text-danger border border-danger/30 font-semibold hover:bg-danger/10 hover:border-danger/40\"\r\n                        >\r\n                          Delete\r\n                        </button>\r\n                      </form>\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n              </div>\r\n            ))}\r\n          </div>\r\n        )}\r\n      </fieldset>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\admin\\business-product-library\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\admin\\business-types\\BusinessTypesClient.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\pos\\pos-app-supabase\\app\\dashboard\\admin\\business-types\\BusinessTypesClient.tsx:163:9\n  161 |     if (online) {\n  162 |       if (Array.isArray(initialTypes) && initialTypes.length > 0) {\n> 163 |         setTypes(initialTypes);\n      |         ^^^^^^^^ Avoid calling setState() directly within an effect\n  164 |         try {\n  165 |           safeLocalStorageSet(cacheKey, JSON.stringify(initialTypes));\n  166 |         } catch {","line":163,"column":9,"nodeType":null,"endLine":163,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// app/dashboard/admin/business-types/BusinessTypesClient.tsx\r\n\r\n\"use client\";\r\n\r\nimport { type FormEvent, useCallback, useEffect, useMemo, useRef, useState } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { useOnlineStatus } from \"@/lib/sync/net-status\";\nimport { useSyncStatus } from \"@/lib/sync/sync-status\";\nimport { queueAdminAction } from \"@/lib/sync/queue\";\nimport {\n  businessFieldConfig as STATIC_CONFIGS,\n  businessOptions,\n  type BusinessType,\n  type Field,\n} from \"@/lib/productFormConfig\";\nimport { safeLocalStorageGet, safeLocalStorageSet } from \"@/lib/storage\";\n\r\ntype BusinessTypeRow = {\r\n  id: string;\r\n  key: string;\r\n  label: string;\r\n  isActive: boolean;\r\n  updatedAt: string | Date;\r\n  fieldRules?: any;\r\n  stockRules?: any;\r\n  unitRules?: any;\r\n};\r\n\r\ntype UsageInfo = { shopCount: number; templateCount: number };\r\n\r\ntype Props = {\r\n  initialTypes: BusinessTypeRow[];\r\n  initialUsage: Record<string, UsageInfo>;\r\n  error?: string | null;\r\n  onSyncDefaults: (formData: FormData) => void | Promise<void>;\r\n  onCreateFromStatic: (formData: FormData) => void | Promise<void>;\r\n  onToggleActive: (formData: FormData) => void | Promise<void>;\r\n  onDeleteBusinessType: (formData: FormData) => void | Promise<void>;\r\n  onStructuredEdit: (formData: FormData) => void | Promise<void>;\r\n};\r\n\r\n// Structured edit (no JSON needed)\r\nconst ALL_FIELDS: Field[] = [\"name\", \"sellPrice\", \"buyPrice\", \"unit\", \"expiry\", \"size\"];\r\n\r\nexport default function BusinessTypesClient({\r\n  initialTypes,\r\n  initialUsage,\r\n  error,\r\n  onSyncDefaults,\r\n  onCreateFromStatic,\r\n  onToggleActive,\r\n  onDeleteBusinessType,\r\n  onStructuredEdit,\r\n}: Props) {\r\n  const online = useOnlineStatus();\r\n  const router = useRouter();\r\n  const { pendingCount, syncing, lastSyncAt } = useSyncStatus();\r\n  const [types, setTypes] = useState<BusinessTypeRow[]>(initialTypes || []);\n  const [usage, setUsage] = useState<Record<string, UsageInfo>>(initialUsage || {});\n  const refreshInFlightRef = useRef(false);\n  const lastRefreshAtRef = useRef(0);\n  const REFRESH_MIN_INTERVAL_MS = 15_000;\n  const serverSnapshotRef = useRef({\n    types: initialTypes,\n    usage: initialUsage,\n  });\n\r\n  const cacheKey = \"admin:business-types\";\r\n  const usageKey = \"admin:business-types-usage\";\r\n\r\n  const updateTypes = useCallback(\r\n    (updater: (prev: BusinessTypeRow[]) => BusinessTypeRow[]) => {\r\n      setTypes((prev) => {\n        const next = updater(prev);\n        try {\n          safeLocalStorageSet(cacheKey, JSON.stringify(next));\n        } catch {\n          // ignore cache errors\n        }\n        return next;\n      });\n    },\r\n    [cacheKey],\r\n  );\r\n\r\n  const updateUsage = useCallback(\r\n    (updater: (prev: Record<string, UsageInfo>) => Record<string, UsageInfo>) => {\r\n      setUsage((prev) => {\n        const next = updater(prev);\n        try {\n          safeLocalStorageSet(usageKey, JSON.stringify(next));\n        } catch {\n          // ignore cache errors\n        }\n        return next;\n      });\n    },\r\n    [usageKey],\r\n  );\r\n\r\n  const buildStructuredPayload = useCallback(\r\n    (formData: FormData) => {\r\n      const rawKey = (formData.get(\"key\") as string | null)?.trim();\r\n      if (!rawKey) return null;\r\n      const key = rawKey.toLowerCase();\r\n      const existing = types.find((t) => t.key === key);\r\n      const fallbackConfig =\r\n        STATIC_CONFIGS[key as BusinessType] ?? STATIC_CONFIGS.mini_grocery;\r\n\r\n      const label =\r\n        (formData.get(\"label\") as string | null)?.trim() ||\r\n        existing?.label ||\r\n        key;\r\n      const isActive = formData.get(\"isActive\") === \"on\";\r\n\r\n      const fieldRules: Record<Field, any> = {} as any;\r\n      for (const f of ALL_FIELDS) {\r\n        fieldRules[f] = {\r\n          required: formData.get(`req:${f}`) === \"on\",\r\n          hidden: formData.get(`hid:${f}`) === \"on\",\r\n        };\r\n      }\r\n\r\n      const stockRules = {\r\n        enabledByDefault: formData.get(\"stock:enabledByDefault\") === \"on\",\r\n        requiredWhenEnabled: formData.get(\"stock:requiredWhenEnabled\") === \"on\",\r\n      };\r\n\r\n      const existingUnit = (existing?.unitRules as any) ?? fallbackConfig.unit;\r\n      const unitEnabled = formData.get(\"unit:enabled\") === \"on\";\r\n      const rawOptions = (formData.get(\"unitOptions\") as string | null) || \"\";\r\n      const unitOptions = Array.from(\r\n        new Set(\r\n          rawOptions\r\n            .split(\",\")\r\n            .map((s) => s.trim().toLowerCase())\r\n            .filter(Boolean),\r\n        ),\r\n      );\r\n      const unitDefault =\r\n        (formData.get(\"unitDefault\") as string | null)\r\n          ?.trim()\r\n          .toLowerCase() ||\r\n        existingUnit.default ||\r\n        unitOptions[0] ||\r\n        \"\";\r\n\r\n      const unitRules = {\r\n        enabled: unitEnabled,\r\n        options: unitOptions.length ? unitOptions : existingUnit.options || [],\r\n        default: unitDefault || undefined,\r\n        keywordRules: existingUnit.keywordRules || [],\r\n      };\r\n\r\n      return { key, label, isActive, fieldRules, stockRules, unitRules };\r\n    },\r\n    [types],\r\n  );\r\n\r\n  useEffect(() => {\r\n    if (online) {\r\n      if (Array.isArray(initialTypes) && initialTypes.length > 0) {\n        setTypes(initialTypes);\n        try {\n          safeLocalStorageSet(cacheKey, JSON.stringify(initialTypes));\n        } catch {\n          // ignore cache errors\n        }\n      } else if (error) {\n        try {\n          const raw = safeLocalStorageGet(cacheKey);\n          if (raw) {\n            const parsed = JSON.parse(raw);\n            if (Array.isArray(parsed)) {\n              setTypes(parsed);\n            }\n          }\r\n        } catch {\r\n          // ignore cache errors\r\n        }\r\n      }\r\n\r\n      if (initialUsage && Object.keys(initialUsage).length > 0) {\n        setUsage(initialUsage);\n        try {\n          safeLocalStorageSet(usageKey, JSON.stringify(initialUsage));\n        } catch {\n          // ignore cache errors\n        }\n      }\n      return;\r\n    }\r\n\r\n    try {\n      const raw = safeLocalStorageGet(cacheKey);\n      if (raw) {\n        const parsed = JSON.parse(raw);\n        if (Array.isArray(parsed)) {\n          setTypes(parsed);\n        }\r\n      }\r\n    } catch {\r\n      // ignore cache errors\r\n    }\r\n\r\n    try {\n      const raw = safeLocalStorageGet(usageKey);\n      if (raw) {\n        const parsed = JSON.parse(raw);\n        if (parsed && typeof parsed === \"object\") {\n          setUsage(parsed);\n        }\r\n      }\r\n    } catch {\r\n      // ignore cache errors\r\n    }\r\n  }, [online, initialTypes, initialUsage, error]);\r\n\r\n  useEffect(() => {\r\n    if (\r\n      serverSnapshotRef.current.types !== initialTypes ||\r\n      serverSnapshotRef.current.usage !== initialUsage\r\n    ) {\r\n      serverSnapshotRef.current = { types: initialTypes, usage: initialUsage };\r\n      refreshInFlightRef.current = false;\r\n    }\r\n  }, [initialTypes, initialUsage]);\r\n\r\n  useEffect(() => {\n    if (!online || !lastSyncAt || syncing || pendingCount > 0) return;\n    if (refreshInFlightRef.current) return;\n    const now = Date.now();\n    if (now - lastRefreshAtRef.current < REFRESH_MIN_INTERVAL_MS) return;\n    lastRefreshAtRef.current = now;\n    refreshInFlightRef.current = true;\n    router.refresh();\n  }, [online, lastSyncAt, syncing, pendingCount, router]);\n\r\n  const handleOfflineSyncDefaults = useCallback(\r\n    async (event: FormEvent<HTMLFormElement>) => {\r\n      if (online) return;\r\n      event.preventDefault();\r\n      await queueAdminAction(\"business_type_sync_defaults\", {});\r\n      alert(\"Offline: sync defaults queued.\");\r\n    },\r\n    [online],\r\n  );\r\n\r\n  const handleOfflineCreateFromStatic = useCallback(\r\n    async (event: FormEvent<HTMLFormElement>) => {\r\n      if (online) return;\r\n      event.preventDefault();\r\n      const formData = new FormData(event.currentTarget);\r\n      const rawKey = (formData.get(\"key\") as string | null)?.trim();\r\n      if (!rawKey) return;\r\n      const key = rawKey.toLowerCase();\r\n      const label = (formData.get(\"label\") as string | null)?.trim() || key;\r\n      const config =\r\n        STATIC_CONFIGS[key as BusinessType] ?? STATIC_CONFIGS.mini_grocery;\r\n\r\n      updateTypes((prev) => {\r\n        const next = [...prev];\r\n        const now = new Date().toISOString();\r\n        const existingIndex = next.findIndex((t) => t.key === key);\r\n        const row = {\r\n          ...(existingIndex >= 0 ? next[existingIndex] : { id: key }),\r\n          key,\r\n          label,\r\n          isActive: true,\r\n          updatedAt: now,\r\n          fieldRules: config.fields,\r\n          stockRules: config.stock,\r\n          unitRules: config.unit,\r\n        };\r\n        if (existingIndex >= 0) {\r\n          next[existingIndex] = row;\r\n        } else {\r\n          next.unshift(row);\r\n        }\r\n        return next;\r\n      });\r\n\r\n      updateUsage((prev) => ({\r\n        ...prev,\r\n        [key]: prev[key] ?? { shopCount: 0, templateCount: 0 },\r\n      }));\r\n\r\n      await queueAdminAction(\"business_type_create_from_static\", {\r\n        key,\r\n        label,\r\n      });\r\n      alert(\"Offline: business type queued.\");\r\n    },\r\n    [online, updateTypes, updateUsage],\r\n  );\r\n\r\n  const handleOfflineToggleActive = useCallback(\r\n    async (event: FormEvent<HTMLFormElement>) => {\r\n      if (online) return;\r\n      event.preventDefault();\r\n      const formData = new FormData(event.currentTarget);\r\n      const rawKey = (formData.get(\"key\") as string | null)?.trim();\r\n      if (!rawKey) return;\r\n      const key = rawKey.toLowerCase();\r\n      const isActive = formData.get(\"isActive\") === \"true\";\r\n      const now = new Date().toISOString();\r\n      updateTypes((prev) =>\r\n        prev.map((t) => (t.key === key ? { ...t, isActive, updatedAt: now } : t)),\r\n      );\r\n      await queueAdminAction(\"business_type_toggle_active\", { key, isActive });\r\n      alert(\"Offline: status change queued.\");\r\n    },\r\n    [online, updateTypes],\r\n  );\r\n\r\n  const handleOfflineStructuredEdit = useCallback(\r\n    async (event: FormEvent<HTMLFormElement>) => {\r\n      if (online) return;\r\n      event.preventDefault();\r\n      const submitter = (event.nativeEvent as SubmitEvent)\r\n        .submitter as HTMLButtonElement | null;\r\n      const action = submitter?.dataset.offlineAction || \"save\";\r\n      const formData = new FormData(event.currentTarget);\r\n      const rawKey = (formData.get(\"key\") as string | null)?.trim();\r\n      if (!rawKey) return;\r\n      const key = rawKey.toLowerCase();\r\n\r\n      if (action === \"delete\") {\r\n        updateTypes((prev) => prev.filter((t) => t.key !== key));\r\n        updateUsage((prev) => {\r\n          const next = { ...prev };\r\n          delete next[key];\r\n          return next;\r\n        });\r\n        await queueAdminAction(\"business_type_delete\", { key });\r\n        alert(\"Offline: delete queued.\");\r\n        return;\r\n      }\r\n\r\n      const payload = buildStructuredPayload(formData);\r\n      if (!payload) return;\r\n      updateTypes((prev) => {\r\n        const next = [...prev];\r\n        const now = new Date().toISOString();\r\n        const existingIndex = next.findIndex((t) => t.key === payload.key);\r\n        const existing = existingIndex >= 0 ? next[existingIndex] : null;\r\n        const row = {\r\n          ...(existing || { id: payload.key }),\r\n          ...payload,\r\n          updatedAt: now,\r\n        };\r\n        if (existingIndex >= 0) {\r\n          next[existingIndex] = row;\r\n        } else {\r\n          next.unshift(row);\r\n        }\r\n        return next;\r\n      });\r\n      updateUsage((prev) => ({\r\n        ...prev,\r\n        [payload.key]: prev[payload.key] ?? { shopCount: 0, templateCount: 0 },\r\n      }));\r\n      await queueAdminAction(\"business_type_upsert\", payload);\r\n      alert(\"Offline: changes queued.\");\r\n    },\r\n    [online, updateTypes, updateUsage, buildStructuredPayload],\r\n  );\r\n\r\n  const missingKeys = useMemo(() => {\r\n    return Object.keys(STATIC_CONFIGS).filter(\r\n      (key) => !types?.some((t) => t.key === key),\r\n    );\r\n  }, [types]);\r\n\r\n  const showError = online && error;\r\n  const showOfflineEmpty = !online && types.length === 0;\r\n\r\n  return (\r\n    <div className=\"max-w-4xl mx-auto space-y-6 py-6\">\r\n      {!online && (\r\n        <div className=\"border border-warning/30 bg-warning-soft text-warning rounded-lg p-3 text-xs font-semibold\">\r\n          অফলাইন: আগের Business Types ডাটা দেখানো হচ্ছে।\r\n        </div>\r\n      )}\r\n\r\n      <div>\r\n        <h1 className=\"text-2xl font-bold text-foreground\">Business Types (Admin)</h1>\r\n        <p className=\"text-muted-foreground\">\r\n          Super Admin can manage business type rules without redeploy. Changes apply immediately.\r\n        </p>\r\n      </div>\r\n\r\n      {showError ? (\r\n        <div className=\"border border-danger/30 bg-danger-soft text-danger rounded-lg p-4\">\r\n          {error}\r\n        </div>\r\n      ) : null}\r\n\r\n      {showOfflineEmpty ? (\r\n        <div className=\"border border-border rounded-lg p-4 text-sm text-muted-foreground\">\r\n          Offline: cached business types data not available.\r\n        </div>\r\n      ) : null}\r\n\r\n      <fieldset className=\"space-y-6\">\r\n        <form\r\n          action={onSyncDefaults}\r\n          onSubmit={handleOfflineSyncDefaults}\r\n          className=\"flex flex-wrap gap-3 items-center\"\r\n        >\r\n          <button\r\n            type=\"submit\"\r\n            className=\"px-4 py-2 rounded-md bg-primary-soft text-primary border border-primary/30 font-semibold hover:bg-primary/15 hover:border-primary/40 disabled:opacity-60 disabled:cursor-not-allowed\"\r\n          >\r\n            Sync default configs from code\r\n          </button>\r\n          <span className=\"text-sm text-muted-foreground\">\r\n            Pulls current code configs into DB (upsert).\r\n          </span>\r\n        </form>\r\n\r\n        {missingKeys.length > 0 ? (\r\n          <div className=\"border border-warning/30 bg-warning-soft text-warning rounded-lg p-3 text-sm\">\r\n            Missing in DB: {missingKeys.join(\", \")}\r\n          </div>\r\n        ) : null}\r\n\r\n        <div className=\"border border-border rounded-xl overflow-hidden\">\r\n          <table className=\"min-w-full divide-y divide-border\">\r\n            <thead className=\"bg-muted\">\r\n              <tr>\r\n                <th className=\"px-4 py-3 text-left text-xs font-semibold text-muted-foreground uppercase tracking-wider\">\r\n                  Key\r\n                </th>\r\n                <th className=\"px-4 py-3 text-left text-xs font-semibold text-muted-foreground uppercase tracking-wider\">\r\n                  Label\r\n                </th>\r\n                <th className=\"px-4 py-3 text-left text-xs font-semibold text-muted-foreground uppercase tracking-wider\">\r\n                  Active\r\n                </th>\r\n                <th className=\"px-4 py-3 text-left text-xs font-semibold text-muted-foreground uppercase tracking-wider\">\r\n                  Updated\r\n                </th>\r\n              </tr>\r\n            </thead>\r\n            <tbody className=\"bg-card divide-y divide-border\">\r\n              {types?.map((t) => (\r\n                <tr key={t.id}>\r\n                  <td className=\"px-4 py-3 text-sm font-mono text-foreground\">{t.key}</td>\r\n                  <td className=\"px-4 py-3 text-sm text-foreground\">{t.label}</td>\r\n                  <td className=\"px-4 py-3 text-sm\">\r\n                    <span\r\n                      className={`inline-flex px-2 py-1 rounded-full text-xs font-semibold ${\r\n                        t.isActive ? \"bg-success-soft text-success\" : \"bg-danger-soft text-danger\"\r\n                      }`}\r\n                    >\r\n                      {t.isActive ? \"Active\" : \"Disabled\"}\r\n                    </span>\r\n                  </td>\r\n                  <td className=\"px-4 py-3 text-sm text-muted-foreground\">\r\n                    {new Date(t.updatedAt).toLocaleString()}\r\n                  </td>\r\n                </tr>\r\n              ))}\r\n              {!types?.length ? (\r\n                <tr>\r\n                  <td className=\"px-4 py-4 text-sm text-muted-foreground\" colSpan={4}>\r\n                    No business types in database yet.\r\n                  </td>\r\n                </tr>\r\n              ) : null}\r\n            </tbody>\r\n          </table>\r\n        </div>\r\n\r\n        <div className=\"border border-border rounded-xl p-4 space-y-3\">\r\n          <h2 className=\"text-lg font-semibold text-foreground\">Add from static config</h2>\r\n          <p className=\"text-sm text-muted-foreground\">\r\n            Pick an existing code config and push it to DB (edit later via DB/UI).\r\n          </p>\r\n          <form\r\n            action={onCreateFromStatic}\r\n            onSubmit={handleOfflineCreateFromStatic}\r\n            className=\"flex flex-col gap-3 sm:flex-row sm:items-center\"\r\n          >\r\n            <select\r\n              name=\"key\"\r\n              className=\"border border-border rounded-md px-3 py-2 text-sm bg-card text-foreground focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n              defaultValue=\"\"\r\n            >\r\n              <option value=\"\" disabled>\r\n                Choose a business type\r\n              </option>\r\n              {businessOptions.map((opt) => (\r\n                <option key={opt.id} value={opt.id}>\r\n                  {opt.id} - {opt.label}\r\n                </option>\r\n              ))}\r\n            </select>\r\n            <input\r\n              name=\"label\"\r\n              type=\"text\"\r\n              className=\"border border-border rounded-md px-3 py-2 text-sm flex-1 bg-card text-foreground focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n              placeholder=\"Label (optional, defaults to code label)\"\r\n            />\r\n            <button\r\n              type=\"submit\"\r\n              className=\"px-4 py-2 rounded-md bg-primary-soft text-primary border border-primary/30 font-semibold hover:bg-primary/15 hover:border-primary/40\"\r\n            >\r\n              Upsert\r\n            </button>\r\n          </form>\r\n        </div>\r\n\r\n        <div className=\"space-y-4\">\r\n          <h2 className=\"text-lg font-semibold text-foreground\">Manage configs</h2>\r\n          <p className=\"text-sm text-muted-foreground\">\r\n            Edit label/active, and adjust field/stock/unit rules inline. Save applies immediately\r\n            (validation enforced).\r\n          </p>\r\n\r\n          {/* Create new business type */}\r\n          <div className=\"border border-success/30 bg-success-soft rounded-xl p-4 space-y-3 shadow-sm\">\r\n            <div className=\"flex items-center justify-between gap-2\">\r\n              <div>\r\n                <div className=\"text-sm text-success font-semibold\">Create new business type</div>\r\n                <p className=\"text-xs text-success/80\">\r\n                  Key is unique. Defaults: name & sellPrice required; others optional.\r\n                </p>\r\n              </div>\r\n            </div>\r\n            <form action={onStructuredEdit} onSubmit={handleOfflineStructuredEdit} className=\"space-y-3\">\r\n              <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-3\">\r\n                <input\r\n                  name=\"key\"\r\n                  type=\"text\"\r\n                  className=\"border border-border rounded-md px-3 py-2 text-sm bg-card text-foreground focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n                  placeholder=\"unique key (e.g., bakery)\"\r\n                  required\r\n                />\r\n                <input\r\n                  name=\"label\"\r\n                  type=\"text\"\r\n                  className=\"border border-border rounded-md px-3 py-2 text-sm bg-card text-foreground focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n                  placeholder=\"Display label\"\r\n                />\r\n                <label className=\"inline-flex items-center gap-2 text-sm text-foreground\">\r\n                  <input type=\"checkbox\" name=\"isActive\" className=\"w-4 h-4\" defaultChecked />\r\n                  <span>Active</span>\r\n                </label>\r\n              </div>\r\n\r\n              <div className=\"border border-border rounded-lg p-3 space-y-2 bg-card\">\r\n                <div className=\"text-sm font-semibold text-foreground\">Fields</div>\r\n                <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2\">\r\n                  {ALL_FIELDS.map((f) => (\r\n                    <div\r\n                      key={`create-${f}`}\r\n                      className=\"border border-border rounded-md px-3 py-2 flex flex-col gap-1\"\r\n                    >\r\n                      <div className=\"text-sm font-medium text-foreground\">{f}</div>\r\n                      <label className=\"inline-flex items-center gap-2 text-xs text-foreground\">\r\n                        <input\r\n                          type=\"checkbox\"\r\n                          name={`req:${f}`}\r\n                          className=\"w-4 h-4\"\r\n                          defaultChecked={f === \"name\" || f === \"sellPrice\"}\r\n                        />\r\n                        <span>Required</span>\r\n                      </label>\r\n                      <label className=\"inline-flex items-center gap-2 text-xs text-foreground\">\r\n                        <input type=\"checkbox\" name={`hid:${f}`} className=\"w-4 h-4\" />\r\n                        <span>Hidden</span>\r\n                      </label>\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-3\">\r\n                <div className=\"border border-border rounded-lg p-3 space-y-2 bg-card\">\r\n                  <div className=\"text-sm font-semibold text-foreground\">Stock</div>\r\n                  <label className=\"inline-flex items-center gap-2 text-sm text-foreground\">\r\n                    <input type=\"checkbox\" name=\"stock:enabledByDefault\" className=\"w-4 h-4\" />\r\n                    <span>Enabled by default</span>\r\n                  </label>\r\n                  <label className=\"inline-flex items-center gap-2 text-sm text-foreground\">\r\n                    <input type=\"checkbox\" name=\"stock:requiredWhenEnabled\" className=\"w-4 h-4\" />\r\n                    <span>Quantity required when enabled</span>\r\n                  </label>\r\n                </div>\r\n\r\n                <div className=\"border border-border rounded-lg p-3 space-y-2 bg-card\">\r\n                  <div className=\"flex items-center justify-between\">\r\n                    <div className=\"text-sm font-semibold text-foreground\">Unit</div>\r\n                    <label className=\"inline-flex items-center gap-2 text-sm text-foreground\">\r\n                      <input type=\"checkbox\" name=\"unit:enabled\" className=\"w-4 h-4\" />\r\n                      <span>Enable unit field</span>\r\n                    </label>\r\n                  </div>\r\n                  <div className=\"space-y-2\">\r\n                    <label className=\"text-xs text-muted-foreground\">Options (comma separated)</label>\r\n                    <input\r\n                      name=\"unitOptions\"\r\n                      type=\"text\"\r\n                      className=\"border border-border rounded-md px-3 py-2 text-sm bg-card text-foreground focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n                      placeholder=\"pcs, kg, liter\"\r\n                    />\r\n                    <label className=\"text-xs text-muted-foreground\">Default unit</label>\r\n                    <input\r\n                      name=\"unitDefault\"\r\n                      type=\"text\"\r\n                      className=\"border border-border rounded-md px-3 py-2 text-sm bg-card text-foreground focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n                      placeholder=\"pcs\"\r\n                    />\r\n                  </div>\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"flex gap-3\">\r\n                <button\r\n                  type=\"submit\"\r\n                  className=\"px-4 py-2 rounded-md bg-primary-soft text-primary border border-primary/30 font-semibold hover:bg-primary/15 hover:border-primary/40\"\r\n                >\r\n                  Create & save\r\n                </button>\r\n              </div>\r\n            </form>\r\n          </div>\r\n\r\n          <div className=\"space-y-3\">\r\n            {types?.map((t) => {\r\n              const fields = (t.fieldRules as any) ?? {};\r\n              const stock = (t.stockRules as any) ?? {};\r\n              const unit = (t.unitRules as any) ?? {};\r\n              const unitOptions = (unit.options || []) as string[];\r\n              const usageInfo = usage[t.key] ?? { shopCount: 0, templateCount: 0 };\r\n              const canDelete = usageInfo.shopCount === 0 && usageInfo.templateCount === 0;\r\n\r\n              return (\r\n                <div\r\n                  key={t.key}\r\n                  className=\"border border-border rounded-xl p-4 space-y-3 bg-card shadow-sm\"\r\n                >\r\n                  <div className=\"flex flex-wrap items-center gap-3 justify-between\">\r\n                    <div>\r\n                      <div className=\"text-sm text-muted-foreground font-mono\">{t.key}</div>\r\n                      <div className=\"text-lg font-semibold text-foreground\">{t.label}</div>\r\n                      <div className=\"text-xs text-muted-foreground mt-1\">\r\n                        Shops: {usageInfo.shopCount} | Templates: {usageInfo.templateCount}\r\n                      </div>\r\n                    </div>\r\n                    <form action={onToggleActive} onSubmit={handleOfflineToggleActive}>\r\n                      <input type=\"hidden\" name=\"key\" value={t.key} />\r\n                      <input type=\"hidden\" name=\"isActive\" value={(!t.isActive).toString()} />\r\n                      <button\r\n                        type=\"submit\"\r\n                        className={`px-3 py-2 text-sm rounded-md border ${\r\n                          t.isActive\r\n                            ? \"border-danger/30 text-danger bg-danger-soft hover:border-danger/50\"\r\n                            : \"border-success/30 text-success bg-success-soft hover:border-success/50\"\r\n                        }`}\r\n                      >\r\n                        {t.isActive ? \"Disable\" : \"Enable\"}\r\n                      </button>\r\n                    </form>\r\n                  </div>\r\n\r\n                  <form action={onStructuredEdit} onSubmit={handleOfflineStructuredEdit} className=\"space-y-3\">\r\n                    <input type=\"hidden\" name=\"key\" value={t.key} />\r\n\r\n                    <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-3\">\r\n                      <input\r\n                        name=\"label\"\r\n                        type=\"text\"\r\n                        className=\"border border-border rounded-md px-3 py-2 text-sm bg-card text-foreground focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n                        placeholder=\"Label\"\r\n                        defaultValue={t.label}\r\n                      />\r\n                      <label className=\"inline-flex items-center gap-2 text-sm text-foreground\">\r\n                        <input type=\"checkbox\" name=\"isActive\" className=\"w-4 h-4\" defaultChecked={t.isActive} />\r\n                        <span>Active</span>\r\n                      </label>\r\n                      <div className=\"text-xs text-muted-foreground\">\r\n                        Save will validate and upsert this config.\r\n                      </div>\r\n                    </div>\r\n\r\n                    <div className=\"border border-border rounded-lg p-3 space-y-2\">\r\n                      <div className=\"text-sm font-semibold text-foreground\">Fields</div>\r\n                      <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2\">\r\n                        {ALL_FIELDS.map((f) => {\r\n                          const rule = (fields as any)[f] || {};\r\n                          return (\r\n                            <div\r\n                              key={f}\r\n                              className=\"border border-border rounded-md px-3 py-2 flex flex-col gap-1\"\r\n                            >\r\n                              <div className=\"text-sm font-medium text-foreground\">{f}</div>\r\n                              <label className=\"inline-flex items-center gap-2 text-xs text-foreground\">\r\n                                <input type=\"checkbox\" name={`req:${f}`} className=\"w-4 h-4\" defaultChecked={!!rule.required} />\r\n                                <span>Required</span>\r\n                              </label>\r\n                              <label className=\"inline-flex items-center gap-2 text-xs text-foreground\">\r\n                                <input type=\"checkbox\" name={`hid:${f}`} className=\"w-4 h-4\" defaultChecked={!!rule.hidden} />\r\n                                <span>Hidden</span>\r\n                              </label>\r\n                            </div>\r\n                          );\r\n                        })}\r\n                      </div>\r\n                    </div>\r\n\r\n                    <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-3\">\r\n                      <div className=\"border border-border rounded-lg p-3 space-y-2\">\r\n                        <div className=\"flex items-center justify-between\">\r\n                          <div className=\"text-sm font-semibold text-foreground\">Stock</div>\r\n                        </div>\r\n                        <label className=\"inline-flex items-center gap-2 text-sm text-foreground\">\r\n                          <input\r\n                            type=\"checkbox\"\r\n                            name=\"stock:enabledByDefault\"\r\n                            className=\"w-4 h-4\"\r\n                            defaultChecked={!!stock.enabledByDefault}\r\n                          />\r\n                          <span>Enabled by default</span>\r\n                        </label>\r\n                        <label className=\"inline-flex items-center gap-2 text-sm text-foreground\">\r\n                          <input\r\n                            type=\"checkbox\"\r\n                            name=\"stock:requiredWhenEnabled\"\r\n                            className=\"w-4 h-4\"\r\n                            defaultChecked={!!stock.requiredWhenEnabled}\r\n                          />\r\n                          <span>Quantity required when enabled</span>\r\n                        </label>\r\n                      </div>\r\n\r\n                      <div className=\"border border-border rounded-lg p-3 space-y-2\">\r\n                        <div className=\"flex items-center justify-between\">\r\n                          <div className=\"text-sm font-semibold text-foreground\">Unit</div>\r\n                          <label className=\"inline-flex items-center gap-2 text-sm text-foreground\">\r\n                            <input\r\n                              type=\"checkbox\"\r\n                              name=\"unit:enabled\"\r\n                              className=\"w-4 h-4\"\r\n                              defaultChecked={!!unit.enabled}\r\n                            />\r\n                            <span>Enable unit field</span>\r\n                          </label>\r\n                        </div>\r\n                        <div className=\"space-y-2\">\r\n                          <label className=\"text-xs text-muted-foreground\">Options (comma separated)</label>\r\n                          <input\r\n                            name=\"unitOptions\"\r\n                            type=\"text\"\r\n                            className=\"border border-border rounded-md px-3 py-2 text-sm bg-card text-foreground focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n                            placeholder=\"kg, gm, pcs\"\r\n                            defaultValue={unitOptions.join(\", \")}\r\n                          />\r\n                          <label className=\"text-xs text-muted-foreground\">Default unit</label>\r\n                          <select\r\n                            name=\"unitDefault\"\r\n                            className=\"border border-border rounded-md px-3 py-2 text-sm bg-card text-foreground focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n                            defaultValue={unit.default || unitOptions[0] || \"\"}\r\n                          >\r\n                            <option value=\"\">(auto)</option>\r\n                            {unitOptions.map((u) => (\r\n                              <option key={u} value={u}>\r\n                                {u}\r\n                              </option>\r\n                            ))}\r\n                          </select>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n\r\n                    <div className=\"flex gap-3\">\r\n                      <button\r\n                        type=\"submit\"\r\n                        data-offline-action=\"save\"\r\n                        className=\"px-4 py-2 rounded-md bg-primary-soft text-primary border border-primary/30 font-semibold hover:bg-primary/15 hover:border-primary/40\"\r\n                      >\r\n                        Save changes\r\n                      </button>\r\n                      <button\r\n                        type=\"submit\"\r\n                        formAction={onDeleteBusinessType}\r\n                        data-offline-action=\"delete\"\r\n                        disabled={!canDelete}\r\n                        className={`px-4 py-2 rounded-md border font-semibold ${\r\n                          canDelete\r\n                            ? \"border-danger/30 text-danger bg-danger-soft hover:border-danger/50\"\r\n                            : \"border-border text-muted-foreground bg-muted cursor-not-allowed\"\r\n                        }`}\r\n                      >\r\n                        Delete\r\n                      </button>\r\n                    </div>\r\n                    {!canDelete && (\r\n                      <p className=\"text-xs text-warning\">\r\n                        Delete is disabled because this business type is in use.\r\n                      </p>\r\n                    )}\r\n                  </form>\r\n                </div>\r\n              );\r\n            })}\r\n          </div>\r\n        </div>\r\n      </fieldset>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\admin\\business-types\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\admin\\rbac\\RbacAdminClient.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\pos\\pos-app-supabase\\app\\dashboard\\admin\\rbac\\RbacAdminClient.tsx:54:7\n  52 |     const cacheKey = \"admin:rbac\";\n  53 |     if (online) {\n> 54 |       setCachedUsers(users);\n     |       ^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  55 |       setCachedRoleOptions(roleOptions);\n  56 |       setCachedRoles(roles);\n  57 |       setCachedPermissions(permissions);","line":54,"column":7,"nodeType":null,"endLine":54,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useMemo, useRef, useState } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport type { Permission, Role } from \"@prisma/client\";\r\nimport { UsersRolesPanel } from \"./UsersRolesPanel\";\nimport { RolesPermissionsPanel } from \"./RolesPermissionsPanel\";\nimport { useOnlineStatus } from \"@/lib/sync/net-status\";\nimport { useSyncStatus } from \"@/lib/sync/sync-status\";\nimport { safeLocalStorageGet, safeLocalStorageSet } from \"@/lib/storage\";\n\r\ntype RoleWithPermissions = Role & { rolePermissions: { permissionId: string }[] };\r\ntype UserRow = {\r\n  id: string;\r\n  email: string | null;\r\n  name: string | null;\r\n  roles: { id: string; name: string }[];\r\n};\r\n\r\ntype Props = {\r\n  users: UserRow[];\r\n  roleOptions: Role[];\r\n  roles: RoleWithPermissions[];\r\n  permissions: Permission[];\r\n};\r\n\r\nconst tabs = [\r\n  { id: \"users\", label: \"টিম অ্যাক্সেস\" },\r\n  { id: \"permissions\", label: \"রোলের পারমিশন\" },\r\n] as const;\r\n\r\nexport default function RbacAdminClient({ users, roleOptions, roles, permissions }: Props) {\r\n  const online = useOnlineStatus();\r\n  const router = useRouter();\r\n  const { pendingCount, syncing, lastSyncAt } = useSyncStatus();\r\n  const [activeTab, setActiveTab] = useState<\"users\" | \"permissions\">(\"users\");\r\n  const [cachedUsers, setCachedUsers] = useState(users);\r\n  const [cachedRoleOptions, setCachedRoleOptions] = useState(roleOptions);\r\n  const [cachedRoles, setCachedRoles] = useState(roles);\r\n  const [cachedPermissions, setCachedPermissions] = useState(permissions);\r\n  const refreshInFlightRef = useRef(false);\n  const lastRefreshAtRef = useRef(0);\n  const REFRESH_MIN_INTERVAL_MS = 15_000;\n  const serverSnapshotRef = useRef({\n    users,\n    roleOptions,\n    roles,\r\n    permissions,\r\n  });\r\n\r\n  useEffect(() => {\r\n    const cacheKey = \"admin:rbac\";\r\n    if (online) {\n      setCachedUsers(users);\n      setCachedRoleOptions(roleOptions);\n      setCachedRoles(roles);\n      setCachedPermissions(permissions);\n      try {\n        safeLocalStorageSet(\n          cacheKey,\n          JSON.stringify({ users, roleOptions, roles, permissions })\n        );\n      } catch {\n        // ignore cache errors\n      }\n      return;\n    }\n\n    try {\n      const raw = safeLocalStorageGet(cacheKey);\n      if (!raw) return;\n      const parsed = JSON.parse(raw) as Partial<Props>;\n      if (Array.isArray(parsed.users)) setCachedUsers(parsed.users as UserRow[]);\r\n      if (Array.isArray(parsed.roleOptions))\r\n        setCachedRoleOptions(parsed.roleOptions as Role[]);\r\n      if (Array.isArray(parsed.roles)) setCachedRoles(parsed.roles as RoleWithPermissions[]);\r\n      if (Array.isArray(parsed.permissions))\r\n        setCachedPermissions(parsed.permissions as Permission[]);\r\n    } catch {\r\n      // ignore cache errors\r\n    }\r\n  }, [online, users, roleOptions, roles, permissions]);\r\n\r\n  useEffect(() => {\r\n    if (\r\n      serverSnapshotRef.current.users !== users ||\r\n      serverSnapshotRef.current.roleOptions !== roleOptions ||\r\n      serverSnapshotRef.current.roles !== roles ||\r\n      serverSnapshotRef.current.permissions !== permissions\r\n    ) {\r\n      serverSnapshotRef.current = { users, roleOptions, roles, permissions };\r\n      refreshInFlightRef.current = false;\r\n    }\r\n  }, [users, roleOptions, roles, permissions]);\r\n\r\n  useEffect(() => {\n    if (!online || !lastSyncAt || syncing || pendingCount > 0) return;\n    if (refreshInFlightRef.current) return;\n    const now = Date.now();\n    if (now - lastRefreshAtRef.current < REFRESH_MIN_INTERVAL_MS) return;\n    lastRefreshAtRef.current = now;\n    refreshInFlightRef.current = true;\n    router.refresh();\n  }, [online, lastSyncAt, syncing, pendingCount, router]);\n\r\n  const stats = useMemo(\r\n    () => ({\r\n      users: cachedUsers.length,\r\n      roles: cachedRoles.length,\r\n    }),\r\n    [cachedUsers.length, cachedRoles.length],\r\n  );\r\n\r\n  return (\r\n    <main className=\"max-w-6xl mx-auto py-8 px-4 sm:px-6 lg:px-8 space-y-6\">\r\n      {!online && (\r\n        <div className=\"border border-warning/30 bg-warning-soft text-warning rounded-lg p-3 text-xs font-semibold\">\r\n          অফলাইন: আগের RBAC ডাটা দেখানো হচ্ছে।\r\n        </div>\r\n      )}\r\n      <header className=\"bg-card/80 border border-border rounded-2xl shadow-sm p-5 flex flex-col gap-3\">\r\n        <div className=\"flex items-center justify-between flex-wrap gap-3\">\r\n          <div className=\"space-y-1\">\r\n            <div className=\"inline-flex items-center gap-2 px-2.5 py-1 rounded-full bg-muted text-foreground text-xs font-semibold\">\r\n              🔒 Role-Based Access Control\r\n            </div>\r\n            <h1 className=\"text-3xl font-bold tracking-tight text-foreground\">RBAC Control Center</h1>\r\n            <p className=\"text-sm text-muted-foreground\">\r\n              কম ভিউতে কাজ করার জন্য ট্যাবে ভাগ করা হয়েছে। টিম অ্যাক্সেস ও পারমিশন আলাদা ট্যাবে দেখুন।\r\n            </p>\r\n          </div>\r\n          <div className=\"flex items-center gap-3 text-sm text-muted-foreground\">\r\n            <div className=\"px-3 py-2 rounded-xl border border-border bg-muted shadow-sm\">\r\n              <div className=\"text-[11px] text-muted-foreground uppercase tracking-wide\">মোট ব্যবহারকারী</div>\r\n              <div className=\"text-lg font-semibold text-foreground\">{stats.users}</div>\r\n            </div>\r\n            <div className=\"px-3 py-2 rounded-xl border border-border bg-muted shadow-sm\">\r\n              <div className=\"text-[11px] text-muted-foreground uppercase tracking-wide\">মোট রোল</div>\r\n              <div className=\"text-lg font-semibold text-foreground\">{stats.roles}</div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"inline-flex items-center gap-2 rounded-xl border border-border bg-muted p-1\">\r\n          {tabs.map((tab) => (\r\n            <button\r\n              key={tab.id}\r\n              onClick={() => setActiveTab(tab.id)}\r\n              className={`px-4 py-2 text-sm font-semibold rounded-lg transition-colors border ${\r\n                activeTab === tab.id\r\n                  ? \"bg-primary-soft text-primary border-primary/30 shadow-sm\"\r\n                  : \"text-muted-foreground border-transparent hover:bg-card\"\r\n              }`}\r\n            >\r\n              {tab.label}\r\n            </button>\r\n          ))}\r\n        </div>\r\n      </header>\r\n\r\n      <section className=\"grid grid-cols-1 gap-6\">\r\n        {activeTab === \"users\" ? (\r\n          <UsersRolesPanel users={cachedUsers as any} roles={cachedRoleOptions as any} />\r\n        ) : (\r\n          <RolesPermissionsPanel roles={cachedRoles as any} permissions={cachedPermissions as any} />\r\n        )}\r\n      </section>\r\n    </main>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\admin\\rbac\\RolesPermissionsPanel.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\pos\\pos-app-supabase\\app\\dashboard\\admin\\rbac\\RolesPermissionsPanel.tsx:189:5\n  187 |     if (!selectedRole || selectedRole.name !== \"staff\") return;\n  188 |     if (staffBaselineIds.size === 0) return;\n> 189 |     setLocalAssignments((prev) => {\n      |     ^^^^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  190 |       const current = new Set(prev[selectedRole.id] ?? []);\n  191 |       let changed = false;\n  192 |       staffBaselineIds.forEach((id) => {","line":189,"column":5,"nodeType":null,"endLine":189,"endColumn":24}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useMemo, useState, useTransition } from \"react\";\r\nimport type { Role, Permission } from \"@prisma/client\";\r\nimport { updateRolePermissions } from \"@/app/actions/rbac-admin\";\nimport { useOnlineStatus } from \"@/lib/sync/net-status\";\nimport { queueAdminAction } from \"@/lib/sync/queue\";\nimport { STAFF_BASELINE_PERMISSIONS } from \"@/lib/staff-baseline-permissions\";\nimport { safeLocalStorageGet, safeLocalStorageSet } from \"@/lib/storage\";\n\r\ntype RoleWithPermissions = Role & {\r\n  rolePermissions: { permissionId: string }[];\r\n};\r\n\r\ninterface RolesPermissionsPanelProps {\r\n  roles: RoleWithPermissions[];\r\n  permissions: Permission[];\r\n}\r\n\r\nexport type ModuleKey =\r\n  | \"dashboard\"\r\n  | \"shops\"\r\n  | \"products\"\n  | \"purchases\"\n  | \"suppliers\"\n  | \"sales\"\n  | \"customers\"\r\n  | \"expenses\"\r\n  | \"cash\"\r\n  | \"reports\"\r\n  | \"users\"\r\n  | \"roles\"\r\n  | \"settings\"\r\n  | \"offline\"\r\n  | \"other\";\r\n\r\nexport const moduleLabels: Record<ModuleKey, string> = {\r\n  dashboard: \"ড্যাশবোর্ড\",\r\n  shops: \"দোকান\",\r\n  products: \"পণ্য\",\n  purchases: \"পণ্য ক্রয়\",\n  suppliers: \"সরবরাহকারী\",\n  sales: \"বিক্রি\",\n  customers: \"কাস্টমার / বকেয়া\",\r\n  expenses: \"খরচ\",\r\n  cash: \"ক্যাশ\",\r\n  reports: \"রিপোর্ট\",\r\n  users: \"ব্যবহারকারী\",\r\n  roles: \"রোল / পারমিশন\",\r\n  settings: \"সেটিংস\",\r\n  offline: \"অফলাইন / সিঙ্ক\",\r\n  other: \"অন্যান্য\",\r\n};\r\n\r\nexport type PermissionMeta = {\r\n  label: string;\r\n  description?: string;\r\n  module: ModuleKey;\r\n  critical?: boolean;\r\n};\r\n\r\nexport const permissionMeta: Record<string, PermissionMeta> = {\r\n  view_dashboard_summary: {\r\n    label: \"ড্যাশবোর্ড দেখা\",\r\n    module: \"dashboard\",\r\n  },\r\n  view_shops: { label: \"দোকান দেখা\", module: \"shops\" },\r\n  create_shop: { label: \"দোকান তৈরি\", module: \"shops\" },\r\n  update_shop: { label: \"দোকান সম্পাদনা\", module: \"shops\" },\r\n  delete_shop: { label: \"দোকান মুছে ফেলা\", module: \"shops\", critical: true },\r\n  switch_shop: { label: \"শপ সুইচ\", module: \"shops\" },\r\n  view_products: { label: \"পণ্য দেখা\", module: \"products\" },\n  create_product: { label: \"পণ্য তৈরি\", module: \"products\" },\n  update_product: { label: \"পণ্য সম্পাদনা\", module: \"products\" },\n  delete_product: { label: \"পণ্য মুছে ফেলা\", module: \"products\", critical: true },\n  update_product_stock: { label: \"স্টক আপডেট\", module: \"products\" },\n  update_product_price: { label: \"মূল্য আপডেট\", module: \"products\" },\n  manage_product_status: { label: \"পণ্যের স্ট্যাটাস টগল\", module: \"products\" },\n  import_products: { label: \"পণ্য ইম্পোর্ট\", module: \"products\" },\n  view_purchases: { label: \"ক্রয় দেখা\", module: \"purchases\" },\n  create_purchase: { label: \"নতুন ক্রয় যোগ\", module: \"purchases\" },\n  view_suppliers: { label: \"সরবরাহকারী দেখা\", module: \"suppliers\" },\n  create_supplier: { label: \"সরবরাহকারী যোগ\", module: \"suppliers\" },\n  create_purchase_payment: { label: \"ক্রয় পরিশোধ\", module: \"suppliers\" },\n  view_sales: { label: \"বিক্রি দেখা\", module: \"sales\" },\r\n  view_sale_details: { label: \"বিক্রি ডিটেইলস\", module: \"sales\" },\r\n  create_sale: { label: \"নতুন বিক্রি\", module: \"sales\" },\r\n  update_sale: { label: \"বিক্রি সম্পাদনা\", module: \"sales\" },\r\n  cancel_sale: { label: \"বিক্রি বাতিল\", module: \"sales\", critical: true },\r\n  create_due_sale: { label: \"ধার বিক্রি\", module: \"sales\" },\r\n  take_due_payment_from_sale: { label: \"বিক্রি থেকে বকেয়া গ্রহণ\", module: \"sales\" },\r\n  view_customers: { label: \"কাস্টমার দেখা\", module: \"customers\" },\r\n  create_customer: { label: \"কাস্টমার তৈরি\", module: \"customers\" },\r\n  update_customer: { label: \"কাস্টমার সম্পাদনা\", module: \"customers\" },\r\n  delete_customer: { label: \"কাস্টমার মুছে ফেলা\", module: \"customers\", critical: true },\r\n  view_due_summary: { label: \"বকেয়া সারাংশ\", module: \"customers\" },\r\n  view_customer_due: { label: \"কাস্টমারের বকেয়া দেখা\", module: \"customers\" },\r\n  create_due_entry: { label: \"বকেয়া এন্ট্রি\", module: \"customers\" },\r\n  take_due_payment: { label: \"বকেয়া পরিশোধ গ্রহণ\", module: \"customers\" },\r\n  writeoff_due: { label: \"বকেয়া রাইট-অফ\", module: \"customers\", critical: true },\r\n  view_expenses: { label: \"খরচ দেখা\", module: \"expenses\" },\r\n  create_expense: { label: \"খরচ যোগ\", module: \"expenses\" },\r\n  update_expense: { label: \"খরচ সম্পাদনা\", module: \"expenses\" },\r\n  delete_expense: { label: \"খরচ মুছে ফেলা\", module: \"expenses\", critical: true },\r\n  view_cashbook: { label: \"ক্যাশবুক দেখা\", module: \"cash\" },\r\n  create_cash_entry: { label: \"ক্যাশ এন্ট্রি\", module: \"cash\" },\r\n  update_cash_entry: { label: \"ক্যাশ এন্ট্রি সম্পাদনা\", module: \"cash\" },\r\n  delete_cash_entry: { label: \"ক্যাশ এন্ট্রি মুছে ফেলা\", module: \"cash\", critical: true },\r\n  adjust_cash_balance: { label: \"ক্যাশ ব্যালেন্স অ্যাডজাস্ট\", module: \"cash\", critical: true },\r\n  view_reports: { label: \"রিপোর্ট দেখা\", module: \"reports\" },\r\n  view_sales_report: { label: \"বিক্রি রিপোর্ট\", module: \"reports\" },\r\n  view_expense_report: { label: \"খরচ রিপোর্ট\", module: \"reports\" },\r\n  view_cashbook_report: { label: \"ক্যাশবুক রিপোর্ট\", module: \"reports\" },\r\n  view_profit_report: { label: \"লাভ-ক্ষতি রিপোর্ট\", module: \"reports\" },\r\n  view_payment_method_report: { label: \"পেমেন্ট মেথড রিপোর্ট\", module: \"reports\" },\r\n  view_top_products_report: { label: \"বেস্টসেলার রিপোর্ট\", module: \"reports\" },\r\n  view_low_stock_report: { label: \"লো স্টক রিপোর্ট\", module: \"reports\" },\r\n  export_reports: { label: \"রিপোর্ট এক্সপোর্ট\", module: \"reports\" },\r\n  view_users: { label: \"ব্যবহারকারী দেখা\", module: \"users\" },\r\n  create_user: { label: \"ব্যবহারকারী তৈরি\", module: \"users\" },\r\n  update_user: { label: \"ব্যবহারকারী সম্পাদনা\", module: \"users\" },\r\n  delete_user: { label: \"ব্যবহারকারী মুছে ফেলা\", module: \"users\", critical: true },\r\n  view_roles: { label: \"রোল দেখা\", module: \"roles\" },\r\n  create_role: { label: \"রোল তৈরি\", module: \"roles\" },\r\n  update_role: { label: \"রোল আপডেট\", module: \"roles\" },\r\n  delete_role: { label: \"রোল মুছে ফেলা\", module: \"roles\", critical: true },\r\n  assign_role_to_user: { label: \"রোল অ্যাসাইন\", module: \"roles\" },\r\n  revoke_role_from_user: { label: \"রোল রিভোক\", module: \"roles\" },\r\n  view_users_under_me: { label: \"সাব-ইউজার দেখা\", module: \"users\" },\r\n  create_user_agent: { label: \"এজেন্ট তৈরি\", module: \"users\" },\r\n  create_user_owner: { label: \"ওনার তৈরি\", module: \"users\" },\r\n  create_user_staff: { label: \"স্টাফ তৈরি\", module: \"users\" },\r\n  edit_users_under_me: { label: \"সাব-ইউজার সম্পাদনা\", module: \"users\" },\r\n  delete_users_under_me: { label: \"সাব-ইউজার মুছে ফেলা\", module: \"users\", critical: true },\r\n  access_rbac_admin: { label: \"RBAC অ্যাডমিন অ্যাক্সেস\", module: \"roles\", critical: true },\r\n  view_settings: { label: \"সেটিংস দেখা\", module: \"settings\" },\r\n  update_settings: { label: \"সেটিংস আপডেট\", module: \"settings\" },\r\n  use_offline_pos: { label: \"অফলাইন POS ব্যবহার\", module: \"offline\" },\r\n  sync_offline_data: { label: \"সিঙ্ক অফলাইন ডেটা\", module: \"offline\" },\r\n};\r\n\r\nexport function RolesPermissionsPanel({\r\n  roles,\r\n  permissions,\r\n}: RolesPermissionsPanelProps) {\r\n  const online = useOnlineStatus();\r\n  const [selectedRoleId, setSelectedRoleId] = useState<string | null>(\r\n    roles[0]?.id ?? null,\r\n  );\r\n  const [saving, startSaving] = useTransition();\r\n  const [query, setQuery] = useState(\"\");\r\n  const [filterMode, setFilterMode] = useState<\"all\" | \"on\" | \"off\">(\"all\");\r\n  const [localAssignments, setLocalAssignments] = useState<\r\n    Record<string, Set<string>>\r\n  >(() => {\r\n    const initial: Record<string, Set<string>> = {};\r\n    for (const role of roles) {\r\n      initial[role.id] = new Set(role.rolePermissions.map((rp) => rp.permissionId));\r\n    }\r\n    return initial;\r\n  });\r\n\r\n  const selectedRole = useMemo(\r\n    () => roles.find((r) => r.id === selectedRoleId) ?? null,\r\n    [roles, selectedRoleId],\r\n  );\r\n\r\n  const selectedPermissionIds = useMemo(() => {\r\n    if (!selectedRole) return new Set<string>();\r\n    return localAssignments[selectedRole.id] ?? new Set<string>();\r\n  }, [selectedRole, localAssignments]);\r\n\r\n  const isStaffRole = selectedRole?.name === \"staff\";\r\n\r\n  const staffBaselineIds = useMemo(() => {\r\n    if (!selectedRole || selectedRole.name !== \"staff\") {\r\n      return new Set<string>();\r\n    }\r\n    const baselineSet = new Set(STAFF_BASELINE_PERMISSIONS);\r\n    const ids = permissions\r\n      .filter((permission) => baselineSet.has(permission.name))\r\n      .map((permission) => permission.id);\r\n    return new Set(ids);\r\n  }, [selectedRole, permissions]);\r\n\r\n  useEffect(() => {\r\n    if (!selectedRole || selectedRole.name !== \"staff\") return;\r\n    if (staffBaselineIds.size === 0) return;\r\n    setLocalAssignments((prev) => {\r\n      const current = new Set(prev[selectedRole.id] ?? []);\r\n      let changed = false;\r\n      staffBaselineIds.forEach((id) => {\r\n        if (!current.has(id)) {\r\n          current.add(id);\r\n          changed = true;\r\n        }\r\n      });\r\n      return changed ? { ...prev, [selectedRole.id]: current } : prev;\r\n    });\r\n  }, [selectedRole, staffBaselineIds]);\r\n\r\n  const groupedPermissions = useMemo(() => {\r\n    const modulesMap = new Map<\r\n      ModuleKey,\r\n      {\r\n        key: ModuleKey;\r\n        label: string;\r\n        items: Array<Permission & { meta: PermissionMeta }>;\r\n      }\r\n    >();\r\n\r\n    const normalizedQuery = query.trim().toLowerCase();\r\n\r\n    const matchesFilters = (p: Permission, meta: PermissionMeta) => {\r\n      const checked = selectedPermissionIds.has(p.id);\r\n      if (filterMode === \"on\" && !checked) return false;\r\n      if (filterMode === \"off\" && checked) return false;\r\n\r\n      if (!normalizedQuery) return true;\r\n      return (\r\n        p.name.toLowerCase().includes(normalizedQuery) ||\r\n        (p.description?.toLowerCase().includes(normalizedQuery) ?? false) ||\r\n        meta.label.toLowerCase().includes(normalizedQuery) ||\r\n        moduleLabels[meta.module].toLowerCase().includes(normalizedQuery)\r\n      );\r\n    };\r\n\r\n    permissions.forEach((p) => {\r\n      const meta: PermissionMeta =\r\n        permissionMeta[p.name] ?? {\r\n          label: p.name,\r\n          module: \"other\" as ModuleKey,\r\n        };\r\n      if (!matchesFilters(p, meta)) return;\r\n\r\n      const key = meta.module;\r\n      const existing = modulesMap.get(key) ?? {\r\n        key,\r\n        label: moduleLabels[key] ?? moduleLabels.other,\r\n        items: [],\r\n      };\r\n      existing.items.push({ ...p, meta });\r\n      modulesMap.set(key, existing);\r\n    });\r\n\r\n    return Array.from(modulesMap.values()).sort((a, b) =>\r\n      a.label.localeCompare(b.label, \"bn\"),\r\n    );\r\n  }, [permissions, query, filterMode, selectedPermissionIds]);\r\n\r\n  const togglePermission = (permissionId: string) => {\r\n    if (!selectedRole) return;\r\n    if (isStaffRole && staffBaselineIds.has(permissionId)) return;\r\n    setLocalAssignments((prev) => {\r\n      const current = new Set(prev[selectedRole.id] ?? []);\r\n      if (current.has(permissionId)) {\r\n        current.delete(permissionId);\r\n      } else {\r\n        current.add(permissionId);\r\n      }\r\n      return { ...prev, [selectedRole.id]: current };\r\n    });\r\n  };\r\n\r\n  const bulkSet = (ids: string[], enabled: boolean) => {\r\n    if (!selectedRole || ids.length === 0) return;\r\n    setLocalAssignments((prev) => {\r\n      const current = new Set(prev[selectedRole.id] ?? []);\r\n      ids.forEach((id) => {\r\n        if (!enabled && isStaffRole && staffBaselineIds.has(id)) return;\r\n        if (enabled) current.add(id);\r\n        else current.delete(id);\r\n      });\r\n      return { ...prev, [selectedRole.id]: current };\r\n    });\r\n  };\r\n\r\n  const handleSave = () => {\r\n    if (!selectedRole) return;\r\n    const ids = isStaffRole\r\n      ? Array.from(new Set([...selectedPermissionIds, ...staffBaselineIds]))\r\n      : Array.from(selectedPermissionIds);\r\n    startSaving(async () => {\r\n      if (!online) {\r\n        await queueAdminAction(\"rbac_update_role_permissions\", {\n          roleId: selectedRole.id,\n          permissionIds: ids,\n        });\n        try {\n          const raw = safeLocalStorageGet(\"admin:rbac\");\n          if (raw) {\n            const parsed = JSON.parse(raw) as {\n              roles?: RoleWithPermissions[];\n              users?: any[];\n              roleOptions?: any[];\n              permissions?: any[];\n            };\n            if (Array.isArray(parsed.roles)) {\n              parsed.roles = parsed.roles.map((role) =>\n                role.id === selectedRole.id\n                  ? {\n                      ...role,\n                      rolePermissions: ids.map((permissionId) => ({ permissionId })),\n                    }\n                  : role,\n              );\n              safeLocalStorageSet(\"admin:rbac\", JSON.stringify(parsed));\n            }\n          }\n        } catch {\n          // ignore cache errors\r\n        }\r\n        alert(\"Offline: permission changes queued.\");\r\n        return;\r\n      }\r\n      await updateRolePermissions(selectedRole.id, ids);\r\n    });\r\n  };\r\n\r\n  return (\r\n    <div className=\"bg-card rounded-2xl border border-border shadow-sm p-5 space-y-4\">\r\n      <div className=\"flex items-center justify-between\">\r\n        <div className=\"space-y-0.5\">\r\n          <div className=\"inline-flex items-center gap-1.5 text-xs font-semibold text-muted-foreground bg-muted px-2.5 py-1 rounded-full\">\r\n            🛡️ Roles & Permissions\r\n          </div>\r\n          <h2 className=\"text-lg font-semibold text-foreground\">রোলের পারমিশন</h2>\r\n          <p className=\"text-[12px] text-muted-foreground\">\r\n            মডিউল অনুযায়ী পারমিশন সাজানো। রোল সিলেক্ট করুন, খুঁজে টিক/আনটিক করুন। সেভ করলে সঙ্গে সঙ্গে প্রয়োগ হবে।\r\n          </p>\r\n        </div>\r\n        <span className=\"text-xs font-semibold text-muted-foreground bg-muted border border-border rounded-lg px-3 py-1.5\">\r\n          {roles.length} roles\r\n        </span>\r\n      </div>\r\n\r\n      <div className=\"grid grid-cols-1 sm:grid-cols-5 gap-4 text-xs sm:text-sm\">\r\n        {/* Roles list */}\r\n        <div className=\"sm:col-span-2 border border-border rounded-xl overflow-hidden max-h-[480px] overflow-y-auto shadow-inner\">\r\n          <div className=\"bg-muted px-3 py-2 border-b border-border text-[11px] font-semibold text-muted-foreground uppercase tracking-wide\">\r\n            Role\r\n          </div>\r\n          <div className=\"divide-y divide-border\">\r\n            {roles.map((r) => {\r\n              const isActive = r.id === selectedRoleId;\r\n              const enabledCount = localAssignments[r.id]?.size ?? 0;\r\n              return (\r\n                <button\r\n                  type=\"button\"\r\n                  key={r.id}\r\n                  onClick={() => setSelectedRoleId(r.id)}\r\n                  className={`w-full text-left px-3 py-2.5 transition-colors flex items-start justify-between gap-3 ${\r\n                    isActive\r\n                      ? \"bg-success-soft border-l-4 border-success/50\"\r\n                      : \"hover:bg-muted\"\r\n                  }`}\r\n                >\r\n                  <div>\r\n                    <div className=\"font-semibold text-foreground text-xs sm:text-sm\">\r\n                      {r.name}\r\n                    </div>\r\n                    {r.description ? (\r\n                      <div className=\"text-[11px] text-muted-foreground\">{r.description}</div>\r\n                    ) : null}\r\n                  </div>\r\n                  <span className=\"text-[11px] font-semibold text-muted-foreground bg-muted rounded-full px-2 py-0.5\">\r\n                    {enabledCount}\r\n                  </span>\r\n                </button>\r\n              );\r\n            })}\r\n          </div>\r\n        </div>\r\n\r\n        {/* Permissions for selected role */}\r\n        <div className=\"sm:col-span-3 border border-border rounded-xl overflow-hidden max-h-[480px] flex flex-col shadow-inner\">\r\n          {selectedRole ? (\r\n            <>\r\n              <div className=\"flex flex-wrap items-center gap-3 px-3 py-3 border-b bg-muted\">\r\n                <div className=\"text-[12px] font-semibold text-foreground flex-1\">\r\n                  Permissions for: <span className=\"font-mono\">{selectedRole.name}</span>\r\n                </div>\r\n                <div className=\"flex items-center gap-2\">\r\n                  <input\r\n                    type=\"search\"\r\n                    value={query}\r\n                    onChange={(e) => setQuery(e.target.value)}\r\n                    placeholder=\"পারমিশন সার্চ করুন\"\r\n                    className=\"w-44 md:w-56 lg:w-64 rounded-lg border border-border bg-card px-3 py-1.5 text-xs text-foreground focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n                  />\r\n                  <div className=\"flex items-center gap-1 rounded-lg border border-border bg-card p-1\">\r\n                    {([\"all\", \"on\", \"off\"] as const).map((mode) => (\r\n                      <button\r\n                        key={mode}\r\n                        type=\"button\"\r\n                        onClick={() => setFilterMode(mode)}\r\n                        className={`px-2.5 py-1 text-[11px] font-semibold rounded-md border ${\r\n                          filterMode === mode\r\n                            ? \"bg-primary-soft text-primary border-primary/30\"\r\n                            : \"text-muted-foreground border-transparent hover:bg-muted\"\r\n                        }`}\r\n                      >\r\n                        {mode === \"all\"\r\n                          ? \"সকল\"\r\n                          : mode === \"on\"\r\n                          ? \"শুধু চালু\"\r\n                          : \"শুধু বন্ধ\"}\r\n                      </button>\r\n                    ))}\r\n                  </div>\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={handleSave}\r\n                    disabled={saving}\r\n                    className=\"inline-flex items-center rounded-lg bg-primary-soft text-primary border border-primary/30 px-3.5 py-1.5 text-[12px] font-semibold shadow-sm hover:bg-primary/15 hover:border-primary/40 disabled:opacity-60 disabled:cursor-not-allowed\"\r\n                  >\r\n                    {saving ? \"Saving...\" : \"Save\"}\r\n                  </button>\r\n                </div>\r\n              </div>\r\n\r\n              {isStaffRole ? (\r\n                <div className=\"px-3 py-2 text-[11px] text-warning bg-warning-soft border-b border-warning/30\">\r\n                  স্টাফ রোলে কিছু বেসলাইন অনুমতি বাধ্যতামূলক — এগুলো বন্ধ করা যাবে না।\r\n                </div>\r\n              ) : null}\r\n\r\n              <div className=\"divide-y divide-border overflow-y-auto\">\r\n                {groupedPermissions.length === 0 ? (\r\n                  <div className=\"p-4 text-xs text-muted-foreground\">\r\n                    সার্চ / ফিল্টার মিলে কোনো পারমিশন পাওয়া যায়নি।\r\n                  </div>\r\n                ) : (\r\n                  groupedPermissions.map((module) => {\r\n                    const total = module.items.length;\r\n                    const enabled = module.items.filter((p) =>\r\n                      selectedPermissionIds.has(p.id),\r\n                    ).length;\r\n                    const ids = module.items.map((p) => p.id);\r\n                    return (\r\n                      <div key={module.key} className=\"px-3 py-2.5\">\r\n                        <div className=\"flex items-center justify-between gap-3\">\r\n                          <div className=\"flex items-center gap-2\">\r\n                            <div className=\"text-sm font-semibold text-foreground\">\r\n                              {module.label}\r\n                            </div>\r\n                            <span className=\"text-[11px] text-muted-foreground\">\r\n                              {enabled}/{total}\r\n                            </span>\r\n                          </div>\r\n                          <div className=\"flex items-center gap-2 text-[11px]\">\r\n                            <button\r\n                              type=\"button\"\r\n                              onClick={() => bulkSet(ids, true)}\r\n                              className=\"px-2 py-1 rounded-md border border-border text-foreground hover:bg-muted\"\r\n                            >\r\n                              Select all\r\n                            </button>\r\n                            <button\r\n                              type=\"button\"\r\n                              onClick={() => bulkSet(ids, false)}\r\n                              className=\"px-2 py-1 rounded-md border border-border text-foreground hover:bg-muted\"\r\n                            >\r\n                              Clear\r\n                            </button>\r\n                          </div>\r\n                        </div>\r\n\r\n                        <div className=\"mt-2 grid grid-cols-1 gap-1\">\r\n                          {module.items.map((p) => {\r\n                            const checked = selectedPermissionIds.has(p.id);\r\n                            const locked = isStaffRole && staffBaselineIds.has(p.id);\r\n                            return (\r\n                              <label\r\n                                key={p.id}\r\n                                className={`flex items-start gap-3 px-2 py-1.5 rounded-lg ${\r\n                                  locked ? \"opacity-80\" : \"hover:bg-muted cursor-pointer\"\r\n                                }`}\r\n                              >\r\n                                <input\r\n                                  type=\"checkbox\"\r\n                                  className=\"mt-0.5 h-4 w-4 rounded border-border text-primary focus:ring-primary/30\"\r\n                                  checked={checked}\r\n                                  onChange={() => togglePermission(p.id)}\r\n                                  disabled={locked}\r\n                                />\r\n                                <div className=\"flex-1\">\r\n                                  <div className=\"flex items-center gap-2\">\r\n                                    <span className=\"text-sm font-semibold text-foreground\">\r\n                                      {p.meta.label}\r\n                                    </span>\r\n                                    <span className=\"text-[11px] font-mono text-muted-foreground\">\r\n                                      {p.name}\r\n                                    </span>\r\n                                    {p.meta.critical ? (\r\n                                      <span className=\"text-[10px] font-semibold text-warning bg-warning-soft border border-warning/30 rounded-full px-2 py-0.5\">\r\n                                        Critical\r\n                                      </span>\r\n                                    ) : null}\r\n                                    {locked ? (\r\n                                      <span className=\"text-[10px] font-semibold text-primary bg-primary-soft border border-primary/30 rounded-full px-2 py-0.5\">\r\n                                        বেসলাইন\r\n                                      </span>\r\n                                    ) : null}\r\n                                  </div>\r\n                                  {p.description || p.meta.description ? (\r\n                                    <div className=\"text-[11px] text-muted-foreground\">\r\n                                      {p.description || p.meta.description}\r\n                                    </div>\r\n                                  ) : null}\r\n                                </div>\r\n                              </label>\r\n                            );\r\n                          })}\r\n                        </div>\r\n                      </div>\r\n                    );\r\n                  })\r\n                )}\r\n              </div>\r\n            </>\r\n          ) : (\r\n            <div className=\"p-4 text-xs text-muted-foreground\">Select a role to manage its permissions.</div>\r\n          )}\r\n        </div>\r\n      </div>\r\n\r\n      <p className=\"text-[11px] text-muted-foreground\">\r\n        নোট: সুপার অ্যাডমিন সবসময় সব পারমিশন রাখবে—এখানে পরিবর্তন হলেও তার ওপর প্রভাব ফেলবে না।\r\n      </p>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\admin\\rbac\\UsersRolesPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\admin\\rbac\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\admin\\user-creation-log\\UserCreationLogClient.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\admin\\user-creation-log\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\cash\\ShopSelectorClient.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\cash\\[id]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\cash\\components\\CashDeleteButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\cash\\components\\CashListClient.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\cash\\new\\CashFormClient.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\pos\\pos-app-supabase\\app\\dashboard\\cash\\new\\CashFormClient.tsx:114:5\n  112 |         ? (window as any).SpeechRecognition || (window as any).webkitSpeechRecognition\n  113 |         : null;\n> 114 |     setVoiceReady(Boolean(SpeechRecognitionImpl));\n      |     ^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  115 |     return () => recognitionRef.current?.stop?.();\n  116 |   }, []);\n  117 |","line":114,"column":5,"nodeType":null,"endLine":114,"endColumn":18},{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\pos\\pos-app-supabase\\app\\dashboard\\cash\\new\\CashFormClient.tsx:123:9\n  121 |     if (stored) {\n  122 |       try {\n> 123 |         setTemplates(JSON.parse(stored) as CashTemplate[]);\n      |         ^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  124 |       } catch {\n  125 |         setTemplates([]);\n  126 |       }","line":123,"column":9,"nodeType":null,"endLine":123,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// app/dashboard/cash/new/CashFormClient.tsx\r\n\"use client\";\r\n\r\nimport { useEffect, useMemo, useRef, useState } from \"react\";\r\nimport { useOnlineStatus } from \"@/lib/sync/net-status\";\nimport { db } from \"@/lib/dexie/db\";\nimport { queueAdd } from \"@/lib/sync/queue\";\nimport useRealTimeReports from \"@/hooks/useRealTimeReports\";\nimport { emitCashUpdate } from \"@/lib/events/reportEvents\";\nimport { safeLocalStorageGet, safeLocalStorageSet } from \"@/lib/storage\";\nimport Link from \"next/link\";\n\r\ntype SpeechRecognitionInstance = {\r\n  lang: string;\r\n  interimResults: boolean;\r\n  continuous: boolean;\r\n  start: () => void;\r\n  stop: () => void;\r\n  abort?: () => void;\r\n  onresult: ((event: any) => void) | null;\r\n  onerror: ((event: any) => void) | null;\r\n  onend: (() => void) | null;\r\n};\r\n\r\ntype CashTemplate = {\r\n  entryType: \"IN\" | \"OUT\";\r\n  amount: string;\r\n  reason?: string;\r\n  count: number;\r\n  lastUsed: number;\r\n};\r\n\r\ntype Props = {\r\n  shopId: string;\r\n  backHref: string;\r\n  action: (formData: FormData) => Promise<void>;\r\n  id?: string;\r\n  title?: string;\r\n  subtitle?: string;\r\n  shopName?: string | null;\r\n  initialValues?: {\r\n    entryType?: \"IN\" | \"OUT\";\r\n    amount?: string;\r\n    reason?: string;\r\n  };\r\n  submitLabel?: string;\r\n};\r\n\r\nconst TEMPLATE_LIMIT = 40;\r\n\r\nfunction mergeTemplates(existing: CashTemplate[], incoming: CashTemplate) {\r\n  const idx = existing.findIndex(\r\n    (t) => t.entryType === incoming.entryType && t.reason === incoming.reason\r\n  );\r\n  const next = [...existing];\r\n  if (idx >= 0) {\r\n    const current = next[idx];\r\n    next[idx] = {\r\n      ...current,\r\n      amount: incoming.amount || current.amount,\r\n      reason: incoming.reason || current.reason,\r\n      count: current.count + 1,\r\n      lastUsed: incoming.lastUsed,\r\n    };\r\n  } else {\r\n    next.unshift(incoming);\r\n  }\r\n  return next\r\n    .sort((a, b) => b.count - a.count || b.lastUsed - a.lastUsed)\r\n    .slice(0, TEMPLATE_LIMIT);\r\n}\r\n\r\nfunction dedupe(values: string[]) {\r\n  return Array.from(new Set(values.filter(Boolean)));\r\n}\r\n\r\nfunction parseAmount(text: string) {\r\n  const match = text.match(/(\\d+(?:[.,]\\d+)?)/);\r\n  return match ? match[1].replace(\",\", \"\") : \"\";\r\n}\r\n\r\nexport default function CashFormClient({\r\n  shopId,\r\n  backHref,\r\n  action,\r\n  id,\r\n  title,\r\n  subtitle,\r\n  shopName,\r\n  initialValues,\r\n  submitLabel = \"+ দ্রুত ক্যাশ এন্ট্রি করুন\",\r\n}: Props) {\r\n  // World-Class Real-time Reports Integration\r\n  const realTimeReports = useRealTimeReports(shopId);\r\n  \r\n  const online = useOnlineStatus();\r\n  const recognitionRef = useRef<SpeechRecognitionInstance | null>(null);\r\n  const [listeningField, setListeningField] = useState<\"amount\" | \"reason\" | null>(null);\r\n  const [voiceReady, setVoiceReady] = useState(false);\r\n  const [voiceError, setVoiceError] = useState<string | null>(null);\r\n\r\n  const storageKey = useMemo(() => `cashTemplates:${shopId}`, [shopId]);\r\n  const [templates, setTemplates] = useState<CashTemplate[]>([]);\r\n\r\n  const [entryType, setEntryType] = useState<\"IN\" | \"OUT\">(initialValues?.entryType || \"IN\");\r\n  const [amount, setAmount] = useState(initialValues?.amount || \"\");\r\n  const [reason, setReason] = useState(initialValues?.reason || \"\");\r\n\r\n  useEffect(() => {\r\n    const SpeechRecognitionImpl =\r\n      typeof window !== \"undefined\"\r\n        ? (window as any).SpeechRecognition || (window as any).webkitSpeechRecognition\r\n        : null;\r\n    setVoiceReady(Boolean(SpeechRecognitionImpl));\r\n    return () => recognitionRef.current?.stop?.();\r\n  }, []);\r\n\r\n  useEffect(() => {\n    if (!storageKey) return;\n    const stored = safeLocalStorageGet(storageKey);\n    if (stored) {\n      try {\n        setTemplates(JSON.parse(stored) as CashTemplate[]);\n      } catch {\n        setTemplates([]);\r\n      }\r\n    }\r\n  }, [storageKey]);\r\n\r\n  const frequentTemplates = useMemo(\r\n    () => templates.slice().sort((a, b) => b.count - a.count || b.lastUsed - a.lastUsed),\r\n    [templates]\r\n  );\r\n\r\n  const recentTemplates = useMemo(\r\n    () => templates.slice().sort((a, b) => b.lastUsed - a.lastUsed),\r\n    [templates]\r\n  );\r\n\r\n  const reasonOptions = useMemo(\r\n    () =>\r\n      dedupe([\r\n        ...frequentTemplates.map((t) => t.reason || \"\"),\r\n        ...recentTemplates.map((t) => t.reason || \"\"),\r\n        \"বিক্রয়\",\r\n        \"ক্যাশ আনা\",\r\n        \"ক্যাশ নেওয়া\",\r\n        \"পে\",\r\n        \"রিকশা\",\r\n      ]),\r\n    [frequentTemplates, recentTemplates]\r\n  );\r\n\r\n  const amountOptions = useMemo(\r\n    () => dedupe(recentTemplates.map((t) => t.amount).concat(frequentTemplates.map((t) => t.amount))),\r\n    [recentTemplates, frequentTemplates]\r\n  );\r\n\r\n  const headerTitle = title || (id ? \"ক্যাশ এন্ট্রি সম্পাদনা\" : \"নতুন ক্যাশ এন্ট্রি\");\r\n  const headerSubtitle =\r\n    subtitle ||\r\n    (id\r\n      ? \"ভয়েস ও টেমপ্লেট দিয়ে দ্রুত পরিবর্তন করুন\"\r\n      : \"ভয়েস + স্মার্ট টেমপ্লেট দিয়ে দ্রুত এন্ট্রি করুন\");\r\n  const shopLabel = shopName?.trim() || \"\";\r\n  const voiceErrorText = voiceError ? `(${voiceError})` : \"\";\r\n  const isListeningAmount = listeningField === \"amount\";\r\n  const isListeningReason = listeningField === \"reason\";\r\n  const amountVoiceHint = isListeningAmount\r\n    ? \"শুনছি... পরিমাণ বলুন\"\r\n    : voiceReady\r\n    ? \"ভয়েসে বললে অটো পূরণ হবে\"\r\n    : \"এই ডিভাইসে ভয়েস সাপোর্ট নেই\";\r\n  const reasonVoiceHint = isListeningReason\r\n    ? \"শুনছি... কারণ বলুন\"\r\n    : voiceReady\r\n    ? \"ভয়েসে কারণ বলুন\"\r\n    : \"এই ডিভাইসে ভয়েস সাপোর্ট নেই\";\r\n\r\n  function persistTemplates(next: CashTemplate[]) {\n    setTemplates(next);\n    safeLocalStorageSet(storageKey, JSON.stringify(next));\n  }\n\r\n  function applyTemplate(t: CashTemplate) {\r\n    setEntryType(t.entryType);\r\n    setAmount(t.amount);\r\n    setReason(t.reason || \"\");\r\n  }\r\n\r\n  function startVoice(field: \"amount\" | \"reason\") {\r\n    if (listeningField === field) return;\r\n    if (listeningField) stopVoice();\r\n    const SpeechRecognitionImpl =\r\n      typeof window !== \"undefined\"\r\n        ? ((window as any).SpeechRecognition ||\r\n            (window as any).webkitSpeechRecognition)\r\n        : null;\r\n\r\n    if (!SpeechRecognitionImpl) {\r\n      setVoiceReady(false);\r\n      setVoiceError(\"ব্রাউজার মাইক্রোফোন সমর্থন দিচ্ছে না\");\r\n      return;\r\n    }\r\n\r\n    const recognition: SpeechRecognitionInstance = new SpeechRecognitionImpl();\r\n    recognition.lang = \"bn-BD\";\r\n    recognition.interimResults = false;\r\n    recognition.continuous = false;\r\n    recognition.onerror = () => {\r\n      setListeningField(null);\r\n      setVoiceError(\"মাইক্রোফোন অ্যাক্সেস পাওয়া যায়নি\");\r\n    };\r\n    recognition.onend = () => setListeningField(null);\r\n    recognition.onresult = (event: any) => {\r\n      const spoken: string | undefined = event?.results?.[0]?.[0]?.transcript;\r\n      if (spoken) {\r\n        if (field === \"amount\") {\r\n          const parsed = parseAmount(spoken);\r\n          if (parsed) setAmount(parsed);\r\n          const leftover = parsed ? spoken.replace(parsed, \"\").trim() : spoken;\r\n          if (leftover && !reason) setReason(leftover);\r\n        } else {\r\n          setReason((prev) => (prev ? `${prev} ${spoken}` : spoken));\r\n          const parsed = parseAmount(spoken);\r\n          if (parsed && !amount) setAmount(parsed);\r\n        }\r\n      }\r\n      setListeningField(null);\r\n    };\r\n\r\n    recognitionRef.current = recognition;\r\n    setVoiceError(null);\r\n    setListeningField(field);\r\n    recognition.start();\r\n  }\r\n\r\n  function stopVoice() {\r\n    recognitionRef.current?.stop?.();\r\n    setListeningField(null);\r\n  }\r\n\r\n  async function handleSubmit(e: React.FormEvent<HTMLFormElement>) {\r\n    e.preventDefault();\r\n    const form = new FormData(e.currentTarget);\r\n\r\n    form.set(\"entryType\", (form.get(\"entryType\") as string) || entryType);\r\n    form.set(\"amount\", (form.get(\"amount\") as string) || amount);\r\n    form.set(\"reason\", (form.get(\"reason\") as string) || reason);\r\n\r\n    const cashAmount = parseFloat((form.get(\"amount\") as string) || \"0\");\r\n    const cashEntryType = (form.get(\"entryType\") as \"IN\" | \"OUT\") || \"IN\";\r\n\r\n    if (!initialValues) {\r\n      const template: CashTemplate = {\r\n        entryType: cashEntryType,\r\n        amount: (form.get(\"amount\") as string) || \"0\",\r\n        reason: (form.get(\"reason\") as string) || \"\",\r\n        count: 1,\r\n        lastUsed: Date.now(),\r\n      };\r\n      persistTemplates(mergeTemplates(templates, template));\r\n    }\r\n\r\n    // World-Class Real-time Update: Instant optimistic update\r\n    const updateId = realTimeReports.updateCashReport(\r\n      cashAmount,\r\n      cashEntryType === \"IN\" ? \"cash-in\" : \"cash-out\",\r\n      {\r\n        cashEntryId: id || crypto.randomUUID(),\r\n        timestamp: Date.now()\r\n      }\r\n    );\r\n    \r\n    // Emit real-time event\r\n    emitCashUpdate(shopId, {\r\n      type: cashEntryType === \"IN\" ? \"cash-in\" : \"cash-out\",\r\n      operation: 'add',\r\n      amount: cashAmount,\r\n      shopId,\r\n      metadata: {\r\n        cashEntryId: id || crypto.randomUUID(),\r\n        timestamp: Date.now()\r\n      }\r\n    }, {\r\n      source: 'ui',\r\n      priority: 'high',\r\n      correlationId: updateId\r\n    });\r\n\r\n    if (online) {\r\n      try {\r\n        await action(form);\r\n        // Background sync for consistency\r\n        setTimeout(() => {\r\n          realTimeReports.syncWithServer(updateId);\r\n        }, 500);\r\n      } catch (error) {\r\n        // Rollback on error\r\n        realTimeReports.rollbackLastUpdate();\r\n        console.error('Cash entry creation failed:', error);\r\n      }\r\n      return;\r\n    }\r\n\r\n    const isEdit = Boolean(id);\r\n    const entryId = id || crypto.randomUUID();\r\n    const payload = {\n      id: entryId,\n      shopId,\n      entryType: cashEntryType,\n      amount: form.get(\"amount\") as string,\n      reason: (form.get(\"reason\") as string) || \"\",\n      createdAt: Date.now(),\n      updatedAt: Date.now(),\n      syncStatus: isEdit ? \"updated\" as const : \"new\" as const,\n    };\n\r\n    await db.transaction(\"rw\", db.cash, db.queue, async () => {\n      await db.cash.put(payload as any);\n      await queueAdd(\"cash\", isEdit ? \"update\" : \"create\", payload);\n    });\n    alert(\r\n      isEdit\r\n        ? \"Offline: ক্যাশ এন্ট্রি আপডেট কিউ হয়েছে, সংযোগ পেলে সিঙ্ক হবে।\"\r\n        : \"Offline: ক্যাশ এন্ট্রি সংরক্ষিত, সংযোগ পেলে সিঙ্ক হবে।\"\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-4\">\r\n      <div className=\"relative overflow-hidden rounded-2xl border border-border bg-card shadow-[0_16px_36px_rgba(15,23,42,0.08)] animate-fade-in\">\r\n        <div className=\"pointer-events-none absolute inset-0 bg-gradient-to-br from-primary-soft/60 via-card to-card\" />\r\n        <div className=\"pointer-events-none absolute -top-16 right-0 h-40 w-40 rounded-full bg-success/20 blur-3xl\" />\r\n        <div className=\"relative space-y-3 p-4\">\r\n          <div className=\"min-w-0 space-y-1\">\r\n            <p className=\"text-[11px] uppercase tracking-[0.22em] text-muted-foreground\">\r\n              ক্যাশ\r\n            </p>\r\n            <h1 className=\"text-2xl font-bold text-foreground leading-tight tracking-tight sm:text-3xl\">\r\n              {headerTitle}\r\n            </h1>\r\n            <p className=\"text-sm text-muted-foreground\">{headerSubtitle}</p>\r\n            {shopLabel ? (\r\n              <p className=\"text-xs text-muted-foreground flex items-center gap-1 min-w-0\">\r\n                দোকান:\r\n                <span className=\"truncate font-semibold text-foreground\">\r\n                  {shopLabel}\r\n                </span>\r\n              </p>\r\n            ) : null}\r\n          </div>\r\n          <div className=\"flex flex-wrap items-center gap-2 text-xs\">\r\n            <span className=\"inline-flex h-7 items-center gap-1 rounded-full bg-card/80 px-3 font-semibold text-foreground border border-border shadow-[0_1px_0_rgba(0,0,0,0.03)]\">\r\n              ভয়েস ইনপুট\r\n            </span>\r\n            <span className=\"inline-flex h-7 items-center gap-1 rounded-full bg-card/80 px-3 font-semibold text-muted-foreground border border-border\">\r\n              টেমপ্লেট\r\n            </span>\r\n            <span\r\n              className={`inline-flex h-7 items-center gap-1 rounded-full px-3 font-semibold border ${\r\n                online\r\n                  ? \"bg-success-soft text-success border-success/30\"\r\n                  : \"bg-danger-soft text-danger border-danger/30\"\r\n              }`}\r\n            >\r\n              {online ? \"অনলাইন\" : \"অফলাইন\"}\r\n            </span>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      <form onSubmit={handleSubmit} className=\"space-y-4\">\r\n        {/* Entry Type */}\r\n        <div className=\"rounded-2xl border border-border bg-card p-4 shadow-sm space-y-2\">\r\n          <div className=\"flex items-center justify-between gap-2\">\r\n            <label className=\"block text-base font-medium text-foreground\">\r\n              ক্যাশ টাইপ *\r\n            </label>\r\n            <span className=\"text-xs text-muted-foreground\">ইন/আউট</span>\r\n          </div>\r\n          <div className=\"grid grid-cols-2 gap-2\">\r\n            <button\r\n              type=\"button\"\r\n              onClick={() => setEntryType(\"IN\")}\r\n              className={`h-11 rounded-full border px-4 text-sm font-semibold transition ${\r\n                entryType === \"IN\"\r\n                  ? \"bg-success-soft border-success/30 text-success shadow-sm\"\r\n                  : \"bg-card border-border text-foreground hover:border-success/40\"\r\n              }`}\r\n            >\r\n              + ক্যাশ ইন\r\n            </button>\r\n            <button\r\n              type=\"button\"\r\n              onClick={() => setEntryType(\"OUT\")}\r\n              className={`h-11 rounded-full border px-4 text-sm font-semibold transition ${\r\n                entryType === \"OUT\"\r\n                  ? \"bg-danger-soft border-danger/30 text-danger shadow-sm\"\r\n                  : \"bg-card border-border text-foreground hover:border-danger/40\"\r\n              }`}\r\n            >\r\n              - ক্যাশ আউট\r\n            </button>\r\n          </div>\r\n          <input type=\"hidden\" name=\"entryType\" value={entryType} />\r\n          <p className=\"text-xs text-muted-foreground\">\r\n            সর্বশেষ ব্যবহৃত টাইপ নির্বাচিত থাকে\r\n          </p>\r\n        </div>\r\n\r\n        {/* Amount */}\r\n        <div className=\"rounded-2xl border border-border bg-card p-4 shadow-sm space-y-2\">\r\n          <div className=\"flex items-center justify-between gap-2\">\r\n            <label className=\"block text-base font-medium text-foreground\">\r\n              পরিমাণ (৳) *\r\n            </label>\r\n            <span className=\"text-xs text-muted-foreground\">ভয়েস/সাজেশন</span>\r\n          </div>\r\n          <div className=\"relative\">\r\n            <input\r\n              name=\"amount\"\r\n              type=\"number\"\r\n              step=\"0.01\"\r\n              min=\"0\"\r\n              value={amount}\r\n              onChange={(e) => setAmount(e.target.value)}\r\n              className=\"w-full h-12 border border-border rounded-xl px-4 pr-16 text-base bg-card shadow-sm focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n              placeholder=\"যেমন: 500, 1000.50\"\r\n              required\r\n            />\r\n            <button\r\n              type=\"button\"\r\n              onClick={isListeningAmount ? stopVoice : () => startVoice(\"amount\")}\r\n              disabled={!voiceReady}\r\n              aria-label={isListeningAmount ? \"ভয়েস বন্ধ করুন\" : \"ভয়েস ইনপুট চালু করুন\"}\r\n              className={`absolute right-2 top-1/2 -translate-y-1/2 inline-flex h-9 items-center justify-center rounded-lg border px-3 text-sm font-semibold transition ${\r\n                isListeningAmount\r\n                  ? \"bg-primary-soft text-primary border-primary/40 animate-pulse\"\r\n                  : \"bg-primary-soft text-primary border-primary/30 active:scale-95\"\r\n              } ${!voiceReady ? \"opacity-60 cursor-not-allowed\" : \"\"}`}\r\n            >\r\n              {isListeningAmount ? \"🔴\" : \"🎤\"}\r\n            </button>\r\n          </div>\r\n          <p className=\"text-xs text-muted-foreground\">\r\n            {amountVoiceHint}{\" \"}\r\n            {voiceErrorText ? (\r\n              <span className=\"text-danger\">{voiceErrorText}</span>\r\n            ) : null}\r\n          </p>\r\n          {amountOptions.length > 0 && (\r\n            <div className=\"flex flex-wrap gap-2\">\r\n              {amountOptions.slice(0, 6).map((a) => (\r\n                <button\r\n                  key={a}\r\n                  type=\"button\"\r\n                  onClick={() => setAmount(a)}\r\n                  className=\"h-9 px-3 rounded-full border border-primary/30 bg-primary-soft/80 text-primary text-xs font-semibold hover:border-primary/50\"\r\n                >\r\n                  ৳ {a}\r\n                </button>\r\n              ))}\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        {/* Reason */}\r\n        <div className=\"rounded-2xl border border-border bg-card p-4 shadow-sm space-y-2\">\r\n          <label className=\"block text-base font-medium text-foreground\">\r\n            কারণ (ঐচ্ছিক)\r\n          </label>\r\n          <div className=\"relative\">\r\n            <input\r\n              name=\"reason\"\r\n              value={reason}\r\n              onChange={(e) => setReason(e.target.value)}\r\n              className=\"w-full h-12 border border-border rounded-xl px-4 pr-16 text-base bg-card shadow-sm focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n              placeholder=\"যেমন: বিক্রয় টাকা, মালিককে ক্যাশ\"\r\n            />\r\n            <button\r\n              type=\"button\"\r\n              onClick={isListeningReason ? stopVoice : () => startVoice(\"reason\")}\r\n              disabled={!voiceReady}\r\n              aria-label={isListeningReason ? \"ভয়েস বন্ধ করুন\" : \"ভয়েস ইনপুট চালু করুন\"}\r\n              className={`absolute right-2 top-1/2 -translate-y-1/2 inline-flex h-9 items-center justify-center rounded-lg border px-3 text-sm font-semibold transition ${\r\n                isListeningReason\r\n                  ? \"bg-primary-soft text-primary border-primary/40 animate-pulse\"\r\n                  : \"bg-primary-soft text-primary border-primary/30 active:scale-95\"\r\n              } ${!voiceReady ? \"opacity-60 cursor-not-allowed\" : \"\"}`}\r\n            >\r\n              {isListeningReason ? \"🔴\" : \"🎤\"}\r\n            </button>\r\n          </div>\r\n          <p className=\"text-xs text-muted-foreground\">\r\n            {reasonVoiceHint}{\" \"}\r\n            {voiceErrorText ? (\r\n              <span className=\"text-danger\">{voiceErrorText}</span>\r\n            ) : null}\r\n          </p>\r\n          <div className=\"flex flex-wrap gap-2\">\r\n            {reasonOptions.slice(0, 6).map((r) => (\r\n              <button\r\n                key={r}\r\n                type=\"button\"\r\n                onClick={() => setReason(r)}\r\n                className=\"h-9 px-3 rounded-full border border-border bg-card text-xs font-semibold text-foreground hover:border-primary/30\"\r\n              >\r\n                {r}\r\n              </button>\r\n            ))}\r\n          </div>\r\n          <p className=\"text-xs text-muted-foreground\">\r\n            বেশি ব্যবহৃত কারণগুলো এক ট্যাপে পাওয়া যাবে\r\n          </p>\r\n        </div>\r\n\r\n        {/* Recent templates */}\r\n        {recentTemplates.length > 0 && (\r\n          <div className=\"rounded-2xl border border-border bg-card p-4 shadow-sm space-y-2\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <h3 className=\"text-base font-semibold text-foreground\">\r\n                রিসেন্ট ক্যাশ\r\n              </h3>\r\n              <span className=\"text-xs text-muted-foreground\">\r\n                এক ট্যাপে অটো-ফিল\r\n              </span>\r\n            </div>\r\n            <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-2\">\r\n              {recentTemplates.slice(0, 4).map((t) => {\r\n                const isIn = t.entryType === \"IN\";\r\n                return (\r\n                  <button\r\n                    key={`${t.entryType}-${t.amount}-${t.lastUsed}`}\r\n                    type=\"button\"\r\n                    onClick={() => applyTemplate(t)}\r\n                    className=\"flex items-center justify-between gap-3 bg-card border border-border rounded-xl px-3 py-2 text-left shadow-sm hover:border-primary/40 transition-colors\"\r\n                  >\r\n                    <div>\r\n                      <p\r\n                        className={`text-xs font-semibold ${\r\n                          isIn ? \"text-success\" : \"text-danger\"\r\n                        }`}\r\n                      >\r\n                        {isIn ? \"ক্যাশ ইন\" : \"ক্যাশ আউট\"}\r\n                      </p>\r\n                      <p className=\"text-sm font-semibold text-foreground\">\r\n                        {t.reason || \"কারণ নেই\"}\r\n                      </p>\r\n                    </div>\r\n                    <span className=\"text-sm font-bold text-primary\">\r\n                      ৳ {t.amount}\r\n                    </span>\r\n                  </button>\r\n                );\r\n              })}\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {/* Buttons */}\r\n        <div className=\"rounded-2xl border border-border bg-card p-4 shadow-sm space-y-3\">\r\n          <div className=\"flex flex-col gap-3 sm:flex-row\">\r\n            <button\r\n              type=\"submit\"\r\n              className=\"flex-1 h-14 sm:h-12 rounded-xl bg-gradient-to-r from-primary to-primary-hover text-primary-foreground border border-primary/40 text-base font-semibold shadow-[0_12px_22px_rgba(22,163,74,0.28)] transition hover:brightness-105 active:scale-[0.99] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/40\"\r\n            >\r\n              {submitLabel}\r\n            </button>\r\n            <Link\r\n              href={backHref}\r\n              className=\"flex-1 h-14 sm:h-12 rounded-xl border border-border text-foreground text-base font-semibold hover:bg-muted transition text-center flex items-center justify-center\"\r\n            >\r\n              পিছনে যান\r\n            </Link>\r\n          </div>\r\n        </div>\r\n      </form>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\cash\\new\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\cash\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\due\\DuePageClient.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'refreshData' function makes the dependencies of useEffect Hook (at line 626) change on every render. To fix this, wrap the definition of 'refreshData' in its own useCallback() Hook.","line":444,"column":3,"nodeType":"FunctionDeclaration","endLine":474,"endColumn":4},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'refreshData' function makes the dependencies of useEffect Hook (at line 648) change on every render. To fix this, wrap the definition of 'refreshData' in its own useCallback() Hook.","line":444,"column":3,"nodeType":"FunctionDeclaration","endLine":474,"endColumn":4},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'statement' logical expression could make the dependencies of useMemo Hook (at line 880) change on every render. Move it inside the useMemo callback. Alternatively, wrap the initialization of 'statement' in its own useMemo() Hook.","line":559,"column":9,"nodeType":"VariableDeclarator","endLine":559,"endColumn":46}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'selectedCustomerId'. Either include it or remove the dependency array.","line":442,"column":6,"nodeType":"ArrayExpression","endLine":442,"endColumn":17,"suggestions":[{"desc":"Update the dependencies array to be: [customers, selectedCustomerId]","fix":{"range":[12416,12427],"text":"[customers, selectedCustomerId]"}}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'refreshData', 'refreshStatement', and 'selectedCustomerId'. Either include them or remove the dependency array.","line":582,"column":6,"nodeType":"ArrayExpression","endLine":582,"endColumn":49,"suggestions":[{"desc":"Update the dependencies array to be: [online, lastSyncAt, syncing, pendingCount, refreshData, selectedCustomerId, refreshStatement]","fix":{"range":[16621,16664],"text":"[online, lastSyncAt, syncing, pendingCount, refreshData, selectedCustomerId, refreshStatement]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// app/dashboard/due/DuePageClient.tsx\r\n\r\n\"use client\";\r\n\r\nimport {\r\n  FormEvent,\r\n  useCallback,\r\n  useEffect,\r\n  useMemo,\r\n  useRef,\r\n  useState,\r\n} from \"react\";\r\nimport { useQuery, useQueryClient } from \"@tanstack/react-query\";\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\";\r\nimport { useOnlineStatus } from \"@/lib/sync/net-status\";\nimport { useSyncStatus } from \"@/lib/sync/sync-status\";\nimport { queueAdd } from \"@/lib/sync/queue\";\nimport { handlePermissionError } from \"@/lib/permission-toast\";\nimport { useRealtimeStatus } from \"@/lib/realtime/status\";\nimport { usePageVisibility } from \"@/lib/use-page-visibility\";\nimport {\n  emitDueCustomersEvent,\n  subscribeDueCustomersEvent,\n} from \"@/lib/due/customer-events\";\nimport { safeLocalStorageGet, safeLocalStorageSet } from \"@/lib/storage\";\nimport {\n  db,\n  type LocalDueCustomer,\n  type LocalDueLedger,\n} from \"@/lib/dexie/db\";\n\r\ntype Customer = {\r\n  id: string;\r\n  name: string;\r\n  phone?: string | null;\r\n  address?: string | null;\r\n  totalDue: string | number;\r\n  lastPaymentAt?: string | null;\r\n};\r\n\r\ntype Summary = {\r\n  totalDue: number;\r\n  topDue: {\r\n    id: string;\r\n    name: string;\r\n    totalDue: number;\r\n    phone?: string | null;\r\n  }[];\r\n};\r\n\r\ntype StatementRow = {\r\n  id: string;\r\n  entryType: \"SALE\" | \"PAYMENT\";\r\n  amount: string | number;\r\n  description?: string | null;\r\n  entryDate: string;\r\n};\r\n\r\ntype SpeechRecognitionInstance = {\r\n  lang: string;\r\n  interimResults: boolean;\r\n  continuous: boolean;\r\n  start: () => void;\r\n  stop: () => void;\r\n  abort?: () => void;\r\n  onresult: ((event: any) => void) | null;\r\n  onerror: ((event: any) => void) | null;\r\n  onend: (() => void) | null;\r\n};\r\n\r\ntype CustomerTemplate = {\r\n  name: string;\r\n  phone?: string;\r\n  address?: string;\r\n  count: number;\r\n  lastUsed: number;\r\n};\r\n\r\ntype PaymentTemplate = {\r\n  customerId?: string;\r\n  amount: string;\r\n  description?: string;\r\n  count: number;\r\n  lastUsed: number;\r\n};\r\n\r\ntype VoiceField =\r\n  | \"customerName\"\r\n  | \"customerPhone\"\r\n  | \"customerAddress\"\r\n  | \"paymentAmount\"\r\n  | \"paymentDescription\";\r\n\r\nfunction toNumber(value: string | number | null | undefined) {\r\n  if (value === null || value === undefined) return 0;\r\n  const num = Number(value);\r\n  return Number.isFinite(num) ? num : 0;\r\n}\r\n\r\nfunction normalizeEntryDate(value: string | number | Date | undefined) {\r\n  if (!value) return new Date().toISOString();\r\n  const parsed = new Date(value);\r\n  return Number.isFinite(parsed.getTime())\r\n    ? parsed.toISOString()\r\n    : new Date().toISOString();\r\n}\r\n\r\nfunction computeSummary(customers: Customer[]): Summary {\r\n  const totalDue = customers.reduce((sum, c) => sum + toNumber(c.totalDue), 0);\r\n  const topDue = [...customers]\r\n    .sort((a, b) => toNumber(b.totalDue) - toNumber(a.totalDue))\r\n    .slice(0, 5)\r\n    .map((c) => ({\r\n      id: c.id,\r\n      name: c.name,\r\n      totalDue: toNumber(c.totalDue),\r\n      phone: c.phone ?? null,\r\n    }));\r\n  return { totalDue, topDue };\r\n}\r\n\r\nfunction toLocalDueCustomer(\r\n  customer: Customer,\r\n  shopId: string,\r\n  now: number\r\n): LocalDueCustomer {\r\n  return {\r\n    id: customer.id,\r\n    shopId,\r\n    name: customer.name,\r\n    phone: customer.phone ?? null,\r\n    address: customer.address ?? null,\r\n    totalDue: toNumber(customer.totalDue),\r\n    lastPaymentAt: customer.lastPaymentAt ?? null,\r\n    updatedAt: now,\r\n    syncStatus: \"synced\",\r\n  };\r\n}\r\n\r\nfunction fromLocalDueCustomer(row: LocalDueCustomer): Customer {\r\n  return {\r\n    id: row.id,\r\n    name: row.name,\r\n    phone: row.phone ?? null,\r\n    address: row.address ?? null,\r\n    totalDue: row.totalDue ?? 0,\r\n    lastPaymentAt: row.lastPaymentAt ?? null,\r\n  };\r\n}\r\n\r\nfunction toLocalDueLedger(\r\n  row: StatementRow,\r\n  shopId: string,\r\n  customerId: string\r\n): LocalDueLedger {\r\n  return {\r\n    id: row.id,\r\n    shopId,\r\n    customerId,\r\n    entryType: row.entryType,\r\n    amount: row.amount,\r\n    description: row.description ?? null,\r\n    entryDate: normalizeEntryDate(row.entryDate),\r\n    syncStatus: \"synced\",\r\n  };\r\n}\r\n\r\nfunction fromLocalDueLedger(row: LocalDueLedger): StatementRow {\r\n  return {\r\n    id: row.id,\r\n    entryType: row.entryType,\r\n    amount: row.amount,\r\n    description: row.description ?? null,\r\n    entryDate: normalizeEntryDate(row.entryDate),\r\n  };\r\n}\r\n\r\ntype Props = {\r\n  shopId: string;\r\n  shopName: string;\r\n  initialCustomers: Customer[];\r\n};\r\n\r\nexport default function DuePageClient({\r\n  shopId,\r\n  shopName,\r\n  initialCustomers,\r\n}: Props) {\r\n  const online = useOnlineStatus();\n  const realtime = useRealtimeStatus();\n  const isVisible = usePageVisibility();\n  const queryClient = useQueryClient();\n  const { pendingCount, syncing, lastSyncAt } = useSyncStatus();\n  const recognitionRef = useRef<SpeechRecognitionInstance | null>(null);\n  const refreshInFlightRef = useRef(false);\n  const lastRefreshAtRef = useRef(0);\n  const REFRESH_MIN_INTERVAL_MS = 2_000;\n  const lastEventAtRef = useRef(0);\n  const wasVisibleRef = useRef(isVisible);\n  const pollIntervalMs = realtime.connected ? 60_000 : 10_000;\n  const pollingEnabled = !realtime.connected;\n  const EVENT_DEBOUNCE_MS = 800;\n  const [voiceReady, setVoiceReady] = useState(false);\r\n  const [listeningField, setListeningField] = useState<VoiceField | null>(null);\r\n  const [voiceError, setVoiceError] = useState<string | null>(null);\r\n  const [mounted, setMounted] = useState(false);\r\n\r\n  const customerTemplateKey = useMemo(\r\n    () => `due:customerTemplates:${shopId}`,\r\n    [shopId]\r\n  );\r\n  const paymentTemplateKey = useMemo(\r\n    () => `due:paymentTemplates:${shopId}`,\r\n    [shopId]\r\n  );\r\n\r\n  const [activeTab, setActiveTab] = useState<\r\n    \"summary\" | \"add\" | \"payment\" | \"list\"\r\n  >(\"summary\");\r\n  const [customers, setCustomers] = useState<Customer[]>(\r\n    initialCustomers || []\r\n  );\r\n  const summary = useMemo(() => computeSummary(customers), [customers]);\r\n  const [selectedCustomerId, setSelectedCustomerId] = useState<string>(\"\");\r\n  const [savingPayment, setSavingPayment] = useState(false);\r\n  const [newCustomer, setNewCustomer] = useState({\r\n    name: \"\",\r\n    phone: \"\",\r\n    address: \"\",\r\n  });\r\n  const [paymentForm, setPaymentForm] = useState({\r\n    customerId: \"\",\r\n    amount: \"\",\r\n    description: \"\",\r\n  });\r\n  const [customerTemplates, setCustomerTemplates] = useState<\r\n    CustomerTemplate[]\r\n  >([]);\r\n  const [paymentTemplates, setPaymentTemplates] = useState<PaymentTemplate[]>(\r\n    []\r\n  );\r\n\r\n  function parseAmount(text: string) {\r\n    const match = text.match(/(\\d+(?:[.,]\\d+)?)/);\r\n    return match ? match[1].replace(\",\", \"\") : \"\";\r\n  }\r\n\r\n  function parsePhone(text: string) {\r\n    const digits = text.replace(/\\D/g, \"\");\r\n    return digits ? digits.slice(0, 15) : \"\";\r\n  }\r\n\r\n  function dedupe(values: string[]) {\r\n    return Array.from(new Set(values.filter(Boolean)));\r\n  }\r\n\r\n  const loadCustomersFromDexie = useCallback(async () => {\r\n    try {\r\n      const rows = await db.dueCustomers\r\n        .where(\"shopId\")\r\n        .equals(shopId)\r\n        .toArray();\r\n      const mapped = rows\r\n        .map(fromLocalDueCustomer)\r\n        .sort((a, b) => toNumber(b.totalDue) - toNumber(a.totalDue));\r\n      setCustomers(mapped);\r\n      return mapped;\r\n    } catch (err) {\r\n      handlePermissionError(err);\r\n      console.error(\"Load offline due customers failed\", err);\r\n      setCustomers([]);\r\n      return [];\r\n    }\r\n  }, [shopId]);\r\n\r\n  const seedCustomersToDexie = useCallback(async (nextCustomers: Customer[]) => {\r\n    const now = Date.now();\r\n    const rows = (nextCustomers || []).map((customer) =>\r\n      toLocalDueCustomer(customer, shopId, now)\r\n    );\r\n    await db.transaction(\"rw\", db.dueCustomers, async () => {\r\n      await db.dueCustomers\r\n        .where(\"shopId\")\r\n        .equals(shopId)\r\n        .and((row) => row.syncStatus === \"synced\")\r\n        .delete();\r\n      if (rows.length > 0) {\r\n        await db.dueCustomers.bulkPut(rows);\r\n      }\r\n    });\r\n  }, [shopId]);\r\n\r\n  const customerQueryKey = useMemo(() => [\"due\", \"customers\", shopId], [shopId]);\r\n\r\n  const fetchCustomers = useCallback(async () => {\n    const res = await fetch(`/api/due/customers?shopId=${shopId}`);\n    if (res.status === 304) {\n      return loadCustomersFromDexie();\n    }\n    if (!res.ok) {\n      throw new Error(\"Due customers fetch failed\");\n    }\n    const json = await res.json();\n    return Array.isArray(json?.data) ? json.data : [];\n  }, [shopId, loadCustomersFromDexie]);\n\r\n  const customersQuery = useQuery({\r\n    queryKey: customerQueryKey,\r\n    queryFn: fetchCustomers,\r\n    enabled: online,\r\n    staleTime: 15_000,\r\n    initialData: () => initialCustomers ?? [],\r\n    placeholderData: (prev) => prev ?? [],\r\n  });\r\n\r\n  // Seed Dexie when online; always read from Dexie as source of truth.\r\n  useEffect(() => {\r\n    const run = async () => {\r\n      if (online) {\r\n        try {\r\n          await seedCustomersToDexie(customersQuery.data ?? initialCustomers ?? []);\r\n        } catch (err) {\r\n          handlePermissionError(err);\r\n          console.error(\"Seed Dexie due customers failed\", err);\r\n        }\r\n      }\r\n      await loadCustomersFromDexie();\r\n    };\r\n    run();\r\n  }, [\r\n    online,\r\n    initialCustomers,\r\n    customersQuery.data,\r\n    loadCustomersFromDexie,\r\n    seedCustomersToDexie,\r\n  ]);\r\n\r\n  function mergeCustomerTemplates(\r\n    existing: CustomerTemplate[],\r\n    incoming: CustomerTemplate\r\n  ) {\r\n    const idx = existing.findIndex(\r\n      (t) => t.name.toLowerCase() === incoming.name.toLowerCase()\r\n    );\r\n    const next = [...existing];\r\n    if (idx >= 0) {\r\n      const current = next[idx];\r\n      next[idx] = {\r\n        ...current,\r\n        phone: incoming.phone || current.phone,\r\n        address: incoming.address || current.address,\r\n        count: current.count + 1,\r\n        lastUsed: incoming.lastUsed,\r\n      };\r\n    } else {\r\n      next.unshift(incoming);\r\n    }\r\n    return next\r\n      .sort((a, b) => b.count - a.count || b.lastUsed - a.lastUsed)\r\n      .slice(0, 50);\r\n  }\r\n\r\n  function mergePaymentTemplates(\r\n    existing: PaymentTemplate[],\r\n    incoming: PaymentTemplate\r\n  ) {\r\n    const keyMatch = (t: PaymentTemplate) =>\r\n      (t.customerId || \"\") === (incoming.customerId || \"\") &&\r\n      (t.description || \"\") === (incoming.description || \"\");\r\n    const idx = existing.findIndex(keyMatch);\r\n    const next = [...existing];\r\n    if (idx >= 0) {\r\n      const current = next[idx];\r\n      next[idx] = {\r\n        ...current,\r\n        amount: incoming.amount || current.amount,\r\n        description: incoming.description || current.description,\r\n        customerId: incoming.customerId || current.customerId,\r\n        count: current.count + 1,\r\n        lastUsed: incoming.lastUsed,\r\n      };\r\n    } else {\r\n      next.unshift(incoming);\r\n    }\r\n    return next\r\n      .sort((a, b) => b.count - a.count || b.lastUsed - a.lastUsed)\r\n      .slice(0, 50);\r\n  }\r\n\r\n  useEffect(() => {\r\n    const SpeechRecognitionImpl =\r\n      typeof window !== \"undefined\"\r\n        ? (window as any).SpeechRecognition ||\r\n          (window as any).webkitSpeechRecognition\r\n        : null;\r\n    setVoiceReady(Boolean(SpeechRecognitionImpl));\r\n    return () => recognitionRef.current?.stop?.();\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    setMounted(true);\r\n  }, []);\r\n\r\n  useEffect(() => {\n    const storedCustomers = safeLocalStorageGet(customerTemplateKey);\n    if (storedCustomers) {\n      try {\n        setCustomerTemplates(JSON.parse(storedCustomers) as CustomerTemplate[]);\n      } catch {\n        setCustomerTemplates([]);\n      }\n    }\n    const storedPayments = safeLocalStorageGet(paymentTemplateKey);\n    if (storedPayments) {\n      try {\n        setPaymentTemplates(JSON.parse(storedPayments) as PaymentTemplate[]);\n      } catch {\n        setPaymentTemplates([]);\n      }\r\n    }\r\n  }, [customerTemplateKey, paymentTemplateKey]);\r\n\r\n  // Reset client state when shop changes to avoid leaking data across shops.\r\n  useEffect(() => {\n    setSelectedCustomerId(\"\");\n    setPaymentForm({ customerId: \"\", amount: \"\", description: \"\" });\n    loadCustomersFromDexie();\n  }, [shopId, loadCustomersFromDexie]);\n\r\n  useEffect(() => {\r\n    if (!selectedCustomerId && customers.length > 0) {\r\n      setSelectedCustomerId(customers[0].id);\r\n      setPaymentForm((prev) => ({ ...prev, customerId: customers[0].id }));\r\n    }\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [customers]);\r\n\r\n  async function refreshData(options?: {\r\n    force?: boolean;\r\n    source?: \"refresh\" | \"create\" | \"payment\" | \"sync\" | \"local\";\r\n  }) {\r\n    if (refreshInFlightRef.current) return;\r\n    const now = Date.now();\r\n    if (!options?.force && now - lastRefreshAtRef.current < REFRESH_MIN_INTERVAL_MS) {\r\n      return;\r\n    }\r\n    refreshInFlightRef.current = true;\r\n    lastRefreshAtRef.current = now;\r\n    try {\r\n      if (online) {\n        await queryClient.invalidateQueries({\n          queryKey: customerQueryKey,\n          refetchType: \"active\",\n        });\n      }\n      await loadCustomersFromDexie();\r\n      emitDueCustomersEvent({\r\n        shopId,\r\n        at: Date.now(),\r\n        source: options?.source ?? \"refresh\",\r\n      });\r\n    } catch (err) {\r\n      handlePermissionError(err);\r\n      console.error(\"Refresh due customers request failed\", err);\r\n    } finally {\r\n      refreshInFlightRef.current = false;\r\n    }\r\n  }\r\n\r\n  const readStatementFromDexie = useCallback(\r\n    async (customerId: string) => {\r\n      const localRows = await db.dueLedger\r\n        .where(\"[shopId+customerId]\")\r\n        .equals([shopId, customerId])\r\n        .toArray();\r\n      return localRows\r\n        .map(fromLocalDueLedger)\r\n        .sort(\r\n          (a, b) =>\r\n            new Date(a.entryDate).getTime() -\r\n            new Date(b.entryDate).getTime()\r\n        );\r\n    },\r\n    [shopId]\r\n  );\r\n\r\n  const fetchStatement = useCallback(\r\n    async (customerId: string) => {\r\n      if (!customerId) return [];\r\n      try {\r\n        if (online) {\r\n          const res = await fetch(\r\n            `/api/due/statement?shopId=${shopId}&customerId=${customerId}`\r\n          );\r\n          if (res.ok) {\r\n            const json = await res.json();\r\n            const rows = Array.isArray(json?.data) ? json.data : [];\r\n            const mapped = rows.map((row: any) =>\r\n              toLocalDueLedger(\r\n                {\r\n                  id: row.id,\r\n                  entryType: row.entryType,\r\n                  amount: row.amount,\r\n                  description: row.description ?? null,\r\n                  entryDate: row.entryDate,\r\n                },\r\n                shopId,\r\n                customerId\r\n              )\r\n            );\r\n\r\n            await db.transaction(\"rw\", db.dueLedger, async () => {\r\n              await db.dueLedger\r\n                .where(\"[shopId+customerId]\")\r\n                .equals([shopId, customerId])\r\n                .and((row) => row.syncStatus === \"synced\")\r\n                .delete();\r\n              if (mapped.length > 0) {\r\n                await db.dueLedger.bulkPut(mapped);\r\n              }\r\n            });\r\n          }\r\n        }\r\n      } catch (err) {\r\n        handlePermissionError(err);\r\n        console.error(\"Load due statement failed\", err);\r\n      }\r\n\r\n      try {\r\n        return await readStatementFromDexie(customerId);\r\n      } catch (err) {\r\n        handlePermissionError(err);\r\n        console.error(\"Load due statement cache failed\", err);\r\n        return [];\r\n      }\r\n    },\r\n    [online, shopId, readStatementFromDexie]\r\n  );\r\n\r\n  const statementQueryKey = useMemo(\r\n    () => [\"due\", \"statement\", shopId, selectedCustomerId],\r\n    [shopId, selectedCustomerId]\r\n  );\r\n\r\n  const statementQuery = useQuery({\r\n    queryKey: statementQueryKey,\r\n    queryFn: () => fetchStatement(selectedCustomerId),\r\n    enabled: Boolean(selectedCustomerId),\r\n    staleTime: 15_000,\r\n    placeholderData: (prev) => prev ?? [],\r\n  });\r\n\r\n  const statement = statementQuery.data ?? [];\r\n  const loadingStatement = statementQuery.isFetching && online;\r\n  const refreshStatement = useCallback(\r\n    (customerId?: string) => {\r\n      if (!customerId) return;\r\n      queryClient.invalidateQueries({\r\n        queryKey: [\"due\", \"statement\", shopId, customerId],\r\n        refetchType: \"active\",\r\n      });\r\n    },\r\n    [queryClient, shopId]\r\n  );\r\n\r\n  useEffect(() => {\n    if (!online) return;\n    if (!lastSyncAt) return;\n    if (syncing) return;\n    if (pendingCount > 0) return;\n    refreshData({ source: \"sync\" });\n    if (selectedCustomerId) {\n      refreshStatement(selectedCustomerId);\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [online, lastSyncAt, syncing, pendingCount]);\n\n  useEffect(() => {\n    return subscribeDueCustomersEvent((detail) => {\n      if (detail.shopId !== shopId) return;\n      const now = detail.at ?? Date.now();\n      if (now - lastEventAtRef.current < EVENT_DEBOUNCE_MS) return;\n      lastEventAtRef.current = now;\n      loadCustomersFromDexie();\n      if (online) {\n        queryClient.invalidateQueries({\n          queryKey: customerQueryKey,\n          refetchType: \"active\",\n        });\n      }\n      if (selectedCustomerId) {\n        refreshStatement(selectedCustomerId);\n      }\n    });\n  }, [\n    shopId,\n    online,\n    loadCustomersFromDexie,\n    queryClient,\n    customerQueryKey,\n    selectedCustomerId,\n    refreshStatement,\n  ]);\n\n  useEffect(() => {\n    if (!online || !isVisible || !pollingEnabled) return;\n    const intervalId = setInterval(() => {\n      const now = Date.now();\n      if (now - lastEventAtRef.current < pollIntervalMs / 2) return;\n      if (refreshInFlightRef.current) return;\n      if (syncing || pendingCount > 0) return;\n      if (now - lastRefreshAtRef.current < REFRESH_MIN_INTERVAL_MS) return;\n      refreshData({ source: \"refresh\" });\n      if (selectedCustomerId) {\n        refreshStatement(selectedCustomerId);\n      }\n    }, pollIntervalMs);\n\n    return () => clearInterval(intervalId);\n  }, [\n    online,\n    isVisible,\n    pollingEnabled,\n    syncing,\n    pendingCount,\n    refreshData,\n    selectedCustomerId,\n    refreshStatement,\n    pollIntervalMs,\n  ]);\n\n  useEffect(() => {\n    if (!online) return;\n    if (wasVisibleRef.current === isVisible) return;\n    wasVisibleRef.current = isVisible;\n    if (!isVisible) return;\n    lastEventAtRef.current = Date.now();\n    refreshData({ force: true, source: \"refresh\" });\n    if (selectedCustomerId) {\n      refreshStatement(selectedCustomerId);\n    }\n  }, [online, isVisible, refreshData, selectedCustomerId, refreshStatement]);\n\r\n  async function handleAddCustomer(e: FormEvent) {\r\n    e.preventDefault();\r\n    if (!newCustomer.name.trim()) return;\n    if (!online) {\n      const now = Date.now();\n      const payload = {\n        id: crypto.randomUUID(),\n        shopId,\r\n        name: newCustomer.name.trim(),\r\n        phone: newCustomer.phone.trim() || null,\r\n        address: newCustomer.address.trim() || null,\r\n        totalDue: \"0\",\r\n        lastPaymentAt: null,\r\n        updatedAt: now,\n        syncStatus: \"new\" as const,\n      };\n      await db.transaction(\"rw\", db.dueCustomers, db.queue, async () => {\n        await db.dueCustomers.put(payload);\n        await queueAdd(\"due_customer\", \"create\", payload);\n      });\n      const template: CustomerTemplate = {\n        name: newCustomer.name.trim(),\n        phone: newCustomer.phone.trim() || undefined,\n        address: newCustomer.address.trim() || undefined,\n        count: 1,\n        lastUsed: Date.now(),\r\n      };\n      const merged = mergeCustomerTemplates(customerTemplates, template);\n      setCustomerTemplates(merged);\n      safeLocalStorageSet(customerTemplateKey, JSON.stringify(merged));\n      setNewCustomer({ name: \"\", phone: \"\", address: \"\" });\n      await loadCustomersFromDexie();\n      emitDueCustomersEvent({ shopId, at: Date.now(), source: \"local\" });\n      return;\n    }\n\r\n    await fetch(\"/api/due/customers\", {\r\n      method: \"POST\",\r\n      headers: { \"Content-Type\": \"application/json\" },\r\n      body: JSON.stringify({\r\n        shopId,\r\n        name: newCustomer.name.trim(),\r\n        phone: newCustomer.phone.trim() || undefined,\r\n        address: newCustomer.address.trim() || undefined,\r\n      }),\r\n    });\r\n\r\n    const template: CustomerTemplate = {\r\n      name: newCustomer.name.trim(),\r\n      phone: newCustomer.phone.trim() || undefined,\r\n      address: newCustomer.address.trim() || undefined,\r\n      count: 1,\r\n      lastUsed: Date.now(),\r\n    };\n    const merged = mergeCustomerTemplates(customerTemplates, template);\n    setCustomerTemplates(merged);\n    safeLocalStorageSet(customerTemplateKey, JSON.stringify(merged));\n\n    setNewCustomer({ name: \"\", phone: \"\", address: \"\" });\n    await refreshData({ force: true, source: \"create\" });\n  }\n\r\n  function persistPaymentTemplate(\r\n    customerId: string,\r\n    amount: string,\r\n    description: string\r\n  ) {\r\n    const template: PaymentTemplate = {\r\n      customerId,\r\n      amount: amount || \"0\",\r\n      description: description || \"\",\r\n      count: 1,\r\n      lastUsed: Date.now(),\r\n    };\n    const merged = mergePaymentTemplates(paymentTemplates, template);\n    setPaymentTemplates(merged);\n    safeLocalStorageSet(paymentTemplateKey, JSON.stringify(merged));\n  }\n\r\n\r\n  async function handlePayment(e: FormEvent) {\r\n    e.preventDefault();\r\n    if (!paymentForm.customerId || !paymentForm.amount) return;\r\n\r\n    const amountValue = Number(paymentForm.amount);\r\n    if (!Number.isFinite(amountValue) || amountValue <= 0) return;\r\n\r\n    setSavingPayment(true);\r\n    try {\r\n      if (!online) {\r\n        const nowIso = new Date().toISOString();\r\n        const nowTs = Date.now();\r\n        const entryId = crypto.randomUUID();\r\n        const description = paymentForm.description?.trim() || \"\";\r\n        const targetCustomer = customers.find(\r\n          (customer) => customer.id === paymentForm.customerId\r\n        );\r\n        const nextDue = Math.max(\r\n          0,\r\n          toNumber(targetCustomer?.totalDue) - amountValue\r\n        );\r\n        let nextCustomers = customers.map((customer) =>\r\n          customer.id === paymentForm.customerId\r\n            ? {\r\n                ...customer,\r\n                totalDue: nextDue,\r\n                lastPaymentAt: nowIso,\r\n              }\r\n            : customer\r\n        );\r\n        if (!targetCustomer) {\r\n          nextCustomers = nextCustomers.concat({\r\n            id: paymentForm.customerId,\r\n            name: \"Customer\",\r\n            phone: null,\r\n            address: null,\r\n            totalDue: nextDue,\r\n            lastPaymentAt: nowIso,\r\n          });\r\n        }\r\n        nextCustomers = nextCustomers.sort(\r\n          (a, b) => toNumber(b.totalDue) - toNumber(a.totalDue)\r\n        );\r\n        setCustomers(nextCustomers);\n\n        const ledgerEntry: LocalDueLedger = {\n          id: entryId,\n          shopId,\n          customerId: paymentForm.customerId,\r\n          entryType: \"PAYMENT\",\r\n          amount: amountValue,\r\n          description: description || null,\r\n          entryDate: nowIso,\n          syncStatus: \"new\",\n        };\n\n        await db.transaction(\n          \"rw\",\n          db.dueCustomers,\n          db.dueLedger,\n          db.queue,\n          async () => {\n          await db.dueLedger.put(ledgerEntry);\n          const existing = await db.dueCustomers.get(paymentForm.customerId);\n          if (existing) {\n            await db.dueCustomers.update(paymentForm.customerId, {\n              totalDue: nextDue,\n              lastPaymentAt: nowIso,\r\n              updatedAt: nowTs,\r\n              syncStatus: \"synced\",\r\n            });\r\n          } else {\r\n            const name = targetCustomer?.name || \"Customer\";\r\n            const phone = targetCustomer?.phone ?? null;\r\n            const address = targetCustomer?.address ?? null;\r\n            await db.dueCustomers.put({\r\n              id: paymentForm.customerId,\r\n              shopId,\r\n              name,\r\n              phone,\r\n              address,\r\n              totalDue: nextDue,\r\n              lastPaymentAt: nowIso,\r\n              updatedAt: nowTs,\r\n              syncStatus: \"synced\",\n            });\n          }\n          await queueAdd(\"due_payment\", \"payment\", {\n            shopId,\n            customerId: paymentForm.customerId,\n            amount: amountValue,\n            description: description || null,\n            createdAt: nowIso,\n            localId: entryId,\n          });\n        });\n\r\n        persistPaymentTemplate(\r\n          paymentForm.customerId,\r\n          paymentForm.amount,\r\n          paymentForm.description || \"\"\r\n        );\r\n\r\n        setPaymentForm({\r\n          customerId: paymentForm.customerId,\r\n          amount: \"\",\r\n          description: \"\",\r\n        });\r\n\r\n        refreshStatement(paymentForm.customerId);\r\n        alert(\"অফলাইন: পেমেন্ট সেভ হয়েছে, অনলাইনে গেলে সিঙ্ক হবে।\");\r\n        return;\r\n      }\r\n\r\n      await fetch(\"/api/due/payment\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({\r\n          shopId,\r\n          customerId: paymentForm.customerId,\r\n          amount: amountValue,\r\n          description: paymentForm.description || undefined,\r\n        }),\r\n      });\r\n\r\n      persistPaymentTemplate(\r\n        paymentForm.customerId,\r\n        paymentForm.amount,\r\n        paymentForm.description || \"\"\r\n      );\r\n\r\n      setPaymentForm({\r\n        customerId: paymentForm.customerId,\r\n        amount: \"\",\r\n        description: \"\",\r\n      });\r\n      await refreshData({ force: true, source: \"payment\" });\r\n      refreshStatement(paymentForm.customerId);\r\n    } finally {\r\n      setSavingPayment(false);\r\n    }\r\n  }\r\n\r\n  const statementWithBalance = useMemo(() => {\r\n    let balance = 0;\r\n    return statement.map((row) => {\r\n      const amt = Number(row.amount || 0);\r\n      balance += row.entryType === \"SALE\" ? amt : -amt;\r\n      return { ...row, running: balance };\r\n    });\r\n  }, [statement]);\r\n\r\n  const customerSuggestions = useMemo(() => {\r\n    const recent = customerTemplates.slice(0, 6).map((t) => t.name);\r\n    const topDue = summary.topDue?.slice(0, 4).map((c) => c.name) || [];\r\n    const existing = customers.slice(0, 6).map((c) => c.name);\r\n    return dedupe([...recent, ...topDue, ...existing]).slice(0, 8);\r\n  }, [customerTemplates, summary.topDue, customers]);\r\n\r\n  const amountSuggestions = useMemo(() => {\r\n    const fromTemplates = paymentTemplates.map((t) => t.amount);\r\n    return dedupe(fromTemplates).slice(0, 6);\r\n  }, [paymentTemplates]);\r\n\r\n  const voiceErrorText = voiceError ? `(${voiceError})` : \"\";\r\n  const isListeningName = listeningField === \"customerName\";\r\n  const isListeningPhone = listeningField === \"customerPhone\";\r\n  const isListeningAddress = listeningField === \"customerAddress\";\r\n  const isListeningPaymentAmount = listeningField === \"paymentAmount\";\r\n  const isListeningPaymentDescription = listeningField === \"paymentDescription\";\r\n\r\n  const nameVoiceHint = isListeningName\r\n    ? \"শুনছি... গ্রাহকের নাম বলুন\"\r\n    : voiceReady\r\n    ? \"ভয়েসে নাম বললে অটো পূরণ হবে\"\r\n    : \"এই ডিভাইসে ভয়েস সাপোর্ট নেই\";\r\n  const phoneVoiceHint = isListeningPhone\r\n    ? \"শুনছি... ফোন নম্বর বলুন\"\r\n    : voiceReady\r\n    ? \"ভয়েসে নম্বর বলুন\"\r\n    : \"এই ডিভাইসে ভয়েস সাপোর্ট নেই\";\r\n  const addressVoiceHint = isListeningAddress\r\n    ? \"শুনছি... ঠিকানা বলুন\"\r\n    : voiceReady\r\n    ? \"ভয়েসে ঠিকানা বলুন\"\r\n    : \"এই ডিভাইসে ভয়েস সাপোর্ট নেই\";\r\n  const paymentAmountVoiceHint = isListeningPaymentAmount\r\n    ? \"শুনছি... পরিমাণ বলুন\"\r\n    : voiceReady\r\n    ? \"ভয়েসে পরিমাণ বলুন\"\r\n    : \"এই ডিভাইসে ভয়েস সাপোর্ট নেই\";\r\n  const paymentDescriptionVoiceHint = isListeningPaymentDescription\r\n    ? \"শুনছি... বিবরণ বলুন\"\r\n    : voiceReady\r\n    ? \"ভয়েসে বিবরণ বলুন\"\r\n    : \"এই ডিভাইসে ভয়েস সাপোর্ট নেই\";\r\n\r\n  const latestPaymentLabel = useMemo(() => {\r\n    const timestamps = customers\r\n      .map((c) => (c.lastPaymentAt ? new Date(c.lastPaymentAt).getTime() : 0))\r\n      .filter((t) => t > 0);\r\n    if (timestamps.length === 0) return null;\r\n    const latest = Math.max(...timestamps);\r\n    return new Date(latest).toLocaleDateString(\"bn-BD\", {\r\n      day: \"numeric\",\r\n      month: \"short\",\r\n    });\r\n  }, [customers]);\r\n\r\n  const selectedCustomer = useMemo(() => {\r\n    const id = paymentForm.customerId || selectedCustomerId;\r\n    return customers.find((c) => c.id === id) || null;\r\n  }, [customers, paymentForm.customerId, selectedCustomerId]);\r\n\r\n  const selectedCustomerDue = selectedCustomer\r\n    ? Number(selectedCustomer.totalDue || 0)\r\n    : null;\r\n  const selectedCustomerDueLabel =\r\n    selectedCustomerDue !== null ? selectedCustomerDue.toFixed(2) : null;\r\n  const selectedCustomerHasDue = selectedCustomerDue !== null && selectedCustomerDue > 0;\r\n\r\n  const statementCustomer = useMemo(\r\n    () => customers.find((c) => c.id === selectedCustomerId) || null,\r\n    [customers, selectedCustomerId]\r\n  );\r\n\r\n  const lastSyncLabel =\r\n    mounted && lastSyncAt\r\n      ? new Date(lastSyncAt).toLocaleTimeString(\"bn-BD\", {\r\n          hour: \"numeric\",\r\n          minute: \"2-digit\",\r\n        })\r\n      : null;\r\n\r\n  const openStatementFor = (customerId: string) => {\r\n    setActiveTab(\"list\");\r\n    setSelectedCustomerId(customerId);\r\n  };\r\n\r\n  const openPaymentFor = (customerId: string) => {\r\n    setActiveTab(\"payment\");\r\n    setSelectedCustomerId(customerId);\r\n    setPaymentForm((prev) => ({ ...prev, customerId }));\r\n  };\r\n\r\n  function startVoice(field: VoiceField) {\r\n    if (listeningField === field) return;\r\n    if (listeningField) stopVoice();\r\n    const SpeechRecognitionImpl =\r\n      typeof window !== \"undefined\"\r\n        ? (window as any).SpeechRecognition ||\r\n          (window as any).webkitSpeechRecognition\r\n        : null;\r\n\r\n    if (!SpeechRecognitionImpl) {\r\n      setVoiceReady(false);\r\n      setVoiceError(\"ব্রাউজার মাইক্রোফোন সমর্থন দিচ্ছে না\");\r\n      return;\r\n    }\r\n\r\n    const recognition: SpeechRecognitionInstance = new SpeechRecognitionImpl();\r\n    recognition.lang = \"bn-BD\";\r\n    recognition.interimResults = false;\r\n    recognition.continuous = false;\r\n    recognition.onerror = () => {\r\n      setListeningField(null);\r\n      setVoiceError(\"মাইক্রোফোন অ্যাক্সেস পাওয়া যায়নি\");\r\n    };\r\n    recognition.onend = () => setListeningField(null);\r\n    recognition.onresult = (event: any) => {\r\n      const spoken: string | undefined = event?.results?.[0]?.[0]?.transcript;\r\n      if (spoken) {\r\n        if (field === \"customerName\") {\r\n          const phone = parsePhone(spoken);\r\n          const name = phone ? spoken.replace(phone, \"\").trim() : spoken;\r\n          setNewCustomer((p) => ({ ...p, name }));\r\n          if (phone && !newCustomer.phone)\r\n            setNewCustomer((p) => ({ ...p, phone }));\r\n        } else if (field === \"customerPhone\") {\r\n          const phone = parsePhone(spoken);\r\n          if (phone) setNewCustomer((p) => ({ ...p, phone }));\r\n        } else if (field === \"customerAddress\") {\r\n          setNewCustomer((p) => ({ ...p, address: spoken }));\r\n        } else if (field === \"paymentAmount\") {\r\n          const amt = parseAmount(spoken);\r\n          if (amt) setPaymentForm((p) => ({ ...p, amount: amt }));\r\n          const leftover = amt ? spoken.replace(amt, \"\").trim() : spoken;\r\n          if (leftover && !paymentForm.description) {\r\n            setPaymentForm((p) => ({ ...p, description: leftover }));\r\n          }\r\n        } else if (field === \"paymentDescription\") {\r\n          setPaymentForm((p) => ({\r\n            ...p,\r\n            description: p.description ? `${p.description} ${spoken}` : spoken,\r\n          }));\r\n          const amt = parseAmount(spoken);\r\n          if (amt && !paymentForm.amount)\r\n            setPaymentForm((p) => ({ ...p, amount: amt }));\r\n        }\r\n      }\r\n      setListeningField(null);\r\n    };\r\n\r\n    recognitionRef.current = recognition;\r\n    setVoiceError(null);\r\n    setListeningField(field);\r\n    recognition.start();\r\n  }\r\n\r\n  function stopVoice() {\r\n    recognitionRef.current?.stop?.();\r\n    setListeningField(null);\r\n  }\r\n\r\n  const tabs = [\r\n    { id: \"summary\", label: \"সারাংশ\" },\r\n    { id: \"add\", label: \"গ্রাহক যোগ\" },\r\n    { id: \"payment\", label: \"পেমেন্ট নিন\" },\r\n    { id: \"list\", label: \"স্টেটমেন্ট\" },\r\n  ] as const;\r\n\r\n  const topDueName = summary.topDue?.[0]?.name || \"\";\r\n  const topDueAmount = summary.topDue?.[0]?.totalDue ?? 0;\r\n\r\n  return (\r\n    <div className=\"space-y-5 pb-24\">\r\n      <div className=\"relative overflow-hidden rounded-2xl border border-border bg-card shadow-[0_16px_36px_rgba(15,23,42,0.08)] animate-fade-in\">\r\n        <div className=\"pointer-events-none absolute inset-0 bg-gradient-to-br from-primary-soft/50 via-card to-card\" />\r\n        <div className=\"pointer-events-none absolute -bottom-16 right-0 h-32 w-32 rounded-full bg-primary/20 blur-3xl\" />\r\n        <div className=\"relative space-y-3 p-4\">\r\n          <div className=\"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between\">\r\n            <div className=\"min-w-0 space-y-1\">\r\n              <p className=\"text-[11px] uppercase tracking-[0.22em] text-muted-foreground\">\r\n                বাকি সারসংক্ষেপ\r\n              </p>\r\n              <p className=\"text-3xl font-bold text-foreground tracking-tight sm:text-4xl\">\r\n                {summary.totalDue.toFixed(2)} ৳\r\n              </p>\r\n              <p className=\"text-xs text-muted-foreground\">\r\n                দোকান:{\" \"}\r\n                <span className=\"font-semibold text-foreground\">{shopName}</span>{\" \"}\r\n                • {customers.length} গ্রাহক\r\n                {topDueName ? (\r\n                  <span>\r\n                    {\" \"}\r\n                    • সর্বোচ্চ বাকি: {topDueName} ({topDueAmount.toFixed(2)} ৳)\r\n                  </span>\r\n                ) : (\r\n                  <span> • কোনো বাকি নেই</span>\r\n                )}\r\n              </p>\r\n            </div>\r\n            <button\r\n              type=\"button\"\r\n              onClick={() => setActiveTab(\"add\")}\r\n              className=\"inline-flex h-10 items-center justify-center rounded-full bg-primary-soft text-primary border border-primary/30 px-4 text-sm font-semibold shadow-sm hover:bg-primary/15 hover:border-primary/40 transition-colors\"\r\n            >\r\n              ➕ নতুন গ্রাহক\r\n            </button>\r\n          </div>\r\n\r\n          <div className=\"flex flex-wrap items-center gap-2 border-t border-border/70 pt-3 text-xs\">\r\n            <span\r\n              className={`inline-flex h-7 items-center gap-1 rounded-full px-3 font-semibold border ${\r\n                online\r\n                  ? \"bg-success-soft text-success border-success/30\"\r\n                  : \"bg-danger-soft text-danger border-danger/30\"\r\n              }`}\r\n            >\r\n              {online ? \"অনলাইন\" : \"অফলাইন\"}\r\n            </span>\r\n            {syncing ? (\r\n              <span className=\"inline-flex h-7 items-center gap-1 rounded-full bg-primary-soft text-primary border border-primary/30 px-3 font-semibold\">\r\n                সিঙ্ক হচ্ছে...\r\n              </span>\r\n            ) : null}\r\n            {pendingCount > 0 ? (\r\n              <span className=\"inline-flex h-7 items-center gap-1 rounded-full bg-warning-soft text-warning border border-warning/30 px-3 font-semibold\">\r\n                পেন্ডিং {pendingCount} টি\r\n              </span>\r\n            ) : null}\r\n            {latestPaymentLabel ? (\r\n              <span className=\"inline-flex h-7 items-center gap-1 rounded-full bg-card/80 text-muted-foreground border border-border px-3 font-semibold\">\r\n                শেষ পেমেন্ট: {latestPaymentLabel}\r\n              </span>\r\n            ) : null}\r\n            {lastSyncLabel ? (\r\n              <span className=\"inline-flex h-7 items-center gap-1 rounded-full bg-card/80 text-muted-foreground border border-border px-3 font-semibold\">\r\n                শেষ সিঙ্ক: {lastSyncLabel}\r\n              </span>\r\n            ) : null}\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"sticky top-0 z-20 bg-card/95 backdrop-blur border-b border-border/70\">\r\n        <div className=\"px-2 py-2\">\r\n          <div className=\"flex gap-2 overflow-x-auto no-scrollbar rounded-full bg-muted/70 p-1 shadow-[inset_0_1px_0_rgba(255,255,255,0.6)]\">\r\n            {tabs.map((tab) => (\r\n              <button\r\n                key={tab.id}\r\n                onClick={() => setActiveTab(tab.id as any)}\r\n                className={`h-9 px-4 rounded-full text-sm font-semibold whitespace-nowrap border border-transparent transition-colors ${\r\n                  activeTab === tab.id\r\n                    ? \"bg-card text-foreground border-border shadow-sm\"\r\n                    : \"text-muted-foreground hover:text-foreground\"\r\n                }`}\r\n              >\r\n                {tab.label}\r\n              </button>\r\n            ))}\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"rounded-2xl border border-border bg-card shadow-sm\">\r\n        <div className=\"p-4 sm:p-6\">\r\n          {/* Summary Tab */}\r\n          {activeTab === \"summary\" && (\r\n            <div className=\"space-y-4\">\r\n              <div className=\"space-y-1\">\r\n                <h3 className=\"text-lg font-bold text-foreground\">\r\n                  গ্রাহক তালিকা\r\n                </h3>\r\n                <p className=\"text-sm text-muted-foreground\">\r\n                  বাকি, ফোন ও শেষ পেমেন্ট এক নজরে দেখুন।\r\n                </p>\r\n              </div>\r\n              {customers.length === 0 ? (\r\n                <div className=\"rounded-2xl border border-dashed border-border/70 bg-muted/40 p-6 text-center\">\r\n                  <p className=\"text-sm text-muted-foreground\">\r\n                    এখনও কোনো গ্রাহক নেই।\r\n                  </p>\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={() => setActiveTab(\"add\")}\r\n                    className=\"mt-3 inline-flex h-10 items-center justify-center rounded-full bg-primary-soft text-primary border border-primary/30 px-4 text-sm font-semibold hover:bg-primary/15 hover:border-primary/40 transition-colors\"\r\n                  >\r\n                    ➕ প্রথম গ্রাহক যোগ করুন\r\n                  </button>\r\n                </div>\r\n              ) : (\r\n                <div className=\"grid gap-3 sm:grid-cols-2\">\r\n                  {customers.map((c) => {\r\n                    const dueValue = Number(c.totalDue || 0);\r\n                    const dueAmount = dueValue.toFixed(2);\r\n                    const hasDue = dueValue > 0;\r\n                    const initial = c.name?.trim()?.charAt(0) || \"•\";\r\n                    return (\r\n                      <div\r\n                        key={c.id}\r\n                        className=\"rounded-2xl border border-border bg-card p-4 shadow-sm card-lift\"\r\n                      >\r\n                        <div className=\"flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between\">\r\n                          <div className=\"flex items-start gap-3 min-w-0\">\r\n                            <span className=\"flex h-10 w-10 items-center justify-center rounded-full bg-primary-soft text-primary text-sm font-bold\">\r\n                              {initial}\r\n                            </span>\r\n                            <div className=\"min-w-0\">\r\n                              <h4 className=\"text-base font-semibold text-foreground truncate\">\r\n                                {c.name}\r\n                              </h4>\r\n                              <p className=\"text-xs text-muted-foreground mt-1\">\r\n                                {c.phone ? `ফোন: ${c.phone}` : \"ফোন নেই\"}\r\n                                {c.address ? ` • ঠিকানা: ${c.address}` : \"\"}\r\n                              </p>\r\n                            </div>\r\n                          </div>\r\n                          <div className=\"text-right\">\r\n                            <span\r\n                              className={`inline-flex items-center rounded-full border px-3 py-1 text-xs font-semibold ${\r\n                                hasDue\r\n                                  ? \"bg-warning-soft text-warning border-warning/30\"\r\n                                  : \"bg-success-soft text-success border-success/30\"\r\n                              }`}\r\n                            >\r\n                              {hasDue ? `বাকি ${dueAmount} ৳` : \"পরিশোধিত\"}\r\n                            </span>\r\n                            {c.lastPaymentAt && (\r\n                              <p className=\"text-[11px] text-muted-foreground mt-2\">\r\n                                শেষ পেমেন্ট: {\" \"}\r\n                                {new Date(c.lastPaymentAt).toLocaleDateString(\r\n                                  \"bn-BD\"\r\n                                )}\r\n                              </p>\r\n                            )}\r\n                          </div>\r\n                        </div>\r\n                        <div className=\"mt-3 flex flex-wrap gap-2\">\r\n                          <button\r\n                            type=\"button\"\r\n                            onClick={() => openStatementFor(c.id)}\r\n                            className=\"h-9 rounded-full border border-border px-3 text-xs font-semibold text-foreground hover:border-primary/40 hover:text-primary transition-colors\"\r\n                          >\r\n                            স্টেটমেন্ট দেখুন\r\n                          </button>\r\n                          <button\r\n                            type=\"button\"\r\n                            onClick={() => openPaymentFor(c.id)}\r\n                            className=\"h-9 rounded-full border border-success/30 bg-success-soft px-3 text-xs font-semibold text-success hover:border-success/40 transition-colors\"\r\n                          >\r\n                            পেমেন্ট নিন\r\n                          </button>\r\n                        </div>\r\n                      </div>\r\n                    );\r\n                  })}\r\n                </div>\r\n              )}\r\n            </div>\r\n          )}\r\n\r\n          {/* Add Customer Tab */}\r\n          {activeTab === \"add\" && (\r\n            <form onSubmit={handleAddCustomer} className=\"space-y-5 max-w-xl\">\r\n              <h3 className=\"text-lg font-bold text-foreground\">\r\n                নতুন গ্রাহক যোগ করুন\r\n              </h3>\r\n              <div className=\"space-y-2\">\r\n                <label className=\"block text-sm font-semibold text-foreground\">\r\n                  গ্রাহকের নাম *\r\n                </label>\r\n                <div className=\"relative\">\r\n                  <input\r\n                    className=\"h-12 w-full rounded-xl border border-border bg-card px-4 pr-16 text-base shadow-sm focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n                    placeholder=\"যেমন: করিম সাহেব\"\r\n                    value={newCustomer.name}\r\n                    onChange={(e) =>\r\n                      setNewCustomer((p) => ({ ...p, name: e.target.value }))\r\n                    }\r\n                    required\r\n                    autoComplete=\"off\"\r\n                  />\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={\r\n                      isListeningName\r\n                        ? stopVoice\r\n                        : () => startVoice(\"customerName\")\r\n                    }\r\n                    disabled={!voiceReady}\r\n                    aria-label={\r\n                      isListeningName\r\n                        ? \"ভয়েস বন্ধ করুন\"\r\n                        : \"ভয়েস ইনপুট চালু করুন\"\r\n                    }\r\n                    className={`absolute right-2 top-1/2 -translate-y-1/2 inline-flex h-9 items-center justify-center rounded-lg border px-3 text-sm font-semibold transition ${\r\n                      isListeningName\r\n                        ? \"bg-primary-soft text-primary border-primary/40 animate-pulse\"\r\n                        : \"bg-primary-soft text-primary border-primary/30 active:scale-95\"\r\n                    } ${!voiceReady ? \"opacity-60 cursor-not-allowed\" : \"\"}`}\r\n                  >\r\n                    {isListeningName ? \"🔴\" : \"🎤\"}\r\n                  </button>\r\n                </div>\r\n                <p className=\"text-xs text-muted-foreground\">\r\n                  {nameVoiceHint}{\" \"}\r\n                  {voiceErrorText ? (\r\n                    <span className=\"text-danger\">{voiceErrorText}</span>\r\n                  ) : null}\r\n                </p>\r\n                {customerSuggestions.length > 0 && (\r\n                  <div className=\"flex flex-wrap gap-2 pt-1\">\r\n                    {customerSuggestions.map((n) => (\r\n                      <button\r\n                        key={n}\r\n                        type=\"button\"\r\n                        onClick={() =>\r\n                          setNewCustomer((p) => ({ ...p, name: n }))\r\n                        }\r\n                        className=\"h-9 px-3 rounded-full border border-primary/30 text-primary bg-primary-soft text-xs font-semibold hover:border-primary/50\"\r\n                      >\r\n                        {n}\r\n                      </button>\r\n                    ))}\r\n                  </div>\r\n                )}\r\n              </div>\r\n              <div className=\"space-y-2\">\r\n                <label className=\"block text-sm font-semibold text-foreground\">\r\n                  ফোন নম্বর (ঐচ্ছিক)\r\n                </label>\r\n                <div className=\"relative\">\r\n                  <input\r\n                    className=\"h-12 w-full rounded-xl border border-border bg-card px-4 pr-16 text-base shadow-sm focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n                    placeholder=\"যেমন: 01700000000\"\r\n                    value={newCustomer.phone}\r\n                    onChange={(e) =>\r\n                      setNewCustomer((p) => ({ ...p, phone: e.target.value }))\r\n                    }\r\n                  />\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={\r\n                      isListeningPhone\r\n                        ? stopVoice\r\n                        : () => startVoice(\"customerPhone\")\r\n                    }\r\n                    disabled={!voiceReady}\r\n                    aria-label={\r\n                      isListeningPhone\r\n                        ? \"ভয়েস বন্ধ করুন\"\r\n                        : \"ভয়েস ইনপুট চালু করুন\"\r\n                    }\r\n                    className={`absolute right-2 top-1/2 -translate-y-1/2 inline-flex h-9 items-center justify-center rounded-lg border px-3 text-sm font-semibold transition ${\r\n                      isListeningPhone\r\n                        ? \"bg-primary-soft text-primary border-primary/40 animate-pulse\"\r\n                        : \"bg-primary-soft text-primary border-primary/30 active:scale-95\"\r\n                    } ${!voiceReady ? \"opacity-60 cursor-not-allowed\" : \"\"}`}\r\n                  >\r\n                    {isListeningPhone ? \"🔴\" : \"🎤\"}\r\n                  </button>\r\n                </div>\r\n                <p className=\"text-xs text-muted-foreground\">\r\n                  {phoneVoiceHint}{\" \"}\r\n                  {voiceErrorText ? (\r\n                    <span className=\"text-danger\">{voiceErrorText}</span>\r\n                  ) : null}\r\n                </p>\r\n              </div>\r\n              <div className=\"space-y-2\">\r\n                <label className=\"block text-sm font-semibold text-foreground\">\r\n                  ঠিকানা (ঐচ্ছিক)\r\n                </label>\r\n                <div className=\"relative\">\r\n                  <input\r\n                    className=\"h-12 w-full rounded-xl border border-border bg-card px-4 pr-16 text-base shadow-sm focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n                    placeholder=\"যেমন: বাজার রোড, ঢাকা\"\r\n                    value={newCustomer.address}\r\n                    onChange={(e) =>\r\n                      setNewCustomer((p) => ({ ...p, address: e.target.value }))\r\n                    }\r\n                  />\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={\r\n                      isListeningAddress\r\n                        ? stopVoice\r\n                        : () => startVoice(\"customerAddress\")\r\n                    }\r\n                    disabled={!voiceReady}\r\n                    aria-label={\r\n                      isListeningAddress\r\n                        ? \"ভয়েস বন্ধ করুন\"\r\n                        : \"ভয়েস ইনপুট চালু করুন\"\r\n                    }\r\n                    className={`absolute right-2 top-1/2 -translate-y-1/2 inline-flex h-9 items-center justify-center rounded-lg border px-3 text-sm font-semibold transition ${\r\n                      isListeningAddress\r\n                        ? \"bg-primary-soft text-primary border-primary/40 animate-pulse\"\r\n                        : \"bg-primary-soft text-primary border-primary/30 active:scale-95\"\r\n                    } ${!voiceReady ? \"opacity-60 cursor-not-allowed\" : \"\"}`}\r\n                  >\r\n                    {isListeningAddress ? \"🔴\" : \"🎤\"}\r\n                  </button>\r\n                </div>\r\n                <p className=\"text-xs text-muted-foreground\">\r\n                  {addressVoiceHint}{\" \"}\r\n                  {voiceErrorText ? (\r\n                    <span className=\"text-danger\">{voiceErrorText}</span>\r\n                  ) : null}\r\n                </p>\r\n              </div>\r\n              <button\r\n                type=\"submit\"\r\n                className=\"w-full h-12 bg-primary-soft text-primary border border-primary/30 hover:bg-primary/15 hover:border-primary/40 font-bold px-6 rounded-xl text-lg transition-colors\"\r\n              >\r\n                ✓ গ্রাহক যোগ করুন\r\n              </button>\r\n            </form>\r\n          )}\r\n\r\n          {/* Payment Tab */}\r\n          {activeTab === \"payment\" && (\r\n            <form onSubmit={handlePayment} className=\"space-y-5 max-w-xl\">\r\n              <h3 className=\"text-lg font-bold text-foreground\">পেমেন্ট নিন</h3>\r\n              {customers.length === 0 ? (\r\n                <div className=\"rounded-2xl border border-dashed border-border/70 bg-muted/40 p-4 text-center text-sm text-muted-foreground\">\r\n                  কোনো গ্রাহক নেই। আগে গ্রাহক যোগ করুন।\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={() => setActiveTab(\"add\")}\r\n                    className=\"mt-3 inline-flex h-9 items-center justify-center rounded-full bg-primary-soft text-primary border border-primary/30 px-4 text-xs font-semibold hover:bg-primary/15 hover:border-primary/40 transition-colors\"\r\n                  >\r\n                    ➕ গ্রাহক যোগ করুন\r\n                  </button>\r\n                </div>\r\n              ) : null}\r\n              <div className=\"space-y-2\">\r\n                <label className=\"block text-sm font-semibold text-foreground\">\r\n                  গ্রাহক বাছাই করুন *\r\n                </label>\r\n                {mounted ? (\r\n                  <Select\r\n                    value={paymentForm.customerId}\r\n                    onValueChange={(value) => {\r\n                      setPaymentForm((p) => ({\r\n                        ...p,\r\n                        customerId: value,\r\n                      }));\r\n                      setSelectedCustomerId(value);\r\n                    }}\r\n                    disabled={customers.length === 0}\r\n                  >\r\n                    <SelectTrigger className=\"h-11 w-full rounded-xl border border-border bg-card px-4 text-left text-base text-foreground shadow-sm focus:ring-2 focus:ring-primary/30\">\r\n                      <SelectValue placeholder=\"গ্রাহক বাছাই করুন\" />\r\n                    </SelectTrigger>\r\n                    <SelectContent\r\n                      align=\"start\"\r\n                      className=\"min-w-[var(--radix-select-trigger-width)]\"\r\n                    >\r\n                      {customers.map((c) => (\r\n                        <SelectItem key={c.id} value={c.id}>\r\n                          {c.name} — বাকি:{\" \"}\r\n                          {Number(c.totalDue || 0).toFixed(2)} ৳\r\n                        </SelectItem>\r\n                      ))}\r\n                    </SelectContent>\r\n                  </Select>\r\n                ) : (\r\n                  <select\r\n                    className=\"h-11 w-full rounded-xl border border-border bg-card px-4 text-base shadow-sm focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n                    value={paymentForm.customerId}\r\n                    onChange={(e) => {\r\n                      setPaymentForm((p) => ({\r\n                        ...p,\r\n                        customerId: e.target.value,\r\n                      }));\r\n                      setSelectedCustomerId(e.target.value);\r\n                    }}\r\n                    disabled={customers.length === 0}\r\n                  >\r\n                    <option value=\"\">-- গ্রাহক বাছাই করুন --</option>\r\n                    {customers.map((c) => (\r\n                      <option key={c.id} value={c.id}>\r\n                        {c.name} — বাকি: {Number(c.totalDue || 0).toFixed(2)} ৳\r\n                      </option>\r\n                    ))}\r\n                  </select>\r\n                )}\r\n              </div>\r\n              {selectedCustomer ? (\r\n                <div className=\"rounded-xl border border-border bg-muted/50 p-3\">\r\n                  <p className=\"text-xs text-muted-foreground\">নির্বাচিত গ্রাহক</p>\r\n                  <div className=\"flex items-center justify-between gap-2\">\r\n                    <p className=\"font-semibold text-foreground truncate\">\r\n                      {selectedCustomer.name}\r\n                    </p>\r\n                    <span\r\n                      className={`inline-flex items-center rounded-full border px-3 py-1 text-xs font-semibold ${\r\n                        selectedCustomerHasDue\r\n                          ? \"bg-warning-soft text-warning border-warning/30\"\r\n                          : \"bg-success-soft text-success border-success/30\"\r\n                      }`}\r\n                    >\r\n                      {selectedCustomerHasDue && selectedCustomerDueLabel\r\n                        ? `বাকি ${selectedCustomerDueLabel} ৳`\r\n                        : \"পরিশোধিত\"}\r\n                    </span>\r\n                  </div>\r\n                  {selectedCustomer.lastPaymentAt && (\r\n                    <p className=\"text-[11px] text-muted-foreground mt-1\">\r\n                      শেষ পেমেন্ট: {\" \"}\r\n                      {new Date(selectedCustomer.lastPaymentAt).toLocaleDateString(\r\n                        \"bn-BD\"\r\n                      )}\r\n                    </p>\r\n                  )}\r\n                </div>\r\n              ) : null}\r\n              <div className=\"space-y-2\">\r\n                <label className=\"block text-sm font-semibold text-foreground\">\r\n                  পেমেন্টের পরিমাণ (৳) *\r\n                </label>\r\n                <div className=\"relative\">\r\n                  <input\r\n                    className=\"h-12 w-full rounded-xl border border-border bg-card px-4 pr-16 text-base shadow-sm focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n                    placeholder=\"যেমন: 500, 1000\"\r\n                    type=\"number\"\r\n                    min=\"0\"\r\n                    step=\"0.01\"\r\n                    value={paymentForm.amount}\r\n                    onChange={(e) =>\r\n                      setPaymentForm((p) => ({ ...p, amount: e.target.value }))\r\n                    }\r\n                    required\r\n                  />\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={\r\n                      isListeningPaymentAmount\r\n                        ? stopVoice\r\n                        : () => startVoice(\"paymentAmount\")\r\n                    }\r\n                    disabled={!voiceReady}\r\n                    aria-label={\r\n                      isListeningPaymentAmount\r\n                        ? \"ভয়েস বন্ধ করুন\"\r\n                        : \"ভয়েস ইনপুট চালু করুন\"\r\n                    }\r\n                    className={`absolute right-2 top-1/2 -translate-y-1/2 inline-flex h-9 items-center justify-center rounded-lg border px-3 text-sm font-semibold transition ${\r\n                      isListeningPaymentAmount\r\n                        ? \"bg-primary-soft text-primary border-primary/40 animate-pulse\"\r\n                        : \"bg-primary-soft text-primary border-primary/30 active:scale-95\"\r\n                    } ${!voiceReady ? \"opacity-60 cursor-not-allowed\" : \"\"}`}\r\n                  >\r\n                    {isListeningPaymentAmount ? \"🔴\" : \"🎤\"}\r\n                  </button>\r\n                </div>\r\n                <p className=\"text-xs text-muted-foreground\">\r\n                  {paymentAmountVoiceHint}{\" \"}\r\n                  {voiceErrorText ? (\r\n                    <span className=\"text-danger\">{voiceErrorText}</span>\r\n                  ) : null}\r\n                </p>\r\n                {amountSuggestions.length > 0 && (\r\n                  <div className=\"flex flex-wrap gap-2\">\r\n                    {amountSuggestions.map((a) => (\r\n                      <button\r\n                        key={a}\r\n                        type=\"button\"\r\n                        onClick={() =>\r\n                          setPaymentForm((p) => ({ ...p, amount: a }))\r\n                        }\r\n                        className=\"h-9 px-3 rounded-full border border-primary/30 bg-primary-soft text-primary text-xs font-semibold hover:border-primary/50\"\r\n                      >\r\n                        ৳ {a}\r\n                      </button>\r\n                    ))}\r\n                  </div>\r\n                )}\r\n              </div>\r\n              <div className=\"space-y-2\">\r\n                <label className=\"block text-sm font-semibold text-foreground\">\r\n                  বিবরণ (ঐচ্ছিক)\r\n                </label>\r\n                <div className=\"relative\">\r\n                  <input\r\n                    className=\"h-12 w-full rounded-xl border border-border bg-card px-4 pr-16 text-base shadow-sm focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n                    placeholder=\"যেমন: নগদ পেমেন্ট\"\r\n                    value={paymentForm.description}\r\n                    onChange={(e) =>\r\n                      setPaymentForm((p) => ({\r\n                        ...p,\r\n                        description: e.target.value,\r\n                      }))\r\n                    }\r\n                  />\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={\r\n                      isListeningPaymentDescription\r\n                        ? stopVoice\r\n                        : () => startVoice(\"paymentDescription\")\r\n                    }\r\n                    disabled={!voiceReady}\r\n                    aria-label={\r\n                      isListeningPaymentDescription\r\n                        ? \"ভয়েস বন্ধ করুন\"\r\n                        : \"ভয়েস ইনপুট চালু করুন\"\r\n                    }\r\n                    className={`absolute right-2 top-1/2 -translate-y-1/2 inline-flex h-9 items-center justify-center rounded-lg border px-3 text-sm font-semibold transition ${\r\n                      isListeningPaymentDescription\r\n                        ? \"bg-primary-soft text-primary border-primary/40 animate-pulse\"\r\n                        : \"bg-primary-soft text-primary border-primary/30 active:scale-95\"\r\n                    } ${!voiceReady ? \"opacity-60 cursor-not-allowed\" : \"\"}`}\r\n                  >\r\n                    {isListeningPaymentDescription ? \"🔴\" : \"🎤\"}\r\n                  </button>\r\n                </div>\r\n                <p className=\"text-xs text-muted-foreground\">\r\n                  {paymentDescriptionVoiceHint}{\" \"}\r\n                  {voiceErrorText ? (\r\n                    <span className=\"text-danger\">{voiceErrorText}</span>\r\n                  ) : null}\r\n                </p>\r\n              </div>\r\n              <button\r\n                type=\"submit\"\r\n                disabled={\r\n                  !paymentForm.customerId ||\r\n                  !paymentForm.amount ||\r\n                  savingPayment\r\n                }\r\n                className=\"w-full h-12 bg-success hover:bg-success/90 disabled:bg-muted disabled:text-muted-foreground text-primary-foreground font-bold px-6 rounded-xl text-lg transition-colors\"\r\n              >\r\n                {savingPayment ? \"সংরক্ষণ করছে...\" : \"✓ পেমেন্ট রেকর্ড করুন\"}\r\n              </button>\r\n            </form>\r\n          )}\r\n\r\n          {/* Customer List Tab */}\r\n          {activeTab === \"list\" && (\r\n            <div className=\"space-y-4\">\r\n              <h3 className=\"text-lg font-bold text-foreground\">সব গ্রাহক</h3>\r\n              <div className=\"space-y-2\">\r\n                <label className=\"block text-sm font-semibold text-foreground\">\r\n                  বিবরণ দেখতে গ্রাহক বাছাই করুন\r\n                </label>\r\n                {mounted ? (\r\n                  <Select\r\n                    value={selectedCustomerId}\r\n                    onValueChange={(value) => {\r\n                      setSelectedCustomerId(value);\r\n                    }}\r\n                    disabled={customers.length === 0}\r\n                  >\r\n                    <SelectTrigger className=\"h-11 w-full rounded-xl border border-border bg-card px-4 text-left text-base text-foreground shadow-sm focus:ring-2 focus:ring-primary/30\">\r\n                      <SelectValue placeholder=\"গ্রাহক বাছাই করুন\" />\r\n                    </SelectTrigger>\r\n                    <SelectContent\r\n                      align=\"start\"\r\n                      className=\"min-w-[var(--radix-select-trigger-width)]\"\r\n                    >\r\n                      {customers.map((c) => (\r\n                        <SelectItem key={c.id} value={c.id}>\r\n                          {c.name}\r\n                        </SelectItem>\r\n                      ))}\r\n                    </SelectContent>\r\n                  </Select>\r\n                ) : (\r\n                  <select\r\n                    className=\"h-11 w-full rounded-xl border border-border bg-card px-4 text-base shadow-sm focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n                    value={selectedCustomerId}\r\n                    onChange={(e) => {\r\n                      setSelectedCustomerId(e.target.value);\r\n                    }}\r\n                    disabled={customers.length === 0}\r\n                  >\r\n                    <option value=\"\">-- গ্রাহক বাছাই করুন --</option>\r\n                    {customers.map((c) => (\r\n                      <option key={c.id} value={c.id}>\r\n                        {c.name}\r\n                      </option>\r\n                    ))}\r\n                  </select>\r\n                )}\r\n              </div>\r\n\r\n              {selectedCustomerId && (\r\n                <div className=\"mt-6 space-y-4\">\r\n                  <h4 className=\"font-bold text-foreground\">লেনদেনের বিবরণ</h4>\r\n                  {statementCustomer ? (\r\n                    <div className=\"rounded-xl border border-border bg-muted/50 p-3\">\r\n                      <p className=\"text-xs text-muted-foreground\">গ্রাহক</p>\r\n                      <div className=\"flex items-center justify-between gap-2\">\r\n                        <p className=\"font-semibold text-foreground truncate\">\r\n                          {statementCustomer.name}\r\n                        </p>\r\n                        <span\r\n                          className={`inline-flex items-center rounded-full border px-3 py-1 text-xs font-semibold ${\r\n                            Number(statementCustomer.totalDue || 0) > 0\r\n                              ? \"bg-warning-soft text-warning border-warning/30\"\r\n                              : \"bg-success-soft text-success border-success/30\"\r\n                          }`}\r\n                        >\r\n                          {Number(statementCustomer.totalDue || 0) > 0\r\n                            ? `বাকি ${Number(statementCustomer.totalDue || 0).toFixed(2)} ৳`\r\n                            : \"পরিশোধিত\"}\r\n                        </span>\r\n                      </div>\r\n                    </div>\r\n                  ) : null}\r\n                  <div className=\"hidden md:block overflow-hidden rounded-xl border border-border\">\r\n                    <table className=\"w-full text-sm\">\r\n                      <thead className=\"bg-muted/70\">\r\n                        <tr>\r\n                          <th className=\"p-3 text-left\">তারিখ</th>\r\n                          <th className=\"p-3 text-left\">বিবরণ</th>\r\n                          <th className=\"p-3 text-right\">বিক্রয়</th>\r\n                          <th className=\"p-3 text-right\">পেমেন্ট</th>\r\n                          <th className=\"p-3 text-right\">ব্যালেন্স</th>\r\n                        </tr>\r\n                      </thead>\r\n                      <tbody>\r\n                        {loadingStatement ? (\r\n                          <tr>\r\n                            <td className=\"p-3 text-center\" colSpan={5}>\r\n                              লোড হচ্ছে...\r\n                            </td>\r\n                          </tr>\r\n                        ) : statementWithBalance.length === 0 ? (\r\n                          <tr>\r\n                            <td className=\"p-3 text-center\" colSpan={5}>\r\n                              কোনো লেনদেন নেই।\r\n                            </td>\r\n                          </tr>\r\n                        ) : (\r\n                          statementWithBalance.map((row) => (\r\n                            <tr key={row.id} className=\"border-t border-border/70\">\r\n                              <td className=\"p-3\">\r\n                                {new Date(row.entryDate).toLocaleDateString(\r\n                                  \"bn-BD\"\r\n                                )}\r\n                              </td>\r\n                              <td className=\"p-3 text-left\">\r\n                                {row.description || \"-\"}\r\n                              </td>\r\n                              <td className=\"p-3 text-right\">\r\n                                {row.entryType === \"SALE\"\r\n                                  ? Number(row.amount || 0).toFixed(2)\r\n                                  : \"\"}\r\n                              </td>\r\n                              <td className=\"p-3 text-right\">\r\n                                {row.entryType === \"PAYMENT\"\r\n                                  ? Number(row.amount || 0).toFixed(2)\r\n                                  : \"\"}\r\n                              </td>\r\n                              <td className=\"p-3 text-right font-semibold\">\r\n                                {Number((row as any).running || 0).toFixed(2)} ৳\r\n                              </td>\r\n                            </tr>\r\n                          ))\r\n                        )}\r\n                      </tbody>\r\n                    </table>\r\n                  </div>\r\n\r\n                  <div className=\"space-y-3 md:hidden\">\r\n                    {loadingStatement ? (\r\n                      <p className=\"text-center text-muted-foreground bg-card border border-border rounded-xl p-4\">\r\n                        লোড হচ্ছে...\r\n                      </p>\r\n                    ) : statementWithBalance.length === 0 ? (\r\n                      <p className=\"text-center text-muted-foreground bg-card border border-border rounded-xl p-4\">\r\n                        কোনো লেনদেন নেই\r\n                      </p>\r\n                    ) : (\r\n                      statementWithBalance.map((row) => {\r\n                        const sale = row.entryType === \"SALE\";\r\n                        const amountValue = Number(row.amount || 0);\r\n                        const amount = amountValue.toFixed(2);\r\n                        const running = Number((row as any).running || 0).toFixed(2);\r\n                        const title = row.description || (sale ? \"বিক্রি\" : \"পেমেন্ট\");\r\n                        const sign = sale ? \"+\" : \"-\";\r\n\r\n                        return (\r\n                          <div\r\n                            key={row.id}\r\n                            className=\"relative bg-card border border-border rounded-2xl p-4 shadow-sm card-lift overflow-hidden\"\r\n                          >\r\n                            <div\r\n                              className={`absolute left-0 top-3 bottom-3 w-1 rounded-full ${\r\n                                sale ? \"bg-warning\" : \"bg-success\"\r\n                              }`}\r\n                            />\r\n                            <div className=\"pl-3 flex items-center justify-between\">\r\n                              <div>\r\n                                <p className=\"text-xs text-muted-foreground\">\r\n                                  {new Date(row.entryDate).toLocaleDateString(\"bn-BD\")}\r\n                                </p>\r\n                                <p className=\"text-base font-semibold text-foreground mt-1\">\r\n                                  {title}\r\n                                </p>\r\n                              </div>\r\n                              <span\r\n                                className={`px-3 py-1 rounded-full text-xs font-semibold ${\r\n                                  sale\r\n                                    ? \"bg-warning-soft text-warning\"\r\n                                    : \"bg-success-soft text-success\"\r\n                                }`}\r\n                              >\r\n                                {sale ? \"বিক্রি\" : \"পেমেন্ট\"}\r\n                              </span>\r\n                            </div>\r\n\r\n                            <div className=\"mt-3 grid grid-cols-2 gap-2 text-sm text-muted-foreground\">\r\n                              <div className=\"bg-muted/80 rounded-xl p-3\">\r\n                                <p className=\"text-xs text-muted-foreground\">\r\n                                  {sale ? \"বিক্রির পরিমাণ\" : \"পেমেন্টের পরিমাণ\"}\r\n                                </p>\r\n                                <p\r\n                                  className={`text-base font-semibold ${\r\n                                    sale ? \"text-warning\" : \"text-success\"\r\n                                  }`}\r\n                                >\r\n                                  {sign}{amount} ৳\r\n                                </p>\r\n                              </div>\r\n                              <div className=\"bg-muted/80 rounded-xl p-3\">\r\n                                <p className=\"text-xs text-muted-foreground\">চলতি বাকি</p>\r\n                                <p className=\"text-base font-semibold text-foreground\">\r\n                                  {running} ৳\r\n                                </p>\r\n                              </div>\r\n                            </div>\r\n                          </div>\r\n                        );\r\n                      })\r\n                    )}\r\n                  </div>\r\n                </div>\r\n              )}\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\due\\ShopSelector.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\due\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\expenses\\ShopSelectorClient.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\expenses\\[id]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\expenses\\components\\ExpensesDeleteButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\expenses\\components\\ExpensesListClient.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\expenses\\new\\ExpenseFormClient.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\pos\\pos-app-supabase\\app\\dashboard\\expenses\\new\\ExpenseFormClient.tsx:128:5\n  126 |         ? (window as any).SpeechRecognition || (window as any).webkitSpeechRecognition\n  127 |         : null;\n> 128 |     setVoiceReady(Boolean(SpeechRecognitionImpl));\n      |     ^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  129 |     return () => recognitionRef.current?.stop?.();\n  130 |   }, []);\n  131 |","line":128,"column":5,"nodeType":null,"endLine":128,"endColumn":18},{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\pos\\pos-app-supabase\\app\\dashboard\\expenses\\new\\ExpenseFormClient.tsx:137:9\n  135 |     if (stored) {\n  136 |       try {\n> 137 |         setTemplates(JSON.parse(stored) as ExpenseTemplate[]);\n      |         ^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  138 |       } catch {\n  139 |         setTemplates([]);\n  140 |       }","line":137,"column":9,"nodeType":null,"endLine":137,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// app/dashboard/expenses/new/ExpenseFormClient.tsx\r\n\"use client\";\r\n\r\nimport { useEffect, useMemo, useRef, useState } from \"react\";\nimport { useRouter } from \"next/navigation\";\nimport { useOnlineStatus } from \"@/lib/sync/net-status\";\nimport { useRealtimeStatus } from \"@/lib/realtime/status\";\nimport { db } from \"@/lib/dexie/db\";\nimport { queueAdd } from \"@/lib/sync/queue\";\nimport useRealTimeReports from \"@/hooks/useRealTimeReports\";\nimport { emitExpenseUpdate } from \"@/lib/events/reportEvents\";\nimport { safeLocalStorageGet, safeLocalStorageSet } from \"@/lib/storage\";\nimport Link from \"next/link\";\nimport { toast } from \"sonner\";\n\r\ntype SpeechRecognitionInstance = {\r\n  lang: string;\r\n  interimResults: boolean;\r\n  continuous: boolean;\r\n  start: () => void;\r\n  stop: () => void;\r\n  abort?: () => void;\r\n  onresult: ((event: any) => void) | null;\r\n  onerror: ((event: any) => void) | null;\r\n  onend: (() => void) | null;\r\n};\r\n\r\ntype ExpenseTemplate = {\r\n  category: string;\r\n  amount: string;\r\n  note?: string;\r\n  count: number;\r\n  lastUsed: number;\r\n};\r\n\r\ntype Props = {\r\n  shopId: string;\r\n  backHref: string;\r\n  action: (formData: FormData) => Promise<void>;\r\n  id?: string;\r\n  title?: string;\r\n  subtitle?: string;\r\n  shopName?: string | null;\r\n  initialValues?: {\r\n    amount?: string;\r\n    category?: string;\r\n    note?: string;\r\n    expenseDate?: string;\r\n  };\r\n  submitLabel?: string;\r\n};\r\n\r\nconst TEMPLATE_LIMIT = 40;\r\n\r\nconst CATEGORY_SUGGESTIONS = [\"ভাড়া\", \"বিদ্যুৎ\", \"কাঁচা বাজার\", \"বেতন\", \"পরিবহন\", \"অন্যান্য\"];\r\n\r\nfunction mergeTemplates(existing: ExpenseTemplate[], incoming: ExpenseTemplate) {\r\n  const idx = existing.findIndex((t) => t.category === incoming.category && t.amount === incoming.amount);\r\n  const next = [...existing];\r\n  if (idx >= 0) {\r\n    const current = next[idx];\r\n    next[idx] = {\r\n      ...current,\r\n      note: incoming.note || current.note,\r\n      count: current.count + 1,\r\n      lastUsed: incoming.lastUsed,\r\n    };\r\n  } else {\r\n    next.unshift(incoming);\r\n  }\r\n  return next\r\n    .sort((a, b) => b.count - a.count || b.lastUsed - a.lastUsed)\r\n    .slice(0, TEMPLATE_LIMIT);\r\n}\r\n\r\nfunction dedupe(values: string[]) {\r\n  return Array.from(new Set(values.filter(Boolean)));\r\n}\r\n\r\nfunction parseAmount(text: string) {\n  const match = text.match(/(\\d+(?:[.,]\\d+)?)/);\n  return match ? match[1].replace(\",\", \"\") : \"\";\n}\n\nfunction isRedirectError(err: unknown) {\n  if (!err || typeof err !== \"object\") return false;\n  const digest = (err as { digest?: string }).digest;\n  return typeof digest === \"string\" && digest.startsWith(\"NEXT_REDIRECT\");\n}\n\nexport default function ExpenseFormClient({\n  shopId,\n  backHref,\n  action,\n  id,\r\n  title,\r\n  subtitle,\r\n  shopName,\r\n  initialValues,\r\n  submitLabel = \"+ দ্রুত খরচ যোগ করুন\",\r\n}: Props) {\n  // World-Class Real-time Reports Integration\n  const realTimeReports = useRealTimeReports(shopId);\n  \n  const online = useOnlineStatus();\n  const realtime = useRealtimeStatus();\n  const router = useRouter();\n  const recognitionRef = useRef<SpeechRecognitionInstance | null>(null);\n  const [listening, setListening] = useState(false);\r\n  const [voiceReady, setVoiceReady] = useState(false);\r\n  const [voiceError, setVoiceError] = useState<string | null>(null);\r\n\r\n  const storageKey = useMemo(() => `expenseTemplates:${shopId}`, [shopId]);\r\n  const [templates, setTemplates] = useState<ExpenseTemplate[]>([]);\r\n\r\n  const [amount, setAmount] = useState(initialValues?.amount || \"\");\r\n  const [category, setCategory] = useState(initialValues?.category || \"\");\r\n  const [note, setNote] = useState(initialValues?.note || \"\");\r\n  const [expenseDate, setExpenseDate] = useState(\r\n    initialValues?.expenseDate || new Date().toISOString().slice(0, 10)\r\n  );\r\n\r\n  useEffect(() => {\r\n    const SpeechRecognitionImpl =\r\n      typeof window !== \"undefined\"\r\n        ? (window as any).SpeechRecognition || (window as any).webkitSpeechRecognition\r\n        : null;\r\n    setVoiceReady(Boolean(SpeechRecognitionImpl));\r\n    return () => recognitionRef.current?.stop?.();\r\n  }, []);\r\n\r\n  useEffect(() => {\n    if (!storageKey) return;\n    const stored = safeLocalStorageGet(storageKey);\n    if (stored) {\n      try {\n        setTemplates(JSON.parse(stored) as ExpenseTemplate[]);\n      } catch {\n        setTemplates([]);\r\n      }\r\n    }\r\n  }, [storageKey]);\r\n\r\n  const frequentTemplates = useMemo(\r\n    () => templates.slice().sort((a, b) => b.count - a.count || b.lastUsed - a.lastUsed),\r\n    [templates]\r\n  );\r\n\r\n  const recentTemplates = useMemo(\r\n    () => templates.slice().sort((a, b) => b.lastUsed - a.lastUsed),\r\n    [templates]\r\n  );\r\n\r\n  const categoryOptions = useMemo(\r\n    () =>\r\n      dedupe([\r\n        ...CATEGORY_SUGGESTIONS,\r\n        ...frequentTemplates.map((t) => t.category),\r\n        ...recentTemplates.map((t) => t.category),\r\n      ]),\r\n    [frequentTemplates, recentTemplates]\r\n  );\r\n\r\n  const amountOptions = useMemo(\r\n    () => dedupe(recentTemplates.map((t) => t.amount).concat(frequentTemplates.map((t) => t.amount))),\r\n    [recentTemplates, frequentTemplates]\r\n  );\r\n\r\n  const headerTitle = title || (id ? \"খরচ সম্পাদনা করুন\" : \"নতুন খরচ যোগ করুন\");\r\n  const headerSubtitle =\r\n    subtitle ||\r\n    (id\r\n      ? \"পরিমাণ, ক্যাটাগরি ও নোট ঠিক করে আপডেট করুন\"\r\n      : \"ভয়েস + স্মার্ট টেমপ্লেট দিয়ে দ্রুত খরচ যোগ করুন\");\r\n  const shopLabel = shopName?.trim() || \"\";\r\n  const voiceErrorText = voiceError ? `(${voiceError})` : \"\";\r\n  const amountVoiceHint = listening\r\n    ? \"শুনছি... খরচের নাম/দাম বলুন\"\r\n    : voiceReady\r\n    ? \"ভয়েসে বললে অটো পূরণ হবে\"\r\n    : \"এই ডিভাইসে ভয়েস সাপোর্ট নেই\";\r\n  const noteVoiceHint = listening\r\n    ? \"শুনছি... নোট বলুন\"\r\n    : voiceReady\r\n    ? \"ভয়েসে নোট বলুন\"\r\n    : \"এই ডিভাইসে ভয়েস সাপোর্ট নেই\";\r\n\r\n  function persistTemplates(next: ExpenseTemplate[]) {\n    setTemplates(next);\n    safeLocalStorageSet(storageKey, JSON.stringify(next));\n  }\n\r\n  function applyTemplate(t: ExpenseTemplate) {\r\n    setCategory(t.category);\r\n    setAmount(t.amount);\r\n    setNote(t.note || \"\");\r\n  }\r\n\r\n  function startVoice(field: \"amount\" | \"note\") {\r\n    if (listening) return;\r\n    const SpeechRecognitionImpl =\r\n      typeof window !== \"undefined\"\r\n        ? ((window as any).SpeechRecognition ||\r\n            (window as any).webkitSpeechRecognition)\r\n        : null;\r\n\r\n    if (!SpeechRecognitionImpl) {\r\n      setVoiceReady(false);\r\n      setVoiceError(\"ব্রাউজার মাইক্রোফোন সমর্থন দিচ্ছে না\");\r\n      return;\r\n    }\r\n\r\n    const recognition: SpeechRecognitionInstance = new SpeechRecognitionImpl();\r\n    recognition.lang = \"bn-BD\";\r\n    recognition.interimResults = false;\r\n    recognition.continuous = false;\r\n    recognition.onerror = () => {\r\n      setListening(false);\r\n      setVoiceError(\"মাইক্রোফোন অ্যাক্সেস পাওয়া যায়নি\");\r\n    };\r\n    recognition.onend = () => setListening(false);\r\n    recognition.onresult = (event: any) => {\r\n      const spoken: string | undefined = event?.results?.[0]?.[0]?.transcript;\r\n      if (spoken) {\r\n        if (field === \"amount\") {\r\n          const parsed = parseAmount(spoken);\r\n          if (parsed) setAmount(parsed);\r\n          // also capture note text if included\r\n          const leftover = parsed ? spoken.replace(parsed, \"\").trim() : spoken;\r\n          if (leftover && !note) setNote(leftover);\r\n        } else {\r\n          setNote((prev) => (prev ? `${prev} ${spoken}` : spoken));\r\n          const parsed = parseAmount(spoken);\r\n          if (parsed && !amount) setAmount(parsed);\r\n        }\r\n      }\r\n      setListening(false);\r\n    };\r\n\r\n    recognitionRef.current = recognition;\r\n    setVoiceError(null);\r\n    setListening(true);\r\n    recognition.start();\r\n  }\r\n\r\n  function stopVoice() {\r\n    recognitionRef.current?.stop?.();\r\n    setListening(false);\r\n  }\r\n\r\n  async function handleSubmit(e: React.FormEvent<HTMLFormElement>) {\n    e.preventDefault();\n    const form = new FormData(e.currentTarget);\n\r\n    // ensure form data includes our state (in case user used quick chips)\r\n    form.set(\"amount\", (form.get(\"amount\") as string) || amount);\r\n    form.set(\"category\", (form.get(\"category\") as string) || category || \"অন্যান্য\");\r\n    form.set(\"note\", (form.get(\"note\") as string) || note);\r\n    form.set(\"expenseDate\", (form.get(\"expenseDate\") as string) || expenseDate);\r\n\r\n    const expenseAmount = parseFloat((form.get(\"amount\") as string) || \"0\");\n    const templateCategory = (form.get(\"category\") as string) || \"অন্যান্য\";\n    const templateAmount = (form.get(\"amount\") as string) || \"0\";\n    \n    if (!initialValues) {\n      const template: ExpenseTemplate = {\r\n        category: templateCategory,\r\n        amount: templateAmount,\r\n        note: (form.get(\"note\") as string) || \"\",\r\n        count: 1,\r\n        lastUsed: Date.now(),\r\n      };\r\n      persistTemplates(mergeTemplates(templates, template));\n    }\n\n    const isEdit = Boolean(id);\n    const expenseId = id || crypto.randomUUID();\n    const previousAmountRaw = initialValues?.amount;\n    const previousAmount = previousAmountRaw ? Number(previousAmountRaw) : NaN;\n    const shouldOptimisticallyUpdate = !online || !realtime.connected;\n    let updateId: string | undefined;\n    let pendingEvent: {\n      payload: {\n        type: \"expense\";\n        operation: \"add\" | \"subtract\";\n        amount: number;\n        shopId: string;\n        metadata?: {\n          expenseId?: string;\n          previousAmount?: number;\n          timestamp?: number;\n          skipCount?: boolean;\n        };\n      };\n      correlationId?: string;\n    } | null = null;\n\n    if (shouldOptimisticallyUpdate && Number.isFinite(expenseAmount)) {\n      let op: \"add\" | \"subtract\" | null = null;\n      let deltaAmount = 0;\n      let skipCount = false;\n\n      if (isEdit && Number.isFinite(previousAmount)) {\n        const delta = Number((expenseAmount - previousAmount).toFixed(2));\n        if (delta !== 0) {\n          op = delta > 0 ? \"add\" : \"subtract\";\n          deltaAmount = Math.abs(delta);\n          skipCount = true;\n        }\n      } else {\n        op = \"add\";\n        deltaAmount = expenseAmount;\n      }\n\n      if (op && deltaAmount > 0) {\n        updateId = realTimeReports.updateExpenseReport(deltaAmount, op, {\n          expenseId,\n          previousAmount: Number.isFinite(previousAmount) ? previousAmount : undefined,\n          timestamp: Date.now(),\n          skipCount,\n        });\n\n        const eventPayload = {\n          type: \"expense\" as const,\n          operation: op,\n          amount: deltaAmount,\n          shopId,\n          metadata: {\n            expenseId,\n            previousAmount: Number.isFinite(previousAmount) ? previousAmount : undefined,\n            timestamp: Date.now(),\n            skipCount,\n          },\n        };\n\n        if (online) {\n          pendingEvent = { payload: eventPayload, correlationId: updateId };\n        } else {\n          emitExpenseUpdate(shopId, eventPayload, {\n            source: \"ui\",\n            priority: \"high\",\n            correlationId: updateId,\n          });\n        }\n      }\n    }\n\n    if (online) {\n      try {\n        await action(form);\n        if (pendingEvent) {\n          emitExpenseUpdate(shopId, pendingEvent.payload, {\n            source: \"ui\",\n            priority: \"high\",\n            correlationId: pendingEvent.correlationId,\n          });\n        }\n        toast.success(isEdit ? \"খরচ আপডেট হয়েছে\" : \"খরচ যোগ হয়েছে\");\n        router.push(backHref);\n        // Background sync for consistency\n        setTimeout(() => {\n          if (updateId) {\n            realTimeReports.syncWithServer(updateId);\n          } else {\n            realTimeReports.syncWithServer();\n          }\n        }, 500);\n      } catch (error) {\n        if (isRedirectError(error)) {\n          return;\n        }\n        // Rollback on error\n        if (updateId) {\n          realTimeReports.rollbackLastUpdate();\n        }\n        console.error('Expense creation failed:', error);\n        toast.error(\"খরচ সংরক্ষণ করা যায়নি\");\n      }\n      return;\n    }\n\n    const payload = {\n      id: expenseId,\n      shopId,\n      amount: form.get(\"amount\") as string,\n      category: (form.get(\"category\") as string) || \"অন্যান্য\",\n      note: (form.get(\"note\") as string) || \"\",\n      expenseDate: (form.get(\"expenseDate\") as string) || new Date().toISOString().slice(0, 10),\n      createdAt: Date.now(),\n      updatedAt: Date.now(),\n      syncStatus: isEdit ? \"updated\" as const : \"new\" as const,\n    };\n\r\n    await db.transaction(\"rw\", db.expenses, db.queue, async () => {\n      await db.expenses.put(payload as any);\n      await queueAdd(\"expense\", isEdit ? \"update\" : \"create\", payload);\n    });\n    toast.warning(\n      isEdit\n        ? \"অফলাইন: খরচ আপডেট কিউ হয়েছে, সংযোগ পেলে সিঙ্ক হবে।\"\n        : \"অফলাইন: খরচ সংরক্ষিত, সংযোগ পেলে সিঙ্ক হবে।\"\n    );\n  }\n\r\n  return (\r\n    <div className=\"space-y-4\">\r\n      <div className=\"relative overflow-hidden rounded-2xl border border-border bg-card shadow-[0_16px_36px_rgba(15,23,42,0.08)] animate-fade-in\">\r\n        <div className=\"pointer-events-none absolute inset-0 bg-gradient-to-br from-warning-soft/60 via-card to-card\" />\r\n        <div className=\"pointer-events-none absolute -top-16 right-0 h-40 w-40 rounded-full bg-warning/20 blur-3xl\" />\r\n        <div className=\"relative space-y-3 p-4\">\r\n          <div className=\"min-w-0 space-y-1\">\r\n            <p className=\"text-[11px] uppercase tracking-[0.22em] text-muted-foreground\">\r\n              খরচ\r\n            </p>\r\n            <h1 className=\"text-2xl font-bold text-foreground leading-tight tracking-tight sm:text-3xl\">\r\n              {headerTitle}\r\n            </h1>\r\n            <p className=\"text-sm text-muted-foreground\">{headerSubtitle}</p>\r\n            {shopLabel ? (\r\n              <p className=\"text-xs text-muted-foreground flex items-center gap-1 min-w-0\">\r\n                দোকান:\r\n                <span className=\"truncate font-semibold text-foreground\">\r\n                  {shopLabel}\r\n                </span>\r\n              </p>\r\n            ) : null}\r\n          </div>\r\n          <div className=\"flex flex-wrap items-center gap-2 text-xs\">\r\n            <span className=\"inline-flex h-7 items-center gap-1 rounded-full bg-card/80 px-3 font-semibold text-foreground border border-border shadow-[0_1px_0_rgba(0,0,0,0.03)]\">\r\n              ভয়েস ইনপুট\r\n            </span>\r\n            <span className=\"inline-flex h-7 items-center gap-1 rounded-full bg-card/80 px-3 font-semibold text-muted-foreground border border-border\">\r\n              স্মার্ট টেমপ্লেট\r\n            </span>\r\n            <span\r\n              className={`inline-flex h-7 items-center gap-1 rounded-full px-3 font-semibold border ${\r\n                online\r\n                  ? \"bg-success-soft text-success border-success/30\"\r\n                  : \"bg-danger-soft text-danger border-danger/30\"\r\n              }`}\r\n            >\r\n              {online ? \"অনলাইন\" : \"অফলাইন\"}\r\n            </span>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      <form onSubmit={handleSubmit} className=\"space-y-4\">\r\n        {/* Amount */}\r\n        <div className=\"rounded-2xl border border-border bg-card p-4 shadow-sm space-y-2\">\r\n          <div className=\"flex items-center justify-between gap-2\">\r\n            <label className=\"block text-base font-medium text-foreground\">\r\n              খরচের পরিমাণ (৳) *\r\n            </label>\r\n            <span className=\"text-xs text-muted-foreground\">ভয়েস/সাজেশন</span>\r\n          </div>\r\n          <div className=\"relative\">\r\n            <input\r\n              name=\"amount\"\r\n              type=\"number\"\r\n              step=\"0.01\"\r\n              min=\"0\"\r\n              value={amount}\r\n              onChange={(e) => setAmount(e.target.value)}\r\n              className=\"w-full h-12 border border-border rounded-xl px-4 pr-16 text-base bg-card shadow-sm focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n              placeholder=\"যেমন: 500, 1000.50\"\r\n              required\r\n            />\r\n            <button\r\n              type=\"button\"\r\n              onClick={listening ? stopVoice : () => startVoice(\"amount\")}\r\n              disabled={!voiceReady}\r\n              aria-label={listening ? \"ভয়েস বন্ধ করুন\" : \"ভয়েস ইনপুট চালু করুন\"}\r\n              className={`absolute right-2 top-1/2 -translate-y-1/2 inline-flex h-9 items-center justify-center rounded-lg border px-3 text-sm font-semibold transition ${\r\n                listening\r\n                  ? \"bg-primary-soft text-primary border-primary/40 animate-pulse\"\r\n                  : \"bg-primary-soft text-primary border-primary/30 active:scale-95\"\r\n              } ${!voiceReady ? \"opacity-60 cursor-not-allowed\" : \"\"}`}\r\n            >\r\n              {listening ? \"🔴\" : \"🎤\"}\r\n            </button>\r\n          </div>\r\n          <p className=\"text-xs text-muted-foreground\">\r\n            {amountVoiceHint}{\" \"}\r\n            {voiceErrorText ? (\r\n              <span className=\"text-danger\">{voiceErrorText}</span>\r\n            ) : null}\r\n          </p>\r\n          {amountOptions.length > 0 && (\r\n            <div className=\"flex flex-wrap gap-2\">\r\n              {amountOptions.slice(0, 6).map((a) => (\r\n                <button\r\n                  key={a}\r\n                  type=\"button\"\r\n                  onClick={() => setAmount(a)}\r\n                  className=\"h-9 px-3 rounded-full border border-primary/30 bg-primary-soft/80 text-primary text-xs font-semibold hover:border-primary/50\"\r\n                >\r\n                  ৳ {a}\r\n                </button>\r\n              ))}\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        {/* Category */}\r\n        <div className=\"rounded-2xl border border-border bg-card p-4 shadow-sm space-y-2\">\r\n          <label className=\"block text-base font-medium text-foreground\">\r\n            খরচের ক্যাটাগরি *\r\n          </label>\r\n          <div className=\"flex flex-wrap gap-2\">\r\n            {categoryOptions.slice(0, 8).map((c) => (\r\n              <button\r\n                key={c}\r\n                type=\"button\"\r\n                onClick={() => setCategory(c)}\r\n                className={`h-9 px-3 rounded-full border text-xs font-semibold ${\r\n                  category === c\r\n                    ? \"bg-primary-soft border-primary/40 text-primary\"\r\n                    : \"bg-card border-border text-foreground hover:border-primary/30\"\r\n                }`}\r\n              >\r\n                {c}\r\n              </button>\r\n            ))}\r\n          </div>\r\n          <input\r\n            name=\"category\"\r\n            value={category}\r\n            onChange={(e) => setCategory(e.target.value)}\r\n            className=\"w-full h-11 border border-border rounded-xl px-4 text-base bg-card shadow-sm focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n            placeholder=\"যেমন: বিদ্যুৎ\"\r\n            required\r\n          />\r\n          <p className=\"text-xs text-muted-foreground\">\r\n            বেশি ব্যবহৃত ক্যাটাগরি উপরে দেখাচ্ছে\r\n          </p>\r\n        </div>\r\n\r\n        {/* Date + Note */}\r\n        <div className=\"rounded-2xl border border-border bg-card p-4 shadow-sm space-y-4\">\r\n          <div className=\"grid gap-4 sm:grid-cols-2\">\r\n            <div className=\"space-y-2\">\r\n              <label className=\"block text-base font-medium text-foreground\">\r\n                তারিখ *\r\n              </label>\r\n              <input\r\n                name=\"expenseDate\"\r\n                type=\"date\"\r\n                value={expenseDate}\r\n                onChange={(e) => setExpenseDate(e.target.value)}\r\n                className=\"w-full h-11 border border-border rounded-xl px-4 text-base bg-card shadow-sm focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n                required\r\n              />\r\n            </div>\r\n            <div className=\"space-y-2 sm:col-span-2\">\r\n              <div className=\"flex items-center justify-between gap-2\">\r\n                <label className=\"block text-base font-medium text-foreground\">\r\n                  নোট (ঐচ্ছিক)\r\n                </label>\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={listening ? stopVoice : () => startVoice(\"note\")}\r\n                  disabled={!voiceReady}\r\n                  aria-label={listening ? \"ভয়েস বন্ধ করুন\" : \"ভয়েস নোট চালু করুন\"}\r\n                  className={`inline-flex h-9 items-center justify-center rounded-lg border px-3 text-sm font-semibold transition ${\r\n                    listening\r\n                      ? \"bg-primary-soft text-primary border-primary/40 animate-pulse\"\r\n                      : \"bg-primary-soft text-primary border-primary/30 active:scale-95\"\r\n                  } ${!voiceReady ? \"opacity-60 cursor-not-allowed\" : \"\"}`}\r\n                >\r\n                  {listening ? \"🔴\" : \"🎤\"}\r\n                </button>\r\n              </div>\r\n              <textarea\r\n                name=\"note\"\r\n                value={note}\r\n                onChange={(e) => setNote(e.target.value)}\r\n                placeholder=\"যেমন: বিল পরিশোধ, রিকশা ভাড়া...\"\r\n                className=\"w-full min-h-[120px] border border-border rounded-xl px-4 py-3 text-base bg-card shadow-sm focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n                rows={4}\r\n              />\r\n              <p className=\"text-xs text-muted-foreground\">\r\n                {noteVoiceHint}{\" \"}\r\n                {voiceErrorText ? (\r\n                  <span className=\"text-danger\">{voiceErrorText}</span>\r\n                ) : null}\r\n              </p>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Recent templates */}\r\n        {recentTemplates.length > 0 && (\r\n          <div className=\"rounded-2xl border border-border bg-card p-4 shadow-sm space-y-2\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <h3 className=\"text-base font-semibold text-foreground\">\r\n                রিসেন্ট খরচ\r\n              </h3>\r\n              <span className=\"text-xs text-muted-foreground\">\r\n                এক ট্যাপে অটো-ফিল\r\n              </span>\r\n            </div>\r\n            <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-2\">\r\n              {recentTemplates.slice(0, 4).map((t) => (\r\n                <button\r\n                  key={`${t.category}-${t.amount}-${t.lastUsed}`}\r\n                  type=\"button\"\r\n                  onClick={() => applyTemplate(t)}\r\n                  className=\"flex items-center justify-between gap-3 bg-card border border-border rounded-xl px-3 py-2 text-left shadow-sm hover:border-primary/40 transition-colors\"\r\n                >\r\n                  <div>\r\n                    <p className=\"font-semibold text-foreground\">{t.category}</p>\r\n                    <p className=\"text-xs text-muted-foreground\">\r\n                      {t.note ? t.note : \"নোট নেই\"}\r\n                    </p>\r\n                  </div>\r\n                  <span className=\"text-sm font-bold text-primary\">\r\n                    ৳ {t.amount}\r\n                  </span>\r\n                </button>\r\n              ))}\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {/* Buttons */}\r\n        <div className=\"rounded-2xl border border-border bg-card p-4 shadow-sm space-y-3\">\r\n          <div className=\"flex flex-col gap-3 sm:flex-row\">\r\n            <button\r\n              type=\"submit\"\r\n              className=\"flex-1 h-14 sm:h-12 rounded-xl bg-gradient-to-r from-primary to-primary-hover text-primary-foreground border border-primary/40 text-base font-semibold shadow-[0_12px_22px_rgba(22,163,74,0.28)] transition hover:brightness-105 active:scale-[0.99] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/40\"\r\n            >\r\n              {submitLabel}\r\n            </button>\r\n            <Link\r\n              href={backHref}\r\n              className=\"flex-1 h-14 sm:h-12 rounded-xl border border-border text-foreground text-base font-semibold hover:bg-muted transition text-center flex items-center justify-center\"\r\n            >\r\n              পিছনে যান\r\n            </Link>\r\n          </div>\r\n        </div>\r\n      </form>\r\n    </div>\r\n  );\r\n}\r\n\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\expenses\\new\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\expenses\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\products\\[id]\\EditProductClient.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\pos\\pos-app-supabase\\app\\dashboard\\products\\[id]\\EditProductClient.tsx:297:5\n  295 |         ? (window as any).SpeechRecognition || (window as any).webkitSpeechRecognition\n  296 |         : null;\n> 297 |     setVoiceReady(Boolean(SpeechRecognitionImpl));\n      |     ^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  298 |\n  299 |     return () => {\n  300 |       recognitionRef.current?.stop?.();","line":297,"column":5,"nodeType":null,"endLine":297,"endColumn":18},{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\pos\\pos-app-supabase\\app\\dashboard\\products\\[id]\\EditProductClient.tsx:310:9\n  308 |     if (stored) {\n  309 |       try {\n> 310 |         setTemplates(JSON.parse(stored) as TemplateItem[]);\n      |         ^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  311 |       } catch {\n  312 |         setTemplates([]);\n  313 |       }","line":310,"column":9,"nodeType":null,"endLine":310,"endColumn":21},{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\pos\\pos-app-supabase\\app\\dashboard\\products\\[id]\\EditProductClient.tsx:324:7\n  322 |       const custom = Array.isArray(parsed) ? parsed : [];\n  323 |       const merged = Array.from(new Set([...baseCategories, ...custom, product.category]));\n> 324 |       setCategoryOptions(merged);\n      |       ^^^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  325 |       setSelectedCategory((prev: string) =>\n  326 |         merged.includes(prev)\n  327 |           ? prev","line":324,"column":7,"nodeType":null,"endLine":324,"endColumn":25},{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\pos\\pos-app-supabase\\app\\dashboard\\products\\[id]\\EditProductClient.tsx:354:7\n  352 |       const merged = Array.from(new Set([...configUnits, ...custom, initialUnit].filter(Boolean)));\n  353 |\n> 354 |       setUnitOptions((prev) => {\n      |       ^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  355 |         const sameLength = prev.length === merged.length;\n  356 |         const sameItems = sameLength && prev.every((v, idx) => v === merged[idx]);\n  357 |         return sameItems ? prev : merged;","line":354,"column":7,"nodeType":null,"endLine":354,"endColumn":21},{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\pos\\pos-app-supabase\\app\\dashboard\\products\\[id]\\EditProductClient.tsx:371:5\n  369 |   // Track stock default\n  370 |   useEffect(() => {\n> 371 |     setStockEnabled(product.trackStock ?? stock.enabledByDefault);\n      |     ^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  372 |   }, [product.trackStock, stock.enabledByDefault, businessType]);\n  373 |\n  374 |   function handleAddCustomCategory() {","line":371,"column":5,"nodeType":null,"endLine":371,"endColumn":20}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// app/dashboard/products/[id]/EditProductClient.tsx\r\n\r\n\"use client\";\r\n\r\nimport { Fragment, useEffect, useMemo, useRef, useState, type JSX } from \"react\";\r\nimport { useOnlineStatus } from \"@/lib/sync/net-status\";\r\nimport { queueAdd } from \"@/lib/sync/queue\";\r\nimport { db, type LocalProduct } from \"@/lib/dexie/db\";\r\nimport { updateProduct } from \"@/app/actions/products\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { useProductFields } from \"@/hooks/useProductFields\";\nimport { type BusinessType, type Field, type BusinessFieldConfig } from \"@/lib/productFormConfig\";\nimport { handlePermissionError } from \"@/lib/permission-toast\";\nimport { safeLocalStorageGet, safeLocalStorageSet } from \"@/lib/storage\";\n\r\ntype Props = {\r\n  product: any;\r\n  shop: { id: string; name: string; businessType?: string | null };\r\n  businessConfig?: BusinessFieldConfig | null;\r\n};\r\n\r\ntype SpeechRecognitionInstance = {\r\n  lang: string;\r\n  interimResults: boolean;\r\n  continuous: boolean;\r\n  start: () => void;\r\n  stop: () => void;\r\n  abort?: () => void;\r\n  onresult: ((event: any) => void) | null;\r\n  onerror: ((event: any) => void) | null;\r\n  onend: (() => void) | null;\r\n};\r\n\r\ntype TemplateItem = {\r\n  name: string;\r\n  category?: string;\r\n  unit?: string;\r\n  price?: string;\r\n  count: number;\r\n  lastUsed: number;\r\n};\r\n\r\nconst TEMPLATE_LIMIT = 25;\r\n\r\nconst KEYWORD_CATEGORY_RULES: { keywords: string[]; category: string }[] = [\r\n  { keywords: [\"চা\", \"কফি\"], category: \"চা/কফি\" },\r\n  { keywords: [\"ডিম\", \"চিনি\", \"তেল\", \"মসলা\", \"আটা\", \"চাল\", \"আলু\"], category: \"মুদি\" },\r\n  { keywords: [\"বিস্কুট\", \"চিপস\", \"চকলেট\", \"নুডলস\"], category: \"স্ন্যাক্স\" },\r\n  { keywords: [\"রিচার্জ\", \"ফ্লেক্সিলোড\", \"টপ আপ\"], category: \"রিচার্জ\" },\r\n  { keywords: [\"ট্যাবলেট\", \"ক্যাপসুল\", \"সিরাপ\", \"প্যারাসিটামল\"], category: \"ঔষধ\" },\r\n  { keywords: [\"টি শার্ট\", \"শার্ট\", \"প্যান্ট\", \"ড্রেস\"], category: \"কাপড়\" },\r\n];\r\n\r\nconst BUSINESS_ASSISTS: Record<\r\n  BusinessType,\r\n  {\r\n    defaultCategory: string;\r\n    fallbackName?: string;\r\n    categoryChips: string[];\r\n    priceHints: string[];\r\n  }\r\n> = {\r\n  tea_stall: {\r\n    defaultCategory: \"চা/কফি\",\r\n    categoryChips: [\"চা/কফি\", \"স্ন্যাক্স\", \"বিস্কুট\"],\r\n    priceHints: [\"5\", \"10\", \"15\", \"20\"],\r\n  },\r\n  pan_cigarette: {\r\n    defaultCategory: \"পান/সিগারেট\",\r\n    categoryChips: [\"পান/সিগারেট\", \"স্ন্যাক্স\", \"রিচার্জ\"],\r\n    priceHints: [\"5\", \"10\", \"12\", \"20\"],\r\n  },\r\n  mobile_recharge: {\r\n    defaultCategory: \"রিচার্জ\",\r\n    categoryChips: [\"রিচার্জ\", \"ডেটা প্যাক\"],\r\n    priceHints: [\"20\", \"50\", \"100\", \"200\"],\r\n    fallbackName: \"Mobile Recharge\",\r\n  },\r\n  fruits_veg: {\r\n    defaultCategory: \"সবজি/ফল\",\r\n    categoryChips: [\"সবজি/ফল\", \"পাতাজাতীয়\", \"মসলা\"],\r\n    priceHints: [\"40\", \"60\", \"80\", \"120\"],\r\n  },\r\n  snacks_stationery: {\r\n    defaultCategory: \"স্ন্যাক্স\",\r\n    categoryChips: [\"স্ন্যাক্স\", \"স্টেশনারি\", \"পানীয়\"],\r\n    priceHints: [\"10\", \"20\", \"30\", \"50\"],\r\n  },\r\n  mini_grocery: {\r\n    defaultCategory: \"মুদি\",\r\n    categoryChips: [\"মুদি\", \"পানীয়\", \"স্ন্যাক্স\"],\r\n    priceHints: [\"50\", \"80\", \"100\", \"120\"],\r\n  },\r\n  clothing: {\r\n    defaultCategory: \"কাপড়\",\r\n    categoryChips: [\"কাপড়\", \"এক্সেসরিজ\"],\r\n    priceHints: [\"150\", \"250\", \"350\", \"500\"],\r\n  },\r\n  cosmetics_gift: {\r\n    defaultCategory: \"কসমেটিকস\",\r\n    categoryChips: [\"কসমেটিকস\", \"গিফট আইটেম\", \"হেয়ার কেয়ার\"],\r\n    priceHints: [\"60\", \"80\", \"120\", \"200\"],\r\n  },\r\n  pharmacy: {\r\n    defaultCategory: \"ঔষধ\",\r\n    categoryChips: [\"ঔষধ\", \"বেবি কেয়ার\", \"হেলথ কেয়ার\"],\r\n    priceHints: [\"5\", \"30\", \"60\", \"120\"],\r\n  },\r\n  mini_wholesale: {\r\n    defaultCategory: \"হোলসেল\",\r\n    categoryChips: [\"হোলসেল\", \"মুদি\", \"স্ন্যাক্স\"],\r\n    priceHints: [\"500\", \"1000\", \"1500\", \"2000\"],\r\n  },\r\n};\r\n\r\n\r\nfunction parseProductText(input: string) {\r\n  const cleaned = input.replace(/টাকা|tk|taka|price/gi, \" \").replace(/:/g, \" \");\r\n  const priceMatch = cleaned.match(/(\\d+(?:[.,]\\d+)?)/);\r\n  const price = priceMatch ? priceMatch[1].replace(\",\", \"\") : null;\r\n  const name = priceMatch\r\n    ? cleaned.replace(priceMatch[0], \" \").replace(/\\s+/g, \" \").trim()\r\n    : cleaned.trim();\r\n  return { name, price: price || undefined };\r\n}\r\n\r\n\r\n\r\nfunction suggestCategoryByName(name: string, businessCategory?: string) {\r\n  const lower = name.toLowerCase();\r\n  for (const rule of KEYWORD_CATEGORY_RULES) {\r\n    if (rule.keywords.some((k) => lower.includes(k.toLowerCase()))) {\r\n      return rule.category;\r\n    }\r\n  }\r\n  return businessCategory;\r\n}\r\n\r\nfunction mergeTemplates(existing: TemplateItem[], incoming: TemplateItem) {\r\n  const idx = existing.findIndex((t) => t.name.toLowerCase() === incoming.name.toLowerCase());\r\n  const next = [...existing];\r\n  if (idx >= 0) {\r\n    const current = next[idx];\r\n    next[idx] = {\r\n      ...current,\r\n      category: incoming.category || current.category,\r\n      unit: incoming.unit || current.unit,\r\n      price: incoming.price || current.price,\r\n      count: current.count + 1,\r\n      lastUsed: incoming.lastUsed,\r\n    };\r\n  } else {\r\n    next.unshift(incoming);\r\n  }\r\n  return next\r\n    .sort((a, b) => b.count - a.count || b.lastUsed - a.lastUsed)\r\n    .slice(0, TEMPLATE_LIMIT);\r\n}\r\n\r\nfunction dedupe(values: string[]) {\r\n  return Array.from(new Set(values.filter(Boolean)));\r\n}\r\n\r\nexport default function EditProductClient({ product, shop, businessConfig }: Props) {\r\n  const router = useRouter();\r\n  const online = useOnlineStatus();\r\n  const businessType = (shop.businessType as BusinessType) || \"tea_stall\";\r\n  const recognitionRef = useRef<SpeechRecognitionInstance | null>(null);\r\n  const templateStorageKey = useMemo(() => `productTemplates:${shop.id}`, [shop.id]);\r\n  const shopId = shop.id;\r\n  const businessAssist = BUSINESS_ASSISTS[businessType];\r\n  const fallbackName = businessAssist?.fallbackName || \"Unnamed product\";\r\n  const {\r\n    isFieldVisible,\r\n    isFieldRequired,\r\n    stock,\r\n    unitOptions: configUnits,\r\n    defaultUnit: configDefaultUnit,\r\n    suggestUnit,\r\n  } = useProductFields(businessType, businessConfig);\r\n  const configUnitsKey = useMemo(() => configUnits.join(\"|\"), [configUnits]);\r\nconst advancedFieldRenderers: Partial<Record<Field, () => JSX.Element>> = {\r\n    buyPrice: () => (\r\n      <div className=\"space-y-2\">\r\n        <label className=\"block text-sm font-semibold text-foreground\">ক্রয়মূল্য (ঐচ্ছিক)</label>\r\n        <input\r\n          name=\"buyPrice\"\r\n          type=\"number\"\r\n          step=\"0.01\"\r\n          min=\"0\"\r\n          required={isFieldRequired(\"buyPrice\")}\r\n          className=\"w-full h-11 rounded-xl border border-border bg-card px-4 text-base shadow-sm focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n          placeholder=\"যেমন: ৫৫.০০\"\r\n          defaultValue={product.buyPrice || \"\"}\r\n        />\r\n        <p className=\"text-sm text-muted-foreground\">চাইলে লাভ হিসাবের জন্য ক্রয়মূল্য দিন</p>\r\n      </div>\r\n    ),\r\n    expiry: () => (\r\n      <div className=\"space-y-2\">\r\n        <label className=\"block text-sm font-semibold text-foreground\">মেয়াদোত্তীর্ণের তারিখ</label>\r\n        <input\r\n          name=\"expiryDate\"\r\n          type=\"date\"\r\n          required={isFieldRequired(\"expiry\")}\r\n          className=\"w-full h-11 rounded-xl border border-border bg-card px-4 text-base shadow-sm focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n          defaultValue={product.expiryDate || \"\"}\r\n        />\r\n      </div>\r\n    ),\r\n    size: () => (\r\n      <div className=\"space-y-2\">\r\n        <label className=\"block text-sm font-semibold text-foreground\">সাইজ / ভ্যারিয়েন্ট</label>\r\n        <input\r\n          name=\"size\"\r\n          type=\"text\"\r\n          required={isFieldRequired(\"size\")}\r\n          className=\"w-full h-11 rounded-xl border border-border bg-card px-4 text-base shadow-sm focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n          placeholder=\"যেমন: L, XL, 100ml\"\r\n          defaultValue={product.size || \"\"}\r\n        />\r\n      </div>\r\n    ),\r\n  };\r\n  const visibleAdvancedFields = ([\"buyPrice\", \"expiry\", \"size\"] as Field[]).filter((field) =>\r\n    isFieldVisible(field)\r\n  );\r\n  const [name, setName] = useState((product.name as string) || fallbackName);\r\n  const [sellPrice, setSellPrice] = useState((product.sellPrice || \"\").toString());\r\n  const [listening, setListening] = useState(false);\r\n  const [voiceReady, setVoiceReady] = useState(false);\r\n  const [voiceError, setVoiceError] = useState<string | null>(null);\r\n  const [templates, setTemplates] = useState<TemplateItem[]>([]);\r\n\r\n  const voiceErrorText = voiceError ? `(${voiceError})` : \"\";\r\n\r\n  \r\n  const templateCategories = useMemo(\r\n    () => dedupe(templates.map((t) => t.category).filter(Boolean) as string[]),\r\n    [templates]\r\n  );\r\n\r\n  const businessCategories = useMemo(\r\n    () =>\r\n      dedupe(\r\n        [businessAssist?.defaultCategory, ...(businessAssist?.categoryChips ?? [])].filter(\r\n          Boolean\r\n        ) as string[]\r\n      ),\r\n    [businessAssist]\r\n  );\r\n\r\n  const baseCategories = useMemo(() => {\r\n    const combined = dedupe([...businessCategories, ...templateCategories, \"Uncategorized\"]);\r\n    return combined.length ? combined : [\"Uncategorized\"];\r\n  }, [businessCategories, templateCategories]);\r\n\r\n  const unitLabels = useMemo(\r\n    () => ({\r\n      pcs: \"পিস\",\r\n      packet: \"প্যাকেট\",\r\n      box: \"বক্স\",\r\n      dozen: \"ডজন\",\r\n      kg: \"কেজি\",\r\n      gm: \"গ্রাম\",\r\n      liter: \"লিটার\",\r\n      ml: \"মিলি\",\r\n      ft: \"ফুট\",\r\n      strip: \"স্ট্রিপ\",\r\n      carton: \"কার্টন\",\r\n    }),\r\n    []\r\n  );\r\n\r\n  const [categoryOptions, setCategoryOptions] = useState<string[]>(baseCategories);\r\n  const [selectedCategory, setSelectedCategory] = useState(\r\n    (product.category && baseCategories.includes(product.category)\r\n      ? product.category\r\n      : businessAssist?.defaultCategory && baseCategories.includes(businessAssist.defaultCategory)\r\n      ? businessAssist.defaultCategory\r\n      : baseCategories[0]) || \"Uncategorized\"\r\n  );\r\n  const [unitOptions, setUnitOptions] = useState<string[]>(configUnits);\r\n  const [selectedUnit, setSelectedUnit] = useState(\r\n    product.baseUnit || configDefaultUnit || configUnits[0] || \"pcs\"\r\n  );\r\n  const [stockEnabled, setStockEnabled] = useState(\r\n    product.trackStock ?? stock.enabledByDefault\r\n  );\r\n\r\n  // Voice availability\r\n  useEffect(() => {\r\n    const SpeechRecognitionImpl =\r\n      typeof window !== \"undefined\"\r\n        ? (window as any).SpeechRecognition || (window as any).webkitSpeechRecognition\r\n        : null;\r\n    setVoiceReady(Boolean(SpeechRecognitionImpl));\r\n\r\n    return () => {\r\n      recognitionRef.current?.stop?.();\r\n    };\r\n  }, []);\r\n\r\n  // Load templates\r\n  useEffect(() => {\n    if (!templateStorageKey) return;\n    const stored = safeLocalStorageGet(templateStorageKey);\n    if (stored) {\n      try {\n        setTemplates(JSON.parse(stored) as TemplateItem[]);\n      } catch {\n        setTemplates([]);\r\n      }\r\n    }\r\n  }, [templateStorageKey]);\r\n\r\n  // Load categories\r\n  useEffect(() => {\n    try {\n      const stored = safeLocalStorageGet(`customCategories:${shopId}`);\n      const parsed = stored ? (JSON.parse(stored) as string[]) : [];\n      const custom = Array.isArray(parsed) ? parsed : [];\n      const merged = Array.from(new Set([...baseCategories, ...custom, product.category]));\r\n      setCategoryOptions(merged);\r\n      setSelectedCategory((prev: string) =>\r\n        merged.includes(prev)\r\n          ? prev\r\n          : businessAssist?.defaultCategory && merged.includes(businessAssist.defaultCategory)\r\n          ? businessAssist.defaultCategory\r\n          : merged[0] || \"Uncategorized\"\r\n      );\r\n    } catch (err) {\r\n      handlePermissionError(err);\r\n      console.error(\"Failed to load custom categories\", err);\r\n      setCategoryOptions(baseCategories);\r\n      setSelectedCategory(\r\n        (businessAssist?.defaultCategory && baseCategories.includes(businessAssist.defaultCategory)\r\n          ? businessAssist.defaultCategory\r\n          : baseCategories[0]) || \"Uncategorized\"\r\n      );\r\n    }\r\n  }, [baseCategories, businessAssist, product.category, shopId]);\r\n\r\n  // Load units (guard against infinite re-renders)\r\n  useEffect(() => {\n    try {\n      const stored = safeLocalStorageGet(`customUnits:${shopId}`);\n      const parsed = stored ? (JSON.parse(stored) as string[]) : [];\n      const custom = Array.isArray(parsed) ? parsed : [];\n\r\n      const initialUnit = product.baseUnit || configDefaultUnit || configUnits[0] || \"pcs\";\r\n      const merged = Array.from(new Set([...configUnits, ...custom, initialUnit].filter(Boolean)));\r\n\r\n      setUnitOptions((prev) => {\r\n        const sameLength = prev.length === merged.length;\r\n        const sameItems = sameLength && prev.every((v, idx) => v === merged[idx]);\r\n        return sameItems ? prev : merged;\r\n      });\r\n\r\n      setSelectedUnit((prev: string) => (merged.includes(prev) ? prev : initialUnit));\r\n    } catch (err) {\r\n      handlePermissionError(err);\r\n      console.error(\"Failed to load custom units\", err);\r\n      setUnitOptions((prev) => (prev.length ? prev : configUnits));\r\n      setSelectedUnit((prev: string) => (prev ? prev : configDefaultUnit || configUnits[0] || \"pcs\"));\r\n    }\r\n  }, [shopId, configUnitsKey, configDefaultUnit, product.baseUnit, configUnits]);\r\n\r\n  // Track stock default\r\n  useEffect(() => {\r\n    setStockEnabled(product.trackStock ?? stock.enabledByDefault);\r\n  }, [product.trackStock, stock.enabledByDefault, businessType]);\r\n\r\n  function handleAddCustomCategory() {\r\n    const input = prompt(\"নতুন ক্যাটাগরি যোগ করুন\");\r\n    if (!input) return;\r\n    const value = input.toString().trim();\r\n    if (!value) return;\r\n\r\n    const merged = Array.from(new Set([...categoryOptions, value]));\r\n    setCategoryOptions(merged);\r\n    setSelectedCategory(value);\r\n\r\n    const customOnly = merged.filter((c) => !baseCategories.includes(c));\r\n    safeLocalStorageSet(\n      `customCategories:${shopId}`,\n      JSON.stringify(customOnly)\n    );\n  }\r\n\r\n  function handleAddCustomUnit() {\r\n    const input = prompt(\"নতুন ইউনিট লিখুন\");\r\n    if (!input) return;\r\n    const value = input.toString().trim().toLowerCase();\r\n    if (!value) return;\r\n\r\n    const merged = Array.from(new Set([...unitOptions, value]));\r\n    setUnitOptions(merged);\r\n    setSelectedUnit(value);\r\n\r\n    const customOnly = merged.filter((u) => !configUnits.includes(u));\r\n    safeLocalStorageSet(`customUnits:${shopId}`, JSON.stringify(customOnly));\n  }\r\n\r\n  function setNameWithSmartDefaults(raw: string) {\r\n    const parsed = parseProductText(raw);\r\n    const finalName = parsed.name || raw;\r\n\r\n    if (isFieldVisible(\"name\")) {\r\n      setName(finalName);\r\n    } else if (!name) {\r\n      setName(fallbackName || finalName);\r\n    }\r\n\r\n    if (parsed.price) {\r\n      setSellPrice(parsed.price);\r\n    }\r\n\r\n    if (isFieldVisible(\"unit\")) {\r\n      const suggested = suggestUnit(finalName, unitOptions);\r\n      if (suggested) {\r\n        setUnitOptions((prev) => (prev.includes(suggested) ? prev : [...prev, suggested]));\r\n        setSelectedUnit(suggested);\r\n      }\r\n    }\r\n\r\n    const byCategory = suggestCategoryByName(finalName, businessAssist?.defaultCategory);\r\n    if (byCategory) {\r\n      setCategoryOptions((prev) => (prev.includes(byCategory) ? prev : [...prev, byCategory]));\r\n      setSelectedCategory(byCategory);\r\n    }\r\n  }\r\n\r\n  function handleVoiceResult(spoken: string) {\r\n    const parsed = parseProductText(spoken);\r\n    const finalName = parsed.name || spoken;\r\n    setNameWithSmartDefaults(finalName);\r\n    if (parsed.price) {\r\n      setSellPrice(parsed.price);\r\n    }\r\n  }\r\n\r\n  function startVoice() {\r\n    if (listening) return;\r\n    const SpeechRecognitionImpl =\r\n      typeof window !== \"undefined\"\r\n        ? ((window as any).SpeechRecognition ||\r\n            (window as any).webkitSpeechRecognition)\r\n        : null;\r\n\r\n    if (!SpeechRecognitionImpl) {\r\n      setVoiceReady(false);\r\n      setVoiceError(\"ব্রাউজার মাইক্রোফোন সাপোর্ট দিচ্ছে না\");\r\n      return;\r\n    }\r\n\r\n    const recognition: SpeechRecognitionInstance = new SpeechRecognitionImpl();\r\n    recognition.lang = \"bn-BD\";\r\n    recognition.interimResults = false;\r\n    recognition.continuous = false;\r\n    recognition.onerror = () => {\r\n      setListening(false);\r\n      setVoiceError(\"মাইক্রোফোন অ্যাক্সেস মেলেনি\");\r\n    };\r\n    recognition.onend = () => setListening(false);\r\n    recognition.onresult = (event: any) => {\r\n      const spoken: string | undefined = event?.results?.[0]?.[0]?.transcript;\r\n      if (spoken) {\r\n        handleVoiceResult(spoken);\r\n      }\r\n      setListening(false);\r\n    };\r\n\r\n    recognitionRef.current = recognition;\r\n    setVoiceError(null);\r\n    setListening(true);\r\n    recognition.start();\r\n  }\r\n\r\n  function stopVoice() {\r\n    recognitionRef.current?.stop?.();\r\n    setListening(false);\r\n  }\r\n\r\n  const frequentTemplates = useMemo(\r\n    () => templates.slice().sort((a, b) => b.count - a.count || b.lastUsed - a.lastUsed),\r\n    [templates]\r\n  );\r\n\r\n  const recentTemplates = useMemo(\r\n    () => templates.slice().sort((a, b) => b.lastUsed - a.lastUsed),\r\n    [templates]\r\n  );\r\n\r\n  const smartNameSuggestions = useMemo(() => {\r\n    const topTemplates = frequentTemplates.slice(0, 6).map((t) => t.name);\r\n    const latest = recentTemplates.slice(0, 6).map((t) => t.name);\r\n    return dedupe([...topTemplates, ...latest]).slice(0, 8);\r\n  }, [frequentTemplates, recentTemplates]);\r\n\r\n  const priceSuggestions = useMemo(() => {\r\n    const templatePrices = dedupe(\r\n      recentTemplates\r\n        .map((t) => t.price)\r\n        .filter(Boolean)\r\n        .map((p) => p as string)\r\n    );\r\n    const hints = businessAssist?.priceHints ?? [];\r\n    return dedupe([...templatePrices, ...hints]).slice(0, 6);\r\n  }, [recentTemplates, businessAssist]);\r\n\r\n  function applyTemplate(item: TemplateItem) {\r\n    setNameWithSmartDefaults(item.name);\r\n    if (item.price) setSellPrice(item.price);\r\n    if (item.unit && isFieldVisible(\"unit\")) {\r\n      setUnitOptions((prev) => (prev.includes(item.unit!) ? prev : [...prev, item.unit!]));\r\n      setSelectedUnit(item.unit);\r\n    }\r\n    if (item.category) {\r\n      setCategoryOptions((prev) => (prev.includes(item.category!) ? prev : [...prev, item.category!]));\r\n      setSelectedCategory(item.category);\r\n    }\r\n  }\r\n\r\n  async function handleSubmit(e: any) {\r\n    e.preventDefault();\r\n\r\n    const form = new FormData(e.target);\r\n\r\n    const buyPriceRaw = form.get(\"buyPrice\") as string;\r\n    const buyPrice = isFieldVisible(\"buyPrice\")\r\n      ? buyPriceRaw && buyPriceRaw.toString().trim() !== \"\"\r\n        ? (buyPriceRaw as string)\r\n        : null\r\n      : null;\r\n\r\n    const baseUnit = isFieldVisible(\"unit\")\r\n      ? ((form.get(\"baseUnit\") as string) || configDefaultUnit || configUnits[0] || \"pcs\")\r\n      : undefined;\r\n\r\n    const stockQty = stockEnabled ? ((form.get(\"stockQty\") as string) || \"0\") : \"0\";\r\n\r\n    const expiryDate = isFieldVisible(\"expiry\")\r\n      ? ((form.get(\"expiryDate\") as string) || null)\r\n      : null;\r\n\r\n    const size = isFieldVisible(\"size\")\r\n      ? ((form.get(\"size\") as string) || \"\").toString().trim() || null\r\n      : null;\r\n\r\n    const resolvedSellPrice = (form.get(\"sellPrice\") as string) || sellPrice;\r\n    const resolvedName = isFieldVisible(\"name\")\r\n      ? (form.get(\"name\") as string) || name || fallbackName\r\n      : name || fallbackName || (resolvedSellPrice ? `Item ${resolvedSellPrice}` : \"Unnamed product\");\r\n\r\n    const payload: LocalProduct = {\r\n      ...product,\r\n      shopId: shopId,\r\n      name: resolvedName,\r\n      category: selectedCategory || \"Uncategorized\",\r\n      baseUnit,\r\n      buyPrice,\r\n      sellPrice: resolvedSellPrice,\r\n      stockQty,\r\n      isActive: form.get(\"isActive\") === \"on\",\r\n      trackStock: stockEnabled,\r\n      businessType,\r\n      expiryDate,\r\n      size,\r\n      updatedAt: Date.now(),\r\n      syncStatus: \"updated\",\r\n    };\r\n\r\n    const template: TemplateItem = {\r\n      name: payload.name,\r\n      category: payload.category,\r\n      unit: payload.baseUnit,\r\n      price: payload.sellPrice,\r\n      count: 1,\r\n      lastUsed: Date.now(),\r\n    };\r\n    setTemplates((prev) => {\r\n      const merged = mergeTemplates(prev, template);\r\n      safeLocalStorageSet(templateStorageKey, JSON.stringify(merged));\n      return merged;\r\n    });\r\n\r\n    if (online) {\n      await updateProduct(product.id, payload);\n      alert(\"পণ্য সফলভাবে আপডেট হয়েছে\");\n    } else {\n      await db.transaction(\"rw\", db.products, db.queue, async () => {\n        await db.products.put(payload);\n        await queueAdd(\"product\", \"update\", payload);\n      });\n      alert(\"পণ্য অফলাইনে আপডেট; অনলাইনে হলে সিঙ্ক হবে\");\n    }\n\r\n    router.push(`/dashboard/products?shopId=${shopId}`);\r\n  }\r\n\r\n  return (\r\n    <div className=\"max-w-2xl mx-auto space-y-4\">\r\n      \r\n      <div className=\"mb-8\">\r\n        <h1 className=\"text-3xl font-bold text-foreground\">পণ্য তথ্য সম্পাদনা</h1>\r\n        <p className=\"text-muted-foreground mt-2\">ভয়েস + অটো সাজেশন দিয়ে দ্রুত আপডেট</p>\r\n        <p className=\"text-sm text-muted-foreground mt-1\">দোকান: {shop.name}</p>\r\n      </div>\r\n\r\n      <form onSubmit={handleSubmit} className=\"rounded-2xl border border-border bg-card p-4 sm:p-6 space-y-4 shadow-sm\">\r\n        \r\n        {/* Product Name */}\r\n        {isFieldVisible(\"name\") && (\r\n          <div className=\"space-y-2\">\r\n            <label className=\"block text-sm font-semibold text-foreground\">পণ্যের নাম *</label>\r\n            <div className=\"relative\">\r\n              <input\r\n                name=\"name\"\r\n                value={name}\r\n                onChange={(e) => setNameWithSmartDefaults(e.target.value)}\r\n                className=\"w-full h-12 rounded-xl border border-border bg-card px-4 pr-16 text-base shadow-sm focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n                placeholder=\"যেমন: চা, ডিম, বিস্কুট...\"\r\n                required={isFieldRequired(\"name\")}\r\n                autoComplete=\"off\"\r\n              />\r\n              <button\r\n                type=\"button\"\r\n                onClick={listening ? stopVoice : startVoice}\r\n                disabled={!voiceReady}\r\n                aria-label={listening ? \"ভয়েস বন্ধ করুন\" : \"ভয়েস ইনপুট চালু করুন\"}\r\n                  className={`absolute right-2 top-1/2 -translate-y-1/2 inline-flex h-9 items-center justify-center rounded-xl border px-3 text-sm font-semibold transition ${\r\n                    listening\r\n                      ? \"bg-primary-soft text-primary border-primary/40 animate-pulse\"\r\n                      : \"bg-primary-soft text-primary border-primary/30 active:scale-95\"\r\n                  } ${!voiceReady ? \"opacity-60 cursor-not-allowed\" : \"\"}`}\r\n              >\r\n                {listening ? \"🔴\" : \"🎤\"}\r\n              </button>\r\n            </div>\r\n            <p className=\"text-xs text-muted-foreground\">\r\n              {listening\r\n                ? \"শুনছি... নাম আর দাম বলুন\"\r\n                : voiceReady\r\n                ? \"ভয়েসে নাম/দাম বললে অটো পূরণ হবে\"\r\n                : \"এই ডিভাইসে ভয়েস সাপোর্ট নেই\"}{\" \"}\r\n              {voiceErrorText}\r\n            </p>\r\n            {smartNameSuggestions.length > 0 && (\r\n              <div className=\"flex flex-wrap gap-2 pt-1\">\r\n                {smartNameSuggestions.map((title) => (\r\n                  <button\r\n                    key={title}\r\n                    type=\"button\"\r\n                    onClick={() => setNameWithSmartDefaults(title)}\r\n                    className=\"h-9 px-3 rounded-full border border-primary/30 text-primary bg-primary-soft text-xs font-semibold hover:border-primary/50\"\r\n                  >\r\n                    {title}\r\n                  </button>\r\n                ))}\r\n              </div>\r\n            )}\r\n          </div>\r\n        )}\r\n\r\n        {/* Sell Price */}\r\n        <div className=\"space-y-2\">\r\n          <label className=\"block text-sm font-semibold text-foreground\">বিক্রয় মূল্য (৳) *</label>\r\n          <input\r\n            name=\"sellPrice\"\r\n            type=\"number\"\r\n            step=\"0.01\"\r\n            min=\"0\"\r\n            value={sellPrice}\r\n            onChange={(e) => setSellPrice(e.target.value)}\r\n            className=\"w-full h-11 rounded-xl border border-border bg-card px-4 text-base shadow-sm focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n            placeholder=\"যেমন: ১০, ২৫.৫০\"\r\n            required={isFieldRequired(\"sellPrice\")}\r\n          />\r\n          {priceSuggestions.length > 0 && (\r\n            <div className=\"flex flex-wrap gap-2\">\r\n              {priceSuggestions.map((p) => (\r\n                <button\r\n                  key={p}\r\n                  type=\"button\"\r\n                  onClick={() => setSellPrice(p)}\r\n                  className=\"h-9 px-3 rounded-full border border-primary/30 bg-primary-soft text-primary text-sm hover:border-primary/50\"\r\n                >\r\n                  ৳ {p}\r\n                </button>\r\n              ))}\r\n            </div>\r\n          )}\r\n          <p className=\"text-sm text-muted-foreground\">নাম বললেই দাম ধরার চেষ্টা করবে</p>\r\n        </div>\r\n\r\n        {/* Category */}\r\n        <div className=\"space-y-2\">\r\n          <label className=\"block text-sm font-semibold text-foreground\">ক্যাটাগরি</label>\r\n          <div className=\"flex gap-3\">\r\n            <select\r\n              name=\"category\"\r\n              value={selectedCategory}\r\n              onChange={(e) => setSelectedCategory(e.target.value)}\r\n              className=\"w-full h-11 rounded-xl border border-border bg-card px-4 text-base shadow-sm focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n            >\r\n              <option value=\"\">ক্যাটাগরি বাছাই করুন</option>\r\n              {categoryOptions.map((c) => (\r\n                <option key={c} value={c}>\r\n                  {c}\r\n                </option>\r\n              ))}\r\n            </select>\r\n            <button\r\n              type=\"button\"\r\n              onClick={handleAddCustomCategory}\r\n              className=\"shrink-0 h-11 px-4 border border-border rounded-xl text-sm font-semibold text-foreground hover:bg-muted transition-colors\"\r\n            >\r\n              + কাস্টম যোগ করুন\r\n            </button>\r\n          </div>\r\n          {businessAssist?.categoryChips?.length ? (\r\n            <div className=\"flex flex-wrap gap-2\">\r\n              {businessAssist.categoryChips.map((c) => (\r\n                <button\r\n                  key={c}\r\n                  type=\"button\"\r\n                  onClick={() => {\r\n                    setCategoryOptions((prev) => (prev.includes(c) ? prev : [...prev, c]));\r\n                    setSelectedCategory(c);\r\n                  }}\r\n                  className=\"h-9 px-3 rounded-full border border-primary/30 text-primary bg-primary-soft text-sm hover:border-primary/50\"\r\n                >\r\n                  {c}\r\n                </button>\r\n              ))}\r\n            </div>\r\n          ) : null}\r\n          <p className=\"text-sm text-muted-foreground\">নাম/ভয়েস থেকে ক্যাটাগরি অনুমান করার চেষ্টা করবে</p>\r\n        </div>\r\n\r\n        {/* Unit */}\r\n        {isFieldVisible(\"unit\") && (\r\n          <div className=\"space-y-2\">\r\n            <label className=\"block text-sm font-semibold text-foreground\">ইউনিট</label>\r\n            <div className=\"flex gap-3\">\r\n              <select\r\n                name=\"baseUnit\"\r\n                value={selectedUnit}\r\n                onChange={(e) => setSelectedUnit(e.target.value)}\r\n                required={isFieldRequired(\"unit\")}\r\n                className=\"w-full h-11 rounded-xl border border-border bg-card px-4 text-base shadow-sm focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n              >\r\n                {unitOptions.map((u) => (\r\n                  <option key={u} value={u}>\r\n                    {unitLabels[u as keyof typeof unitLabels] || u}\r\n                  </option>\r\n                ))}\r\n              </select>\r\n              <button\r\n                type=\"button\"\r\n                onClick={handleAddCustomUnit}\r\n                className=\"shrink-0 h-11 px-4 border border-border rounded-xl text-sm font-semibold text-foreground hover:bg-muted transition-colors\"\r\n              >\r\n                + কাস্টম যোগ করুন\r\n              </button>\r\n            </div>\r\n            <div className=\"flex flex-wrap gap-2\">\r\n              {unitOptions.slice(0, 5).map((u) => (\r\n                <button\r\n                  key={u}\r\n                  type=\"button\"\r\n                  onClick={() => setSelectedUnit(u)}\r\n                  className=\"h-9 px-3 rounded-full border border-primary/30 text-primary bg-primary-soft text-sm hover:border-primary/50\"\r\n                >\r\n                  {unitLabels[u as keyof typeof unitLabels] || u}\r\n                </button>\r\n              ))}\r\n            </div>\r\n            <p className=\"text-sm text-muted-foreground\">নাম থেকেই ইউনিট অনুমান হবে: ডিম → পিস, তেল → লিটার</p>\r\n          </div>\r\n        )}\r\n\r\n        {/* Stock toggle & qty */}\r\n        <div className=\"space-y-2\">\r\n          <label className=\"flex items-center gap-3 cursor-pointer\">\r\n            <input \r\n              type=\"checkbox\" \r\n              checked={stockEnabled}\r\n              onChange={(e) => setStockEnabled(e.target.checked)}\r\n              className=\"w-5 h-5 border border-border rounded cursor-pointer\"\r\n            />\r\n            <span className=\"text-sm font-semibold text-foreground\">স্টক ট্র্যাক (অন/অফ)</span>\r\n          </label>\r\n          <div className=\"pt-2\">\r\n            <input\r\n              name=\"stockQty\"\r\n              type=\"number\"\r\n              step=\"0.01\"\r\n              min=\"0\"\r\n              defaultValue={product.stockQty || \"0\"}\r\n              required={stockEnabled && stock.requiredWhenEnabled}\r\n              disabled={!stockEnabled}\r\n              className=\"w-full h-11 rounded-xl border border-border bg-card px-4 text-base shadow-sm focus:outline-none focus:ring-2 focus:ring-primary/30 disabled:bg-muted disabled:text-muted-foreground\"\r\n              placeholder=\"যেমন: 10, 5.50\"\r\n            />\r\n          </div>\r\n        </div>\r\n\r\n        {/* Advanced */}\r\n        {visibleAdvancedFields.length > 0 && (\r\n          <details className=\"rounded-2xl border border-border bg-muted/60 p-4\">\r\n            <summary className=\"cursor-pointer text-base font-semibold text-foreground\">\r\n              অ্যাডভান্সড অপশন (ঐচ্ছিক)\r\n            </summary>\r\n            <div className=\"mt-4 space-y-4\">\r\n              {visibleAdvancedFields.map((field) => (\r\n                <Fragment key={field}>{advancedFieldRenderers[field]?.()}</Fragment>\r\n              ))}\r\n            </div>\r\n          </details>\r\n        )}\r\n\r\n        {/* Active Status */}\r\n        <div className=\"space-y-2\">\r\n          <label className=\"flex items-center gap-3 cursor-pointer\">\r\n            <input \r\n              type=\"checkbox\" \r\n              name=\"isActive\" \r\n              defaultChecked={product.isActive !== false}\r\n              className=\"w-5 h-5 border border-border rounded cursor-pointer\"\r\n            />\r\n            <span className=\"text-sm font-semibold text-foreground\">পণ্য সক্রিয় রাখুন</span>\r\n          </label>\r\n        </div>\r\n\r\n        {/* Recent templates */}\r\n        {recentTemplates.length > 0 && (\r\n          <div className=\"rounded-2xl border border-border bg-card p-4 space-y-2 shadow-sm\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <h3 className=\"text-base font-semibold text-foreground\">রিসেন্ট টেমপ্লেট</h3>\r\n              <span className=\"text-xs text-muted-foreground\">এক ট্যাপে অটো-ফিল</span>\r\n            </div>\r\n            <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-2\">\r\n              {recentTemplates.slice(0, 4).map((t) => (\r\n                <button\r\n                  key={`${t.name}-${t.lastUsed}`}\r\n                  type=\"button\"\r\n                  onClick={() => applyTemplate(t)}\r\n                  className=\"flex items-center justify-between gap-3 bg-card border border-border rounded-xl px-3 py-2 text-left hover:border-primary/40 transition-colors\"\r\n                >\r\n                  <div>\r\n                    <p className=\"font-semibold text-foreground\">{t.name}</p>\r\n                    <p className=\"text-xs text-muted-foreground\">\r\n                      {t.category || \"ক্যাটাগরি নেই\"} • {t.unit || \"ইউনিট নেই\"}\r\n                    </p>\r\n                  </div>\r\n                  {t.price ? (\r\n                    <span className=\"text-sm font-bold text-primary\">৳ {t.price}</span>\r\n                  ) : null}\r\n                </button>\r\n              ))}\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {/* Buttons */}\r\n        <div className=\"flex gap-3 pt-4\">\r\n          <button\r\n            type=\"submit\"\r\n            className=\"flex-1 h-14 sm:h-12 rounded-xl bg-gradient-to-r from-primary to-primary-hover text-primary-foreground border border-primary/40 text-base font-semibold shadow-[0_12px_22px_rgba(22,163,74,0.28)] transition hover:brightness-105 active:scale-[0.99] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/40\"\r\n          >\r\n            ✓ পণ্য আপডেট করুন\r\n          </button>\r\n          <button \r\n            type=\"button\"\r\n            onClick={() => router.back()}\r\n            className=\"flex-1 h-14 sm:h-12 rounded-xl border border-border text-foreground text-base font-semibold hover:bg-muted transition-colors flex items-center justify-center\"\r\n          >\r\n            পিছনে যান\r\n          </button>\r\n        </div>\r\n      </form>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\products\\[id]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\products\\components\\ProductsListClient.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\products\\new\\ProductFormClient.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\pos\\pos-app-supabase\\app\\dashboard\\products\\new\\ProductFormClient.tsx:317:5\n  315 |   // Reset stock/unit when business type changes\n  316 |   useEffect(() => {\n> 317 |     setStockEnabled((prev) =>\n      |     ^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  318 |       prev === stock.enabledByDefault ? prev : stock.enabledByDefault\n  319 |     );\n  320 |","line":317,"column":5,"nodeType":null,"endLine":317,"endColumn":20},{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\pos\\pos-app-supabase\\app\\dashboard\\products\\new\\ProductFormClient.tsx:359:5\n  357 |         ? (window as any).SpeechRecognition || (window as any).webkitSpeechRecognition\n  358 |         : null;\n> 359 |     setVoiceReady(Boolean(SpeechRecognitionImpl));\n      |     ^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  360 |\n  361 |     return () => {\n  362 |       recognitionRef.current?.stop?.();","line":359,"column":5,"nodeType":null,"endLine":359,"endColumn":18},{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\pos\\pos-app-supabase\\app\\dashboard\\products\\new\\ProductFormClient.tsx:366:5\n  364 |   }, []);\n  365 |   useEffect(() => {\n> 366 |     setIsMounted(true);\n      |     ^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  367 |   }, []);\n  368 |\n  369 |   // Load recent/frequent templates","line":366,"column":5,"nodeType":null,"endLine":366,"endColumn":17},{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\pos\\pos-app-supabase\\app\\dashboard\\products\\new\\ProductFormClient.tsx:376:9\n  374 |       try {\n  375 |         const parsed = JSON.parse(stored) as TemplateItem[];\n> 376 |         setTemplates(parsed);\n      |         ^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  377 |       } catch {\n  378 |         setTemplates([]);\n  379 |       }","line":376,"column":9,"nodeType":null,"endLine":376,"endColumn":21},{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\pos\\pos-app-supabase\\app\\dashboard\\products\\new\\ProductFormClient.tsx:390:7\n  388 |       const custom = Array.isArray(parsed) ? parsed : [];\n  389 |       const merged = Array.from(new Set([...baseCategories, ...custom]));\n> 390 |       setCategoryOptions(merged);\n      |       ^^^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  391 |       setSelectedCategory((prev) =>\n  392 |         merged.includes(prev)\n  393 |           ? prev","line":390,"column":7,"nodeType":null,"endLine":390,"endColumn":25},{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\pos\\pos-app-supabase\\app\\dashboard\\products\\new\\ProductFormClient.tsx:420:7\n  418 |       const merged = Array.from(new Set([...configUnits, ...custom]));\n  419 |\n> 420 |       setUnitOptions((prev) => {\n      |       ^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  421 |         const sameLength = prev.length === merged.length;\n  422 |         const sameItems = sameLength && prev.every((v, idx) => v === merged[idx]);\n  423 |         return sameItems ? prev : merged;","line":420,"column":7,"nodeType":null,"endLine":420,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\n// app/dashboard/products/new/ProductFormClient.tsx\r\n\r\n\"use client\";\r\n\r\nimport {\r\n  Fragment,\r\n  Suspense,\r\n  type ReactElement,\r\n  useEffect,\r\n  useMemo,\r\n  useRef,\r\n  useState,\r\n} from \"react\";\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\";\r\nimport { useOnlineStatus } from \"@/lib/sync/net-status\";\r\nimport { queueAdd } from \"@/lib/sync/queue\";\r\nimport { db, type LocalProduct } from \"@/lib/dexie/db\";\r\nimport { createProduct } from \"@/app/actions/products\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { useProductFields } from \"@/hooks/useProductFields\";\nimport { type BusinessType, type Field, type BusinessFieldConfig } from \"@/lib/productFormConfig\";\nimport { emitProductEvent } from \"@/lib/products/product-events\";\nimport { toast } from \"sonner\";\nimport { handlePermissionError } from \"@/lib/permission-toast\";\nimport { safeLocalStorageGet, safeLocalStorageSet } from \"@/lib/storage\";\n\r\ntype Props = {\r\n  shop: { id: string; name: string; businessType?: string | null };\r\n  businessConfig?: BusinessFieldConfig | null;\r\n};\r\n\r\ntype SpeechRecognitionInstance = {\r\n  lang: string;\r\n  interimResults: boolean;\r\n  continuous: boolean;\r\n  start: () => void;\r\n  stop: () => void;\r\n  abort?: () => void;\r\n  onresult: ((event: any) => void) | null;\r\n  onerror: ((event: any) => void) | null;\r\n  onend: (() => void) | null;\r\n};\r\n\r\ntype TemplateItem = {\r\n  name: string;\r\n  category?: string;\r\n  unit?: string;\r\n  price?: string;\r\n  count: number;\r\n  lastUsed: number;\r\n};\r\n\r\nconst TEMPLATE_LIMIT = 25;\r\n\r\nconst KEYWORD_CATEGORY_RULES: { keywords: string[]; category: string }[] = [\r\n  { keywords: [\"চা\", \"কফি\"], category: \"চা/কফি\" },\r\n  { keywords: [\"ডিম\", \"চিনি\", \"তেল\", \"মসলা\", \"আটা\", \"চাল\", \"আলু\"], category: \"মুদি\" },\r\n  { keywords: [\"বিস্কুট\", \"চিপস\", \"চকলেট\", \"নুডলস\"], category: \"স্ন্যাক্স\" },\r\n  { keywords: [\"রিচার্জ\", \"ফ্লেক্সিলোড\", \"টপ আপ\"], category: \"রিচার্জ\" },\r\n  { keywords: [\"ট্যাবলেট\", \"ক্যাপসুল\", \"সিরাপ\", \"প্যারাসিটামল\"], category: \"ঔষধ\" },\r\n  { keywords: [\"টি শার্ট\", \"শার্ট\", \"প্যান্ট\", \"ড্রেস\"], category: \"কাপড়\" },\r\n];\r\n\r\nconst BUSINESS_ASSISTS: Record<\r\n  BusinessType,\r\n  {\r\n    defaultCategory: string;\r\n    fallbackName?: string;\r\n    quickNames: string[];\r\n    categoryChips: string[];\r\n    priceHints: string[];\r\n  }\r\n> = {\r\n  tea_stall: {\r\n    defaultCategory: \"চা/কফি\",\r\n    quickNames: [],\r\n    categoryChips: [\"চা/কফি\", \"স্ন্যাক্স\", \"বিস্কুট\"],\r\n    priceHints: [\"5\", \"10\", \"15\", \"20\"],\r\n  },\r\n  pan_cigarette: {\r\n    defaultCategory: \"পান/সিগারেট\",\r\n    quickNames: [],\r\n    categoryChips: [\"পান/সিগারেট\", \"স্ন্যাক্স\", \"রিচার্জ\"],\r\n    priceHints: [\"5\", \"10\", \"12\", \"20\"],\r\n  },\r\n  mobile_recharge: {\r\n    defaultCategory: \"রিচার্জ\",\r\n    quickNames: [],\r\n    categoryChips: [\"রিচার্জ\", \"ডেটা প্যাক\"],\r\n    priceHints: [\"20\", \"50\", \"100\", \"200\"],\r\n    fallbackName: \"Mobile Recharge\",\r\n  },\r\n  fruits_veg: {\r\n    defaultCategory: \"সবজি/ফল\",\r\n    quickNames: [],\r\n    categoryChips: [\"সবজি/ফল\", \"পাতাজাতীয়\", \"মসলা\"],\r\n    priceHints: [\"40\", \"60\", \"80\", \"120\"],\r\n  },\r\n  snacks_stationery: {\r\n    defaultCategory: \"স্ন্যাক্স\",\r\n    quickNames: [],\r\n    categoryChips: [\"স্ন্যাক্স\", \"স্টেশনারি\", \"পানীয়\"],\r\n    priceHints: [\"10\", \"20\", \"30\", \"50\"],\r\n  },\r\n  mini_grocery: {\r\n    defaultCategory: \"মুদি\",\r\n    quickNames: [],\r\n    categoryChips: [\"মুদি\", \"পানীয়\", \"স্ন্যাক্স\"],\r\n    priceHints: [\"50\", \"80\", \"100\", \"120\"],\r\n  },\r\n  clothing: {\r\n    defaultCategory: \"কাপড়\",\r\n    quickNames: [],\r\n    categoryChips: [\"কাপড়\", \"এক্সেসরিজ\"],\r\n    priceHints: [\"150\", \"250\", \"350\", \"500\"],\r\n  },\r\n  cosmetics_gift: {\r\n    defaultCategory: \"কসমেটিকস\",\r\n    quickNames: [],\r\n    categoryChips: [\"কসমেটিকস\", \"গিফট আইটেম\", \"হেয়ার কেয়ার\"],\r\n    priceHints: [\"60\", \"80\", \"120\", \"200\"],\r\n  },\r\n  pharmacy: {\r\n    defaultCategory: \"ঔষধ\",\r\n    quickNames: [],\r\n    categoryChips: [\"ঔষধ\", \"বেবি কেয়ার\", \"হেলথ কেয়ার\"],\r\n    priceHints: [\"5\", \"30\", \"60\", \"120\"],\r\n  },\r\n  mini_wholesale: {\r\n    defaultCategory: \"হোলসেল\",\r\n    quickNames: [],\r\n    categoryChips: [\"হোলসেল\", \"মুদি\", \"স্ন্যাক্স\"],\r\n    priceHints: [\"500\", \"1000\", \"1500\", \"2000\"],\r\n  },\r\n};\r\n\r\n\r\nfunction parseProductText(input: string) {\n  const cleaned = input.replace(/টাকা|tk|taka|price/gi, \" \").replace(/:/g, \" \");\n  const priceMatch = cleaned.match(/(\\d+(?:[.,]\\d+)?)/);\n  if (!priceMatch) {\n    return { name: input, price: undefined };\n  }\n  const price = priceMatch[1].replace(\",\", \"\");\n  const name = cleaned\n    .replace(priceMatch[0], \" \")\n    .replace(/\\s+/g, \" \")\n    .trim();\n  return { name, price: price || undefined };\n}\n\r\n\r\n\r\nfunction suggestCategoryByName(name: string, businessCategory?: string) {\r\n  const lower = name.toLowerCase();\r\n  for (const rule of KEYWORD_CATEGORY_RULES) {\r\n    if (rule.keywords.some((k) => lower.includes(k.toLowerCase()))) {\r\n      return rule.category;\r\n    }\r\n  }\r\n  return businessCategory;\r\n}\r\n\r\nfunction mergeTemplates(existing: TemplateItem[], incoming: TemplateItem) {\r\n  const idx = existing.findIndex((t) => t.name.toLowerCase() === incoming.name.toLowerCase());\r\n  const next = [...existing];\r\n  if (idx >= 0) {\r\n    const current = next[idx];\r\n    next[idx] = {\r\n      ...current,\r\n      category: incoming.category || current.category,\r\n      unit: incoming.unit || current.unit,\r\n      price: incoming.price || current.price,\r\n      count: current.count + 1,\r\n      lastUsed: incoming.lastUsed,\r\n    };\r\n  } else {\r\n    next.unshift(incoming);\r\n  }\r\n  return next\r\n    .sort((a, b) => b.count - a.count || b.lastUsed - a.lastUsed)\r\n    .slice(0, TEMPLATE_LIMIT);\r\n}\r\n\r\nfunction dedupe(values: string[]) {\r\n  return Array.from(new Set(values.filter(Boolean)));\r\n}\r\nfunction ProductForm({ shop, businessConfig }: Props) {\r\n  const router = useRouter();\r\n  const online = useOnlineStatus();\r\n  const businessType = (shop.businessType as BusinessType) || \"tea_stall\";\r\n  const recognitionRef = useRef<SpeechRecognitionInstance | null>(null);\r\n  const templateStorageKey = useMemo(() => `productTemplates:${shop.id}`, [shop.id]);\r\n\r\n  const businessAssist = BUSINESS_ASSISTS[businessType];\r\n  const fallbackName = businessAssist?.fallbackName || \"\";\r\n  const [name, setName] = useState(fallbackName);\r\n  const [sellPrice, setSellPrice] = useState(\"\");\r\n  const [listening, setListening] = useState(false);\r\n  const [voiceReady, setVoiceReady] = useState(false);\r\n  const [voiceError, setVoiceError] = useState<string | null>(null);\r\n  const [templates, setTemplates] = useState<TemplateItem[]>([]);\r\n  const [isMounted, setIsMounted] = useState(false);\r\n\r\n  const templateCategories = useMemo(\r\n    () => dedupe(templates.map((t) => t.category).filter(Boolean) as string[]),\r\n    [templates]\r\n  );\r\n\r\n  const businessCategories = useMemo(\r\n    () =>\r\n      dedupe(\r\n        [businessAssist?.defaultCategory, ...(businessAssist?.categoryChips ?? [])].filter(\r\n          Boolean\r\n        ) as string[]\r\n      ),\r\n    [businessAssist]\r\n  );\r\n\r\n  const baseCategories = useMemo(() => {\r\n    const combined = dedupe([...businessCategories, ...templateCategories, \"Uncategorized\"]);\r\n    return combined.length ? combined : [\"Uncategorized\"];\r\n  }, [businessCategories, templateCategories]);\r\n  const baseCategoryKey = useMemo(() => baseCategories.join(\"|\"), [baseCategories]);\r\n\r\n  const {\r\n    isFieldVisible,\r\n    isFieldRequired,\r\n    stock,\r\n    unitOptions: configUnits,\r\n    defaultUnit: configDefaultUnit,\r\n    suggestUnit,\r\n  } = useProductFields(businessType, businessConfig);\r\n  const configUnitsKey = useMemo(() => configUnits.join(\"|\"), [configUnits]);\r\n\r\n  const unitLabels = useMemo(\r\n    () => ({\r\n      pcs: \"পিস\",\r\n      packet: \"প্যাকেট\",\r\n      box: \"বক্স\",\r\n      dozen: \"ডজন\",\r\n      kg: \"কেজি\",\r\n      gm: \"গ্রাম\",\r\n      liter: \"লিটার\",\r\n      ml: \"মিলি\",\r\n      ft: \"ফুট\",\r\n      strip: \"স্ট্রিপ\",\r\n      carton: \"কার্টন\",\r\n    }),\r\n    []\r\n  );\r\n\r\n  const [categoryOptions, setCategoryOptions] = useState<string[]>(baseCategories);\r\n  const [selectedCategory, setSelectedCategory] = useState(\r\n    (businessAssist?.defaultCategory && baseCategories.includes(businessAssist.defaultCategory)\r\n      ? businessAssist.defaultCategory\r\n      : baseCategories[0]) || \"Uncategorized\"\r\n  );\r\n  const [unitOptions, setUnitOptions] = useState<string[]>(configUnits);\r\n  const [selectedUnit, setSelectedUnit] = useState(configDefaultUnit || configUnits[0] || \"pcs\");\r\n  const [stockEnabled, setStockEnabled] = useState(stock.enabledByDefault);\r\n\r\n  const ensuredShopId = shop.id;\r\n  const advancedFieldRenderers: Partial<Record<Field, () => ReactElement>> = {\r\n    buyPrice: () => (\r\n      <div className=\"space-y-2\">\r\n        <label className=\"block text-sm font-semibold text-foreground\">ক্রয়মূল্য (ঐচ্ছিক)</label>\r\n        <input\r\n          name=\"buyPrice\"\r\n          type=\"number\"\r\n          step=\"0.01\"\r\n          min=\"0\"\r\n          required={isFieldRequired(\"buyPrice\")}\r\n          className=\"w-full h-11 border border-border rounded-xl px-4 text-base bg-card shadow-sm focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n          placeholder=\"যেমন: ৫৫.০০\"\r\n        />\r\n        <p className=\"text-xs text-muted-foreground\">চাইলে লাভ হিসাবের জন্য ক্রয়মূল্য দিন</p>\r\n      </div>\r\n    ),\r\n    expiry: () => (\r\n      <div className=\"space-y-2\">\r\n        <label className=\"block text-sm font-semibold text-foreground\">মেয়াদোত্তীর্ণের তারিখ</label>\r\n        <input\r\n          name=\"expiryDate\"\r\n          type=\"date\"\r\n          required={isFieldRequired(\"expiry\")}\r\n          className=\"w-full h-11 border border-border rounded-xl px-4 text-base bg-card shadow-sm focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n        />\r\n      </div>\r\n    ),\r\n    size: () => (\r\n      <div className=\"space-y-2\">\r\n        <label className=\"block text-sm font-semibold text-foreground\">সাইজ / ভ্যারিয়েন্ট</label>\r\n        <input\r\n          name=\"size\"\r\n          type=\"text\"\r\n          required={isFieldRequired(\"size\")}\r\n          className=\"w-full h-11 border border-border rounded-xl px-4 text-base bg-card shadow-sm focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n          placeholder=\"যেমন: L, XL, 100ml\"\r\n        />\r\n      </div>\r\n    ),\r\n  };\r\n  const visibleAdvancedFields = ([\"buyPrice\", \"expiry\", \"size\"] as Field[]).filter((field) =>\r\n    isFieldVisible(field)\r\n  );\r\n\r\n  // Reset stock/unit when business type changes\r\n  useEffect(() => {\r\n    setStockEnabled((prev) =>\r\n      prev === stock.enabledByDefault ? prev : stock.enabledByDefault\r\n    );\r\n\r\n    setUnitOptions((prev) => {\r\n      const sameLength = prev.length === configUnits.length;\r\n      const sameItems =\r\n        sameLength && prev.every((item, idx) => item === configUnits[idx]);\r\n      return sameItems ? prev : configUnits;\r\n    });\r\n\r\n    setSelectedUnit((prev) => {\r\n      const nextUnit = configDefaultUnit || configUnits[0] || \"pcs\";\r\n      return prev === nextUnit ? prev : nextUnit;\r\n    });\r\n    if (fallbackName) {\r\n      setName((prev) => (prev ? prev : fallbackName));\r\n    }\r\n    const assistCategory = businessAssist?.defaultCategory;\r\n    const nextCategory =\r\n      assistCategory && baseCategories.includes(assistCategory)\r\n        ? assistCategory\r\n        : baseCategories[0] || \"Uncategorized\";\r\n    setSelectedCategory((prev) => (prev === nextCategory ? prev : nextCategory));\r\n  }, [\r\n    businessType,\r\n    configUnitsKey,\r\n    configUnits,\r\n    configDefaultUnit,\r\n    stock.enabledByDefault,\r\n    businessAssist,\r\n    baseCategoryKey,\r\n    fallbackName,\r\n    baseCategories,\r\n  ]);\r\n\r\n  // Voice availability\r\n  useEffect(() => {\r\n    const SpeechRecognitionImpl =\r\n      typeof window !== \"undefined\"\r\n        ? (window as any).SpeechRecognition || (window as any).webkitSpeechRecognition\r\n        : null;\r\n    setVoiceReady(Boolean(SpeechRecognitionImpl));\r\n\r\n    return () => {\r\n      recognitionRef.current?.stop?.();\r\n    };\r\n  }, []);\r\n  useEffect(() => {\r\n    setIsMounted(true);\r\n  }, []);\r\n\r\n  // Load recent/frequent templates\r\n  useEffect(() => {\n    if (!templateStorageKey) return;\n    const stored = safeLocalStorageGet(templateStorageKey);\n    if (stored) {\n      try {\n        const parsed = JSON.parse(stored) as TemplateItem[];\n        setTemplates(parsed);\n      } catch {\r\n        setTemplates([]);\r\n      }\r\n    }\r\n  }, [templateStorageKey]);\r\n\r\n  useEffect(() => {\n    if (!ensuredShopId) return;\n    try {\n      const stored = safeLocalStorageGet(`customCategories:${ensuredShopId}`);\n      const parsed = stored ? (JSON.parse(stored) as string[]) : [];\n      const custom = Array.isArray(parsed) ? parsed : [];\n      const merged = Array.from(new Set([...baseCategories, ...custom]));\r\n      setCategoryOptions(merged);\r\n      setSelectedCategory((prev) =>\r\n        merged.includes(prev)\r\n          ? prev\r\n          : businessAssist?.defaultCategory && merged.includes(businessAssist.defaultCategory)\r\n          ? businessAssist.defaultCategory\r\n          : merged[0] || \"Uncategorized\"\r\n      );\r\n    } catch (err) {\r\n      handlePermissionError(err);\r\n      console.error(\"Failed to load custom categories\", err);\r\n      setCategoryOptions(baseCategories);\r\n      setSelectedCategory(\r\n        (businessAssist?.defaultCategory &&\r\n          baseCategories.includes(businessAssist.defaultCategory) &&\r\n          businessAssist.defaultCategory) ||\r\n          baseCategories[0] ||\r\n          \"Uncategorized\"\r\n      );\r\n    }\r\n  }, [ensuredShopId, baseCategories, businessAssist]);\r\n\r\n  useEffect(() => {\n    if (!ensuredShopId) return;\n    try {\n      const stored = safeLocalStorageGet(`customUnits:${ensuredShopId}`);\n      const parsed = stored ? (JSON.parse(stored) as string[]) : [];\n      const custom = Array.isArray(parsed) ? parsed : [];\n      const merged = Array.from(new Set([...configUnits, ...custom]));\r\n\r\n      setUnitOptions((prev) => {\r\n        const sameLength = prev.length === merged.length;\r\n        const sameItems = sameLength && prev.every((v, idx) => v === merged[idx]);\r\n        return sameItems ? prev : merged;\r\n      });\r\n\r\n      setSelectedUnit((prev) => {\r\n        const next = configDefaultUnit || merged[0] || \"pcs\";\r\n        return merged.includes(prev) ? prev : next;\r\n      });\r\n    } catch (err) {\r\n      handlePermissionError(err);\r\n      console.error(\"Failed to load custom units\", err);\r\n      setUnitOptions((prev) => (prev.length ? prev : configUnits));\r\n      setSelectedUnit((prev) => (prev ? prev : configDefaultUnit || configUnits[0] || \"pcs\"));\r\n    }\r\n  }, [ensuredShopId, configUnitsKey, configDefaultUnit, configUnits]);\r\n\r\n  function handleAddCustomCategory() {\r\n    const input = prompt(\"নতুন ক্যাটাগরি যোগ করুন\");\r\n    if (!input) return;\r\n    const value = input.toString().trim();\r\n    if (!value) return;\r\n\r\n    const merged = Array.from(new Set([...categoryOptions, value]));\r\n    setCategoryOptions(merged);\r\n    setSelectedCategory(value);\r\n\r\n    const customOnly = merged.filter((c) => !baseCategories.includes(c));\r\n    safeLocalStorageSet(\n      `customCategories:${ensuredShopId}`,\n      JSON.stringify(customOnly)\n    );\n  }\r\n\r\n  function handleAddCustomUnit() {\r\n    const input = prompt(\"নতুন ইউনিট লিখুন\");\r\n    if (!input) return;\r\n    const value = input.toString().trim().toLowerCase();\r\n    if (!value) return;\r\n\r\n    const merged = Array.from(new Set([...unitOptions, value]));\r\n    setUnitOptions(merged);\r\n    setSelectedUnit(value);\r\n\r\n    const customOnly = merged.filter((u) => !configUnits.includes(u));\r\n    safeLocalStorageSet(\n      `customUnits:${ensuredShopId}`,\n      JSON.stringify(customOnly)\n    );\n  }\r\n\r\n  function persistTemplates(updater: (prev: TemplateItem[]) => TemplateItem[]) {\r\n    setTemplates((prev) => {\r\n      const next = updater(prev);\r\n      safeLocalStorageSet(templateStorageKey, JSON.stringify(next));\n      return next;\r\n    });\r\n  }\r\n\r\n  function upsertTemplateFromForm(payload: {\r\n    name: string;\r\n    category?: string;\r\n    unit?: string;\r\n    price?: string;\r\n  }) {\r\n    if (!payload.name) return;\r\n    const incoming: TemplateItem = {\r\n      name: payload.name,\r\n      category: payload.category,\r\n      unit: payload.unit,\r\n      price: payload.price,\r\n      count: 1,\r\n      lastUsed: Date.now(),\r\n    };\r\n    persistTemplates((prev) => mergeTemplates(prev, incoming));\r\n  }\r\n\r\n  function setNameWithSmartDefaults(raw: string) {\n    const parsed = parseProductText(raw);\n    const finalName = parsed.name || raw;\n    const nameForInference = finalName.replace(/\\s+/g, \" \").trim();\n\n    if (isFieldVisible(\"name\")) {\n      setName(finalName);\n    } else if (!name) {\n      setName(fallbackName || finalName);\n    }\n\n    if (parsed.price) {\n      setSellPrice(parsed.price);\n    }\n\n    if (isFieldVisible(\"unit\")) {\n      const suggested = suggestUnit(nameForInference, unitOptions);\n      if (suggested) {\n        setUnitOptions((prev) => (prev.includes(suggested) ? prev : [...prev, suggested]));\n        setSelectedUnit(suggested);\n      }\n    }\n\n    const byCategory = suggestCategoryByName(nameForInference, businessAssist?.defaultCategory);\n    if (byCategory) {\n      setCategoryOptions((prev) => (prev.includes(byCategory) ? prev : [...prev, byCategory]));\n      setSelectedCategory(byCategory);\n    }\n  }\n\r\n  function handleVoiceResult(spoken: string) {\r\n    const parsed = parseProductText(spoken);\r\n    const finalName = parsed.name || spoken;\r\n    setNameWithSmartDefaults(finalName);\r\n    if (parsed.price) {\r\n      setSellPrice(parsed.price);\r\n    }\r\n  }\r\n\r\n  function startVoice() {\r\n    if (listening) return;\r\n    const SpeechRecognitionImpl =\r\n      typeof window !== \"undefined\"\r\n        ? ((window as any).SpeechRecognition ||\r\n            (window as any).webkitSpeechRecognition)\r\n        : null;\r\n\r\n    if (!SpeechRecognitionImpl) {\r\n      setVoiceReady(false);\r\n      setVoiceError(\"ব্রাউজার মাইক্রোফোন সাপোর্ট দিচ্ছে না\");\r\n      return;\r\n    }\r\n\r\n    const recognition: SpeechRecognitionInstance = new SpeechRecognitionImpl();\r\n    recognition.lang = \"bn-BD\";\r\n    recognition.interimResults = false;\r\n    recognition.continuous = false;\r\n    recognition.onerror = () => {\r\n      setListening(false);\r\n      setVoiceError(\"মাইক্রোফোন অ্যাক্সেস মেলেনি\");\r\n    };\r\n    recognition.onend = () => setListening(false);\r\n    recognition.onresult = (event: any) => {\r\n      const spoken: string | undefined = event?.results?.[0]?.[0]?.transcript;\r\n      if (spoken) {\r\n        handleVoiceResult(spoken);\r\n      }\r\n      setListening(false);\r\n    };\r\n\r\n    recognitionRef.current = recognition;\r\n    setVoiceError(null);\r\n    setListening(true);\r\n    recognition.start();\r\n  }\r\n\r\n  function stopVoice() {\r\n    recognitionRef.current?.stop?.();\r\n    setListening(false);\r\n  }\r\n\r\n  const frequentTemplates = useMemo(\r\n    () => templates.slice().sort((a, b) => b.count - a.count || b.lastUsed - a.lastUsed),\r\n    [templates]\r\n  );\r\n\r\n  const recentTemplates = useMemo(\r\n    () => templates.slice().sort((a, b) => b.lastUsed - a.lastUsed),\r\n    [templates]\r\n  );\r\n\r\n  const smartNameSuggestions = useMemo(() => {\r\n    const topTemplates = frequentTemplates.slice(0, 6).map((t) => t.name);\r\n    const latest = recentTemplates.slice(0, 6).map((t) => t.name);\r\n    return dedupe([...topTemplates, ...latest]).slice(0, 8);\r\n  }, [frequentTemplates, recentTemplates]);\r\n\r\n  const priceSuggestions = useMemo(() => {\r\n    const templatePrices = dedupe(\r\n      recentTemplates\r\n        .map((t) => t.price)\r\n        .filter(Boolean)\r\n        .map((p) => p as string)\r\n    );\r\n    const hints = businessAssist?.priceHints ?? [];\r\n    return dedupe([...templatePrices, ...hints]).slice(0, 6);\r\n  }, [recentTemplates, businessAssist]);\r\n\r\n  function applyTemplate(item: TemplateItem) {\r\n    setNameWithSmartDefaults(item.name);\r\n    if (item.price) setSellPrice(item.price);\r\n    if (item.unit && isFieldVisible(\"unit\")) {\r\n      setUnitOptions((prev) => (prev.includes(item.unit!) ? prev : [...prev, item.unit!]));\r\n      setSelectedUnit(item.unit);\r\n    }\r\n    if (item.category) {\r\n      setCategoryOptions((prev) => (prev.includes(item.category!) ? prev : [...prev, item.category!]));\r\n      setSelectedCategory(item.category);\r\n    }\r\n  }\r\n  async function handleSubmit(e: any) {\r\n    e.preventDefault();\r\n    const form = new FormData(e.target);\r\n\r\n    const buyPriceRaw = form.get(\"buyPrice\") as string;\r\n    const buyPrice = isFieldVisible(\"buyPrice\")\r\n      ? buyPriceRaw && buyPriceRaw.toString().trim() !== \"\"\r\n        ? (buyPriceRaw as string)\r\n        : null\r\n      : null;\r\n\r\n    const baseUnit = isFieldVisible(\"unit\")\r\n      ? ((form.get(\"baseUnit\") as string) || configDefaultUnit || configUnits[0] || \"pcs\")\r\n      : undefined;\r\n\r\n    const stockQty = stockEnabled ? ((form.get(\"stockQty\") as string) || \"0\") : \"0\";\r\n\r\n    const expiryDate = isFieldVisible(\"expiry\")\r\n      ? ((form.get(\"expiryDate\") as string) || null)\r\n      : null;\r\n\r\n    const size = isFieldVisible(\"size\")\r\n      ? ((form.get(\"size\") as string) || \"\").toString().trim() || null\r\n      : null;\r\n\r\n    const resolvedSellPrice = (form.get(\"sellPrice\") as string) || sellPrice;\r\n    const resolvedName = isFieldVisible(\"name\")\r\n      ? (form.get(\"name\") as string) || name || fallbackName || \"Unnamed product\"\r\n      : name || fallbackName || (resolvedSellPrice ? `Item ${resolvedSellPrice}` : \"Unnamed product\");\r\n\r\n    const payload: LocalProduct = {\r\n      id: crypto.randomUUID(),\r\n      shopId: ensuredShopId,\r\n      name: resolvedName,\r\n      category: selectedCategory || \"Uncategorized\",\r\n      baseUnit,\r\n      buyPrice,\r\n      sellPrice: resolvedSellPrice,\r\n      stockQty,\r\n      isActive: form.get(\"isActive\") === \"on\",\r\n      trackStock: stockEnabled,\r\n      businessType,\r\n      expiryDate,\r\n      size,\r\n      updatedAt: Date.now(),\r\n      syncStatus: \"new\",\r\n    };\r\n\r\n    upsertTemplateFromForm({\r\n      name: payload.name,\r\n      category: payload.category,\r\n      unit: payload.baseUnit,\r\n      price: payload.sellPrice,\r\n    });\r\n\r\n    try {\r\n      if (online) {\r\n        const result = await createProduct(payload);\r\n        const createdId = result?.id || payload.id;\r\n        try {\r\n          await db.products.put({\r\n            ...payload,\r\n            id: createdId,\r\n            updatedAt: Date.now(),\r\n            syncStatus: \"synced\",\r\n          });\r\n        } catch (err) {\r\n          handlePermissionError(err);\r\n          console.warn(\"Seed local product failed\", err);\r\n        }\r\n        emitProductEvent({\r\n          shopId: ensuredShopId,\r\n          at: Date.now(),\r\n          source: \"create\",\r\n        });\r\n        toast.success(\"পণ্য তৈরি হয়েছে।\");\r\n      } else {\n        await db.transaction(\"rw\", db.products, db.queue, async () => {\n          await db.products.put(payload);\n          await queueAdd(\"product\", \"create\", payload);\n        });\n        emitProductEvent({\n          shopId: ensuredShopId,\n          at: Date.now(),\n          source: \"local\",\n        });\n        toast.success(\"অফলাইন: পণ্য কিউ হয়েছে, অনলাইনে গেলে সিঙ্ক হবে।\");\r\n      }\r\n\r\n      router.push(`/dashboard/products?shopId=${ensuredShopId}`);\r\n    } catch (err) {\r\n      if (handlePermissionError(err)) {\r\n        return;\r\n      }\r\n      const message = err instanceof Error ? err.message : \"পণ্য তৈরি ব্যর্থ হয়েছে\";\r\n      const normalized = message.toLowerCase();\r\n      if (normalized.includes(\"access to this shop\")) {\r\n        toast.error(\"এই দোকানে আপনার অনুমতি নেই।\");\r\n        return;\r\n      }\r\n      toast.error(message);\r\n    }\r\n  }\r\n  return (\r\n    <div className=\"max-w-2xl mx-auto space-y-4\">\r\n      <div className=\"relative overflow-hidden rounded-2xl border border-border bg-card shadow-[0_16px_36px_rgba(15,23,42,0.08)] animate-fade-in\">\r\n        <div className=\"pointer-events-none absolute inset-0 bg-gradient-to-br from-primary/10 via-card to-card\" />\r\n        <div className=\"pointer-events-none absolute -top-16 right-0 h-40 w-40 rounded-full bg-primary/20 blur-3xl\" />\r\n        <div className=\"relative space-y-3 p-4\">\r\n          <div className=\"min-w-0 space-y-1\">\r\n            <p className=\"text-[11px] uppercase tracking-[0.22em] text-muted-foreground\">\r\n              পণ্য\r\n            </p>\r\n            <h1 className=\"text-2xl font-bold text-foreground leading-tight tracking-tight sm:text-3xl\">\r\n              নতুন পণ্য যোগ করুন\r\n            </h1>\r\n            <p className=\"text-sm text-muted-foreground\">\r\n              কয়েক ট্যাপেই সব তথ্য ভর্তি করার জন্য স্মার্ট ফর্ম\r\n            </p>\r\n            <p className=\"text-xs text-muted-foreground flex items-center gap-1 min-w-0\">\r\n              দোকান:\r\n              <span className=\"truncate font-semibold text-foreground\">\r\n                {shop.name}\r\n              </span>\r\n            </p>\r\n          </div>\r\n          <div className=\"flex flex-wrap items-center gap-2 text-xs\">\r\n            <span className=\"inline-flex h-7 items-center gap-1 rounded-full bg-card/80 px-3 font-semibold text-foreground border border-border shadow-[0_1px_0_rgba(0,0,0,0.03)]\">\r\n              ভয়েস ইনপুট\r\n            </span>\r\n            <span className=\"inline-flex h-7 items-center gap-1 rounded-full bg-card/80 px-3 font-semibold text-muted-foreground border border-border\">\r\n              স্মার্ট সাজেশন\r\n            </span>\r\n            <span\r\n              className={`inline-flex h-7 items-center gap-1 rounded-full px-3 font-semibold border ${\r\n                online\r\n                  ? \"bg-success-soft text-success border-success/30\"\r\n                  : \"bg-danger-soft text-danger border-danger/30\"\r\n              }`}\r\n            >\r\n              {online ? \"অনলাইন\" : \"অফলাইন\"}\r\n            </span>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      <form onSubmit={handleSubmit} className=\"space-y-4\">\r\n        <div className=\"rounded-2xl border border-border bg-card p-4 shadow-sm space-y-4\">\r\n          {/* Product Name */}\r\n          {isFieldVisible(\"name\") && (\r\n            <div className=\"space-y-2\">\r\n              <div className=\"flex items-center justify-between gap-2\">\r\n                <label className=\"block text-base font-medium text-foreground\">\r\n                  পণ্যের নাম *\r\n                </label>\r\n                <span className=\"text-xs text-muted-foreground\">ভয়েস/সাজেশন</span>\r\n              </div>\r\n              <div className=\"relative\">\r\n                <input\r\n                  name=\"name\"\r\n                  value={name}\r\n                  onChange={(e) => setNameWithSmartDefaults(e.target.value)}\r\n                  className=\"w-full h-12 border border-border rounded-xl px-4 pr-16 text-base bg-card shadow-sm focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n                  placeholder=\"যেমন: চা, ডিম, বিস্কুট...\"\r\n                  required={isFieldRequired(\"name\")}\r\n                  autoComplete=\"off\"\r\n                />\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={listening ? stopVoice : startVoice}\r\n                  disabled={!voiceReady}\r\n                  aria-label={listening ? \"ভয়েস বন্ধ করুন\" : \"ভয়েস ইনপুট চালু করুন\"}\r\n                  className={`absolute right-2 top-1/2 -translate-y-1/2 inline-flex h-9 items-center justify-center rounded-lg border px-3 text-sm font-semibold transition ${\r\n                    listening\r\n                      ? \"bg-primary-soft text-primary border-primary/40 animate-pulse\"\r\n                      : \"bg-primary-soft text-primary border-primary/30 active:scale-95\"\r\n                  } ${!voiceReady ? \"opacity-60 cursor-not-allowed\" : \"\"}`}\r\n                >\r\n                  {listening ? \"🔴\" : \"🎤\"}\r\n                </button>\r\n              </div>\r\n              <p className=\"text-xs text-muted-foreground\">\r\n                {listening\r\n                  ? \"শুনছি... নাম ও দাম বলুন\"\r\n                  : voiceReady\r\n                  ? \"নাম/দাম বললেই অটো বসবে\"\r\n                  : \"এই ডিভাইসে ভয়েস সাপোর্ট নেই\"}{\" \"}\r\n                {voiceError ? `(${voiceError})` : \"\"}\r\n              </p>\r\n\r\n              {smartNameSuggestions.length > 0 && (\r\n                <div className=\"flex flex-wrap gap-2 pt-1\">\r\n                  {smartNameSuggestions.map((title) => (\r\n                    <button\r\n                      key={title}\r\n                      type=\"button\"\r\n                      onClick={() => setNameWithSmartDefaults(title)}\r\n                      className=\"h-9 px-3 rounded-full border border-primary/30 text-primary bg-primary-soft/80 text-xs font-semibold hover:border-primary/50\"\r\n                    >\r\n                      {title}\r\n                    </button>\r\n                  ))}\r\n                </div>\r\n              )}\r\n            </div>\r\n          )}\r\n\r\n          {/* Sell Price */}\r\n          <div className=\"space-y-2\">\r\n            <label className=\"block text-base font-medium text-foreground\">\r\n              বিক্রয় মূল্য (৳) *\r\n            </label>\r\n            <input\r\n              name=\"sellPrice\"\r\n              type=\"number\"\r\n              step=\"0.01\"\r\n              min=\"0\"\r\n              value={sellPrice}\r\n              onChange={(e) => setSellPrice(e.target.value)}\r\n              className=\"w-full h-12 border border-border rounded-xl px-4 text-base bg-card shadow-sm focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n              placeholder=\"যেমন: ১০, ২৫.৫০\"\r\n              required={isFieldRequired(\"sellPrice\")}\r\n            />\r\n            {priceSuggestions.length > 0 && (\r\n              <div className=\"flex flex-wrap gap-2\">\r\n                {priceSuggestions.map((p) => (\r\n                  <button\r\n                    key={p}\r\n                    type=\"button\"\r\n                    onClick={() => setSellPrice(p)}\r\n                    className=\"h-9 px-3 rounded-full border border-primary/30 bg-primary-soft/80 text-primary text-xs font-semibold hover:border-primary/50\"\r\n                  >\r\n                    ৳ {p}\r\n                  </button>\r\n                ))}\r\n              </div>\r\n            )}\r\n            <p className=\"text-xs text-muted-foreground\">\r\n              শুধু দাম বললেও/লিখলেও অটো শনাক্ত হবে\r\n            </p>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Category (optional with custom) */}\r\n        <div className=\"rounded-2xl border border-border bg-card p-4 shadow-sm space-y-4\">\r\n          <div className=\"space-y-2\">\r\n            <label className=\"block text-base font-medium text-foreground\">\r\n              ক্যাটাগরি (ঐচ্ছিক)\r\n            </label>\r\n            <div className=\"flex flex-col gap-2 sm:flex-row sm:items-center\">\r\n              {isMounted ? (\r\n                <div className=\"w-full\">\r\n                  <input type=\"hidden\" name=\"category\" value={selectedCategory} />\r\n                  <Select value={selectedCategory} onValueChange={setSelectedCategory}>\r\n                    <SelectTrigger className=\"h-11 w-full rounded-xl border border-border bg-card px-4 text-left text-base text-foreground shadow-sm focus:ring-2 focus:ring-primary/30\">\r\n                      <SelectValue placeholder=\"ক্যাটাগরি বাছাই করুন\" />\r\n                    </SelectTrigger>\r\n                    <SelectContent\r\n                      align=\"start\"\r\n                      className=\"min-w-[var(--radix-select-trigger-width)]\"\r\n                    >\r\n                      {categoryOptions.map((c) => (\r\n                        <SelectItem key={c} value={c}>\r\n                          {c}\r\n                        </SelectItem>\r\n                      ))}\r\n                    </SelectContent>\r\n                  </Select>\r\n                </div>\r\n              ) : (\r\n                <select\r\n                  name=\"category\"\r\n                  value={selectedCategory}\r\n                  onChange={(e) => setSelectedCategory(e.target.value)}\r\n                  className=\"w-full h-11 border border-border rounded-xl px-4 text-base bg-card shadow-sm focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n                >\r\n                  <option value=\"\">ক্যাটাগরি বাছাই করুন</option>\r\n                  {categoryOptions.map((c) => (\r\n                    <option key={c} value={c}>\r\n                      {c}\r\n                    </option>\r\n                  ))}\r\n                </select>\r\n              )}\r\n              <button\r\n                type=\"button\"\r\n                onClick={handleAddCustomCategory}\r\n                className=\"h-11 px-4 border border-border rounded-xl text-sm font-semibold text-foreground hover:bg-muted transition-colors sm:w-auto\"\r\n              >\r\n                + কাস্টম যোগ করুন\r\n              </button>\r\n            </div>\r\n            {businessAssist?.categoryChips?.length ? (\r\n              <div className=\"flex flex-wrap gap-2\">\r\n                {businessAssist.categoryChips.map((c) => (\r\n                  <button\r\n                    key={c}\r\n                    type=\"button\"\r\n                    onClick={() => {\r\n                      setCategoryOptions((prev) =>\r\n                        prev.includes(c) ? prev : [...prev, c]\r\n                      );\r\n                      setSelectedCategory(c);\r\n                    }}\r\n                    className=\"h-9 px-3 rounded-full border border-primary/30 text-primary bg-primary-soft/80 text-xs font-semibold hover:border-primary/50\"\r\n                  >\r\n                    {c}\r\n                  </button>\r\n                ))}\r\n              </div>\r\n            ) : null}\r\n            <p className=\"text-xs text-muted-foreground\">\r\n              এক ট্যাপে ক্যাটাগরি/ইউনিট সিলেক্ট করুন; ভয়েস বা নাম লিখলে স্মার্ট ফিল হবে\r\n            </p>\r\n          </div>\r\n\r\n          {/* Unit (conditional) */}\r\n          {isFieldVisible(\"unit\") && (\r\n            <div className=\"space-y-2\">\r\n              <label className=\"block text-base font-medium text-foreground\">\r\n                ইউনিট (ঐচ্ছিক)\r\n              </label>\r\n              <div className=\"flex flex-col gap-2 sm:flex-row sm:items-center\">\r\n                {isMounted ? (\r\n                  <div className=\"w-full\">\r\n                    <input type=\"hidden\" name=\"baseUnit\" value={selectedUnit} />\r\n                    <Select value={selectedUnit} onValueChange={setSelectedUnit}>\r\n                      <SelectTrigger className=\"h-11 w-full rounded-xl border border-border bg-card px-4 text-left text-base text-foreground shadow-sm focus:ring-2 focus:ring-primary/30\">\r\n                        <SelectValue placeholder=\"ইউনিট বাছাই করুন\" />\r\n                      </SelectTrigger>\r\n                      <SelectContent\r\n                        align=\"start\"\r\n                        className=\"min-w-[var(--radix-select-trigger-width)]\"\r\n                      >\r\n                        {unitOptions.map((u) => (\r\n                          <SelectItem key={u} value={u}>\r\n                            {unitLabels[u as keyof typeof unitLabels] || u}\r\n                          </SelectItem>\r\n                        ))}\r\n                      </SelectContent>\r\n                    </Select>\r\n                  </div>\r\n                ) : (\r\n                  <select\r\n                    name=\"baseUnit\"\r\n                    value={selectedUnit}\r\n                    onChange={(e) => setSelectedUnit(e.target.value)}\r\n                    required={isFieldRequired(\"unit\")}\r\n                    className=\"w-full h-11 border border-border rounded-xl px-4 text-base bg-card shadow-sm focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n                  >\r\n                    {unitOptions.map((u) => (\r\n                      <option key={u} value={u}>\r\n                        {unitLabels[u as keyof typeof unitLabels] || u}\r\n                      </option>\r\n                    ))}\r\n                  </select>\r\n                )}\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={handleAddCustomUnit}\r\n                  className=\"h-11 px-4 border border-border rounded-xl text-sm font-semibold text-foreground hover:bg-muted transition-colors sm:w-auto\"\r\n                >\r\n                  + কাস্টম যোগ করুন\r\n                </button>\r\n              </div>\r\n              <div className=\"flex flex-wrap gap-2\">\r\n                {unitOptions.slice(0, 5).map((u) => (\r\n                  <button\r\n                    key={u}\r\n                    type=\"button\"\r\n                    onClick={() => setSelectedUnit(u)}\r\n                    className=\"h-9 px-3 rounded-full border border-primary/30 text-primary bg-primary-soft/80 text-xs font-semibold hover:border-primary/50\"\r\n                  >\r\n                    {unitLabels[u as keyof typeof unitLabels] || u}\r\n                  </button>\r\n                ))}\r\n              </div>\r\n              <p className=\"text-xs text-muted-foreground\">\r\n                নাম থেকেই ইউনিট অনুমান হবে: ডিম → পিস, তেল → লিটার, চিনি → কেজি\r\n              </p>\r\n            </div>\r\n          )}\r\n\r\n          {/* Stock toggle & qty */}\r\n          <div\r\n            className={`rounded-xl border border-border/70 bg-muted/30 p-3 space-y-3 ${\r\n              stockEnabled ? \"\" : \"blur-[1px]\"\r\n            }`}\r\n          >\r\n            <div className=\"flex items-center justify-between gap-3\">\r\n              <label className=\"flex items-center gap-3 cursor-pointer\">\r\n                <input\r\n                  type=\"checkbox\"\r\n                  checked={stockEnabled}\r\n                  onChange={(e) => setStockEnabled(e.target.checked)}\r\n                  className=\"h-5 w-5 border border-border rounded cursor-pointer\"\r\n                />\r\n                <span className=\"text-sm font-semibold text-foreground\">\r\n                  স্টক ট্র্যাক\r\n                </span>\r\n              </label>\r\n              <span\r\n                className={`inline-flex items-center rounded-full px-2 py-0.5 text-[11px] font-semibold ${\r\n                  stockEnabled\r\n                    ? \"bg-success-soft text-success border border-success/30\"\r\n                    : \"bg-muted text-muted-foreground border border-border\"\r\n                }`}\r\n              >\r\n                {stockEnabled ? \"চালু\" : \"বন্ধ\"}\r\n              </span>\r\n            </div>\r\n            <p className=\"text-xs text-muted-foreground\">\r\n              দোকানের ধরন দেখে ডিফল্ট অন/অফ সেট হয়; লাগলে বন্ধ করুন\r\n            </p>\r\n            <input\r\n              name=\"stockQty\"\r\n              type=\"number\"\r\n              step=\"0.01\"\r\n              min=\"0\"\r\n              defaultValue=\"0\"\r\n              required={stockEnabled && stock.requiredWhenEnabled}\r\n              disabled={!stockEnabled}\r\n              className=\"w-full h-11 border border-border rounded-xl px-4 text-base bg-card shadow-sm focus:outline-none focus:ring-2 focus:ring-primary/30 disabled:bg-muted disabled:text-muted-foreground\"\r\n              placeholder=\"যেমন: 10, 5.50\"\r\n            />\r\n          </div>\r\n        </div>\r\n\r\n        {/* Recent templates */}\r\n        {recentTemplates.length > 0 && (\r\n          <div className=\"rounded-2xl border border-border bg-card p-4 shadow-sm space-y-2\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <h3 className=\"text-base font-semibold text-foreground\">\r\n                রিসেন্ট টেমপ্লেট\r\n              </h3>\r\n              <span className=\"text-xs text-muted-foreground\">এক ট্যাপে অটো-ফিল</span>\r\n            </div>\r\n            <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-2\">\r\n              {recentTemplates.slice(0, 4).map((t) => (\r\n                <button\r\n                  key={`${t.name}-${t.lastUsed}`}\r\n                  type=\"button\"\r\n                  onClick={() => applyTemplate(t)}\r\n                  className=\"flex items-center justify-between gap-3 bg-card border border-border rounded-xl px-3 py-2 text-left shadow-sm hover:border-primary/40 transition-colors\"\r\n                >\r\n                  <div>\r\n                    <p className=\"font-semibold text-foreground\">{t.name}</p>\r\n                    <p className=\"text-xs text-muted-foreground\">\r\n                      {t.category || \"ক্যাটাগরি নেই\"} • {t.unit || \"ইউনিট নেই\"}\r\n                    </p>\r\n                  </div>\r\n                  {t.price ? (\r\n                    <span className=\"text-sm font-bold text-primary\">৳ {t.price}</span>\r\n                  ) : null}\r\n                </button>\r\n              ))}\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {/* Quick product buttons */}\r\n        {businessAssist?.quickNames?.length ? (\r\n          <div className=\"rounded-2xl border border-border bg-card p-4 shadow-sm space-y-2\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <h3 className=\"text-base font-semibold text-foreground\">এক ট্যাপ পণ্য</h3>\r\n              <span className=\"text-xs text-muted-foreground\">ব্যবসার ধরন অনুযায়ী সাজেশন</span>\r\n            </div>\r\n            <div className=\"flex flex-wrap gap-2\">\r\n              {businessAssist.quickNames.slice(0, 8).map((n) => (\r\n                <button\r\n                  key={n}\r\n                  type=\"button\"\r\n                  onClick={() => setNameWithSmartDefaults(n)}\r\n                  className=\"h-9 px-3 rounded-full border border-border bg-card text-foreground text-xs font-semibold hover:border-primary/30\"\r\n                >\r\n                  {n}\r\n                </button>\r\n              ))}\r\n            </div>\r\n          </div>\r\n        ) : null}\r\n        {/* Advanced (optional) */}\r\n        {visibleAdvancedFields.length > 0 && (\r\n          <details className=\"rounded-2xl border border-border bg-card p-4 shadow-sm\">\r\n            <summary className=\"cursor-pointer text-sm font-semibold text-foreground\">\r\n              অ্যাডভান্সড অপশন (ঐচ্ছিক)\r\n            </summary>\r\n            <div className=\"mt-4 space-y-4\">\r\n              {visibleAdvancedFields.map((field) => (\r\n                <Fragment key={field}>{advancedFieldRenderers[field]?.()}</Fragment>\r\n              ))}\r\n            </div>\r\n          </details>\r\n        )}\r\n\r\n        <div className=\"rounded-2xl border border-border bg-card p-4 shadow-sm space-y-3\">\r\n          {/* Active Status */}\r\n          <div className=\"space-y-2\">\r\n            <label className=\"flex items-center gap-3 cursor-pointer\">\r\n              <input\r\n                type=\"checkbox\"\r\n                name=\"isActive\"\r\n                defaultChecked\r\n                className=\"h-5 w-5 border border-border rounded cursor-pointer\"\r\n              />\r\n              <span className=\"text-sm font-semibold text-foreground\">\r\n                পণ্য সক্রিয় রাখুন\r\n              </span>\r\n            </label>\r\n            <p className=\"text-xs text-muted-foreground\">\r\n              অফ-স্টক হলে চাইলে বন্ধ করতে পারেন\r\n            </p>\r\n          </div>\r\n\r\n          {/* Buttons */}\r\n          <div className=\"flex flex-col gap-3 sm:flex-row\">\r\n            <button\r\n              type=\"submit\"\r\n              className=\"flex-1 h-14 sm:h-12 rounded-xl bg-gradient-to-r from-primary to-primary-hover text-primary-foreground border border-primary/40 text-base font-semibold shadow-[0_12px_22px_rgba(22,163,74,0.28)] transition hover:brightness-105 active:scale-[0.99] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/40\"\r\n            >\r\n              + দ্রুত পণ্য যুক্ত করুন\r\n            </button>\r\n            <button\r\n              type=\"button\"\r\n              onClick={() => router.back()}\r\n              className=\"flex-1 h-14 sm:h-12 rounded-xl border border-border text-foreground text-base font-semibold hover:bg-muted transition\"\r\n            >\r\n              পিছনে যান\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </form>\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default function ProductFormClient(props: Props) {\r\n  return (\r\n    <Suspense fallback={<div>Loading form...</div>}>\r\n      <ProductForm {...props} />\r\n    </Suspense>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\products\\new\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\products\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\products\\shop-switcher-client.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\profile\\ProfileClient.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\profile\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\purchases\\ShopSelectorClient.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\pos\\pos-app-supabase\\app\\dashboard\\purchases\\ShopSelectorClient.tsx:29:5\n  27 |\n  28 |   useEffect(() => {\n> 29 |     setMounted(true);\n     |     ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  30 |   }, []);\n  31 |\n  32 |   const handleSelect = (id: string) => {","line":29,"column":5,"nodeType":null,"endLine":29,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// app/dashboard/purchases/ShopSelectorClient.tsx\n\n\"use client\";\n\nimport { useRouter } from \"next/navigation\";\nimport { useCurrentShop } from \"@/hooks/use-current-shop\";\nimport { useEffect, useState } from \"react\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\n\ntype Shop = { id: string; name: string };\n\ntype Props = {\n  shops: Shop[];\n  selectedShopId: string;\n};\n\nexport default function ShopSelectorClient({ shops, selectedShopId }: Props) {\n  const router = useRouter();\n  const { setShop } = useCurrentShop();\n  const [mounted, setMounted] = useState(false);\n\n  useEffect(() => {\n    setMounted(true);\n  }, []);\n\n  const handleSelect = (id: string) => {\n    setShop(id);\n    document.cookie = `activeShopId=${id}; path=/; max-age=${60 * 60 * 24 * 30}`;\n    router.push(`/dashboard/purchases?shopId=${id}`);\n  };\n\n  return mounted ? (\n    <Select value={selectedShopId} onValueChange={handleSelect}>\n      <SelectTrigger className=\"h-11 w-full sm:w-[220px] border border-border bg-card text-left text-foreground shadow-sm focus:ring-2 focus:ring-primary/30\">\n        <SelectValue placeholder=\"দোকান সিলেক্ট করুন\" />\n      </SelectTrigger>\n      <SelectContent\n        align=\"start\"\n        className=\"min-w-[var(--radix-select-trigger-width)]\"\n      >\n        {shops.map((shop) => (\n          <SelectItem key={shop.id} value={shop.id}>\n            {shop.name}\n          </SelectItem>\n        ))}\n      </SelectContent>\n    </Select>\n  ) : (\n    <select\n      className=\"h-11 w-full sm:w-[220px] border border-border bg-card px-3 text-sm text-foreground shadow-sm focus:outline-none focus:ring-2 focus:ring-primary/30\"\n      value={selectedShopId}\n      onChange={(e) => handleSelect(e.target.value)}\n    >\n      {shops.map((shop) => (\n        <option key={shop.id} value={shop.id}>\n          {shop.name}\n        </option>\n      ))}\n    </select>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\purchases\\[purchaseId]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\purchases\\new\\PurchaseFormClient.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\purchases\\new\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\purchases\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\purchases\\pay\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\purchases\\pay\\purchase-payment-client.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\reports\\ShopSelectorClient.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\pos\\pos-app-supabase\\app\\dashboard\\reports\\ShopSelectorClient.tsx:29:5\n  27 |\n  28 |   useEffect(() => {\n> 29 |     setMounted(true);\n     |     ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  30 |   }, []);\n  31 |\n  32 |   const handleChange = (id: string) => {","line":29,"column":5,"nodeType":null,"endLine":29,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// app/dashboard/reports/ShopSelectorClient.tsx\r\n\r\n\"use client\";\r\n\r\nimport { useRouter } from \"next/navigation\";\r\nimport { useEffect, useState } from \"react\";\r\nimport { useCurrentShop } from \"@/hooks/use-current-shop\";\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\";\r\n\r\ntype Shop = { id: string; name: string };\r\n\r\ntype Props = {\r\n  shops: Shop[];\r\n  selectedShopId: string;\r\n};\r\n\r\nexport default function ShopSelectorClient({ shops, selectedShopId }: Props) {\r\n  const router = useRouter();\r\n  const { setShop } = useCurrentShop();\r\n  const [mounted, setMounted] = useState(false);\r\n\r\n  useEffect(() => {\r\n    setMounted(true);\r\n  }, []);\r\n\r\n  const handleChange = (id: string) => {\r\n    // Persist globally selected shop\r\n    setShop(id);\r\n    document.cookie = `activeShopId=${id}; path=/; max-age=${60 * 60 * 24 * 30}`;\r\n    router.push(`/dashboard/reports?shopId=${id}`);\r\n  };\r\n\r\n  return (\r\n    mounted ? (\r\n      <Select value={selectedShopId} onValueChange={handleChange}>\r\n        <SelectTrigger className=\"h-11 w-full sm:w-[240px] border border-border bg-card text-left text-foreground shadow-sm focus:ring-2 focus:ring-primary/30\">\r\n          <SelectValue placeholder=\"দোকান সিলেক্ট করুন\" />\r\n        </SelectTrigger>\r\n        <SelectContent\r\n          align=\"start\"\r\n          className=\"min-w-[var(--radix-select-trigger-width)]\"\r\n        >\r\n          {shops.map((shop) => (\r\n            <SelectItem key={shop.id} value={shop.id}>\r\n              {shop.name}\r\n            </SelectItem>\r\n          ))}\r\n        </SelectContent>\r\n      </Select>\r\n    ) : (\r\n      <select\r\n        className=\"h-11 w-full sm:w-[240px] border border-border bg-card px-3 text-sm text-foreground shadow-sm focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n        value={selectedShopId}\r\n        onChange={(e) => handleChange(e.target.value)}\r\n      >\r\n        {shops.map((shop) => (\r\n          <option key={shop.id} value={shop.id}>\r\n            {shop.name}\r\n          </option>\r\n        ))}\r\n      </select>\r\n    )\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\reports\\components\\CashbookReport.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\pos\\pos-app-supabase\\app\\dashboard\\reports\\components\\CashbookReport.tsx:43:5\n  41 |\n  42 |   useEffect(() => {\n> 43 |     setPage(1);\n     |     ^^^^^^^ Avoid calling setState() directly within an effect\n  44 |     setCursorList([]);\n  45 |   }, [shopId, from, to]);\n  46 |","line":43,"column":5,"nodeType":null,"endLine":43,"endColumn":12},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'rows' logical expression could make the dependencies of useMemo Hook (at line 207) change on every render. To fix this, wrap the initialization of 'rows' in its own useMemo() Hook.","line":152,"column":9,"nodeType":"VariableDeclarator","endLine":152,"endColumn":53},{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\pos\\pos-app-supabase\\app\\dashboard\\reports\\components\\CashbookReport.tsx:161:7\n  159 |   useEffect(() => {\n  160 |     if (!online && page > 1) {\n> 161 |       setPage(1);\n      |       ^^^^^^^ Avoid calling setState() directly within an effect\n  162 |       setCursorList([]);\n  163 |     }\n  164 |   }, [online, page]);","line":161,"column":7,"nodeType":null,"endLine":161,"endColumn":14},{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\pos\\pos-app-supabase\\app\\dashboard\\reports\\components\\CashbookReport.tsx:168:7\n  166 |   useEffect(() => {\n  167 |     if (page > 1 && !currentCursor) {\n> 168 |       setPage(1);\n      |       ^^^^^^^ Avoid calling setState() directly within an effect\n  169 |     }\n  170 |   }, [page, currentCursor]);\n  171 |","line":168,"column":7,"nodeType":null,"endLine":168,"endColumn":14}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// app/dashboard/reports/components/CashbookReport.tsx\r\n\r\n\"use client\";\r\n\r\nimport Link from \"next/link\";\r\nimport { useCallback, useEffect, useMemo, useRef, useState } from \"react\";\nimport { useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { useOnlineStatus } from \"@/lib/sync/net-status\";\r\nimport { REPORT_ROW_LIMIT } from \"@/lib/reporting-config\";\nimport { PREFETCH_PRESETS, computePresetRange } from \"@/lib/reporting-range\";\nimport { scheduleIdle } from \"@/lib/schedule-idle\";\nimport { handlePermissionError } from \"@/lib/permission-toast\";\nimport { safeLocalStorageGet, safeLocalStorageSet } from \"@/lib/storage\";\n\r\ntype Props = { shopId: string; from?: string; to?: string };\r\n\r\ntype CashRow = {\r\n  id: string;\r\n  entryType: string;\r\n  amount: number;\r\n  reason: string;\r\n  createdAt: string;\r\n};\r\n\r\ntype ReportCursor = { at: string; id: string };\r\n\r\nexport default function CashbookReport({ shopId, from, to }: Props) {\n  const online = useOnlineStatus();\n  const queryClient = useQueryClient();\n  const [page, setPage] = useState(1);\n  const [cursorList, setCursorList] = useState<ReportCursor[]>([]);\n  const prefetchKeyRef = useRef<string | null>(null);\n\r\n  const currentCursor = page > 1 ? cursorList[page - 2] ?? null : null;\r\n\r\n  const buildCacheKey = useCallback(\r\n    (rangeFrom?: string, rangeTo?: string) =>\r\n      `reports:cash:${shopId}:${rangeFrom || \"all\"}:${rangeTo || \"all\"}:${REPORT_ROW_LIMIT}`,\r\n    [shopId]\r\n  );\r\n\r\n  useEffect(() => {\n    setPage(1);\n    setCursorList([]);\n  }, [shopId, from, to]);\n\r\n  const readCached = useCallback(\n    (rangeFrom?: string, rangeTo?: string) => {\n      if (typeof window === \"undefined\") return null;\n      try {\n        const raw = safeLocalStorageGet(buildCacheKey(rangeFrom, rangeTo));\n        if (!raw) {\n          return null;\n        }\n        const parsed = JSON.parse(raw);\n        return Array.isArray(parsed) ? (parsed as CashRow[]) : null;\n      } catch (err) {\n        handlePermissionError(err);\n        console.warn(\"Cash report cache read failed\", err);\n        return null;\n      }\n    },\n    [buildCacheKey]\n  );\n\n  const fetchCash = useCallback(\n    async (\n      rangeFrom?: string,\n      rangeTo?: string,\n      cursor?: ReportCursor | null,\n      shouldCache = false\n    ) => {\n      const params = new URLSearchParams({\n        shopId,\n        limit: `${REPORT_ROW_LIMIT}`,\n      });\n      if (rangeFrom) params.append(\"from\", rangeFrom);\n      if (rangeTo) params.append(\"to\", rangeTo);\n      if (cursor) {\n        params.append(\"cursorAt\", cursor.at);\n        params.append(\"cursorId\", cursor.id);\n      }\n\n      const res = await fetch(`/api/reports/cash?${params.toString()}`);\n      if (res.status === 304) {\n        const cached = readCached(rangeFrom, rangeTo);\n        if (cached && !cursor) {\n          return { rows: cached, hasMore: false, nextCursor: null };\n        }\n        throw new Error(\"Cash report not modified\");\n      }\n      if (!res.ok) {\n        const cached = readCached(rangeFrom, rangeTo);\n        if (cached && !cursor) {\n          return { rows: cached, hasMore: false, nextCursor: null };\n        }\n        throw new Error(\"Cash report fetch failed\");\n      }\n      const data = await res.json();\n      const rows = data.rows || [];\n      if (shouldCache && !cursor && typeof window !== \"undefined\") {\n        try {\n          safeLocalStorageSet(\n            buildCacheKey(rangeFrom, rangeTo),\n            JSON.stringify(rows)\n          );\n        } catch (err) {\n          handlePermissionError(err);\n          console.warn(\"Cash report cache write failed\", err);\n        }\n      }\n      return {\n        rows,\n        hasMore: Boolean(data.hasMore),\n        nextCursor: data.nextCursor ?? null,\n      };\n    },\n    [shopId, buildCacheKey, readCached]\n  );\n\n  const cashQueryKey = useMemo(\n    () => [\n      \"reports\",\n      \"cash\",\n      shopId,\n      from ?? \"all\",\n      to ?? \"all\",\n      page,\n      currentCursor?.at ?? \"start\",\n      currentCursor?.id ?? \"start\",\n    ],\n    [shopId, from, to, page, currentCursor?.at, currentCursor?.id]\n  );\n\n  const cashQuery = useQuery({\n    queryKey: cashQueryKey,\n    queryFn: () => fetchCash(from, to, currentCursor, page === 1),\n    enabled: online,\n    initialData: () => {\n      if (page !== 1) {\n        return { rows: [], hasMore: false, nextCursor: null };\n      }\n      const cached = readCached(from, to);\n      return cached\n        ? { rows: cached, hasMore: false, nextCursor: null }\n        : { rows: [], hasMore: false, nextCursor: null };\n    },\n    placeholderData: (prev) =>\n      prev ?? { rows: [], hasMore: false, nextCursor: null },\n  });\n\n  const rows: CashRow[] = cashQuery.data?.rows ?? [];\n  const hasMore = cashQuery.data?.hasMore ?? false;\n  const nextCursor = cashQuery.data?.nextCursor ?? null;\n  const loading = cashQuery.isFetching && online;\n  const hasFetched = cashQuery.isFetchedAfterMount;\n  const showEmpty = rows.length === 0 && (!online || hasFetched) && !loading;\n\n  useEffect(() => {\n    if (!online && page > 1) {\n      setPage(1);\n      setCursorList([]);\n    }\n  }, [online, page]);\n\n  useEffect(() => {\n    if (page > 1 && !currentCursor) {\n      setPage(1);\n    }\n  }, [page, currentCursor]);\n\r\n  useEffect(() => {\n    if (!online || typeof window === \"undefined\") return;\n    if (prefetchKeyRef.current === shopId) return;\n    prefetchKeyRef.current = shopId;\n    const cancel = scheduleIdle(() => {\n      PREFETCH_PRESETS.forEach((presetKey) => {\n        const { from: rangeFrom, to: rangeTo } = computePresetRange(presetKey);\n        const queryKey = [\n          \"reports\",\n          \"cash\",\n          shopId,\n          rangeFrom ?? \"all\",\n          rangeTo ?? \"all\",\n          1,\n          \"start\",\n          \"start\",\n        ];\n        if (queryClient.getQueryData(queryKey)) return;\n        queryClient.prefetchQuery({\n          queryKey,\n          queryFn: () => fetchCash(rangeFrom, rangeTo, null, true),\n        });\n      });\n    }, 50);\n    return () => cancel();\n  }, [online, shopId, fetchCash, queryClient]);\n\r\n  const totals = useMemo(() => {\r\n    const inbound = rows\r\n      .filter((r) => (r.entryType || \"\").toUpperCase() === \"IN\")\r\n      .reduce((sum, r) => sum + Number(r.amount || 0), 0);\r\n    const outbound = rows\r\n      .filter((r) => (r.entryType || \"\").toUpperCase() === \"OUT\")\r\n      .reduce((sum, r) => sum + Number(r.amount || 0), 0);\r\n    return { inbound, outbound, balance: inbound - outbound };\r\n  }, [rows]);\r\n\r\n  const handlePrev = () => {\r\n    setPage((prev) => Math.max(1, prev - 1));\r\n  };\r\n\r\n  const handleNext = () => {\r\n    const cursorToUse = cursorList[page - 1] ?? nextCursor;\r\n    if (!cursorToUse) return;\r\n    setCursorList((prev) => {\r\n      const next = [...prev];\r\n      next[page - 1] = cursorToUse;\r\n      return next;\r\n    });\r\n    setPage((prev) => prev + 1);\r\n  };\r\n\r\n  const buildHref = () => {\r\n    const params = new URLSearchParams({ shopId });\r\n    if (from) params.set(\"from\", from);\r\n    if (to) params.set(\"to\", to);\r\n    return `/dashboard/cash?${params.toString()}`;\r\n  };\r\n\r\n  return (\r\n    <div className=\"space-y-4\">\r\n      <div className=\"relative overflow-hidden rounded-2xl border border-border bg-card shadow-[0_12px_30px_rgba(15,23,42,0.08)]\">\r\n        <div className=\"pointer-events-none absolute inset-0 bg-gradient-to-br from-primary-soft/50 via-card to-card\" />\r\n        <div className=\"relative space-y-3 p-4\">\r\n          <div className=\"flex flex-wrap items-start justify-between gap-3\">\r\n            <div className=\"flex items-start gap-3\">\r\n              <span className=\"inline-flex h-10 w-10 items-center justify-center rounded-2xl bg-warning/15 text-warning text-lg\">\r\n                💵\r\n              </span>\r\n              <div>\r\n                <h2 className=\"text-lg font-bold text-foreground\">ক্যাশ রিপোর্ট</h2>\r\n                <p className=\"text-xs text-muted-foreground\">\r\n                  সর্বশেষ 20টি ক্যাশ এন্ট্রি\r\n                </p>\r\n              </div>\r\n            </div>\r\n            <Link\r\n              href={buildHref()}\r\n              className=\"inline-flex h-7 items-center rounded-full border border-primary/20 bg-primary-soft px-3 text-xs font-semibold text-primary hover:bg-primary/20\"\r\n            >\r\n              পূর্ণ রিপোর্ট দেখুন\r\n            </Link>\r\n          </div>\r\n\r\n          <div className=\"grid grid-cols-3 gap-2 text-xs font-semibold\">\r\n            <div className=\"rounded-xl bg-success-soft text-success border border-success/30 px-3 py-2\">\r\n              ইন: {totals.inbound.toFixed(2)} ৳\r\n            </div>\r\n            <div className=\"rounded-xl bg-danger-soft text-danger border border-danger/30 px-3 py-2 text-right\">\r\n              আউট: {totals.outbound.toFixed(2)} ৳\r\n            </div>\r\n            <div className=\"rounded-xl bg-muted text-foreground border border-border px-3 py-2 text-right\">\r\n              ব্যালান্স: {totals.balance.toFixed(2)} ৳\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"rounded-2xl border border-border/70 bg-card/80 p-3 shadow-[0_10px_20px_rgba(15,23,42,0.06)] space-y-2\">\r\n        {rows.length === 0 ? (\n          <p className=\"rounded-xl border border-border bg-card px-4 py-6 text-center text-sm text-muted-foreground\">\n            {showEmpty ? \"কোনো ক্যাশ এন্ট্রি নেই\" : \"লোড হচ্ছে...\"}\n          </p>\n        ) : (\n          <>\r\n            {rows.map((r) => {\r\n              const isIn = (r.entryType || \"\").toUpperCase() === \"IN\";\r\n              const accent = isIn\r\n                ? \"border-success/25 from-success-soft/40\"\r\n                : \"border-danger/25 from-danger-soft/40\";\r\n              const iconTone = isIn\r\n                ? \"bg-success/15 text-success\"\r\n                : \"bg-danger/15 text-danger\";\r\n              return (\r\n                <div\r\n                  key={r.id}\r\n                  className={`relative overflow-hidden rounded-2xl border bg-card p-3 shadow-sm transition-all hover:shadow-md hover:-translate-y-0.5 ${accent}`}\r\n                >\r\n                  <div className={`pointer-events-none absolute inset-0 bg-gradient-to-br ${accent}`} />\r\n                  <div className=\"relative flex items-center justify-between gap-3\">\r\n                    <div className=\"flex items-center gap-3\">\r\n                      <span\n                        className={`inline-flex h-9 w-9 items-center justify-center rounded-2xl text-lg ${iconTone}`}\n                      >\n                        {isIn ? \"⬆️\" : \"⬇️\"}\n                      </span>\n                      <div>\n                        <p\n                          className={`text-sm font-semibold ${\n                            isIn ? \"text-success\" : \"text-danger\"\n                          }`}\n                        >\n                          {isIn ? \"+\" : \"-\"} {Number(r.amount || 0).toFixed(2)} ৳\n                        </p>\n                        <p className=\"text-xs text-muted-foreground\">\n                          {r.reason || \"ক্যাশ এন্ট্রি\"}\n                        </p>\n                      </div>\r\n                    </div>\r\n                    <p className=\"text-xs text-muted-foreground\">\r\n                      {new Date(r.createdAt).toLocaleDateString(\"bn-BD\")}\r\n                    </p>\r\n                  </div>\r\n                </div>\r\n              );\r\n            })}\r\n            {loading && (\n              <p className=\"text-xs text-muted-foreground text-center pt-1\">\n                আপডেট হচ্ছে...\n              </p>\n            )}\n          </>\r\n        )}\r\n      </div>\r\n\r\n      {(page > 1 || hasMore) && (\n        <div className=\"flex items-center justify-between gap-2 pt-2\">\r\n          <button\r\n            type=\"button\"\r\n            onClick={handlePrev}\r\n            disabled={page <= 1 || loading || !online}\r\n            className=\"inline-flex items-center gap-1 rounded-full border border-border px-3 py-1 text-xs font-semibold text-foreground hover:bg-muted disabled:opacity-50 disabled:cursor-not-allowed\"\r\n          >\r\n            Prev\r\n          </button>\r\n          <span className=\"rounded-full border border-border px-3 py-1 text-xs font-semibold text-muted-foreground\">\r\n            Page {page}\r\n          </span>\r\n          <button\r\n            type=\"button\"\r\n            onClick={handleNext}\r\n            disabled={!hasMore || !nextCursor || loading || !online}\r\n            className=\"inline-flex items-center gap-1 rounded-full border border-border px-3 py-1 text-xs font-semibold text-foreground hover:bg-muted disabled:opacity-50 disabled:cursor-not-allowed\"\r\n          >\r\n            Next\r\n          </button>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\reports\\components\\ExpenseReport.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\pos\\pos-app-supabase\\app\\dashboard\\reports\\components\\ExpenseReport.tsx:41:5\n  39 |\n  40 |   useEffect(() => {\n> 41 |     setPage(1);\n     |     ^^^^^^^ Avoid calling setState() directly within an effect\n  42 |     setCursorList([]);\n  43 |   }, [shopId, from, to]);\n  44 |","line":41,"column":5,"nodeType":null,"endLine":41,"endColumn":12},{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\pos\\pos-app-supabase\\app\\dashboard\\reports\\components\\ExpenseReport.tsx:159:7\n  157 |   useEffect(() => {\n  158 |     if (!online && page > 1) {\n> 159 |       setPage(1);\n      |       ^^^^^^^ Avoid calling setState() directly within an effect\n  160 |       setCursorList([]);\n  161 |     }\n  162 |   }, [online, page]);","line":159,"column":7,"nodeType":null,"endLine":159,"endColumn":14},{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\pos\\pos-app-supabase\\app\\dashboard\\reports\\components\\ExpenseReport.tsx:166:7\n  164 |   useEffect(() => {\n  165 |     if (page > 1 && !currentCursor) {\n> 166 |       setPage(1);\n      |       ^^^^^^^ Avoid calling setState() directly within an effect\n  167 |     }\n  168 |   }, [page, currentCursor]);\n  169 |","line":166,"column":7,"nodeType":null,"endLine":166,"endColumn":14}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// app/dashboard/reports/components/ExpenseReport.tsx\r\n\r\n\"use client\";\r\n\r\nimport Link from \"next/link\";\r\nimport { useCallback, useEffect, useMemo, useRef, useState } from \"react\";\nimport { useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { useOnlineStatus } from \"@/lib/sync/net-status\";\r\nimport { REPORT_ROW_LIMIT } from \"@/lib/reporting-config\";\nimport { PREFETCH_PRESETS, computePresetRange } from \"@/lib/reporting-range\";\nimport { scheduleIdle } from \"@/lib/schedule-idle\";\nimport { handlePermissionError } from \"@/lib/permission-toast\";\nimport { safeLocalStorageGet, safeLocalStorageSet } from \"@/lib/storage\";\n\r\ntype Props = { shopId: string; from?: string; to?: string };\n\ntype ReportCursor = { at: string; id: string };\ntype ExpenseRow = {\n  id: string;\n  amount: number | string;\n  category?: string | null;\n  expenseDate: string;\n};\n\r\nexport default function ExpenseReport({ shopId, from, to }: Props) {\n  const online = useOnlineStatus();\n  const queryClient = useQueryClient();\n  const [page, setPage] = useState(1);\n  const [cursorList, setCursorList] = useState<ReportCursor[]>([]);\n  const prefetchKeyRef = useRef<string | null>(null);\n\r\n  const currentCursor = page > 1 ? cursorList[page - 2] ?? null : null;\r\n\r\n  const buildCacheKey = useCallback(\r\n    (rangeFrom?: string, rangeTo?: string) =>\r\n      `reports:expenses:${shopId}:${rangeFrom || \"all\"}:${rangeTo || \"all\"}:${REPORT_ROW_LIMIT}`,\r\n    [shopId]\r\n  );\r\n\r\n  useEffect(() => {\n    setPage(1);\n    setCursorList([]);\n  }, [shopId, from, to]);\n\r\n  const readCached = useCallback(\n    (rangeFrom?: string, rangeTo?: string) => {\n      if (typeof window === \"undefined\") return null;\n      try {\n        const raw = safeLocalStorageGet(buildCacheKey(rangeFrom, rangeTo));\n        if (!raw) {\n          return null;\n        }\n        const parsed = JSON.parse(raw);\n        return Array.isArray(parsed) ? parsed : null;\n      } catch (err) {\n        handlePermissionError(err);\n        console.warn(\"Expense report cache read failed\", err);\n        return null;\n      }\n    },\n    [buildCacheKey]\n  );\n\n  const fetchExpenses = useCallback(\n    async (\n      rangeFrom?: string,\n      rangeTo?: string,\n      cursor?: ReportCursor | null,\n      shouldCache = false\n    ) => {\n      const params = new URLSearchParams({\n        shopId,\n        limit: `${REPORT_ROW_LIMIT}`,\n      });\n      if (rangeFrom) params.append(\"from\", rangeFrom);\n      if (rangeTo) params.append(\"to\", rangeTo);\n      if (cursor) {\n        params.append(\"cursorAt\", cursor.at);\n        params.append(\"cursorId\", cursor.id);\n      }\n\n      const res = await fetch(`/api/reports/expenses?${params.toString()}`);\n      if (res.status === 304) {\n        const cached = readCached(rangeFrom, rangeTo);\n        if (cached && !cursor) {\n          return { rows: cached, hasMore: false, nextCursor: null };\n        }\n        throw new Error(\"Expense report not modified\");\n      }\n      if (!res.ok) {\n        const cached = readCached(rangeFrom, rangeTo);\n        if (cached && !cursor) {\n          return { rows: cached, hasMore: false, nextCursor: null };\n        }\n        throw new Error(\"Expense report fetch failed\");\n      }\n      const data = await res.json();\n      const rows = data.rows || [];\n      if (shouldCache && !cursor && typeof window !== \"undefined\") {\n        try {\n          safeLocalStorageSet(\n            buildCacheKey(rangeFrom, rangeTo),\n            JSON.stringify(rows)\n          );\n        } catch (err) {\n          handlePermissionError(err);\n          console.warn(\"Expense report cache write failed\", err);\n        }\n      }\n      return {\n        rows,\n        hasMore: Boolean(data.hasMore),\n        nextCursor: data.nextCursor ?? null,\n      };\n    },\n    [shopId, buildCacheKey, readCached]\n  );\n\n  const expenseQueryKey = useMemo(\n    () => [\n      \"reports\",\n      \"expenses\",\n      shopId,\n      from ?? \"all\",\n      to ?? \"all\",\n      page,\n      currentCursor?.at ?? \"start\",\n      currentCursor?.id ?? \"start\",\n    ],\n    [shopId, from, to, page, currentCursor?.at, currentCursor?.id]\n  );\n\n  const expenseQuery = useQuery({\n    queryKey: expenseQueryKey,\n    queryFn: () => fetchExpenses(from, to, currentCursor, page === 1),\n    enabled: online,\n    initialData: () => {\n      if (page !== 1) {\n        return { rows: [], hasMore: false, nextCursor: null };\n      }\n      const cached = readCached(from, to);\n      return cached\n        ? { rows: cached, hasMore: false, nextCursor: null }\n        : { rows: [], hasMore: false, nextCursor: null };\n    },\n    placeholderData: (prev) =>\n      prev ?? { rows: [], hasMore: false, nextCursor: null },\n  });\n\n  const items: ExpenseRow[] = expenseQuery.data?.rows ?? [];\n  const hasMore = expenseQuery.data?.hasMore ?? false;\n  const nextCursor = expenseQuery.data?.nextCursor ?? null;\n  const loading = expenseQuery.isFetching && online;\n  const hasFetched = expenseQuery.isFetchedAfterMount;\n  const showEmpty = items.length === 0 && (!online || hasFetched) && !loading;\n\n  useEffect(() => {\n    if (!online && page > 1) {\n      setPage(1);\n      setCursorList([]);\n    }\n  }, [online, page]);\n\n  useEffect(() => {\n    if (page > 1 && !currentCursor) {\n      setPage(1);\n    }\n  }, [page, currentCursor]);\n\r\n  useEffect(() => {\n    if (!online || typeof window === \"undefined\") return;\n    if (prefetchKeyRef.current === shopId) return;\n    prefetchKeyRef.current = shopId;\n    const cancel = scheduleIdle(() => {\n      PREFETCH_PRESETS.forEach((presetKey) => {\n        const { from: rangeFrom, to: rangeTo } = computePresetRange(presetKey);\n        const queryKey = [\n          \"reports\",\n          \"expenses\",\n          shopId,\n          rangeFrom ?? \"all\",\n          rangeTo ?? \"all\",\n          1,\n          \"start\",\n          \"start\",\n        ];\n        if (queryClient.getQueryData(queryKey)) return;\n        queryClient.prefetchQuery({\n          queryKey,\n          queryFn: () => fetchExpenses(rangeFrom, rangeTo, null, true),\n        });\n      });\n    }, 50);\n    return () => cancel();\n  }, [online, shopId, fetchExpenses, queryClient]);\n\r\n  const shownTotal = items.reduce(\r\n    (sum, e) => sum + Number(e.amount || 0),\r\n    0\r\n  );\r\n\r\n  const handlePrev = () => {\r\n    setPage((prev) => Math.max(1, prev - 1));\r\n  };\r\n\r\n  const handleNext = () => {\r\n    const cursorToUse = cursorList[page - 1] ?? nextCursor;\r\n    if (!cursorToUse) return;\r\n    setCursorList((prev) => {\r\n      const next = [...prev];\r\n      next[page - 1] = cursorToUse;\r\n      return next;\r\n    });\r\n    setPage((prev) => prev + 1);\r\n  };\r\n\r\n  const buildHref = () => {\r\n    const params = new URLSearchParams({ shopId });\r\n    if (from) params.set(\"from\", from);\r\n    if (to) params.set(\"to\", to);\r\n    return `/dashboard/expenses?${params.toString()}`;\r\n  };\r\n\r\n  return (\r\n    <div className=\"space-y-4\">\r\n      <div className=\"relative overflow-hidden rounded-2xl border border-border bg-card shadow-[0_12px_30px_rgba(15,23,42,0.08)]\">\r\n        <div className=\"pointer-events-none absolute inset-0 bg-gradient-to-br from-primary-soft/50 via-card to-card\" />\r\n        <div className=\"relative space-y-3 p-4\">\r\n          <div className=\"flex flex-wrap items-start justify-between gap-3\">\r\n            <div className=\"flex items-start gap-3\">\r\n              <span className=\"inline-flex h-10 w-10 items-center justify-center rounded-2xl bg-danger/15 text-danger text-lg\">\r\n                💸\r\n              </span>\r\n              <div>\r\n                <h2 className=\"text-lg font-bold text-foreground\">খরচ রিপোর্ট</h2>\r\n                <p className=\"text-xs text-muted-foreground\">\r\n                  সর্বশেষ 20টি খরচ\r\n                </p>\r\n              </div>\r\n            </div>\r\n            <Link\r\n              href={buildHref()}\r\n              className=\"inline-flex h-7 items-center rounded-full border border-primary/20 bg-primary-soft px-3 text-xs font-semibold text-primary hover:bg-primary/20\"\r\n            >\r\n              পূর্ণ রিপোর্ট দেখুন\r\n            </Link>\r\n          </div>\r\n\r\n          <div className=\"flex flex-wrap items-center gap-2 text-xs font-semibold\">\r\n            <span className=\"inline-flex h-7 items-center rounded-full border border-border bg-card/80 px-3 text-muted-foreground\">\r\n              এই তালিকায় মোট খরচ: {shownTotal.toFixed(2)} ৳\r\n            </span>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"rounded-2xl border border-border/70 bg-card/80 p-3 shadow-[0_10px_20px_rgba(15,23,42,0.06)] space-y-2\">\r\n        {items.length === 0 ? (\n          <p className=\"rounded-xl border border-border bg-card px-4 py-6 text-center text-sm text-muted-foreground\">\n            {showEmpty ? \"কোনো খরচ পাওয়া যায়নি\" : \"লোড হচ্ছে...\"}\n          </p>\n        ) : (\n          <>\r\n            {items.map((e) => (\r\n              <div\r\n                key={e.id}\r\n                className=\"relative overflow-hidden rounded-2xl border border-danger/20 bg-card p-3 shadow-sm transition-all hover:shadow-md hover:-translate-y-0.5\"\r\n              >\r\n                <div className=\"pointer-events-none absolute inset-0 bg-gradient-to-br from-danger-soft/40 via-transparent to-transparent\" />\r\n                <div className=\"relative flex items-center justify-between gap-3\">\r\n                  <div className=\"flex items-center gap-3\">\n                    <span className=\"inline-flex h-9 w-9 items-center justify-center rounded-2xl bg-danger/15 text-danger text-lg\">\n                      💸\n                    </span>\n                    <div>\n                      <p className=\"text-sm font-semibold text-foreground\">\n                        {Number(e.amount).toFixed(2)} ৳\n                      </p>\n                      <p className=\"text-xs text-muted-foreground\">\r\n                        {e.category}\r\n                      </p>\r\n                    </div>\r\n                  </div>\r\n                  <p className=\"text-xs text-muted-foreground\">\r\n                    {new Date(e.expenseDate).toLocaleDateString(\"bn-BD\")}\r\n                  </p>\r\n                </div>\r\n              </div>\r\n            ))}\r\n            {loading && (\n              <p className=\"text-xs text-muted-foreground text-center pt-1\">\n                আপডেট হচ্ছে...\n              </p>\n            )}\n          </>\r\n        )}\r\n      </div>\r\n\r\n      {(page > 1 || hasMore) && (\n        <div className=\"flex items-center justify-between gap-2 pt-2\">\r\n          <button\r\n            type=\"button\"\r\n            onClick={handlePrev}\r\n            disabled={page <= 1 || loading || !online}\r\n            className=\"inline-flex items-center gap-1 rounded-full border border-border px-3 py-1 text-xs font-semibold text-foreground hover:bg-muted disabled:opacity-50 disabled:cursor-not-allowed\"\r\n          >\r\n            Prev\r\n          </button>\r\n          <span className=\"rounded-full border border-border px-3 py-1 text-xs font-semibold text-muted-foreground\">\r\n            Page {page}\r\n          </span>\r\n          <button\r\n            type=\"button\"\r\n            onClick={handleNext}\r\n            disabled={!hasMore || !nextCursor || loading || !online}\r\n            className=\"inline-flex items-center gap-1 rounded-full border border-border px-3 py-1 text-xs font-semibold text-foreground hover:bg-muted disabled:opacity-50 disabled:cursor-not-allowed\"\r\n          >\r\n            Next\r\n          </button>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\reports\\components\\LowStockReport.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\reports\\components\\PaymentMethodReport.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'data' logical expression could make the dependencies of useMemo Hook (at line 136) change on every render. To fix this, wrap the initialization of 'data' in its own useMemo() Hook.","line":105,"column":9,"nodeType":"VariableDeclarator","endLine":105,"endColumn":53}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// app/dashboard/reports/components/PaymentMethodReport.tsx\r\n\r\n\"use client\";\r\n\r\nimport { useCallback, useEffect, useMemo, useRef } from \"react\";\r\nimport { keepPreviousData, useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { useOnlineStatus } from \"@/lib/sync/net-status\";\r\nimport { PREFETCH_PRESETS, computePresetRange } from \"@/lib/reporting-range\";\nimport { scheduleIdle } from \"@/lib/schedule-idle\";\nimport { handlePermissionError } from \"@/lib/permission-toast\";\nimport { safeLocalStorageGet, safeLocalStorageSet } from \"@/lib/storage\";\n\r\ntype PaymentRow = { name: string; value: number; count?: number };\r\ntype Props = { shopId: string; from?: string; to?: string };\r\n\r\nexport default function PaymentMethodReport({ shopId, from, to }: Props) {\r\n  const online = useOnlineStatus();\r\n  const queryClient = useQueryClient();\r\n  const prefetchKeyRef = useRef<string | null>(null);\r\n\r\n  const buildCacheKey = useCallback(\r\n    (rangeFrom?: string, rangeTo?: string) =>\r\n      `reports:payment:${shopId}:${rangeFrom || \"all\"}:${rangeTo || \"all\"}`,\r\n    [shopId]\r\n  );\r\n\r\n  \r\n  const readCached = useCallback(\n    (rangeFrom?: string, rangeTo?: string) => {\n      if (typeof window === \"undefined\") return null;\n      try {\n        const raw = safeLocalStorageGet(buildCacheKey(rangeFrom, rangeTo));\n        if (!raw) {\n          return null;\n        }\n        const parsed = JSON.parse(raw);\n        return Array.isArray(parsed) ? (parsed as PaymentRow[]) : null;\n      } catch (err) {\n        handlePermissionError(err);\n        console.warn(\"Payment report cache read failed\", err);\n        return null;\n      }\n    },\n    [buildCacheKey]\n  );\n\r\n  const fetchPayment = useCallback(\r\n    async (rangeFrom?: string, rangeTo?: string) => {\r\n      const params = new URLSearchParams({ shopId });\n      if (rangeFrom) params.append(\"from\", rangeFrom);\n      if (rangeTo) params.append(\"to\", rangeTo);\n      params.append(\"fresh\", \"1\");\n\n      const res = await fetch(\n        `/api/reports/payment-method?${params.toString()}`,\n        { cache: \"no-cache\" }\n      );\n\n      if (res.status === 304) {\n        return readCached(rangeFrom, rangeTo) ?? [];\n      }\n      if (!res.ok) {\n        const cached = readCached(rangeFrom, rangeTo);\n        if (cached) return cached;\n        throw new Error(\"Payment report fetch failed\");\r\n      }\r\n\r\n      const text = await res.text();\r\n      if (!text) {\r\n        const cached = readCached(rangeFrom, rangeTo);\r\n        if (cached) return cached;\r\n        return [];\r\n      }\r\n      const json = JSON.parse(text);\n      const rows = Array.isArray(json?.data) ? json.data : [];\n      if (typeof window !== \"undefined\") {\n        try {\n          safeLocalStorageSet(\n            buildCacheKey(rangeFrom, rangeTo),\n            JSON.stringify(rows)\n          );\n        } catch (err) {\n          handlePermissionError(err);\n          console.warn(\"Payment report cache write failed\", err);\n        }\n      }\n      return rows;\n    },\r\n    [shopId, buildCacheKey, readCached]\r\n  );\r\n\r\n  const paymentQueryKey = useMemo(\r\n    () => [\"reports\", \"payment\", shopId, from ?? \"all\", to ?? \"all\"],\r\n    [shopId, from, to]\r\n  );\r\n\r\n  const paymentQuery = useQuery({\n    queryKey: paymentQueryKey,\n    queryFn: () => fetchPayment(from, to),\n    enabled: online,\n    initialData: () => readCached(from, to) ?? [],\n    placeholderData: keepPreviousData,\n  });\n\n  const data: PaymentRow[] = paymentQuery.data ?? [];\n  const loading = paymentQuery.isFetching && online;\n  const hasFetched = paymentQuery.isFetchedAfterMount;\n  const showEmpty = data.length === 0 && (!online || hasFetched) && !loading;\n\r\n  useEffect(() => {\r\n    if (!online || typeof window === \"undefined\") return;\r\n    if (prefetchKeyRef.current === shopId) return;\r\n    prefetchKeyRef.current = shopId;\n    const cancel = scheduleIdle(() => {\n      PREFETCH_PRESETS.forEach((presetKey) => {\n        const { from: rangeFrom, to: rangeTo } = computePresetRange(presetKey);\n        const queryKey = [\n          \"reports\",\n          \"payment\",\n          shopId,\n          rangeFrom ?? \"all\",\n          rangeTo ?? \"all\",\n        ];\n        if (queryClient.getQueryData(queryKey)) return;\n        queryClient.prefetchQuery({\n          queryKey,\n          queryFn: () => fetchPayment(rangeFrom, rangeTo),\n        });\n      });\n    }, 50);\n    return () => cancel();\n  }, [online, shopId, fetchPayment, queryClient]);\n\r\n  const totalAmount = useMemo(\r\n    () => data.reduce((sum, item) => sum + Number(item.value || 0), 0),\r\n    [data]\r\n  );\r\n\r\n  return (\r\n    <div className=\"space-y-4\">\r\n      <div className=\"relative overflow-hidden rounded-2xl border border-border bg-card shadow-[0_12px_30px_rgba(15,23,42,0.08)]\">\r\n        <div className=\"pointer-events-none absolute inset-0 bg-gradient-to-br from-primary-soft/50 via-card to-card\" />\r\n        <div className=\"relative space-y-3 p-4\">\r\n          <div className=\"flex flex-wrap items-start justify-between gap-3\">\r\n            <div className=\"flex items-start gap-3\">\r\n              <span className=\"inline-flex h-10 w-10 items-center justify-center rounded-2xl bg-primary/15 text-primary text-lg\">\r\n                💳\r\n              </span>\r\n              <div>\r\n                <h2 className=\"text-lg font-bold text-foreground\">পেমেন্ট মাধ্যম</h2>\r\n                <p className=\"text-xs text-muted-foreground\">শেয়ার ও পরিমাণ</p>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"flex flex-wrap items-center gap-2 text-xs font-semibold\">\r\n            <span className=\"inline-flex h-7 items-center rounded-full border border-border bg-card/80 px-3 text-muted-foreground\">\r\n              মোট: {totalAmount.toFixed(2)} ৳\r\n            </span>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"rounded-2xl border border-border/70 bg-card/80 p-2 shadow-[0_10px_20px_rgba(15,23,42,0.06)] space-y-2\">\r\n        {data.length === 0 ? (\n          <p className=\"rounded-xl border border-border bg-card px-4 py-6 text-center text-sm text-muted-foreground\">\n            {showEmpty ? \"কোনো পেমেন্ট ডাটা নেই\" : \"লোড হচ্ছে...\"}\n          </p>\n        ) : (\n          <>\r\n            {data.map((item, idx) => {\r\n              const percent =\r\n                totalAmount > 0\r\n                  ? Math.round((Number(item.value || 0) / totalAmount) * 100)\r\n                  : 0;\r\n\r\n              return (\r\n                <div\r\n                  key={`${item.name}-${idx}`}\r\n                  className=\"relative overflow-hidden rounded-2xl border border-primary/20 bg-card p-3 shadow-sm transition-all hover:shadow-md hover:-translate-y-0.5 space-y-2\"\r\n                >\r\n                  <div className=\"pointer-events-none absolute inset-0 bg-gradient-to-br from-primary-soft/40 via-transparent to-transparent\" />\r\n                  <div className=\"relative flex items-center justify-between gap-3\">\r\n                    <div className=\"flex items-center gap-3\">\n                      <span className=\"inline-flex h-9 w-9 items-center justify-center rounded-2xl bg-primary/15 text-primary text-lg\">\n                        💳\n                      </span>\n                      <div>\n                        <p className=\"font-semibold text-foreground\">\n                          {item.name || \"অজানা\"}\n                        </p>\n                        {typeof item.count === \"number\" && (\n                          <p className=\"text-xs text-muted-foreground mt-1\">\n                            {item.count} টি লেনদেন\n                          </p>\n                        )}\n                      </div>\n                    </div>\n                    <div className=\"text-right\">\n                      <p className=\"font-semibold text-foreground\">\n                        {Number(item.value || 0)} ৳\n                      </p>\n                      <p className=\"text-xs text-muted-foreground mt-1\">\n                        {percent}% শেয়ার\n                      </p>\n                    </div>\n                  </div>\n                  <div className=\"relative h-2 w-full rounded-full bg-muted/70 overflow-hidden\">\r\n                    <div\r\n                      className=\"h-full rounded-full bg-gradient-to-r from-primary via-primary-hover to-primary\"\r\n                      style={{ width: `${percent}%` }}\r\n                    />\r\n                  </div>\r\n                </div>\r\n              );\r\n            })}\r\n            {loading && (\n              <p className=\"text-xs text-muted-foreground text-center pt-1\">\n                আপডেট হচ্ছে...\n              </p>\n            )}\n          </>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\reports\\components\\ProfitTrendReport.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'data' logical expression could make the dependencies of useMemo Hook (at line 131) change on every render. To fix this, wrap the initialization of 'data' in its own useMemo() Hook.","line":96,"column":9,"nodeType":"VariableDeclarator","endLine":96,"endColumn":51}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// app/dashboard/reports/components/ProfitTrendReport.tsx\r\n\r\n\"use client\";\r\n\r\nimport { useCallback, useEffect, useMemo, useRef } from \"react\";\r\nimport { keepPreviousData, useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { useOnlineStatus } from \"@/lib/sync/net-status\";\r\nimport { PREFETCH_PRESETS, computePresetRange } from \"@/lib/reporting-range\";\nimport { scheduleIdle } from \"@/lib/schedule-idle\";\nimport { handlePermissionError } from \"@/lib/permission-toast\";\nimport { safeLocalStorageGet, safeLocalStorageSet } from \"@/lib/storage\";\n\r\ntype ProfitRow = { date: string; sales: number; expense: number };\r\ntype Props = { shopId: string; from?: string; to?: string };\r\n\r\nexport default function ProfitTrendReport({ shopId, from, to }: Props) {\r\n  const online = useOnlineStatus();\r\n  const queryClient = useQueryClient();\r\n  const prefetchKeyRef = useRef<string | null>(null);\r\n\r\n  const buildCacheKey = useCallback(\r\n    (rangeFrom?: string, rangeTo?: string) =>\r\n      `reports:profit:${shopId}:${rangeFrom || \"all\"}:${rangeTo || \"all\"}`,\r\n    [shopId]\r\n  );\r\n\r\n  \r\n  const readCached = useCallback(\n    (rangeFrom?: string, rangeTo?: string) => {\n      if (typeof window === \"undefined\") return null;\n      try {\n        const raw = safeLocalStorageGet(buildCacheKey(rangeFrom, rangeTo));\n        if (!raw) {\n          return null;\n        }\n        const parsed = JSON.parse(raw);\n        return Array.isArray(parsed) ? (parsed as ProfitRow[]) : null;\n      } catch (err) {\n        handlePermissionError(err);\n        console.warn(\"Profit report cache read failed\", err);\n        return null;\n      }\n    },\n    [buildCacheKey]\n  );\n\r\n  const fetchProfit = useCallback(\r\n    async (rangeFrom?: string, rangeTo?: string) => {\r\n      const params = new URLSearchParams({ shopId });\n      if (rangeFrom) params.append(\"from\", rangeFrom);\n      if (rangeTo) params.append(\"to\", rangeTo);\n\n      params.append(\"fresh\", \"1\");\n      const res = await fetch(`/api/reports/profit-trend?${params.toString()}`, {\n        cache: \"no-cache\",\n      });\n      if (res.status === 304) {\n        return readCached(rangeFrom, rangeTo) ?? [];\n      }\n      if (!res.ok) {\n        const cached = readCached(rangeFrom, rangeTo);\n        if (cached) return cached;\n        throw new Error(\"Profit report fetch failed\");\r\n      }\n      const json = await res.json();\n      const rows = Array.isArray(json?.data) ? json.data : [];\n      if (typeof window !== \"undefined\") {\n        try {\n          safeLocalStorageSet(\n            buildCacheKey(rangeFrom, rangeTo),\n            JSON.stringify(rows)\n          );\n        } catch (err) {\n          handlePermissionError(err);\n          console.warn(\"Profit report cache write failed\", err);\n        }\n      }\n      return rows;\n    },\r\n    [shopId, buildCacheKey, readCached]\r\n  );\r\n\r\n  const profitQueryKey = useMemo(\r\n    () => [\"reports\", \"profit\", shopId, from ?? \"all\", to ?? \"all\"],\r\n    [shopId, from, to]\r\n  );\r\n\r\n  const profitQuery = useQuery({\n    queryKey: profitQueryKey,\n    queryFn: () => fetchProfit(from, to),\n    enabled: online,\n    initialData: () => readCached(from, to) ?? [],\n    placeholderData: keepPreviousData,\n  });\n\n  const data: ProfitRow[] = profitQuery.data ?? [];\n  const loading = profitQuery.isFetching && online;\n  const hasFetched = profitQuery.isFetchedAfterMount;\n  const showEmpty = data.length === 0 && (!online || hasFetched) && !loading;\n\r\n  useEffect(() => {\r\n    if (!online || typeof window === \"undefined\") return;\r\n    if (prefetchKeyRef.current === shopId) return;\r\n    prefetchKeyRef.current = shopId;\n    const cancel = scheduleIdle(() => {\n      PREFETCH_PRESETS.forEach((presetKey) => {\n        const { from: rangeFrom, to: rangeTo } = computePresetRange(presetKey);\n        const queryKey = [\n          \"reports\",\n          \"profit\",\n          shopId,\n          rangeFrom ?? \"all\",\n          rangeTo ?? \"all\",\n        ];\n        if (queryClient.getQueryData(queryKey)) return;\n        queryClient.prefetchQuery({\n          queryKey,\n          queryFn: () => fetchProfit(rangeFrom, rangeTo),\n        });\n      });\n    }, 50);\n    return () => cancel();\n  }, [online, shopId, fetchProfit, queryClient]);\n\r\n  const totalProfit = useMemo(\r\n    () =>\r\n      data.reduce(\r\n        (sum, row) => sum + Number(row.sales || 0) - Number(row.expense || 0),\r\n        0\r\n      ),\r\n    [data]\r\n  );\r\n\r\n  return (\r\n    <div className=\"space-y-4\">\r\n      <div className=\"relative overflow-hidden rounded-2xl border border-border bg-card shadow-[0_12px_30px_rgba(15,23,42,0.08)]\">\r\n        <div className=\"pointer-events-none absolute inset-0 bg-gradient-to-br from-primary-soft/50 via-card to-card\" />\r\n        <div className=\"relative space-y-3 p-4\">\r\n          <div className=\"flex flex-wrap items-start justify-between gap-3\">\r\n            <div className=\"flex items-start gap-3\">\r\n              <span className=\"inline-flex h-10 w-10 items-center justify-center rounded-2xl bg-primary/15 text-primary text-lg\">\r\n                📈\r\n              </span>\r\n              <div>\r\n                <h2 className=\"text-lg font-bold text-foreground\">লাভের প্রবণতা</h2>\r\n                <p className=\"text-xs text-muted-foreground\">\n                  দিনওয়ারি লাভ/খরচ (COGS সহ)\n                </p>\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"flex flex-wrap items-center gap-2 text-xs font-semibold\">\r\n            <span className=\"inline-flex h-7 items-center rounded-full border border-border bg-card/80 px-3 text-muted-foreground\">\r\n              মোট লাভ: {totalProfit.toFixed(2)} ৳\r\n            </span>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"rounded-2xl border border-border overflow-x-auto hidden md:block\">\r\n        <table className=\"w-full text-sm\">\r\n          <thead className=\"bg-muted\">\r\n            <tr>\r\n              <th className=\"p-3 text-left text-foreground\">তারিখ</th>\r\n              <th className=\"p-3 text-right text-foreground\">বিক্রি (৳)</th>\r\n              <th className=\"p-3 text-right text-foreground\">\n                খরচ + COGS (৳)\n              </th>\n              <th className=\"p-3 text-right text-foreground\">লাভ (৳)</th>\r\n            </tr>\r\n          </thead>\r\n\r\n          <tbody>\r\n            {data.length === 0 ? (\n              <tr>\n                <td className=\"p-3 text-center text-muted-foreground\" colSpan={4}>\n                  {showEmpty ? \"কোনো তথ্য নেই\" : \"লোড হচ্ছে...\"}\n                </td>\n              </tr>\n            ) : (\n              data.map((row, idx) => {\r\n                const profit =\r\n                  Number(row.sales || 0) - Number(row.expense || 0);\r\n                return (\r\n                  <tr\r\n                    key={`${row.date}-${idx}`}\r\n                    className=\"border-t hover:bg-muted transition-colors\"\r\n                  >\r\n                    <td className=\"p-3 text-foreground\">\r\n                      {new Date(row.date).toLocaleDateString(\"bn-BD\")}\r\n                    </td>\r\n                    <td className=\"p-3 text-right text-foreground\">\r\n                      {Number(row.sales || 0).toFixed(2)}\r\n                    </td>\r\n                    <td className=\"p-3 text-right text-foreground\">\r\n                      {Number(row.expense || 0).toFixed(2)}\r\n                    </td>\r\n                    <td\r\n                      className={`p-2 text-right font-semibold ${\r\n                        profit >= 0 ? \"text-success\" : \"text-danger\"\r\n                      }`}\r\n                    >\r\n                      {profit.toFixed(2)}\r\n                    </td>\r\n                  </tr>\r\n                );\r\n              })\r\n            )}\r\n          </tbody>\r\n        </table>\r\n        {loading && data.length > 0 && (\n          <p className=\"p-2 text-center text-xs text-muted-foreground\">\n            আপডেট হচ্ছে...\n          </p>\n        )}\n      </div>\r\n\r\n      <div className=\"space-y-3 md:hidden\">\r\n        {data.length === 0 ? (\n          <p className=\"rounded-xl border border-border bg-card px-4 py-6 text-center text-sm text-muted-foreground\">\n            {showEmpty ? \"কোনো তথ্য নেই\" : \"লোড হচ্ছে...\"}\n          </p>\n        ) : (\n          <>\r\n            {data.map((row, idx) => {\r\n              const profit = Number(row.sales || 0) - Number(row.expense || 0);\r\n              const positive = profit >= 0;\r\n              return (\r\n                <div\r\n                  key={`${row.date}-${idx}`}\r\n                  className=\"relative overflow-hidden bg-card border border-border/70 rounded-2xl p-4 shadow-[0_10px_20px_rgba(15,23,42,0.06)] flex gap-3\"\r\n                >\r\n                  <div\r\n                    className={`pointer-events-none absolute inset-0 bg-gradient-to-br ${\r\n                      positive ? \"from-success-soft/35\" : \"from-danger-soft/35\"\r\n                    } via-transparent to-transparent`}\r\n                  />\r\n                  <div\r\n                    className={`relative w-1 rounded-full ${\r\n                      positive ? \"bg-success\" : \"bg-danger\"\r\n                    }`}\r\n                  />\r\n                  <div className=\"relative flex-1 space-y-2\">\r\n                    <div className=\"flex items-center justify-between\">\r\n                      <div>\r\n                        <p className=\"text-xs text-muted-foreground\">#{idx + 1}</p>\r\n                        <h3 className=\"text-base font-semibold text-foreground mt-1\">\r\n                          {new Date(row.date).toLocaleDateString(\"bn-BD\")}\r\n                        </h3>\r\n                      </div>\r\n                      <span\n                        className={`px-3 py-1 rounded-full text-xs font-semibold ${\n                          positive\n                            ? \"bg-success-soft text-success\"\n                            : \"bg-danger-soft text-danger\"\n                        }`}\n                      >\n                        {positive ? \"লাভ\" : \"ক্ষতি\"}\n                      </span>\n                    </div>\n\n                    <div className=\"grid grid-cols-2 gap-3 text-sm text-muted-foreground\">\n                      <div className=\"bg-muted/60 rounded-xl p-3\">\n                        <p className=\"text-xs text-muted-foreground\">বিক্রি</p>\n                        <p className=\"text-base font-semibold text-foreground\">\n                          {Number(row.sales || 0).toFixed(2)} ৳\n                        </p>\n                      </div>\n                      <div className=\"bg-muted/60 rounded-xl p-3\">\n                        <p className=\"text-xs text-muted-foreground\">\n                          খরচ + COGS\n                        </p>\n                        <p className=\"text-base font-semibold text-foreground\">\n                          {Number(row.expense || 0).toFixed(2)} ৳\n                        </p>\n                      </div>\n                    </div>\n\n                    <div className=\"flex items-center justify-between text-sm text-muted-foreground\">\n                      <span>লাভ</span>\n                      <span\n                        className={`font-semibold ${\n                          positive ? \"text-success\" : \"text-danger\"\n                        }`}\n                      >\n                        {profit.toFixed(2)} ৳\n                      </span>\n                    </div>\n                  </div>\r\n                </div>\r\n              );\r\n            })}\r\n            {loading && (\n              <p className=\"text-xs text-muted-foreground text-center\">\n                আপডেট হচ্ছে...\n              </p>\n            )}\n          </>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\reports\\components\\ReportsClient.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\pos\\pos-app-supabase\\app\\dashboard\\reports\\components\\ReportsClient.tsx:92:7\n  90 |     const node = ref.current;\n  91 |     if (!node || typeof IntersectionObserver === \"undefined\") {\n> 92 |       setVisible(true);\n     |       ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  93 |       return;\n  94 |     }\n  95 |","line":92,"column":7,"nodeType":null,"endLine":92,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// app/dashboard/reports/components/ReportsClient.tsx\r\n\r\n\"use client\";\r\n\r\nimport {\r\n  useCallback,\r\n  useEffect,\r\n  useMemo,\r\n  useRef,\r\n  useState,\r\n  type ReactNode,\r\n} from \"react\";\r\nimport dynamic from \"next/dynamic\";\nimport { useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport ShopSelectorClient from \"../ShopSelectorClient\";\nimport { StatCard } from \"./StatCard\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport { toast } from \"sonner\";\nimport { useOnlineStatus } from \"@/lib/sync/net-status\";\nimport {\n  PREFETCH_PRESETS,\n  computeRange,\n  computePresetRange,\n  type RangePreset,\r\n} from \"@/lib/reporting-range\";\r\nimport { REPORT_ROW_LIMIT } from \"@/lib/reporting-config\";\nimport { scheduleIdle } from \"@/lib/schedule-idle\";\nimport { handlePermissionError } from \"@/lib/permission-toast\";\nimport { reportEvents } from \"@/lib/events/reportEvents\";\nimport { useRealtimeStatus } from \"@/lib/realtime/status\";\nimport { usePageVisibility } from \"@/lib/use-page-visibility\";\nimport { safeLocalStorageGet, safeLocalStorageSet } from \"@/lib/storage\";\nimport { generateCSV } from \"@/lib/utils/csv\";\nimport { downloadFile } from \"@/lib/utils/download\";\n\ntype Summary = {\n  sales: {\n    totalAmount: number;\n    completedCount?: number;\n    voidedCount?: number;\n    count?: number;\n  };\n  expense: { totalAmount: number; count?: number };\n  cash: { balance: number; totalIn: number; totalOut: number };\n  profit: {\n    profit: number;\n    salesTotal: number;\n    expenseTotal: number;\n    cogs?: number;\n  };\n};\n\r\ntype Props = {\r\n  shopId: string;\r\n  shopName: string;\r\n  shops: { id: string; name: string }[];\r\n  summary: Summary;\r\n};\r\n\r\nfunction ReportSkeleton() {\r\n  return (\r\n    <div className=\"animate-pulse space-y-3\">\r\n      <div className=\"h-4 w-28 rounded bg-muted\" />\r\n      <div className=\"h-3 w-44 rounded bg-muted\" />\r\n      <div className=\"h-40 w-full rounded bg-muted\" />\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction LazyReport({\r\n  children,\r\n  fallback,\r\n  rootMargin = \"200px\",\r\n}: {\r\n  children: ReactNode;\r\n  fallback?: ReactNode;\r\n  rootMargin?: string;\r\n}) {\r\n  const ref = useRef<HTMLDivElement | null>(null);\r\n  const [visible, setVisible] = useState(false);\r\n\r\n  useEffect(() => {\r\n    if (visible) return;\r\n    const node = ref.current;\r\n    if (!node || typeof IntersectionObserver === \"undefined\") {\r\n      setVisible(true);\r\n      return;\r\n    }\r\n\r\n    const observer = new IntersectionObserver(\r\n      (entries) => {\r\n        if (entries.some((entry) => entry.isIntersecting)) {\r\n          setVisible(true);\r\n          observer.disconnect();\r\n        }\r\n      },\r\n      { rootMargin }\r\n    );\r\n\r\n    observer.observe(node);\r\n    return () => observer.disconnect();\r\n  }, [visible, rootMargin]);\r\n\r\n  return <div ref={ref}>{visible ? children : fallback}</div>;\r\n}\r\n\r\nconst SalesReport = dynamic(() => import(\"./SalesReport\"), {\r\n  loading: () => <ReportSkeleton />,\r\n});\r\nconst ExpenseReport = dynamic(() => import(\"./ExpenseReport\"), {\r\n  loading: () => <ReportSkeleton />,\r\n});\r\nconst CashbookReport = dynamic(() => import(\"./CashbookReport\"), {\r\n  loading: () => <ReportSkeleton />,\r\n});\r\nconst ProfitTrendReport = dynamic(() => import(\"./ProfitTrendReport\"), {\r\n  loading: () => <ReportSkeleton />,\r\n});\r\nconst PaymentMethodReport = dynamic(() => import(\"./PaymentMethodReport\"), {\r\n  loading: () => <ReportSkeleton />,\r\n});\r\nconst TopProductsReport = dynamic(() => import(\"./TopProductsReport\"), {\r\n  loading: () => <ReportSkeleton />,\r\n});\r\nconst LowStockReport = dynamic(() => import(\"./LowStockReport\"), {\n  loading: () => <ReportSkeleton />,\n});\n\ntype ReportKey = (typeof NAV)[number][\"key\"];\n\nconst prefetchReportModule = (key: ReportKey) => {\n  switch (key) {\n    case \"sales\":\n      return import(\"./SalesReport\");\n    case \"expenses\":\n      return import(\"./ExpenseReport\");\n    case \"cash\":\n      return import(\"./CashbookReport\");\n    case \"payment\":\n      return import(\"./PaymentMethodReport\");\n    case \"profit\":\n      return import(\"./ProfitTrendReport\");\n    case \"products\":\n      return import(\"./TopProductsReport\");\n    case \"stock\":\n      return import(\"./LowStockReport\");\n    default:\n      return Promise.resolve();\n  }\n};\n\nconst PREFETCH_REPORTS_BY_TAB: Record<ReportKey, ReportKey[]> = {\n  summary: [\"sales\", \"expenses\"],\n  sales: [\"expenses\", \"cash\"],\n  expenses: [\"sales\", \"cash\"],\n  cash: [\"payment\", \"profit\"],\n  payment: [\"profit\"],\n  profit: [\"payment\", \"products\"],\n  products: [\"stock\"],\n  stock: [],\n};\n\nconst PREFETCH_REPORT_DATA_BY_TAB: Record<ReportKey, ReportKey[]> = {\n  summary: [\"sales\", \"expenses\", \"cash\"],\n  sales: [\"expenses\", \"cash\"],\n  expenses: [\"sales\", \"cash\"],\n  cash: [\"payment\", \"profit\"],\n  payment: [\"profit\"],\n  profit: [\"payment\"],\n  products: [\"stock\"],\n  stock: [\"products\"],\n};\n\nconst NAV = [\r\n  { key: \"summary\", label: \"সারাংশ\" },\r\n  { key: \"sales\", label: \"বিক্রি\" },\r\n  { key: \"expenses\", label: \"খরচ\" },\r\n  { key: \"cash\", label: \"ক্যাশ\" },\r\n  { key: \"payment\", label: \"পেমেন্ট\" },\r\n  { key: \"profit\", label: \"লাভ\" },\r\n  { key: \"products\", label: \"পণ্য\" },\r\n  { key: \"stock\", label: \"লো স্টক\" },\r\n] as const;\r\n\r\nconst PRESETS: { key: RangePreset; label: string }[] = [\n  { key: \"today\", label: \"আজ\" },\n  { key: \"yesterday\", label: \"গতকাল\" },\n  { key: \"7d\", label: \"৭ দিন\" },\n  { key: \"month\", label: \"এই মাস\" },\n  { key: \"all\", label: \"সব\" },\n  { key: \"custom\", label: \"কাস্টম\" },\n];\n\nconst EXPORT_PAGE_LIMIT = REPORT_ROW_LIMIT;\nconst EXPORT_MAX_PAGES = 250;\nconst EXPORT_MAX_ROWS = 5000;\nconst EXPORT_LOW_STOCK_THRESHOLD = 20;\n\ntype ExportCursor = { at: string; id: string };\n\ntype ExportTarget =\n  | \"summary\"\n  | \"sales\"\n  | \"expenses\"\n  | \"cash\"\n  | \"payment\"\n  | \"profit\"\n  | \"products\"\n  | \"stock\";\n\ntype ExportKey = ExportTarget | \"active\" | \"all\";\n\nfunction buildExportSuffix(rangeFrom?: string, rangeTo?: string) {\n  if (rangeFrom && rangeTo) {\n    return rangeFrom === rangeTo\n      ? rangeFrom\n      : `${rangeFrom}_to_${rangeTo}`;\n  }\n  return rangeFrom ?? rangeTo ?? \"all\";\n}\n\nfunction isSummaryPayload(value: unknown): value is Summary {\n  if (!value || typeof value !== \"object\") return false;\n  const payload = value as Summary;\n  return (\n    typeof payload.sales?.totalAmount === \"number\" &&\n    typeof payload.expense?.totalAmount === \"number\" &&\n    typeof payload.cash?.balance === \"number\" &&\n    typeof payload.cash?.totalIn === \"number\" &&\n    typeof payload.cash?.totalOut === \"number\" &&\n    typeof payload.profit?.profit === \"number\" &&\n    typeof payload.profit?.salesTotal === \"number\" &&\n    typeof payload.profit?.expenseTotal === \"number\"\n  );\n}\n\nexport default function ReportsClient({\n  shopId,\n  shopName,\n  shops,\n  summary,\n}: Props) {\n  const online = useOnlineStatus();\n  const realtime = useRealtimeStatus();\n  const isVisible = usePageVisibility();\n  const queryClient = useQueryClient();\n\n  const [active, setActive] = useState<(typeof NAV)[number][\"key\"]>(\"summary\");\n  const [preset, setPreset] = useState<RangePreset>(\"today\");\n  const [customFrom, setCustomFrom] = useState<string | undefined>(undefined);\n  const [customTo, setCustomTo] = useState<string | undefined>(undefined);\n  const [realTimeIndicator, setRealTimeIndicator] = useState(false);\n  const [lowStockThreshold, setLowStockThreshold] = useState(\n    EXPORT_LOW_STOCK_THRESHOLD\n  );\n  const [exportOpen, setExportOpen] = useState(false);\n  const [exportingKey, setExportingKey] = useState<ExportKey | null>(null);\n  const [exportError, setExportError] = useState<string | null>(null);\n  const lastEventAtRef = useRef(0);\n  const wasVisibleRef = useRef(isVisible);\n  const indicatorTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n  const pollIntervalMs = realtime.connected ? 60_000 : 10_000;\n  const pollingEnabled = !realtime.connected;\n  const EVENT_DEBOUNCE_MS = 600;\n  \n  // Auto-sync on real-time events\n  useEffect(() => {\r\n    const syncListener = reportEvents.addListener(\n      'sync-complete',\n      async (event) => {\n        if (event.shopId === shopId) {\n          if (!isSummaryPayload(event.data)) return;\n          // Refresh query data with latest from server\n          queryClient.setQueryData(\n            [\"reports\", \"summary\", shopId, \"all\", \"all\"],\n            event.data\n          );\n        }\n      },\n      { shopId, priority: 5 }\n    );\n    \r\n    return () => {\r\n      reportEvents.removeListener(syncListener);\r\n    };\r\n  }, [shopId, queryClient]);\r\n  \r\n  // Performance monitoring\r\n  useEffect(() => {\r\n    const metricsListener = reportEvents.addListener(\n      'metrics-updated',\n      (event) => {\n        if (event.shopId === shopId) {\n          if (process.env.NODE_ENV !== \"production\") {\n            console.debug('Real-time Reports Metrics:', event.data);\n          }\n        }\n      },\n      { shopId, priority: 1 }\n    );\n    \r\n    return () => {\r\n      reportEvents.removeListener(metricsListener);\r\n    };\r\n  }, [shopId]);\r\n  const range = useMemo(\r\n    () => computeRange(preset, customFrom, customTo),\r\n    [preset, customFrom, customTo]\r\n  );\n  const presetLabel = useMemo(\n    () => PRESETS.find((item) => item.key === preset)?.label ?? \"\",\n    [preset]\n  );\n  const exportSuffix = useMemo(\n    () => buildExportSuffix(range.from, range.to),\n    [range.from, range.to]\n  );\n  const rangeLabel = useMemo(() => {\n    if (range.from && range.to) {\n      return range.from === range.to ? range.from : `${range.from} - ${range.to}`;\n    }\n    return range.from ?? range.to ?? null;\n  }, [range.from, range.to]);\r\n\r\n  const rangeKeyFrom = range.from ?? \"all\";\r\n  const rangeKeyTo = range.to ?? \"all\";\r\n\r\n  const buildSummaryKey = useCallback(\r\n    (rangeFrom?: string, rangeTo?: string) =>\r\n      `reports:summary:${shopId}:${rangeFrom || \"all\"}:${rangeTo || \"all\"}`,\r\n    [shopId]\r\n  );\r\n\r\n  \r\n  const readCachedSummary = useCallback(\n    (rangeFrom?: string, rangeTo?: string) => {\n      if (typeof window === \"undefined\") return null;\n      const key = buildSummaryKey(rangeFrom, rangeTo);\n      try {\n        const raw = safeLocalStorageGet(key);\n        if (!raw) return null;\n        const parsed = JSON.parse(raw) as Summary;\n        return parsed && parsed.sales ? parsed : null;\n      } catch (err) {\n        handlePermissionError(err);\r\n        console.warn(\"Summary cache read failed\", err);\r\n        return null;\r\n      }\r\n    },\r\n    [buildSummaryKey]\r\n  );\r\n\r\n  const fetchSummary = useCallback(\r\n    async (rangeFrom?: string, rangeTo?: string, fresh = false) => {\r\n      const params = new URLSearchParams({ shopId });\r\n      if (rangeFrom) params.append(\"from\", rangeFrom);\r\n      if (rangeTo) params.append(\"to\", rangeTo);\r\n      if (fresh) params.append(\"fresh\", \"1\");\r\n      const res = await fetch(`/api/reports/summary?${params.toString()}`, {\r\n        cache: \"no-store\",\r\n      });\r\n      if (!res.ok) {\r\n        const cached = readCachedSummary(rangeFrom, rangeTo);\r\n        if (cached) return cached;\r\n        throw new Error(\"Summary fetch failed\");\r\n      }\r\n      const json = (await res.json()) as Summary;\n      if (typeof window !== \"undefined\") {\n        const key = buildSummaryKey(rangeFrom, rangeTo);\n        try {\n          safeLocalStorageSet(key, JSON.stringify(json));\n        } catch (err) {\n          handlePermissionError(err);\n          console.warn(\"Summary cache write failed\", err);\n        }\n      }\r\n      return json;\r\n    },\r\n    [shopId, buildSummaryKey, readCachedSummary]\r\n  );\r\n\r\n  const summaryQueryKey = useMemo(\r\n    () => [\"reports\", \"summary\", shopId, range.from ?? \"all\", range.to ?? \"all\"],\r\n    [shopId, range.from, range.to]\r\n  );\r\n\r\n  const summaryQuery = useQuery({\n    queryKey: summaryQueryKey,\n    queryFn: () => fetchSummary(range.from, range.to),\n    enabled: online,\n    initialData: () => readCachedSummary(range.from, range.to) ?? summary,\n    placeholderData: (prev) => prev ?? summary,\r\n  });\r\n\r\n  const liveSummary = summaryQuery.data ?? summary;\n  const summaryLoading = summaryQuery.isFetching && online;\n  const summarySnapshot = `${liveSummary.sales.totalAmount.toFixed(1)} ৳ বিক্রি | লাভ ${liveSummary.profit.profit.toFixed(1)} ৳`;\n\n  const refreshSummaryFresh = useCallback(async () => {\n    if (!online) return;\r\n    try {\r\n      const freshData = await fetchSummary(range.from, range.to, true);\r\n      if (freshData) {\r\n        queryClient.setQueryData(summaryQueryKey, freshData);\r\n      }\r\n    } catch (err) {\r\n      handlePermissionError(err);\r\n    }\r\n  }, [online, fetchSummary, range.from, range.to, queryClient, summaryQueryKey]);\r\n\r\n  const invalidateSales = useCallback(() => {\r\n    queryClient.invalidateQueries({\r\n      queryKey: [\"reports\", \"sales\", shopId, rangeKeyFrom, rangeKeyTo],\r\n    });\r\n  }, [queryClient, shopId, rangeKeyFrom, rangeKeyTo]);\r\n\r\n  const invalidateExpenses = useCallback(() => {\r\n    queryClient.invalidateQueries({\r\n      queryKey: [\"reports\", \"expenses\", shopId, rangeKeyFrom, rangeKeyTo],\r\n    });\r\n  }, [queryClient, shopId, rangeKeyFrom, rangeKeyTo]);\r\n\r\n  const invalidateCash = useCallback(() => {\r\n    queryClient.invalidateQueries({\r\n      queryKey: [\"reports\", \"cash\", shopId, rangeKeyFrom, rangeKeyTo],\r\n    });\r\n  }, [queryClient, shopId, rangeKeyFrom, rangeKeyTo]);\r\n\r\n  const invalidatePayment = useCallback(() => {\r\n    queryClient.invalidateQueries({\r\n      queryKey: [\"reports\", \"payment\", shopId, rangeKeyFrom, rangeKeyTo],\r\n    });\r\n  }, [queryClient, shopId, rangeKeyFrom, rangeKeyTo]);\r\n\r\n  const invalidateProfit = useCallback(() => {\r\n    queryClient.invalidateQueries({\r\n      queryKey: [\"reports\", \"profit\", shopId, rangeKeyFrom, rangeKeyTo],\r\n    });\r\n  }, [queryClient, shopId, rangeKeyFrom, rangeKeyTo]);\r\n\r\n  const invalidateTopProducts = useCallback(() => {\r\n    queryClient.invalidateQueries({\r\n      queryKey: [\"reports\", \"top-products\", shopId, REPORT_ROW_LIMIT],\r\n    });\r\n  }, [queryClient, shopId]);\r\n\r\n  const invalidateLowStock = useCallback(() => {\n    queryClient.invalidateQueries({\n      queryKey: [\"reports\", \"low-stock\", shopId],\n    });\n  }, [queryClient, shopId]);\n\r\n  const invalidateActiveReport = useCallback(() => {\r\n    switch (active) {\r\n      case \"sales\":\r\n        invalidateSales();\r\n        break;\r\n      case \"expenses\":\r\n        invalidateExpenses();\r\n        break;\r\n      case \"cash\":\r\n        invalidateCash();\r\n        break;\r\n      case \"payment\":\r\n        invalidatePayment();\r\n        break;\r\n      case \"profit\":\r\n        invalidateProfit();\r\n        break;\r\n      case \"products\":\r\n        invalidateTopProducts();\r\n        break;\r\n      case \"stock\":\r\n        invalidateLowStock();\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n  }, [\r\n    active,\r\n    invalidateSales,\r\n    invalidateExpenses,\r\n    invalidateCash,\r\n    invalidatePayment,\r\n    invalidateProfit,\r\n    invalidateTopProducts,\r\n    invalidateLowStock,\r\n  ]);\r\n\r\n  useEffect(() => {\r\n    if (typeof window === \"undefined\") return;\n    const mutationKey = `reports-last-mutation:${shopId}`;\n    const refreshKey = `reports-last-refresh:${shopId}`;\n    const lastMutation = Number(\n      safeLocalStorageGet(mutationKey) || \"0\"\n    );\n    if (!lastMutation) return;\n    const lastRefresh = Number(\n      safeLocalStorageGet(refreshKey) || \"0\"\n    );\n    if (lastMutation <= lastRefresh) return;\n    if (Date.now() - lastMutation > 2 * 60 * 1000) return;\n\r\n    refreshSummaryFresh();\r\n    invalidateSales();\r\n    invalidateExpenses();\r\n    invalidateCash();\r\n    invalidatePayment();\r\n    invalidateProfit();\r\n    invalidateTopProducts();\r\n    invalidateLowStock();\n\n    try {\n      safeLocalStorageSet(refreshKey, String(Date.now()));\n    } catch {\n      // ignore storage failures\n    }\n  }, [\r\n    shopId,\r\n    refreshSummaryFresh,\r\n    invalidateSales,\r\n    invalidateExpenses,\r\n    invalidateCash,\r\n    invalidatePayment,\r\n    invalidateProfit,\r\n    invalidateTopProducts,\r\n    invalidateLowStock,\r\n  ]);\r\n\r\n  // Real-time event listeners\n  useEffect(() => {\n    const handleIndicator = () => {\n      setRealTimeIndicator(true);\n      if (indicatorTimeoutRef.current) {\n        clearTimeout(indicatorTimeoutRef.current);\n      }\n      indicatorTimeoutRef.current = setTimeout(() => {\n        setRealTimeIndicator(false);\n      }, 1000);\n    };\n\r\n    const maybeDebounce = () => {\r\n      const now = Date.now();\r\n      if (now - lastEventAtRef.current < EVENT_DEBOUNCE_MS) return false;\r\n      lastEventAtRef.current = now;\r\n      return true;\r\n    };\r\n\r\n    const saleUpdateListener = reportEvents.addListener(\r\n      \"sale-update\",\r\n      (event) => {\r\n        if (event.shopId !== shopId) return;\r\n        handleIndicator();\r\n        if (!maybeDebounce()) return;\r\n        refreshSummaryFresh();\r\n        invalidateSales();\r\n        invalidateProfit();\r\n        invalidatePayment();\r\n        invalidateTopProducts();\r\n      },\r\n      { shopId, priority: 10 }\r\n    );\r\n\r\n    const expenseUpdateListener = reportEvents.addListener(\r\n      \"expense-update\",\r\n      (event) => {\r\n        if (event.shopId !== shopId) return;\r\n        handleIndicator();\r\n        if (!maybeDebounce()) return;\r\n        refreshSummaryFresh();\r\n        invalidateExpenses();\r\n        invalidateProfit();\r\n      },\r\n      { shopId, priority: 10 }\r\n    );\r\n\r\n    const cashUpdateListener = reportEvents.addListener(\r\n      \"cash-update\",\r\n      (event) => {\r\n        if (event.shopId !== shopId) return;\r\n        handleIndicator();\r\n        if (!maybeDebounce()) return;\r\n        refreshSummaryFresh();\r\n        invalidateCash();\r\n      },\r\n      { shopId, priority: 10 }\r\n    );\r\n\r\n    return () => {\n      reportEvents.removeListener(saleUpdateListener);\n      reportEvents.removeListener(expenseUpdateListener);\n      reportEvents.removeListener(cashUpdateListener);\n      if (indicatorTimeoutRef.current) {\n        clearTimeout(indicatorTimeoutRef.current);\n        indicatorTimeoutRef.current = null;\n      }\n    };\n  }, [\n    shopId,\r\n    refreshSummaryFresh,\r\n    invalidateSales,\r\n    invalidateExpenses,\r\n    invalidateCash,\r\n    invalidateProfit,\r\n    invalidatePayment,\r\n    invalidateTopProducts,\r\n  ]);\r\n\r\n  useEffect(() => {\r\n    if (!online || typeof window === \"undefined\") return;\r\n    const cancel = scheduleIdle(() => {\r\n      PREFETCH_PRESETS.forEach((presetKey) => {\r\n        const { from, to } = computePresetRange(presetKey);\r\n        const queryKey = [\r\n          \"reports\",\r\n          \"summary\",\r\n          shopId,\r\n          from ?? \"all\",\r\n          to ?? \"all\",\r\n        ];\r\n        if (queryClient.getQueryData(queryKey)) return;\r\n        queryClient.prefetchQuery({\r\n          queryKey,\r\n          queryFn: () => fetchSummary(from, to),\r\n        });\r\n      });\r\n    }, 50);\r\n    return () => cancel();\r\n  }, [online, shopId, fetchSummary, queryClient]);\r\n\r\n  useEffect(() => {\n    if (!online || !isVisible || !pollingEnabled) return;\n    const intervalId = setInterval(() => {\n      const now = Date.now();\n      if (now - lastEventAtRef.current < pollIntervalMs / 2) return;\n      refreshSummaryFresh();\n      invalidateActiveReport();\n    }, pollIntervalMs);\n    return () => clearInterval(intervalId);\n  }, [\n    online,\n    isVisible,\n    pollingEnabled,\n    refreshSummaryFresh,\n    invalidateActiveReport,\n    pollIntervalMs,\n  ]);\n\n  useEffect(() => {\n    if (!online) return;\n    if (wasVisibleRef.current === isVisible) return;\n    wasVisibleRef.current = isVisible;\n    if (!isVisible) return;\n    lastEventAtRef.current = Date.now();\n    refreshSummaryFresh();\n    invalidateActiveReport();\n  }, [online, isVisible, refreshSummaryFresh, invalidateActiveReport]);\n\r\n  useEffect(() => {\n    if (!online) return;\n    const connection = (navigator as any)?.connection;\n    if (connection?.saveData) return;\n    if ([\"slow-2g\", \"2g\"].includes(connection?.effectiveType)) return;\n\n    const dataTargets = PREFETCH_REPORT_DATA_BY_TAB[active] ?? [];\n    if (dataTargets.length === 0) return;\n\n    const rangeFrom = range.from ?? \"all\";\n    const rangeTo = range.to ?? \"all\";\n    const salesKey = [\n      \"reports\",\n      \"sales\",\n      shopId,\n      rangeFrom,\n      rangeTo,\n      1,\n      \"start\",\n      \"start\",\n    ];\n    const expensesKey = [\n      \"reports\",\n      \"expenses\",\n      shopId,\n      rangeFrom,\n      rangeTo,\n      1,\n      \"start\",\n      \"start\",\n    ];\n    const cashKey = [\n      \"reports\",\n      \"cash\",\n      shopId,\n      rangeFrom,\n      rangeTo,\n      1,\n      \"start\",\n      \"start\",\n    ];\n    const paymentKey = [\"reports\", \"payment\", shopId, rangeFrom, rangeTo];\n    const profitKey = [\"reports\", \"profit\", shopId, rangeFrom, rangeTo];\n    const topProductsKey = [\"reports\", \"top-products\", shopId, REPORT_ROW_LIMIT];\n    const lowStockKey = [\n      \"reports\",\n      \"low-stock\",\n      shopId,\n      lowStockThreshold,\n      REPORT_ROW_LIMIT,\n    ];\n\n    const cancel = scheduleIdle(() => {\n      const tasks: Promise<unknown>[] = [];\n\n      if (dataTargets.includes(\"sales\") && !queryClient.getQueryData(salesKey)) {\n        tasks.push(\n          queryClient\n            .prefetchQuery({\n              queryKey: salesKey,\n              queryFn: async () => {\n                const params = new URLSearchParams({\n                  shopId,\n                  limit: `${REPORT_ROW_LIMIT}`,\n                });\n                if (range.from) params.append(\"from\", range.from);\n                if (range.to) params.append(\"to\", range.to);\n                const res = await fetch(\n                  `/api/reports/sales?${params.toString()}`\n                );\n                if (!res.ok) throw new Error(\"Sales prefetch failed\");\n                const json = await res.json();\n                const rows = Array.isArray(json?.rows) ? json.rows : [];\n                return {\n                  rows,\n                  hasMore: Boolean(json?.hasMore),\n                  nextCursor: json?.nextCursor ?? null,\n                };\n              },\n            })\n            .catch(() => null)\n        );\n      }\n\n      if (\n        dataTargets.includes(\"expenses\") &&\n        !queryClient.getQueryData(expensesKey)\n      ) {\n        tasks.push(\n          queryClient\n            .prefetchQuery({\n              queryKey: expensesKey,\n              queryFn: async () => {\n                const params = new URLSearchParams({\n                  shopId,\n                  limit: `${REPORT_ROW_LIMIT}`,\n                });\n                if (range.from) params.append(\"from\", range.from);\n                if (range.to) params.append(\"to\", range.to);\n                const res = await fetch(\n                  `/api/reports/expenses?${params.toString()}`\n                );\n                if (!res.ok) throw new Error(\"Expense prefetch failed\");\n                const json = await res.json();\n                const rows = Array.isArray(json?.rows) ? json.rows : [];\n                return {\n                  rows,\n                  hasMore: Boolean(json?.hasMore),\n                  nextCursor: json?.nextCursor ?? null,\n                };\n              },\n            })\n            .catch(() => null)\n        );\n      }\n\n      if (dataTargets.includes(\"cash\") && !queryClient.getQueryData(cashKey)) {\n        tasks.push(\n          queryClient\n            .prefetchQuery({\n              queryKey: cashKey,\n              queryFn: async () => {\n                const params = new URLSearchParams({\n                  shopId,\n                  limit: `${REPORT_ROW_LIMIT}`,\n                });\n                if (range.from) params.append(\"from\", range.from);\n                if (range.to) params.append(\"to\", range.to);\n                const res = await fetch(\n                  `/api/reports/cash?${params.toString()}`\n                );\n                if (!res.ok) throw new Error(\"Cash prefetch failed\");\n                const json = await res.json();\n                const rows = Array.isArray(json?.rows) ? json.rows : [];\n                return {\n                  rows,\n                  hasMore: Boolean(json?.hasMore),\n                  nextCursor: json?.nextCursor ?? null,\n                };\n              },\n            })\n            .catch(() => null)\n        );\n      }\n\n      if (\n        dataTargets.includes(\"payment\") &&\n        !queryClient.getQueryData(paymentKey)\n      ) {\n        tasks.push(\n          queryClient\n            .prefetchQuery({\n              queryKey: paymentKey,\n              queryFn: async () => {\n                const params = new URLSearchParams({ shopId, fresh: \"1\" });\n                if (range.from) params.append(\"from\", range.from);\n                if (range.to) params.append(\"to\", range.to);\n                const res = await fetch(\n                  `/api/reports/payment-method?${params.toString()}`,\n                  { cache: \"no-cache\" }\n                );\n                if (!res.ok) throw new Error(\"Payment prefetch failed\");\n                const text = await res.text();\n                if (!text) return [];\n                const json = JSON.parse(text);\n                return Array.isArray(json?.data) ? json.data : [];\n              },\n            })\n            .catch(() => null)\n        );\n      }\n\n      if (\n        dataTargets.includes(\"profit\") &&\n        !queryClient.getQueryData(profitKey)\n      ) {\n        tasks.push(\n          queryClient\n            .prefetchQuery({\n              queryKey: profitKey,\n              queryFn: async () => {\n                const params = new URLSearchParams({ shopId, fresh: \"1\" });\n                if (range.from) params.append(\"from\", range.from);\n                if (range.to) params.append(\"to\", range.to);\n                const res = await fetch(\n                  `/api/reports/profit-trend?${params.toString()}`,\n                  { cache: \"no-cache\" }\n                );\n                if (!res.ok) throw new Error(\"Profit prefetch failed\");\n                const json = await res.json();\n                return Array.isArray(json?.data) ? json.data : [];\n              },\n            })\n            .catch(() => null)\n        );\n      }\n\n      if (\n        dataTargets.includes(\"products\") &&\n        !queryClient.getQueryData(topProductsKey)\n      ) {\n        tasks.push(\n          queryClient\n            .prefetchQuery({\n              queryKey: topProductsKey,\n              queryFn: async () => {\n                const params = new URLSearchParams({\n                  shopId,\n                  limit: `${REPORT_ROW_LIMIT}`,\n                  fresh: \"1\",\n                });\n                const res = await fetch(\n                  `/api/reports/top-products?${params.toString()}`,\n                  { cache: \"no-cache\" }\n                );\n                if (!res.ok) throw new Error(\"Top products prefetch failed\");\n                const text = await res.text();\n                if (!text) return [];\n                const json = JSON.parse(text);\n                return Array.isArray(json?.data) ? json.data : [];\n              },\n            })\n            .catch(() => null)\n        );\n      }\n\n      if (\n        dataTargets.includes(\"stock\") &&\n        !queryClient.getQueryData(lowStockKey)\n      ) {\n        tasks.push(\n          queryClient\n            .prefetchQuery({\n              queryKey: lowStockKey,\n              queryFn: async () => {\n                const params = new URLSearchParams({\n                  shopId,\n                  limit: `${REPORT_ROW_LIMIT}`,\n                  threshold: `${lowStockThreshold}`,\n                  fresh: \"1\",\n                });\n                const res = await fetch(\n                  `/api/reports/low-stock?${params.toString()}`,\n                  { cache: \"no-cache\" }\n                );\n                if (!res.ok) throw new Error(\"Low stock prefetch failed\");\n                const text = await res.text();\n                if (!text) return [];\n                const json = JSON.parse(text);\n                return Array.isArray(json?.data) ? json.data : [];\n              },\n            })\n            .catch(() => null)\n        );\n      }\n\n      if (tasks.length > 0) {\n        Promise.all(tasks).catch(() => null);\n      }\n    }, 150);\n\n    return () => cancel();\n  }, [active, online, shopId, range.from, range.to, queryClient, lowStockThreshold]);\n\r\n\r\n  useEffect(() => {\n    if (typeof window === \"undefined\") return;\n    if (!online) return;\n    const connection = (navigator as any)?.connection;\n    if (connection?.saveData) return;\n    if ([\"slow-2g\", \"2g\"].includes(connection?.effectiveType)) return;\n\n    const targets = PREFETCH_REPORTS_BY_TAB[active] ?? [];\n    if (targets.length === 0) return;\n\n    const cancel = scheduleIdle(() => {\n      Promise.all(targets.map((key) => prefetchReportModule(key))).catch(\n        () => null\n      );\n    }, 250);\n\n    return () => cancel();\n  }, [active, online]);\n\r\n  useEffect(() => {\n    if (preset === \"custom\" && customFrom && customTo && customFrom > customTo) {\n      alert(\"শুরুর তারিখ শেষের তারিখের আগে হতে হবে\");\n    }\n  }, [preset, customFrom, customTo]);\n\n  const fetchAllRows = useCallback(\n    async (endpoint: string, rangeFrom?: string, rangeTo?: string) => {\n      const rows: any[] = [];\n      let cursor: ExportCursor | null = null;\n      let pages = 0;\n\n      while (true) {\n        const params = new URLSearchParams({\n          shopId,\n          limit: String(EXPORT_PAGE_LIMIT),\n        });\n        if (rangeFrom) params.append(\"from\", rangeFrom);\n        if (rangeTo) params.append(\"to\", rangeTo);\n        if (cursor) {\n          params.append(\"cursorAt\", cursor.at);\n          params.append(\"cursorId\", cursor.id);\n        }\n\n        const res = await fetch(`${endpoint}?${params.toString()}`);\n        if (!res.ok) {\n          throw new Error(\"Report fetch failed\");\n        }\n        const data = await res.json();\n        const nextRows = Array.isArray(data?.rows) ? data.rows : [];\n        rows.push(...nextRows);\n\n        if (rows.length > EXPORT_MAX_ROWS) {\n          throw new Error(\"Too many rows to export\");\n        }\n\n        if (!data?.hasMore || !data?.nextCursor) break;\n        cursor = data.nextCursor;\n        pages += 1;\n        if (pages >= EXPORT_MAX_PAGES) {\n          throw new Error(\"Export limit reached\");\n        }\n      }\n\n      return rows;\n    },\n    [shopId]\n  );\n\n  const fetchReportData = useCallback(\n    async (endpoint: string, params: URLSearchParams) => {\n      const res = await fetch(`${endpoint}?${params.toString()}`, {\n        cache: \"no-cache\",\n      });\n      if (!res.ok) throw new Error(\"Report fetch failed\");\n      const text = await res.text();\n      if (!text) return [];\n      const json = JSON.parse(text);\n      return Array.isArray(json?.data) ? json.data : json;\n    },\n    []\n  );\n\n  const exportSingle = useCallback(\n    async (target: ExportTarget) => {\n      switch (target) {\n        case \"summary\": {\n          const summaryData = await fetchSummary(range.from, range.to, true);\n          const salesCount =\n            summaryData.sales.count ?? summaryData.sales.completedCount ?? 0;\n          const summaryCsv = generateCSV(\n            [\n              \"range_from\",\n              \"range_to\",\n              \"sales_total\",\n              \"sales_count\",\n              \"sales_voided\",\n              \"expense_total\",\n              \"expense_count\",\n              \"cash_in\",\n              \"cash_out\",\n              \"cash_balance\",\n              \"profit\",\n              \"cogs\",\n            ],\n            [\n              {\n                range_from: range.from ?? \"all\",\n                range_to: range.to ?? \"all\",\n                sales_total: summaryData.sales.totalAmount ?? 0,\n                sales_count: salesCount,\n                sales_voided: summaryData.sales.voidedCount ?? 0,\n                expense_total: summaryData.expense.totalAmount ?? 0,\n                expense_count: summaryData.expense.count ?? 0,\n                cash_in: summaryData.cash.totalIn ?? 0,\n                cash_out: summaryData.cash.totalOut ?? 0,\n                cash_balance: summaryData.cash.balance ?? 0,\n                profit: summaryData.profit.profit ?? 0,\n                cogs: summaryData.profit.cogs ?? 0,\n              },\n            ]\n          );\n          downloadFile(`summary-${exportSuffix}.csv`, summaryCsv);\n          return;\n        }\n        case \"sales\": {\n          const rows = await fetchAllRows(\n            \"/api/reports/sales\",\n            range.from,\n            range.to\n          );\n          const csv = generateCSV(\n            [\"id\", \"saleDate\", \"totalAmount\", \"paymentMethod\", \"note\"],\n            rows\n          );\n          downloadFile(`sales-${exportSuffix}.csv`, csv);\n          return;\n        }\n        case \"expenses\": {\n          const rows = await fetchAllRows(\n            \"/api/reports/expenses\",\n            range.from,\n            range.to\n          );\n          const csv = generateCSV(\n            [\"id\", \"expenseDate\", \"amount\", \"category\"],\n            rows\n          );\n          downloadFile(`expenses-${exportSuffix}.csv`, csv);\n          return;\n        }\n        case \"cash\": {\n          const rows = await fetchAllRows(\n            \"/api/reports/cash\",\n            range.from,\n            range.to\n          );\n          const csv = generateCSV(\n            [\"id\", \"createdAt\", \"entryType\", \"amount\", \"reason\"],\n            rows\n          );\n          downloadFile(`cashbook-${exportSuffix}.csv`, csv);\n          return;\n        }\n        case \"payment\": {\n          const params = new URLSearchParams({ shopId, fresh: \"1\" });\n          if (range.from) params.append(\"from\", range.from);\n          if (range.to) params.append(\"to\", range.to);\n          const rows = await fetchReportData(\n            \"/api/reports/payment-method\",\n            params\n          );\n          const csv = generateCSV([\"name\", \"value\", \"count\"], rows);\n          downloadFile(`payment-method-${exportSuffix}.csv`, csv);\n          return;\n        }\n        case \"profit\": {\n          const params = new URLSearchParams({ shopId, fresh: \"1\" });\n          if (range.from) params.append(\"from\", range.from);\n          if (range.to) params.append(\"to\", range.to);\n          const rows = await fetchReportData(\"/api/reports/profit-trend\", params);\n          const normalized = Array.isArray(rows)\n            ? rows.map((row: any) => ({\n                date: row.date,\n                sales: row.sales ?? 0,\n                expense: row.expense ?? 0,\n                profit: Number(row.sales ?? 0) - Number(row.expense ?? 0),\n              }))\n            : [];\n          const csv = generateCSV([\"date\", \"sales\", \"expense\", \"profit\"], normalized);\n          downloadFile(`profit-trend-${exportSuffix}.csv`, csv);\n          return;\n        }\n        case \"products\": {\n          const params = new URLSearchParams({\n            shopId,\n            limit: String(REPORT_ROW_LIMIT),\n            fresh: \"1\",\n          });\n          const rows = await fetchReportData(\"/api/reports/top-products\", params);\n          const csv = generateCSV([\"name\", \"qty\", \"revenue\"], rows);\n          downloadFile(\"top-products-all.csv\", csv);\n          return;\n        }\n        case \"stock\": {\n          const params = new URLSearchParams({\n            shopId,\n            limit: String(REPORT_ROW_LIMIT),\n            threshold: String(lowStockThreshold),\n            fresh: \"1\",\n          });\n          const rows = await fetchReportData(\"/api/reports/low-stock\", params);\n          const csv = generateCSV([\"id\", \"name\", \"stockQty\"], rows);\n          downloadFile(\"low-stock-all.csv\", csv);\n          return;\n        }\n        default:\n          return;\n      }\n    },\n    [\n      exportSuffix,\n      fetchAllRows,\n      fetchReportData,\n      fetchSummary,\n      lowStockThreshold,\n      range.from,\n      range.to,\n      shopId,\n    ]\n  );\n\n  const handleExport = useCallback(\n    async (key: ExportKey) => {\n      if (!online) {\n        toast.error(\"অফলাইনে রিপোর্ট ডাউনলোড করা যাবে না\");\n        return;\n      }\n      setExportingKey(key);\n      setExportError(null);\n      const toastId = toast.success(\"রিপোর্ট ডাউনলোড হচ্ছে...\");\n\n      try {\n        if (key === \"all\") {\n          const targets: ExportTarget[] = [\n            \"summary\",\n            \"sales\",\n            \"expenses\",\n            \"cash\",\n            \"payment\",\n            \"profit\",\n            \"products\",\n            \"stock\",\n          ];\n          for (const target of targets) {\n            await exportSingle(target);\n          }\n        } else if (key === \"active\") {\n          const target =\n            active === \"summary\"\n              ? \"summary\"\n              : (active as Exclude<ReportKey, \"summary\">);\n          await exportSingle(target);\n        } else {\n          await exportSingle(key);\n        }\n\n        toast.success(\"CSV ডাউনলোড হয়েছে\", { id: toastId });\n        setExportOpen(false);\n      } catch (err) {\n        handlePermissionError(err);\n        setExportError(\"CSV ডাউনলোড করা যায়নি\");\n        toast.error(\"CSV ডাউনলোড করা যায়নি\", { id: toastId });\n      } finally {\n        setExportingKey(null);\n      }\n    },\n    [active, exportSingle, online]\n  );\n\n  const renderReport = () => {\n    switch (active) {\n      case \"summary\":\n        return (\n          <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-3\">\r\n            <StatCard\r\n              title=\"মোট বিক্রি\"\r\n              value={`${liveSummary.sales.totalAmount.toFixed(2)} ৳`}\r\n              subtitle={`মোট বিল: ${liveSummary.sales.completedCount ?? 0}${\r\n                typeof liveSummary.sales.voidedCount === \"number\"\r\n                  ? ` · বাতিল: ${liveSummary.sales.voidedCount}`\r\n                  : \"\"\r\n              }`}\r\n              icon=\"🧾\"\r\n              tone=\"success\"\r\n            />\r\n            <StatCard\r\n              title=\"খরচ\"\r\n              value={`${liveSummary.expense.totalAmount.toFixed(2)} ৳`}\r\n              subtitle={`মোট খরচ: ${liveSummary.expense.count ?? 0}`}\r\n              icon=\"💸\"\r\n              tone=\"danger\"\r\n            />\r\n            <StatCard\r\n              title=\"ক্যাশ ব্যালান্স\"\r\n              value={`${liveSummary.cash.balance.toFixed(2)} ৳`}\r\n              subtitle={`ইন: ${liveSummary.cash.totalIn.toFixed(\r\n                2\r\n              )} ৳ | আউট: ${liveSummary.cash.totalOut.toFixed(2)} ৳`}\r\n              icon=\"💵\"\r\n              tone=\"warning\"\r\n            />\r\n            <StatCard\r\n              title=\"লাভ\"\r\n              value={`${liveSummary.profit.profit.toFixed(2)} ৳`}\r\n              subtitle={`বিক্রি: ${liveSummary.profit.salesTotal.toFixed(\r\n                2\r\n              )} ৳ | খরচ: ${liveSummary.profit.expenseTotal.toFixed(2)} ৳`}\r\n              icon=\"📈\"\r\n              tone=\"primary\"\r\n            />\r\n          </div>\r\n        );\r\n      case \"sales\":\r\n        return <SalesReport shopId={shopId} from={range.from} to={range.to} />;\r\n      case \"expenses\":\r\n        return (\r\n          <ExpenseReport shopId={shopId} from={range.from} to={range.to} />\r\n        );\r\n      case \"cash\":\r\n        return <CashbookReport shopId={shopId} from={range.from} to={range.to} />;\r\n      case \"payment\":\r\n        return (\r\n          <PaymentMethodReport shopId={shopId} from={range.from} to={range.to} />\r\n        );\r\n      case \"profit\":\r\n        return (\r\n          <ProfitTrendReport shopId={shopId} from={range.from} to={range.to} />\r\n        );\r\n      case \"products\":\r\n        return <TopProductsReport shopId={shopId} />;\r\n      case \"stock\":\n        return (\n          <LowStockReport\n            shopId={shopId}\n            threshold={lowStockThreshold}\n            onThresholdChange={setLowStockThreshold}\n          />\n        );\n      default:\r\n        return null;\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"space-y-6 pb-24\">\r\n      {!online && (\r\n        <div className=\"rounded-xl border border-warning/30 bg-warning-soft text-warning text-xs font-semibold px-3 py-2 shadow-sm\">\r\n          অফলাইন: আগের রিপোর্ট ডাটা দেখানো হচ্ছে।\r\n        </div>\r\n      )}\r\n      <div className=\"relative overflow-hidden rounded-2xl border border-border bg-card shadow-[0_16px_36px_rgba(15,23,42,0.08)] animate-fade-in\">\r\n        <div className=\"pointer-events-none absolute inset-0 bg-gradient-to-br from-primary-soft/50 via-card to-card\" />\r\n        <div className=\"pointer-events-none absolute -bottom-16 right-0 h-32 w-32 rounded-full bg-primary/20 blur-3xl\" />\r\n        <div className=\"relative space-y-4 p-4 sm:p-5\">\r\n          <div className=\"flex flex-col gap-4 md:flex-row md:items-center md:justify-between\">\r\n            <div className=\"min-w-0 space-y-1\">\r\n            <h1 className=\"text-3xl font-bold text-foreground leading-tight\">\r\n              রিপোর্ট ও বিশ্লেষণ\r\n            </h1>\r\n            <p className=\"text-sm text-muted-foreground mt-1\">\r\n              দোকান: <span className=\"font-semibold\">{shopName}</span>\r\n            </p>\r\n            <p className=\"text-sm text-muted-foreground\">\r\n              বিক্রি, খরচ, ক্যাশ, লাভ এক জায়গায়\r\n            </p>\r\n            </div>\n\n            <div className=\"w-full md:w-auto\">\n              <div className=\"flex flex-col gap-2 sm:flex-row sm:items-center\">\n                <ShopSelectorClient shops={shops} selectedShopId={shopId} />\n                <Dialog\n                  open={exportOpen}\n                  onOpenChange={(open) => {\n                    setExportOpen(open);\n                    if (!open) setExportError(null);\n                  }}\n                >\n                  <div className=\"inline-flex items-center gap-2\">\n                    <DialogTrigger asChild>\n                      <button\n                        type=\"button\"\n                        disabled={!online || exportingKey !== null}\n                        className=\"inline-flex h-10 items-center justify-center rounded-xl border border-primary/30 bg-primary-soft px-4 text-sm font-semibold text-primary shadow-sm transition hover:bg-primary/20 disabled:opacity-60 disabled:cursor-not-allowed\"\n                      >\n                        {exportingKey ? \"এক্সপোর্ট হচ্ছে...\" : \"CSV এক্সপোর্ট\"}\n                      </button>\n                    </DialogTrigger>\n                    <button\n                      type=\"button\"\n                      onClick={() =>\n                        toast.message(\"সব রিপোর্ট মানে একাধিক CSV ফাইল ডাউনলোড হবে\")\n                      }\n                      className=\"inline-flex h-8 w-8 items-center justify-center rounded-full border border-border bg-card text-xs text-muted-foreground hover:bg-muted transition\"\n                      title=\"সব রিপোর্ট মানে একাধিক CSV ফাইল ডাউনলোড হবে\"\n                      aria-label=\"এক্সপোর্ট তথ্য\"\n                    >\n                      ℹ️\n                    </button>\n                  </div>\n                  <DialogContent className=\"max-w-md\">\n                    <DialogHeader>\n                      <DialogTitle>CSV এক্সপোর্ট</DialogTitle>\n                    </DialogHeader>\n                    <div className=\"space-y-4\">\n                      <div className=\"rounded-xl border border-border/70 bg-muted/40 px-4 py-3 text-xs text-muted-foreground space-y-1\">\n                        <p>রেঞ্জ: {rangeLabel ?? \"সব সময়\"}</p>\n                        <p>\n                          বর্তমান ট্যাব:{\" \"}\n                          {NAV.find((item) => item.key === active)?.label ??\n                            \"সারাংশ\"}\n                        </p>\n                        <p>টপ পণ্য ও লো স্টক সবসময় সামগ্রিক ডেটা দেখায়।</p>\n                        <p>বড় রিপোর্টে কিছু সময় লাগতে পারে।</p>\n                      </div>\n\n                      <div className=\"space-y-2\">\n                        {[\n                          { key: \"active\", label: \"বর্তমান ট্যাব\" },\n                          { key: \"summary\", label: \"সারাংশ\" },\n                          { key: \"sales\", label: \"বিক্রি\" },\n                          { key: \"expenses\", label: \"খরচ\" },\n                          { key: \"cash\", label: \"ক্যাশ\" },\n                          { key: \"payment\", label: \"পেমেন্ট\" },\n                          { key: \"profit\", label: \"লাভ\" },\n                          { key: \"products\", label: \"টপ পণ্য\" },\n                          { key: \"stock\", label: \"লো স্টক\" },\n                          { key: \"all\", label: \"সব রিপোর্ট\" },\n                        ].map((option) => (\n                          <button\n                            key={option.key}\n                            type=\"button\"\n                            onClick={() => handleExport(option.key as ExportKey)}\n                            disabled={exportingKey !== null}\n                            className=\"w-full flex items-center justify-between rounded-xl border border-border bg-card px-4 py-3 text-sm font-semibold text-foreground hover:bg-muted transition disabled:opacity-60 disabled:cursor-not-allowed\"\n                          >\n                            <span>{option.label}</span>\n                            <span className=\"text-xs text-muted-foreground\">\n                              {exportingKey === option.key\n                                ? \"ডাউনলোড হচ্ছে...\"\n                                : \"ডাউনলোড\"}\n                            </span>\n                          </button>\n                        ))}\n                      </div>\n\n                      {exportError ? (\n                        <div className=\"rounded-lg border border-danger/40 bg-danger-soft/60 px-3 py-2 text-xs text-danger\">\n                          {exportError}\n                        </div>\n                      ) : null}\n\n                      {!online ? (\n                        <div className=\"rounded-lg border border-warning/40 bg-warning-soft/60 px-3 py-2 text-xs text-warning\">\n                          অফলাইনে CSV এক্সপোর্ট করা যাবে না।\n                        </div>\n                      ) : null}\n                    </div>\n                  </DialogContent>\n                </Dialog>\n              </div>\n            </div>\n          </div>\n\r\n          <div className=\"flex flex-wrap items-center gap-2 text-xs font-semibold\">\r\n            <span className=\"inline-flex h-7 items-center rounded-full border px-3\">\r\n              {presetLabel}\r\n            </span>\r\n            {rangeLabel ? (\r\n              <span className=\"inline-flex h-7 items-center rounded-full border border-border bg-card/80 px-3 text-muted-foreground\">\r\n                {rangeLabel}\r\n              </span>\r\n            ) : null}\r\n            <span\n              className={`inline-flex h-7 items-center rounded-full border px-3 transition-all duration-300 ${\n                summaryLoading\n                  ? \"bg-yellow-soft text-yellow border-yellow/30 animate-pulse\"\n                  : realTimeIndicator\n                  ? \"bg-green-soft text-green border-green/30 animate-pulse\"\n                  : \"bg-primary-soft text-primary border-primary/30\"\n              }`}\n            >\n              <>\n                {summarySnapshot}\n                {realTimeIndicator && (\n                  <span className=\"ml-1 text-xs\">🔄 LIVE</span>\n                )}\n              </>\n            </span>\n            {summaryLoading ? (\r\n              <span\r\n                aria-hidden=\"true\"\r\n                className=\"inline-flex h-7 w-16 animate-pulse rounded-full bg-muted\"\r\n              />\r\n            ) : null}\r\n            <span\r\n              className={`inline-flex h-7 items-center rounded-full border px-3 ${\r\n                online\r\n                  ? \"bg-success-soft text-success border-success/30\"\r\n                  : \"bg-danger-soft text-danger border-danger/30\"\r\n              }`}\r\n            >\r\n              {online ? \"অনলাইন\" : \"অফলাইন\"}\r\n            </span>\r\n          </div>\n        </div>\n      </div>\n\r\n      {/* Mobile controls */}\r\n      <div className=\"md:hidden space-y-3\">\r\n        <div className=\"sticky top-0 z-30 bg-card/95 backdrop-blur border-b border-border/70 pt-3 pb-2\">\r\n          <div className=\"px-3 space-y-2\">\r\n            <p className=\"text-[11px] font-semibold text-muted-foreground\"> রিপোর্ট</p>\r\n            <div className=\"relative\">\r\n              <div className=\"flex gap-2 overflow-x-auto no-scrollbar rounded-full bg-muted/70 p-1 pr-6 shadow-[inset_0_1px_0_rgba(255,255,255,0.6)]\">\r\n                {NAV.map((item) => (\r\n                  <button\r\n                    key={item.key}\r\n                    onClick={() => setActive(item.key)}\r\n                    className={`h-9 px-4 rounded-full text-sm font-semibold whitespace-nowrap border border-transparent transition-colors ${\r\n                      active === item.key\r\n                        ? \"bg-card text-foreground border-border shadow-sm\"\r\n                        : \"text-muted-foreground hover:text-foreground\"\r\n                    }`}\r\n                  >\r\n                    {item.label}\r\n                  </button>\r\n                ))}\r\n              </div>\r\n              <div className=\"pointer-events-none absolute inset-y-0 right-0 w-10 bg-gradient-to-l from-card to-transparent\" />\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"px-3 space-y-2\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <p className=\"text-[11px] font-semibold text-muted-foreground\"> সময়</p>\r\n            {rangeLabel ? (\r\n              <span className=\"text-[11px] font-semibold text-muted-foreground\">\r\n                {rangeLabel}\r\n              </span>\r\n            ) : null}\r\n          </div>\r\n          <div className=\"relative\">\r\n            <div className=\"flex gap-2 overflow-x-auto no-scrollbar rounded-full bg-muted/70 p-1 pr-8 pb-1 shadow-[inset_0_1px_0_rgba(255,255,255,0.6)]\">\r\n              {PRESETS.map(({ key, label }) => (\r\n                <button\r\n                  key={key}\r\n                  onClick={() => setPreset(key)}\r\n                  className={`h-9 px-4 rounded-full text-sm font-semibold whitespace-nowrap border border-transparent transition-colors ${\r\n                    preset === key\r\n                      ? \"bg-card text-foreground border-border shadow-sm\"\r\n                      : \"text-muted-foreground hover:text-foreground\"\r\n                  }`}\r\n                >\r\n                  {label}\r\n                </button>\r\n              ))}\r\n            </div>\r\n            <div className=\"pointer-events-none absolute inset-y-0 right-0 w-10 bg-gradient-to-l from-card to-transparent\" />\r\n          </div>\r\n          {preset === \"custom\" && (\r\n            <div className=\"grid grid-cols-2 gap-2\">\r\n              <input\r\n                type=\"date\"\r\n                className=\"h-10 w-full rounded-xl border border-border bg-card px-3 text-sm text-foreground focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n                value={customFrom ?? \"\"}\r\n                onChange={(e) => setCustomFrom(e.target.value)}\r\n              />\r\n              <input\r\n                type=\"date\"\r\n                className=\"h-10 w-full rounded-xl border border-border bg-card px-3 text-sm text-foreground focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n                value={customTo ?? \"\"}\r\n                onChange={(e) => setCustomTo(e.target.value)}\r\n              />\r\n            </div>\r\n          )}\r\n          <div>\r\n            <div className=\"rounded-xl border border-primary/30 bg-primary-soft px-3 py-2 text-xs font-semibold text-primary shadow-sm\">\r\n              {summarySnapshot}\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n      {/* Desktop: primary tabs + date filter separated */}\r\n      <div className=\"hidden md:block space-y-4\">\r\n        <div className=\"rounded-2xl bg-card border border-border shadow-sm px-4 py-3 relative\">\r\n          <p className=\"text-xs font-semibold text-muted-foreground mb-2\"> রিপোর্ট</p>\r\n          <div className=\"relative\">\r\n            <div className=\"flex gap-2 overflow-x-auto no-scrollbar rounded-full bg-muted/70 p-1 pr-10 shadow-[inset_0_1px_0_rgba(255,255,255,0.6)]\">\r\n              {NAV.map((item) => (\r\n                <button\r\n                  key={item.key}\r\n                  onClick={() => setActive(item.key)}\r\n                  className={`h-9 px-4 rounded-full text-sm font-semibold whitespace-nowrap border border-transparent transition-colors ${\r\n                    active === item.key\r\n                      ? \"bg-card text-foreground border-border shadow-sm\"\r\n                      : \"text-muted-foreground hover:text-foreground\"\r\n                  }`}\r\n                >\r\n                  {item.label}\r\n                </button>\r\n              ))}\r\n            </div>\r\n            <div className=\"pointer-events-none absolute inset-y-0 right-0 w-12 bg-gradient-to-l from-card to-transparent\" />\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"rounded-2xl bg-card border border-border shadow-sm px-4 py-3 space-y-4\">\r\n          <p className=\"text-xs font-semibold text-muted-foreground\"> সময়</p>\r\n          <div className=\"relative\">\r\n            <div className=\"flex items-center gap-2 overflow-x-auto no-scrollbar rounded-full bg-muted/70 p-1 pr-12 pb-1 shadow-[inset_0_1px_0_rgba(255,255,255,0.6)]\">\r\n              {PRESETS.map(({ key, label }) => (\r\n                <button\r\n                  key={key}\r\n                  onClick={() => setPreset(key)}\r\n                  className={`h-9 px-4 rounded-full text-sm font-semibold whitespace-nowrap border border-transparent transition-colors ${\r\n                    preset === key\r\n                      ? \"bg-card text-foreground border-border shadow-sm\"\r\n                      : \"text-muted-foreground hover:text-foreground\"\r\n                  }`}\r\n                >\r\n                  {label}\r\n                </button>\r\n              ))}\r\n            </div>\r\n            <div className=\"pointer-events-none absolute inset-y-0 right-0 w-12 bg-gradient-to-l from-card to-transparent\" />\r\n          </div>\r\n          {preset === \"custom\" && (\r\n            <div className=\"flex items-center gap-2 flex-wrap\">\r\n              <input\r\n                type=\"date\"\r\n                className=\"h-9 rounded-lg border border-border bg-card px-2 text-sm text-foreground focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n                value={customFrom ?? \"\"}\r\n                onChange={(e) => setCustomFrom(e.target.value)}\r\n              />\r\n              <input\r\n                type=\"date\"\r\n                className=\"h-9 rounded-lg border border-border bg-card px-2 text-sm text-foreground focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n                value={customTo ?? \"\"}\r\n                onChange={(e) => setCustomTo(e.target.value)}\r\n              />\r\n            </div>\r\n          )}\r\n          <div className=\"rounded-xl border border-primary/20 bg-primary-soft px-3 py-2 text-xs font-semibold text-primary\">\r\n            {summarySnapshot}\r\n          </div>\r\n          {summaryLoading && (\r\n            <span className=\"text-xs text-muted-foreground\">রিফ্রেশ হচ্ছে...</span>\r\n          )}\r\n        </div>\r\n      </div>\r\n      {/* Desktop grid */}\r\n      <div className=\"hidden md:block space-y-6\">\r\n        <div className=\"bg-card border border-border rounded-2xl p-5 shadow-[0_12px_30px_rgba(15,23,42,0.08)]\">\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\r\n            <StatCard\r\n              title=\"মোট বিক্রি\"\r\n              value={`${liveSummary.sales.totalAmount.toFixed(2)} ৳`}\r\n              subtitle={`মোট বিল: ${liveSummary.sales.completedCount ?? 0}${\r\n                typeof liveSummary.sales.voidedCount === \"number\"\r\n                  ? ` · বাতিল: ${liveSummary.sales.voidedCount}`\r\n                  : \"\"\r\n              }`}\r\n              icon=\"🧾\"\r\n              tone=\"success\"\r\n            />\r\n            <StatCard\r\n              title=\"খরচ\"\r\n              value={`${liveSummary.expense.totalAmount.toFixed(2)} ৳`}\r\n              subtitle={`মোট খরচ: ${liveSummary.expense.count ?? 0}`}\r\n              icon=\"💸\"\r\n              tone=\"danger\"\r\n            />\r\n            <StatCard\r\n              title=\"ক্যাশ ব্যালান্স\"\r\n              value={`${liveSummary.cash.balance.toFixed(2)} ৳`}\r\n              subtitle={`ইন: ${liveSummary.cash.totalIn.toFixed(\r\n                2\r\n              )} ৳ | আউট: ${liveSummary.cash.totalOut.toFixed(2)} ৳`}\r\n              icon=\"💵\"\r\n              tone=\"warning\"\r\n            />\r\n            <StatCard\r\n              title=\"লাভ\"\r\n              value={`${liveSummary.profit.profit.toFixed(2)} ৳`}\r\n              subtitle={`বিক্রি: ${liveSummary.profit.salesTotal.toFixed(\r\n                2\r\n              )} ৳ | খরচ: ${liveSummary.profit.expenseTotal.toFixed(2)} ৳`}\r\n              icon=\"📈\"\r\n              tone=\"primary\"\r\n            />\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-4\">\r\n          <div className=\"border border-border rounded-2xl p-6 bg-card shadow-[0_12px_30px_rgba(15,23,42,0.08)]\">\r\n            <LazyReport fallback={<ReportSkeleton />}>\r\n              <SalesReport shopId={shopId} from={range.from} to={range.to} />\r\n            </LazyReport>\r\n          </div>\r\n\r\n          <div className=\"border border-border rounded-2xl p-6 bg-card shadow-[0_12px_30px_rgba(15,23,42,0.08)]\">\r\n            <LazyReport fallback={<ReportSkeleton />}>\r\n              <ExpenseReport shopId={shopId} from={range.from} to={range.to} />\r\n            </LazyReport>\r\n          </div>\r\n\r\n          <div className=\"border border-border rounded-2xl p-6 bg-card shadow-[0_12px_30px_rgba(15,23,42,0.08)]\">\r\n            <LazyReport fallback={<ReportSkeleton />}>\r\n              <CashbookReport shopId={shopId} from={range.from} to={range.to} />\r\n            </LazyReport>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-4\">\r\n          <div className=\"border border-border rounded-2xl p-6 bg-card shadow-[0_12px_30px_rgba(15,23,42,0.08)]\">\r\n            <LazyReport fallback={<ReportSkeleton />}>\r\n              <PaymentMethodReport\r\n                shopId={shopId}\r\n                from={range.from}\r\n                to={range.to}\r\n              />\r\n            </LazyReport>\r\n          </div>\r\n\r\n          <div className=\"border border-border rounded-2xl p-6 bg-card shadow-[0_12px_30px_rgba(15,23,42,0.08)]\">\r\n            <LazyReport fallback={<ReportSkeleton />}>\r\n              <ProfitTrendReport\r\n                shopId={shopId}\r\n                from={range.from}\r\n                to={range.to}\r\n              />\r\n            </LazyReport>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-4\">\r\n          <div className=\"border border-border rounded-2xl p-6 bg-card shadow-[0_12px_30px_rgba(15,23,42,0.08)]\">\r\n            <LazyReport fallback={<ReportSkeleton />}>\r\n              <TopProductsReport shopId={shopId} />\r\n            </LazyReport>\r\n          </div>\r\n\r\n          <div className=\"border border-border rounded-2xl p-6 bg-card shadow-[0_12px_30px_rgba(15,23,42,0.08)]\">\r\n            <LazyReport fallback={<ReportSkeleton />}>\n              <LowStockReport\n                shopId={shopId}\n                threshold={lowStockThreshold}\n                onThresholdChange={setLowStockThreshold}\n              />\n            </LazyReport>\n          </div>\n        </div>\r\n      </div>\r\n\r\n      {/* Mobile single report view */}\r\n      <div className=\"md:hidden animate-fade-in\">{renderReport()}</div>\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\reports\\components\\SalesReport.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\pos\\pos-app-supabase\\app\\dashboard\\reports\\components\\SalesReport.tsx:42:5\n  40 |\n  41 |   useEffect(() => {\n> 42 |     setPage(1);\n     |     ^^^^^^^ Avoid calling setState() directly within an effect\n  43 |     setCursorList([]);\n  44 |   }, [shopId, from, to]);\n  45 |","line":42,"column":5,"nodeType":null,"endLine":42,"endColumn":12},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'items' logical expression could make the dependencies of useMemo Hook (at line 200) change on every render. To fix this, wrap the initialization of 'items' in its own useMemo() Hook.","line":151,"column":9,"nodeType":"VariableDeclarator","endLine":151,"endColumn":56},{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\pos\\pos-app-supabase\\app\\dashboard\\reports\\components\\SalesReport.tsx:160:7\n  158 |   useEffect(() => {\n  159 |     if (!online && page > 1) {\n> 160 |       setPage(1);\n      |       ^^^^^^^ Avoid calling setState() directly within an effect\n  161 |       setCursorList([]);\n  162 |     }\n  163 |   }, [online, page]);","line":160,"column":7,"nodeType":null,"endLine":160,"endColumn":14},{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\pos\\pos-app-supabase\\app\\dashboard\\reports\\components\\SalesReport.tsx:167:7\n  165 |   useEffect(() => {\n  166 |     if (page > 1 && !currentCursor) {\n> 167 |       setPage(1);\n      |       ^^^^^^^ Avoid calling setState() directly within an effect\n  168 |     }\n  169 |   }, [page, currentCursor]);\n  170 |","line":167,"column":7,"nodeType":null,"endLine":167,"endColumn":14}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// app/dashboard/reports/components/SalesReport.tsx\r\n\r\n\"use client\";\r\n\r\nimport Link from \"next/link\";\r\nimport { useCallback, useEffect, useMemo, useRef, useState } from \"react\";\nimport { useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { useOnlineStatus } from \"@/lib/sync/net-status\";\r\nimport { REPORT_ROW_LIMIT } from \"@/lib/reporting-config\";\r\nimport { PREFETCH_PRESETS, computePresetRange } from \"@/lib/reporting-range\";\nimport { scheduleIdle } from \"@/lib/schedule-idle\";\nimport { handlePermissionError } from \"@/lib/permission-toast\";\nimport { safeLocalStorageGet, safeLocalStorageSet } from \"@/lib/storage\";\n\r\ntype Props = { shopId: string; from?: string; to?: string };\n\ntype ReportCursor = { at: string; id: string };\ntype SalesRow = {\n  id: string;\n  totalAmount: number | string;\n  paymentMethod?: string | null;\n  saleDate: string;\n  note?: string | null;\n};\n\r\nexport default function SalesReport({ shopId, from, to }: Props) {\n  const online = useOnlineStatus();\n  const queryClient = useQueryClient();\n  const [page, setPage] = useState(1);\n  const [cursorList, setCursorList] = useState<ReportCursor[]>([]);\n  const prefetchKeyRef = useRef<string | null>(null);\n\r\n  const currentCursor = page > 1 ? cursorList[page - 2] ?? null : null;\r\n\r\n  const buildCacheKey = useCallback(\r\n    (rangeFrom?: string, rangeTo?: string) =>\r\n      `reports:sales:${shopId}:${rangeFrom || \"all\"}:${rangeTo || \"all\"}:${REPORT_ROW_LIMIT}`,\r\n    [shopId]\r\n  );\r\n\r\n  useEffect(() => {\n    setPage(1);\n    setCursorList([]);\n  }, [shopId, from, to]);\n\r\n  const readCached = useCallback(\n    (rangeFrom?: string, rangeTo?: string) => {\n      if (typeof window === \"undefined\") return null;\n      try {\n        const raw = safeLocalStorageGet(buildCacheKey(rangeFrom, rangeTo));\n        if (!raw) {\n          return null;\n        }\n        const parsed = JSON.parse(raw);\n        return Array.isArray(parsed) ? parsed : null;\n      } catch (err) {\n        handlePermissionError(err);\n        console.warn(\"Sales report cache read failed\", err);\n        return null;\n      }\n    },\n    [buildCacheKey]\n  );\n\n  const fetchSales = useCallback(\n    async (\n      rangeFrom?: string,\n      rangeTo?: string,\n      cursor?: ReportCursor | null,\n      shouldCache = false\n    ) => {\n      const params = new URLSearchParams({\n        shopId,\n        limit: `${REPORT_ROW_LIMIT}`,\n      });\n      if (rangeFrom) params.append(\"from\", rangeFrom);\n      if (rangeTo) params.append(\"to\", rangeTo);\n      if (cursor) {\n        params.append(\"cursorAt\", cursor.at);\n        params.append(\"cursorId\", cursor.id);\n      }\n\n      const res = await fetch(`/api/reports/sales?${params.toString()}`);\n      if (res.status === 304) {\n        const cached = readCached(rangeFrom, rangeTo);\n        if (cached && !cursor) {\n          return { rows: cached, hasMore: false, nextCursor: null };\n        }\n        throw new Error(\"Sales report not modified\");\n      }\n      if (!res.ok) {\n        const cached = readCached(rangeFrom, rangeTo);\n        if (cached && !cursor) {\n          return { rows: cached, hasMore: false, nextCursor: null };\n        }\n        throw new Error(\"Sales report fetch failed\");\n      }\n      const data = await res.json();\n      const rows = data.rows || [];\n      if (shouldCache && !cursor && typeof window !== \"undefined\") {\n        try {\n          safeLocalStorageSet(\n            buildCacheKey(rangeFrom, rangeTo),\n            JSON.stringify(rows)\n          );\n        } catch (err) {\n          handlePermissionError(err);\n          console.warn(\"Sales report cache write failed\", err);\n        }\n      }\n      return {\n        rows,\n        hasMore: Boolean(data.hasMore),\n        nextCursor: data.nextCursor ?? null,\n      };\n    },\n    [shopId, buildCacheKey, readCached]\n  );\n\n  const salesQueryKey = useMemo(\n    () => [\n      \"reports\",\n      \"sales\",\n      shopId,\n      from ?? \"all\",\n      to ?? \"all\",\n      page,\n      currentCursor?.at ?? \"start\",\n      currentCursor?.id ?? \"start\",\n    ],\n    [shopId, from, to, page, currentCursor?.at, currentCursor?.id]\n  );\n\n  const salesQuery = useQuery({\n    queryKey: salesQueryKey,\n    queryFn: () => fetchSales(from, to, currentCursor, page === 1),\n    enabled: online,\n    initialData: () => {\n      if (page !== 1) {\n        return { rows: [], hasMore: false, nextCursor: null };\n      }\n      const cached = readCached(from, to);\n      return cached\n        ? { rows: cached, hasMore: false, nextCursor: null }\n        : { rows: [], hasMore: false, nextCursor: null };\n    },\n    placeholderData: (prev) =>\n      prev ?? { rows: [], hasMore: false, nextCursor: null },\n  });\n\n  const items: SalesRow[] = salesQuery.data?.rows ?? [];\n  const hasMore = salesQuery.data?.hasMore ?? false;\n  const nextCursor = salesQuery.data?.nextCursor ?? null;\n  const loading = salesQuery.isFetching && online;\n  const hasFetched = salesQuery.isFetchedAfterMount;\n  const showEmpty = items.length === 0 && (!online || hasFetched) && !loading;\n\n  useEffect(() => {\n    if (!online && page > 1) {\n      setPage(1);\n      setCursorList([]);\n    }\n  }, [online, page]);\n\n  useEffect(() => {\n    if (page > 1 && !currentCursor) {\n      setPage(1);\n    }\n  }, [page, currentCursor]);\n\r\n  useEffect(() => {\n    if (!online || typeof window === \"undefined\") return;\n    if (prefetchKeyRef.current === shopId) return;\n    prefetchKeyRef.current = shopId;\n    const cancel = scheduleIdle(() => {\n      PREFETCH_PRESETS.forEach((presetKey) => {\n        const { from: rangeFrom, to: rangeTo } = computePresetRange(presetKey);\n        const queryKey = [\n          \"reports\",\n          \"sales\",\n          shopId,\n          rangeFrom ?? \"all\",\n          rangeTo ?? \"all\",\n          1,\n          \"start\",\n          \"start\",\n        ];\n        if (queryClient.getQueryData(queryKey)) return;\n        queryClient.prefetchQuery({\n          queryKey,\n          queryFn: () => fetchSales(rangeFrom, rangeTo, null, true),\n        });\n      });\n    }, 50);\n    return () => cancel();\n  }, [online, shopId, fetchSales, queryClient]);\n\r\n  const shownTotal = useMemo(\r\n    () => items.reduce((sum, s) => sum + Number(s.totalAmount || 0), 0),\r\n    [items]\r\n  );\r\n\r\n  const handlePrev = () => {\r\n    setPage((prev) => Math.max(1, prev - 1));\r\n  };\r\n\r\n  const handleNext = () => {\r\n    const cursorToUse = cursorList[page - 1] ?? nextCursor;\r\n    if (!cursorToUse) return;\r\n    setCursorList((prev) => {\r\n      const next = [...prev];\r\n      next[page - 1] = cursorToUse;\r\n      return next;\r\n    });\r\n    setPage((prev) => prev + 1);\r\n  };\r\n\r\n  const buildHref = () => {\r\n    const params = new URLSearchParams({ shopId });\r\n    if (from) params.set(\"from\", from);\r\n    if (to) params.set(\"to\", to);\r\n    return `/dashboard/sales?${params.toString()}`;\r\n  };\r\n\r\n  return (\r\n    <div className=\"space-y-4\">\r\n      <div className=\"relative overflow-hidden rounded-2xl border border-border bg-card shadow-[0_12px_30px_rgba(15,23,42,0.08)]\">\r\n        <div className=\"pointer-events-none absolute inset-0 bg-gradient-to-br from-primary-soft/50 via-card to-card\" />\r\n        <div className=\"relative space-y-3 p-4\">\r\n          <div className=\"flex flex-wrap items-start justify-between gap-3\">\r\n            <div className=\"flex items-start gap-3\">\r\n              <span className=\"inline-flex h-10 w-10 items-center justify-center rounded-2xl bg-success/15 text-success text-lg\">\r\n                🧾\r\n              </span>\r\n              <div>\r\n                <h2 className=\"text-lg font-bold text-foreground\">বিক্রি রিপোর্ট</h2>\r\n                <p className=\"text-xs text-muted-foreground\">\r\n                  সর্বশেষ 20টি বিক্রি\r\n                </p>\r\n              </div>\r\n            </div>\r\n            <Link\r\n              href={buildHref()}\r\n              className=\"inline-flex h-7 items-center rounded-full border border-primary/20 bg-primary-soft px-3 text-xs font-semibold text-primary hover:bg-primary/20\"\r\n            >\r\n              পূর্ণ রিপোর্ট দেখুন\r\n            </Link>\r\n          </div>\r\n\r\n          <div className=\"flex flex-wrap items-center gap-2 text-xs font-semibold\">\n            <span className=\"inline-flex h-7 items-center rounded-full border border-border bg-card/80 px-3 text-muted-foreground\">\n              এই তালিকায় মোট: {shownTotal.toFixed(2)} ৳\n            </span>\n          </div>\n        </div>\n      </div>\n\r\n      {/* List */}\r\n      <div className=\"rounded-2xl border border-border/70 bg-card/80 p-3 shadow-[0_10px_20px_rgba(15,23,42,0.06)] space-y-2\">\r\n        {items.length === 0 ? (\n          <p className=\"rounded-xl border border-border bg-card px-4 py-6 text-center text-sm text-muted-foreground\">\n            {showEmpty ? \"কোনো বিক্রি পাওয়া যায়নি\" : \"লোড হচ্ছে...\"}\n          </p>\n        ) : (\n          <>\r\n            {items.map((s) => (\r\n              <div\r\n                key={s.id}\r\n                className=\"relative overflow-hidden rounded-2xl border border-success/20 bg-card p-3 shadow-sm transition-all hover:shadow-md hover:-translate-y-0.5\"\r\n              >\r\n                <div className=\"pointer-events-none absolute inset-0 bg-gradient-to-br from-success-soft/40 via-transparent to-transparent\" />\r\n                <div className=\"relative flex items-center justify-between gap-3\">\r\n                  <div className=\"flex items-center gap-3\">\n                    <span className=\"inline-flex h-9 w-9 items-center justify-center rounded-2xl bg-success/15 text-success text-lg\">\n                      🛒\n                    </span>\n                    <div>\n                      <p className=\"text-sm font-semibold text-foreground\">\n                        {s.totalAmount} ৳\n                      </p>\n                      <p className=\"text-xs text-muted-foreground\">\r\n                        {s.paymentMethod}\r\n                      </p>\r\n                    </div>\r\n                  </div>\r\n                  <p className=\"text-xs text-muted-foreground\">\r\n                    {new Date(s.saleDate).toLocaleDateString(\"bn-BD\")}\r\n                  </p>\r\n                </div>\r\n              </div>\r\n            ))}\r\n            {loading && (\n              <p className=\"text-xs text-muted-foreground text-center pt-1\">\n                আপডেট হচ্ছে...\n              </p>\n            )}\n          </>\r\n        )}\r\n      </div>\r\n\r\n      {(page > 1 || hasMore) && (\n        <div className=\"flex items-center justify-between gap-2 pt-2\">\r\n          <button\r\n            type=\"button\"\r\n            onClick={handlePrev}\r\n            disabled={page <= 1 || loading || !online}\r\n            className=\"inline-flex items-center gap-1 rounded-full border border-border px-3 py-1 text-xs font-semibold text-foreground hover:bg-muted disabled:opacity-50 disabled:cursor-not-allowed\"\r\n          >\r\n            Prev\r\n          </button>\r\n          <span className=\"rounded-full border border-border px-3 py-1 text-xs font-semibold text-muted-foreground\">\r\n            Page {page}\r\n          </span>\r\n          <button\r\n            type=\"button\"\r\n            onClick={handleNext}\r\n            disabled={!hasMore || !nextCursor || loading || !online}\r\n            className=\"inline-flex items-center gap-1 rounded-full border border-border px-3 py-1 text-xs font-semibold text-foreground hover:bg-muted disabled:opacity-50 disabled:cursor-not-allowed\"\r\n          >\r\n            Next\r\n          </button>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\reports\\components\\StatCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\reports\\components\\TopProductsReport.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\reports\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\sales\\PosPageClient.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\sales\\ShopSelectorClient.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\sales\\components\\DateFilterClient.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\pos\\pos-app-supabase\\app\\dashboard\\sales\\components\\DateFilterClient.tsx:86:5\n  84 |\n  85 |   useEffect(() => {\n> 86 |     setMounted(true);\n     |     ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  87 |   }, []);\n  88 |\n  89 |   useEffect(() => {","line":86,"column":5,"nodeType":null,"endLine":86,"endColumn":15},{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\pos\\pos-app-supabase\\app\\dashboard\\sales\\components\\DateFilterClient.tsx:90:5\n  88 |\n  89 |   useEffect(() => {\n> 90 |     setCustomFrom(from);\n     |     ^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  91 |     setCustomTo(to);\n  92 |   }, [from, to]);\n  93 |","line":90,"column":5,"nodeType":null,"endLine":90,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// app/dashboard/sales/components/DateFilterClient.tsx\r\n\r\n\"use client\";\r\n\r\nimport { useEffect, useMemo, useState } from \"react\";\r\nimport { createPortal } from \"react-dom\";\r\nimport { useRouter } from \"next/navigation\";\r\n\r\ntype Props = {\r\n  shopId: string;\r\n  from: string;\r\n  to: string;\r\n};\r\n\r\nconst DHAKA_TIMEZONE = \"Asia/Dhaka\";\r\n\r\nfunction parseDateParts(value: string) {\r\n  const [y, m, d] = value.split(\"-\").map((v) => Number(v));\r\n  if (!y || !m || !d) return null;\r\n  const date = new Date(Date.UTC(y, m - 1, d));\r\n  return Number.isNaN(date.getTime()) ? null : date;\r\n}\r\n\r\nfunction formatDate(value: string) {\r\n  const date = parseDateParts(value);\r\n  if (!date) return value;\r\n  return new Intl.DateTimeFormat(\"bn-BD\", {\r\n    timeZone: DHAKA_TIMEZONE,\r\n    month: \"short\",\r\n    day: \"numeric\",\r\n  }).format(date);\r\n}\r\n\r\nfunction getDhakaTodayStr() {\r\n  return new Intl.DateTimeFormat(\"en-CA\", {\r\n    timeZone: DHAKA_TIMEZONE,\r\n    year: \"numeric\",\r\n    month: \"2-digit\",\r\n    day: \"2-digit\",\r\n  }).format(new Date());\r\n}\r\n\r\nfunction addDays(dateStr: string, days: number) {\r\n  const date = parseDateParts(dateStr);\r\n  if (!date) return dateStr;\r\n  date.setUTCDate(date.getUTCDate() + days);\r\n  return date.toISOString().slice(0, 10);\r\n}\r\n\r\nfunction getMonthStart(dateStr: string) {\r\n  const date = parseDateParts(dateStr);\r\n  if (!date) return dateStr;\r\n  return new Date(\r\n    Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), 1)\r\n  )\r\n    .toISOString()\r\n    .slice(0, 10);\r\n}\r\n\r\nexport default function DateFilterClient({ shopId, from, to }: Props) {\r\n  const router = useRouter();\r\n  const [mounted, setMounted] = useState(false);\r\n  const [open, setOpen] = useState(false);\r\n  const [customFrom, setCustomFrom] = useState(from);\r\n  const [customTo, setCustomTo] = useState(to);\r\n  const rangeText = useMemo(() => {\r\n    // Check if this is \"all time\" range\r\n    if (from === \"1970-01-01\" && to === \"2099-12-31\") {\r\n      return \"সর্বকাল\";\r\n    }\r\n    if (from === to) {\r\n      const today = getDhakaTodayStr();\r\n      const yesterday = addDays(today, -1);\r\n      if (from === today) {\r\n        return `আজ · ${formatDate(from)}`;\r\n      }\r\n      if (from === yesterday) {\r\n        return `গতকাল · ${formatDate(from)}`;\r\n      }\r\n      return formatDate(from);\r\n    }\r\n    return `${formatDate(from)} - ${formatDate(to)}`;\r\n  }, [from, to]);\r\n\r\n  useEffect(() => {\r\n    setMounted(true);\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    setCustomFrom(from);\r\n    setCustomTo(to);\r\n  }, [from, to]);\r\n\r\n  const applyRange = (nextFrom: string, nextTo: string) => {\r\n    const params = new URLSearchParams({\r\n      shopId,\r\n      from: nextFrom,\r\n      to: nextTo,\r\n    });\r\n    router.push(`/dashboard/sales?${params.toString()}`);\r\n    setOpen(false);\r\n  };\r\n\r\n  const setPreset = (key: \"today\" | \"yesterday\" | \"7d\" | \"month\" | \"all\") => {\r\n    const today = getDhakaTodayStr();\r\n    if (key === \"today\") {\r\n      applyRange(today, today);\r\n      return;\r\n    }\r\n    if (key === \"yesterday\") {\r\n      const fromY = addDays(today, -1);\r\n      applyRange(fromY, fromY);\r\n      return;\r\n    }\r\n    if (key === \"7d\") {\r\n      // last 7 days\r\n      const end = today;\r\n      const start = addDays(today, -6);\r\n      applyRange(start, end);\r\n      return;\r\n    }\r\n    if (key === \"month\") {\r\n      // this month\r\n      const startStr = getMonthStart(today);\r\n      applyRange(startStr, today);\r\n      return;\r\n    }\r\n    // all time\r\n    applyRange(\"1970-01-01\", \"2099-12-31\");\r\n  };\r\n\r\n  const canApplyCustom =\r\n    Boolean(customFrom) && Boolean(customTo) && customFrom <= customTo;\r\n\r\n  return (\r\n    <>\r\n      <button\r\n        type=\"button\"\r\n        onClick={() => setOpen(true)}\r\n        className=\"flex h-10 w-full items-center justify-between gap-2 rounded-xl border border-border bg-card/90 px-3 text-sm font-semibold text-foreground shadow-[0_1px_0_rgba(0,0,0,0.03)] hover:bg-muted transition sm:inline-flex sm:w-auto sm:min-w-[200px]\"\r\n      >\r\n        <span className=\"shrink-0\">📅</span>\r\n        <span className=\"min-w-0 flex-1 text-left text-sm truncate\">\r\n          {rangeText}\r\n        </span>\r\n      </button>\r\n\r\n      {mounted &&\r\n        open &&\r\n        typeof document !== \"undefined\" &&\r\n        createPortal(\r\n          <div\r\n            className=\"fixed inset-0 z-[9999] bg-foreground/30 backdrop-blur-[1px]\"\r\n            onClick={() => setOpen(false)}\r\n          >\r\n            <div\r\n              onClick={(e) => e.stopPropagation()}\r\n              className=\"absolute inset-x-0 bottom-0 w-full rounded-t-2xl bg-card border border-border shadow-2xl p-4 space-y-4 sm:inset-auto sm:left-1/2 sm:top-[72px] sm:w-[92%] sm:max-w-md sm:-translate-x-1/2 sm:rounded-2xl\"\r\n            >\r\n              <div className=\"flex items-center justify-between\">\r\n                <div>\r\n                  <p className=\"text-sm font-semibold text-foreground\">\r\n                    তারিখ বাছাই\r\n                  </p>\r\n                  <p className=\"text-xs text-muted-foreground\">{rangeText}</p>\r\n                </div>\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => setOpen(false)}\r\n                  className=\"text-muted-foreground text-sm\"\r\n                >\r\n                  ✕\r\n                </button>\r\n              </div>\r\n\r\n              <div className=\"grid grid-cols-2 gap-2 text-sm sm:grid-cols-3\">\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => setPreset(\"today\")}\r\n                  className=\"rounded-lg border border-border px-3 py-2 font-semibold text-foreground hover:bg-muted\"\r\n                >\r\n                  আজ\r\n                </button>\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => setPreset(\"yesterday\")}\r\n                  className=\"rounded-lg border border-border px-3 py-2 font-semibold text-foreground hover:bg-muted\"\r\n                >\r\n                  গতকাল\r\n                </button>\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => setPreset(\"7d\")}\r\n                  className=\"rounded-lg border border-border px-3 py-2 font-semibold text-foreground hover:bg-muted\"\r\n                >\r\n                  ৭ দিন\r\n                </button>\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => setPreset(\"month\")}\r\n                  className=\"rounded-lg border border-border px-3 py-2 font-semibold text-foreground hover:bg-muted\"\r\n                >\r\n                  এই মাস\r\n                </button>\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => setPreset(\"all\")}\r\n                  className=\"rounded-lg border border-border px-3 py-2 font-semibold text-foreground hover:bg-muted sm:col-span-1\"\r\n                >\r\n                  সব\r\n                </button>\r\n              </div>\r\n\r\n              <div className=\"space-y-2\">\r\n                <p className=\"text-xs font-semibold text-foreground\">\r\n                  Custom range\r\n                </p>\r\n                <div className=\"grid grid-cols-2 gap-2\">\r\n                  <input\r\n                    type=\"date\"\r\n                    value={customFrom}\r\n                    onChange={(e) => setCustomFrom(e.target.value)}\r\n                    className=\"h-11 w-full rounded-lg border border-border px-3 text-sm\"\r\n                  />\r\n                  <input\r\n                    type=\"date\"\r\n                    value={customTo}\r\n                    onChange={(e) => setCustomTo(e.target.value)}\r\n                    className=\"h-11 w-full rounded-lg border border-border px-3 text-sm\"\r\n                  />\r\n                </div>\r\n                <button\r\n                  type=\"button\"\r\n                  disabled={!canApplyCustom}\r\n                  onClick={() => applyRange(customFrom, customTo)}\r\n                  className=\"w-full rounded-lg bg-primary-soft text-primary border border-primary/30 py-2.5 text-sm font-semibold hover:bg-primary/15 hover:border-primary/40 disabled:opacity-60\"\r\n                >\r\n                  রেঞ্জ প্রয়োগ করুন\r\n                </button>\r\n              </div>\r\n            </div>\r\n          </div>,\r\n          document.body\r\n        )}\r\n    </>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\sales\\components\\DateRangePicker.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\sales\\components\\SalesClient.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\sales\\components\\SalesListClient.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\pos\\pos-app-supabase\\app\\dashboard\\sales\\components\\SalesListClient.tsx:255:7\n  253 |       }\n  254 |\n> 255 |       setItems(sales);\n      |       ^^^^^^^^ Avoid calling setState() directly within an effect\n  256 |       const rows = sales.map((s) => ({\n  257 |         tempId: s.id,\n  258 |         id: s.id,","line":255,"column":7,"nodeType":null,"endLine":255,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// app/dashboard/sales/components/SalesListClient.tsx\r\n\r\n\"use client\";\r\n\r\nimport Link from \"next/link\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { useEffect, useMemo, useRef, useState } from \"react\";\nimport { useOnlineStatus } from \"@/lib/sync/net-status\";\nimport { useSyncStatus } from \"@/lib/sync/sync-status\";\nimport { db } from \"@/lib/dexie/db\";\nimport { VoidSaleControls } from \"./VoidSaleControls\";\nimport { handlePermissionError } from \"@/lib/permission-toast\";\nimport { reportEvents, type ReportEventData } from \"@/lib/events/reportEvents\";\nimport { useRealtimeStatus } from \"@/lib/realtime/status\";\nimport { usePageVisibility } from \"@/lib/use-page-visibility\";\nimport { safeLocalStorageGet, safeLocalStorageSet } from \"@/lib/storage\";\n\r\ntype SaleSummary = {\r\n  id: string;\r\n  totalAmount: string;\r\n  paymentMethod: string;\r\n  status?: string | null;\r\n  voidReason?: string | null;\r\n  createdAt: string; // ISO string\r\n  itemCount: number;\r\n  itemPreview: string;\r\n  customerName: string | null;\r\n  syncStatus?: \"new\" | \"synced\";\r\n};\r\n\r\ntype Props = {\r\n  shopId: string;\r\n  sales: SaleSummary[];\r\n  page: number;\r\n  prevHref: string | null;\r\n  nextHref: string | null;\r\n  hasMore: boolean;\r\n  voidSaleAction: (formData: FormData) => Promise<void>;\r\n};\r\n\r\nconst paymentLabels: Record<string, string> = {\r\n  cash: \"💵 ক্যাশ\",\r\n  bkash: \"📱 বিকাশ\",\r\n  nagad: \"📲 নগদ\",\r\n  card: \"💳 কার্ড\",\r\n  bank_transfer: \"🏦 ব্যাংক\",\r\n  due: \"🧾 বাকিতে\",\r\n};\r\n\r\nfunction formatDate(iso: string) {\r\n  const date = new Date(iso);\r\n  if (Number.isNaN(date.getTime())) return iso;\r\n  return date.toLocaleDateString(\"bn-BD\", {\r\n    month: \"short\",\r\n    day: \"numeric\",\r\n  });\r\n}\r\n\r\nfunction formatTime(iso: string) {\r\n  const date = new Date(iso);\r\n  if (Number.isNaN(date.getTime())) return \"\";\r\n  return date.toLocaleTimeString(\"bn-BD\", {\r\n    hour: \"2-digit\",\r\n    minute: \"2-digit\",\r\n  });\r\n}\r\n\r\nexport default function SalesListClient({\r\n  shopId,\r\n  sales,\r\n  page,\r\n  prevHref,\r\n  nextHref,\r\n  hasMore,\r\n  voidSaleAction,\r\n}: Props) {\r\n  const router = useRouter();\n  const online = useOnlineStatus();\n  const realtime = useRealtimeStatus();\n  const isVisible = usePageVisibility();\n  const { pendingCount, syncing, lastSyncAt } = useSyncStatus();\n  const [items, setItems] = useState<SaleSummary[]>(sales);\n  const serverSnapshotRef = useRef(sales);\n  const refreshInFlightRef = useRef(false);\n  const lastRefreshAtRef = useRef(0);\n  const REFRESH_MIN_INTERVAL_MS = 2_000;\n  const lastEventAtRef = useRef(0);\n  const wasVisibleRef = useRef(isVisible);\n  const pollIntervalMs = realtime.connected ? 60_000 : 10_000;\n  const pollingEnabled = !realtime.connected;\n  const EVENT_DEBOUNCE_MS = 800;\n\r\n  useEffect(() => {\r\n    if (serverSnapshotRef.current !== sales) {\r\n      serverSnapshotRef.current = sales;\r\n      refreshInFlightRef.current = false;\r\n    }\r\n  }, [sales]);\r\n\r\n  useEffect(() => {\n    if (!online || !lastSyncAt || syncing || pendingCount > 0) return;\n    if (refreshInFlightRef.current) return;\n    const now = Date.now();\n    if (now - lastRefreshAtRef.current < REFRESH_MIN_INTERVAL_MS) return;\n    lastRefreshAtRef.current = now;\n    refreshInFlightRef.current = true;\n    router.refresh();\n  }, [online, lastSyncAt, syncing, pendingCount, router]);\n\n  useEffect(() => {\n    if (!online) return;\n\n    const handleSaleUpdate = (event: ReportEventData) => {\n      if (event.shopId !== shopId) return;\n      if (event.metadata?.source === \"ui\") return;\n      const now = event.timestamp ?? Date.now();\n      if (now - lastEventAtRef.current < EVENT_DEBOUNCE_MS) return;\n      if (refreshInFlightRef.current) return;\n      if (now - lastRefreshAtRef.current < REFRESH_MIN_INTERVAL_MS) return;\n      lastEventAtRef.current = now;\n      lastRefreshAtRef.current = now;\n      refreshInFlightRef.current = true;\n      router.refresh();\n    };\n\n    const listenerId = reportEvents.addListener(\n      \"sale-update\",\n      handleSaleUpdate,\n      { shopId, priority: 5 }\n    );\n\n    return () => {\n      reportEvents.removeListener(listenerId);\n    };\n  }, [online, router, shopId]);\n\n  useEffect(() => {\n    if (!online || !isVisible || !pollingEnabled) return;\n    const intervalId = setInterval(() => {\n      const now = Date.now();\n      if (now - lastEventAtRef.current < pollIntervalMs / 2) return;\n      if (refreshInFlightRef.current) return;\n      if (syncing || pendingCount > 0) return;\n      if (now - lastRefreshAtRef.current < REFRESH_MIN_INTERVAL_MS) return;\n      lastRefreshAtRef.current = now;\n      refreshInFlightRef.current = true;\n      router.refresh();\n    }, pollIntervalMs);\n\n    return () => clearInterval(intervalId);\n  }, [\n    online,\n    isVisible,\n    pollingEnabled,\n    router,\n    syncing,\n    pendingCount,\n    pollIntervalMs,\n  ]);\n\n  useEffect(() => {\n    if (!online) return;\n    if (wasVisibleRef.current === isVisible) return;\n    wasVisibleRef.current = isVisible;\n    if (!isVisible) return;\n    const now = Date.now();\n    if (refreshInFlightRef.current) return;\n    if (syncing || pendingCount > 0) return;\n    if (now - lastRefreshAtRef.current < REFRESH_MIN_INTERVAL_MS) return;\n    lastEventAtRef.current = now;\n    lastRefreshAtRef.current = now;\n    refreshInFlightRef.current = true;\n    router.refresh();\n  }, [online, isVisible, router, syncing, pendingCount]);\n\r\n  // Seed Dexie when online; load from Dexie when offline.\r\n  useEffect(() => {\r\n    let cancelled = false;\r\n\r\n    const loadFromDexie = async () => {\r\n      try {\r\n        const rows = await db.sales.where(\"shopId\").equals(shopId).toArray();\r\n        if (cancelled) return;\r\n        if (!rows || rows.length === 0) {\n          // Fallback to cached server copy\n          try {\n            const cached = safeLocalStorageGet(`cachedSales:${shopId}`);\n            if (cached) {\n              const parsed = JSON.parse(cached) as SaleSummary[];\n              setItems(parsed || []);\n            }\n          } catch {\r\n            setItems([]);\r\n          }\r\n          return;\r\n        }\r\n\r\n        const mapped: SaleSummary[] = rows.map((r) => {\r\n          const created =\r\n            typeof r.createdAt === \"number\"\r\n              ? new Date(r.createdAt).toISOString()\r\n              : typeof r.createdAt === \"string\"\r\n              ? r.createdAt\r\n              : new Date().toISOString();\r\n          const payment = (r as any).paymentMethod || \"cash\";\r\n          const itemPreview =\r\n            (r as any).itemPreview ||\r\n            (Array.isArray(r.items) && r.items.length > 0\r\n              ? r.items\r\n                  .map((it: any) => {\r\n                    const name = it?.name || \"\";\r\n                    const qty = Number(it?.qty || 0);\r\n                    return qty > 0 ? `${name} x${qty}` : name;\r\n                  })\r\n                  .filter(Boolean)\r\n                  .slice(0, 5)\r\n                  .join(\", \")\r\n              : \"\");\r\n          const itemCount =\r\n            (r as any).itemCount ??\r\n            (Array.isArray(r.items) ? r.items.length : 0);\r\n          return {\r\n            id: (r as any).id || r.tempId,\r\n            totalAmount: r.totalAmount,\r\n            paymentMethod: payment,\r\n            status: (r as any).status ?? \"COMPLETED\",\r\n            voidReason: (r as any).voidReason ?? null,\r\n            createdAt: created,\r\n            itemCount,\r\n            itemPreview,\r\n            customerName: (r as any).customerName ?? null,\r\n            syncStatus: (r as any).syncStatus ?? \"synced\",\r\n          };\r\n        });\r\n\r\n        mapped.sort(\r\n          (a, b) =>\r\n            new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()\r\n        );\r\n        setItems(mapped);\r\n      } catch (err) {\r\n        handlePermissionError(err);\r\n        console.error(\"Load offline sales failed\", err);\r\n      }\r\n    };\r\n\r\n    if (online) {\r\n      if (syncing || pendingCount > 0 || refreshInFlightRef.current) {\r\n        loadFromDexie();\r\n        return () => {\r\n          cancelled = true;\r\n        };\r\n      }\r\n\r\n      setItems(sales);\r\n      const rows = sales.map((s) => ({\r\n        tempId: s.id,\r\n        id: s.id,\r\n        shopId,\r\n        items: [],\r\n        paymentMethod: s.paymentMethod,\r\n        customerId: null,\r\n        note: \"\",\r\n        totalAmount: s.totalAmount,\r\n        createdAt: new Date(s.createdAt).getTime(),\r\n        syncStatus: \"synced\" as const,\r\n        itemCount: s.itemCount,\r\n        itemPreview: s.itemPreview,\r\n        customerName: s.customerName,\r\n        status: s.status ?? \"COMPLETED\",\r\n        voidReason: s.voidReason ?? null,\r\n      }));\r\n      db.sales.bulkPut(rows).catch((err) => {\n        console.error(\"Seed Dexie sales failed\", err);\n      });\n      try {\n        safeLocalStorageSet(`cachedSales:${shopId}`, JSON.stringify(sales));\n      } catch (err) {\n        handlePermissionError(err);\n        console.warn(\"Persist cached sales failed\", err);\n      }\n      return () => {\r\n        cancelled = true;\r\n      };\r\n    }\r\n\r\n    loadFromDexie();\r\n    return () => {\r\n      cancelled = true;\r\n    };\r\n  }, [online, sales, shopId, pendingCount, syncing]);\r\n\r\n  const renderedItems = useMemo(() => items, [items]);\r\n\r\n  return (\r\n    <div className=\"space-y-3\">\r\n      <div className=\"flex flex-wrap items-center justify-between gap-2\">\r\n        <div className=\"flex items-center gap-1.5\">\r\n          {!online && (\r\n            <span className=\"inline-flex items-center gap-1 rounded-full bg-warning-soft px-2 py-0.5 text-[11px] font-semibold text-warning border border-warning/30\">\r\n              📡 Offline - শুধু দেখা যাবে\r\n            </span>\r\n          )}\r\n          {page > 1 && prevHref && (\r\n            <Link\r\n              href={prevHref}\r\n              className=\"inline-flex items-center gap-1 rounded-full border border-border px-3 py-1 text-xs font-semibold text-foreground hover:bg-muted\"\r\n            >\r\n              ⬆️ নতুনগুলো\r\n            </Link>\r\n          )}\r\n        </div>\r\n        <span className=\"text-xs text-muted-foreground\">পৃষ্ঠা {page}</span>\r\n      </div>\r\n\r\n      {renderedItems.length === 0 ? (\r\n        <p className=\"text-center text-muted-foreground py-10\">\r\n          {online\r\n            ? \"এই তারিখে কোনো বিক্রি নেই\"\r\n            : \"Offline: সর্বশেষ সিঙ্ককৃত বিক্রিগুলো দেখাচ্ছে\"}\r\n        </p>\r\n      ) : (\r\n        renderedItems.map((s) => {\r\n          const isVoided = (s.status || \"\").toUpperCase() === \"VOIDED\";\r\n          const voidReason = s.voidReason || \"\";\r\n          const totalStr = Number(s.totalAmount || 0).toFixed(2);\r\n          const paymentKey = s.paymentMethod?.toLowerCase?.() || \"cash\";\r\n          const paymentText =\r\n            paymentLabels[paymentKey] || s.paymentMethod || \"নগদ\";\r\n          const isDueSale = paymentKey === \"due\";\r\n          const isPending = s.syncStatus === \"new\";\r\n          const itemLine =\r\n            s.itemPreview ||\r\n            (s.itemCount > 0\r\n              ? `${s.itemCount} আইটেম`\r\n              : \"কোন আইটেম সংযুক্ত নেই\");\r\n          const timeStr = formatTime(s.createdAt);\r\n          const dateStr = formatDate(s.createdAt);\r\n          const formId = `void-sale-${s.id}`;\r\n          const statusPill = isVoided\r\n            ? \"bg-danger-soft text-danger border-danger/30\"\r\n            : \"bg-success-soft text-success border-success/30\";\r\n          const statusText = isVoided ? \"❌ বাতিল\" : \"✅ পরিশোধিত\";\r\n          const accentBorder = isVoided\r\n            ? \"border-l-4 border-l-danger/60\"\r\n            : \"border-l-4 border-l-success/60\";\r\n\r\n          return (\r\n            <div\r\n              key={s.id}\r\n              className={`rounded-2xl border bg-card shadow-sm transition card-lift overflow-hidden hover:shadow-md ${accentBorder} ${\r\n                isVoided ? \"opacity-90 border-danger/30\" : \"border-border\"\r\n              }`}\r\n            >\r\n              <div className=\"space-y-1.5 p-2.5 sm:p-3\">\r\n                <div className=\"flex flex-col gap-1.5 sm:flex-row sm:items-center sm:justify-between\">\r\n                  <div className=\"flex items-center gap-1.5\">\r\n                    <p className=\"text-lg font-bold text-foreground sm:text-xl\">\r\n                      ৳ {totalStr}\r\n                    </p>\r\n                    <span\r\n                      className={`inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-[11px] font-semibold border shadow-[0_1px_0_rgba(0,0,0,0.04)] ${statusPill}`}\r\n                    >\r\n                      {statusText}\r\n                    </span>\r\n                  </div>\r\n                  <div className=\"text-left text-[11px] text-muted-foreground sm:text-xs sm:text-right\">\r\n                    <p className=\"font-semibold flex items-center gap-1 justify-start sm:justify-end\">\r\n                      ⏱ {timeStr}\r\n                    </p>\r\n                    <p>{dateStr}</p>\r\n                  </div>\r\n                </div>\r\n\r\n                <p className=\"text-[12px] text-muted-foreground flex flex-wrap items-center gap-2 sm:text-sm\">\r\n                  <span className=\"inline-flex items-center gap-1 rounded-full bg-muted px-2 py-0.5 text-[11px] font-semibold text-foreground border border-border\">\r\n                    {paymentText}\r\n                  </span>\r\n                  {s.customerName && (\r\n                    <span className=\"text-xs text-muted-foreground\">\r\n                      👤 {s.customerName}\r\n                    </span>\r\n                  )}\r\n                </p>\r\n                <p className=\"text-[12px] text-muted-foreground flex items-center gap-1.5 leading-snug break-words line-clamp-1 sm:text-[13px] sm:line-clamp-2\">\r\n                  🧾 {itemLine}\r\n                </p>\r\n                {isVoided && voidReason && (\r\n                  <p className=\"text-xs text-danger\">\r\n                    বাতিলের কারণ: {voidReason}\r\n                  </p>\r\n                )}\r\n                {isDueSale && !isVoided && (\r\n                  <p className=\"text-xs text-warning\">\r\n                    বাকির বিক্রি – কাস্টমার লেজারে পরিশোধ করুন\r\n                  </p>\r\n                )}\r\n              </div>\r\n\r\n              <div className=\"flex flex-wrap items-center justify-between gap-2 border-t border-border/70 bg-muted/40 px-3 py-1.5 sm:px-4 sm:py-2\">\r\n                <div className=\"flex flex-wrap items-center gap-2\">\r\n                  {!online && (\r\n                    <span className=\"inline-flex items-center gap-1 rounded-full bg-warning-soft px-2 py-0.5 text-[11px] font-semibold text-warning border border-warning/30\">\r\n                      বাতিল করা যাবে না (Offline)\r\n                    </span>\r\n                  )}\r\n                  {!online && isPending && (\r\n                    <span className=\"inline-flex items-center gap-1 rounded-full bg-warning-soft px-2 py-0.5 text-[11px] font-semibold text-warning border border-warning/30\">\r\n                      Pending sync\r\n                    </span>\r\n                  )}\r\n                  {online && isDueSale && !isVoided && (\r\n                    <span className=\"inline-flex items-center gap-1 rounded-full bg-warning-soft px-3 py-1 text-xs font-semibold text-warning border border-warning/30\">\r\n                      বাকির বিল – বাতিল নয়\r\n                    </span>\r\n                  )}\r\n                </div>\r\n                {online && !isDueSale ? (\r\n                  <div className=\"flex flex-wrap items-center gap-2\">\r\n                    <form id={formId} action={voidSaleAction} />\r\n                    <VoidSaleControls\r\n                      saleId={s.id}\r\n                      isVoided={isVoided}\r\n                      formId={formId}\r\n                    />\r\n                  </div>\r\n                ) : null}\r\n              </div>\r\n            </div>\r\n          );\r\n        })\r\n      )}\r\n\r\n      {hasMore && (\r\n        <div className=\"flex justify-center pt-2\">\r\n          {online && nextHref ? (\r\n            <Link\r\n              href={nextHref}\r\n              className=\"inline-flex items-center gap-1.5 rounded-full bg-primary-soft text-primary border border-primary/30 px-4 py-2 text-sm font-semibold shadow-sm hover:bg-primary/15 hover:border-primary/40 transition\"\r\n            >\r\n              ⬇️ আরও দেখুন\r\n            </Link>\r\n          ) : (\r\n            <button\r\n              type=\"button\"\r\n              disabled\r\n              className=\"inline-flex items-center gap-1.5 rounded-full bg-muted px-4 py-2 text-sm font-semibold text-muted-foreground\"\r\n            >\r\n              ⬇️ আরও দেখুন\r\n            </button>\r\n          )}\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\sales\\components\\VoidSaleButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\sales\\components\\VoidSaleControls.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\pos\\pos-app-supabase\\app\\dashboard\\sales\\components\\VoidSaleControls.tsx:43:5\n  41 |\n  42 |   useEffect(() => {\n> 43 |     setMounted(true);\n     |     ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  44 |   }, []);\n  45 |\n  46 |   if (isVoided) {","line":43,"column":5,"nodeType":null,"endLine":43,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// app/dashboard/sales/components/VoidSaleControls.tsx\r\n\r\n\"use client\";\r\n\r\nimport { useEffect, useState } from \"react\";\r\nimport { useFormStatus } from \"react-dom\";\r\nimport { createPortal } from \"react-dom\";\r\n\r\ntype VoidSaleControlsProps = {\r\n  saleId: string;\r\n  isVoided: boolean;\r\n  formId: string;\r\n};\r\n\r\ntype SubmitButtonProps = {\r\n  formId: string;\r\n};\r\n\r\nfunction SubmitButton({ formId }: SubmitButtonProps) {\r\n  const { pending } = useFormStatus();\r\n\r\n  return (\r\n    <button\r\n      type=\"submit\"\r\n      form={formId}\r\n      disabled={pending}\r\n      className=\"inline-flex items-center justify-center rounded-full bg-destructive px-4 py-2 text-sm font-semibold text-primary-foreground shadow-sm hover:bg-destructive/90 disabled:opacity-60\"\r\n    >\r\n      {pending ? \"বাতিল হচ্ছে...\" : \"চূড়ান্ত বাতিল\"}\r\n    </button>\r\n  );\r\n}\r\n\r\nexport function VoidSaleControls({\r\n  saleId,\r\n  isVoided,\r\n  formId,\r\n}: VoidSaleControlsProps) {\r\n  const [open, setOpen] = useState(false);\r\n  const [mounted, setMounted] = useState(false);\r\n\r\n  useEffect(() => {\r\n    setMounted(true);\r\n  }, []);\r\n\r\n  if (isVoided) {\r\n    return (\r\n      <span className=\"inline-flex items-center gap-1 rounded-full bg-danger-soft px-3 py-1 text-xs font-semibold text-danger border border-danger/30\">\r\n        ❌ ইতিমধ্যেই বাতিল\r\n      </span>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <>\r\n      <button\r\n        type=\"button\"\r\n        onClick={() => setOpen(true)}\r\n        className=\"inline-flex items-center gap-1 rounded-full border border-danger/30 px-3 py-2 text-sm font-semibold text-danger bg-card hover:bg-danger-soft/60 transition\"\r\n      >\r\n        ❌ বাতিল করুন\r\n      </button>\r\n\r\n      {mounted &&\r\n        open &&\r\n        createPortal(\r\n          <div\r\n            className=\"fixed inset-0 z-[9999] flex items-end bg-foreground/30 backdrop-blur-[2px]\"\r\n            onClick={() => setOpen(false)}\r\n          >\r\n            <div\r\n              onClick={(e) => e.stopPropagation()}\r\n              className=\"w-full rounded-t-2xl bg-card shadow-2xl border-t border-border p-4 space-y-4\"\r\n            >\r\n              <input type=\"hidden\" name=\"saleId\" value={saleId} form={formId} />\r\n\r\n              <div className=\"flex items-start gap-3\">\r\n                <div className=\"flex h-9 w-9 items-center justify-center rounded-full bg-danger-soft text-danger border border-danger/30\">\r\n                  ⚠️\r\n                </div>\r\n                <div className=\"space-y-1\">\r\n                  <h3 className=\"text-base font-semibold text-foreground\">\r\n                    বিক্রি বাতিল করলে টাকা ফেরত যাবে\r\n                  </h3>\r\n                  <p className=\"text-sm text-muted-foreground\">\r\n                    নিশ্চিত হলে কারণ লিখে চূড়ান্ত বাতিল করুন।\r\n                  </p>\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"space-y-2\">\r\n                <input\r\n                  type=\"text\"\r\n                  name=\"reason\"\r\n                  form={formId}\r\n                  placeholder=\"কারণ (ঐচ্ছিক)\"\r\n                  className=\"w-full rounded-lg border border-border px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-danger/30\"\r\n                />\r\n                <p className=\"text-xs text-muted-foreground\">\r\n                  এই ধাপ দুর্ঘটনাবশত Void হওয়া ঠেকাতে যুক্ত করা হয়েছে।\r\n                </p>\r\n              </div>\r\n\r\n              <div className=\"flex items-center justify-end gap-2\">\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => setOpen(false)}\r\n                  className=\"rounded-full border border-border px-4 py-2 text-sm font-semibold text-foreground hover:bg-muted\"\r\n                >\r\n                  ফিরে যান\r\n                </button>\r\n                <SubmitButton formId={formId} />\r\n              </div>\r\n            </div>\r\n          </div>,\r\n          document.body\r\n        )}\r\n    </>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\sales\\components\\pos-cart-item.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\sales\\components\\pos-product-search.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\sales\\new\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\sales\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\shops\\ShopFormClient.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\pos\\pos-app-supabase\\app\\dashboard\\shops\\ShopFormClient.tsx:129:9\n  127 |     if (stored) {\n  128 |       try {\n> 129 |         setTemplates(JSON.parse(stored) as ShopTemplate[]);\n      |         ^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  130 |       } catch {\n  131 |         setTemplates([]);\n  132 |       }","line":129,"column":9,"nodeType":null,"endLine":129,"endColumn":21},{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\pos\\pos-app-supabase\\app\\dashboard\\shops\\ShopFormClient.tsx:141:5\n  139 |         ? (window as any).SpeechRecognition || (window as any).webkitSpeechRecognition\n  140 |         : null;\n> 141 |     setVoiceReady(Boolean(SpeechRecognitionImpl));\n      |     ^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  142 |     return () => {\n  143 |       recognitionRef.current?.stop?.();\n  144 |     };","line":141,"column":5,"nodeType":null,"endLine":141,"endColumn":18},{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\pos\\pos-app-supabase\\app\\dashboard\\shops\\ShopFormClient.tsx:150:7\n  148 |     if (!ownerOptions) return;\n  149 |     if (ownerOptions.length === 0) {\n> 150 |       setSelectedOwnerId(\"\");\n      |       ^^^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  151 |       return;\n  152 |     }\n  153 |     setSelectedOwnerId((prev) => prev || ownerOptions[0]?.id || \"\");","line":150,"column":7,"nodeType":null,"endLine":150,"endColumn":25}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// app/dashboard/shops/ShopFormClient.tsx\r\n\"use client\";\r\n\r\nimport { useEffect, useMemo, useRef, useState } from \"react\";\r\nimport { businessOptions } from \"@/lib/productFormConfig\";\r\nimport Link from \"next/link\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { useOnlineStatus } from \"@/lib/sync/net-status\";\nimport { safeLocalStorageGet, safeLocalStorageSet } from \"@/lib/storage\";\nimport { queueAdminAction } from \"@/lib/sync/queue\";\r\nimport { db } from \"@/lib/dexie/db\";\r\nimport { handlePermissionError } from \"@/lib/permission-toast\";\r\n\r\ntype SpeechRecognitionInstance = {\r\n  lang: string;\r\n  interimResults: boolean;\r\n  continuous: boolean;\r\n  start: () => void;\r\n  stop: () => void;\r\n  abort?: () => void;\r\n  onresult: ((event: any) => void) | null;\r\n  onerror: ((event: any) => void) | null;\r\n  onend: (() => void) | null;\r\n};\r\n\r\ntype ShopTemplate = {\r\n  name: string;\r\n  address?: string;\r\n  phone?: string;\r\n  businessType: string;\r\n  count: number;\r\n  lastUsed: number;\r\n};\r\n\r\ntype VoiceField = \"name\" | \"address\" | \"phone\";\r\n\r\ntype Props = {\r\n  backHref: string;\r\n  action: (formData: FormData) => Promise<void>;\r\n  cacheUserId?: string | null;\r\n  shopId?: string | null;\r\n  initial?: {\r\n    name?: string;\r\n    address?: string;\r\n    phone?: string;\r\n    businessType?: string;\r\n  };\r\n  submitLabel?: string;\r\n  ownerOptions?: Array<{ id: string; name: string | null; email: string | null }>;\r\n  businessTypeOptions?: Array<{ id: string; label: string }>;\r\n};\r\n\r\nconst SHOP_TEMPLATE_KEY = \"shopTemplates:v1\";\r\n\r\nfunction mergeTemplates(existing: ShopTemplate[], incoming: ShopTemplate) {\r\n  const idx = existing.findIndex((t) => t.name.toLowerCase() === incoming.name.toLowerCase());\r\n  const next = [...existing];\r\n  if (idx >= 0) {\r\n    const current = next[idx];\r\n    next[idx] = {\r\n      ...current,\r\n      address: incoming.address || current.address,\r\n      phone: incoming.phone || current.phone,\r\n      businessType: incoming.businessType || current.businessType,\r\n      count: current.count + 1,\r\n      lastUsed: incoming.lastUsed,\r\n    };\r\n  } else {\r\n    next.unshift(incoming);\r\n  }\r\n  return next\r\n    .sort((a, b) => b.count - a.count || b.lastUsed - a.lastUsed)\r\n    .slice(0, 40);\r\n}\r\n\r\nfunction dedupe(values: string[]) {\r\n  return Array.from(new Set(values.filter(Boolean)));\r\n}\r\n\r\nfunction parsePhone(text: string) {\r\n  const digits = text.replace(/\\D/g, \"\");\r\n  return digits ? digits.slice(0, 15) : \"\";\r\n}\r\n\r\nfunction parseSpokenNameAndPhone(spoken: string) {\r\n  const phone = parsePhone(spoken);\r\n  const name = phone ? spoken.replace(new RegExp(phone, \"g\"), \"\").trim() : spoken.trim();\r\n  return { name, phone };\r\n}\r\n\r\nexport default function ShopFormClient({\r\n  backHref,\r\n  action,\r\n  cacheUserId,\r\n  shopId,\r\n  initial,\r\n  submitLabel = \"+ নতুন দোকান তৈরি করুন\",\r\n  ownerOptions,\r\n  businessTypeOptions,\r\n}: Props) {\r\n  const router = useRouter();\r\n  const online = useOnlineStatus();\r\n  const recognitionRef = useRef<SpeechRecognitionInstance | null>(null);\r\n  const [templates, setTemplates] = useState<ShopTemplate[]>([]);\r\n  const [voiceReady, setVoiceReady] = useState(false);\r\n  const [listeningField, setListeningField] = useState<VoiceField | null>(null);\r\n  const [voiceError, setVoiceError] = useState<string | null>(null);\r\n  const [submitError, setSubmitError] = useState<string | null>(null);\r\n\r\n  const [name, setName] = useState(initial?.name || \"\");\r\n  const [address, setAddress] = useState(initial?.address || \"\");\r\n  const [phone, setPhone] = useState(initial?.phone || \"\");\r\n  const availableBusinessTypes = businessTypeOptions?.length ? businessTypeOptions : businessOptions;\r\n  const [businessType, setBusinessType] = useState<string>(\r\n    initial?.businessType || availableBusinessTypes[0]?.id || \"tea_stall\"\r\n  );\r\n  const [selectedOwnerId, setSelectedOwnerId] = useState(\"\");\r\n  const hasOwnerOptions = Boolean(ownerOptions && ownerOptions.length > 0);\r\n  const cacheKey = useMemo(\r\n    () => `cachedShops:${cacheUserId || \"anon\"}`,\r\n    [cacheUserId]\r\n  );\r\n\r\n  useEffect(() => {\r\n    const stored =\n      typeof window !== \"undefined\" ? safeLocalStorageGet(SHOP_TEMPLATE_KEY) : null;\n    if (stored) {\r\n      try {\r\n        setTemplates(JSON.parse(stored) as ShopTemplate[]);\r\n      } catch {\r\n        setTemplates([]);\r\n      }\r\n    }\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    const SpeechRecognitionImpl =\r\n      typeof window !== \"undefined\"\r\n        ? (window as any).SpeechRecognition || (window as any).webkitSpeechRecognition\r\n        : null;\r\n    setVoiceReady(Boolean(SpeechRecognitionImpl));\r\n    return () => {\r\n      recognitionRef.current?.stop?.();\r\n    };\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    if (!ownerOptions) return;\r\n    if (ownerOptions.length === 0) {\r\n      setSelectedOwnerId(\"\");\r\n      return;\r\n    }\r\n    setSelectedOwnerId((prev) => prev || ownerOptions[0]?.id || \"\");\r\n  }, [ownerOptions]);\r\n\r\n  const frequentTemplates = useMemo(\r\n    () => templates.slice().sort((a, b) => b.count - a.count || b.lastUsed - a.lastUsed),\r\n    [templates]\r\n  );\r\n\r\n  const recentTemplates = useMemo(\r\n    () => templates.slice().sort((a, b) => b.lastUsed - a.lastUsed),\r\n    [templates]\r\n  );\r\n\r\n  const smartNameSuggestions = useMemo(() => {\r\n    const top = frequentTemplates.slice(0, 6).map((t) => t.name);\r\n    const latest = recentTemplates.slice(0, 6).map((t) => t.name);\r\n    return dedupe([...top, ...latest]).slice(0, 8);\r\n  }, [frequentTemplates, recentTemplates]);\r\n\r\n  const businessUsage = useMemo(() => {\r\n    const counts: Record<string, number> = {};\r\n    templates.forEach((t) => {\r\n      counts[t.businessType] = (counts[t.businessType] ?? 0) + t.count;\r\n    });\r\n    return counts;\r\n  }, [templates]);\r\n\r\n  const sortedBusinessOptions = useMemo(() => {\r\n    return availableBusinessTypes\r\n      .slice()\r\n      .sort((a, b) => (businessUsage[b.id] ?? 0) - (businessUsage[a.id] ?? 0));\r\n  }, [availableBusinessTypes, businessUsage]);\r\n\r\n  const voiceErrorText = voiceError ? `(${voiceError})` : \"\";\r\n  const isListeningName = listeningField === \"name\";\r\n  const isListeningAddress = listeningField === \"address\";\r\n  const isListeningPhone = listeningField === \"phone\";\r\n\r\n  const nameVoiceHint = isListeningName\r\n    ? \"শুনছি... দোকানের নাম বলুন\"\r\n    : voiceReady\r\n    ? \"ভয়েসে নাম বললে অটো পূরণ হবে\"\r\n    : \"এই ডিভাইসে ভয়েস সাপোর্ট নেই\";\r\n  const addressVoiceHint = isListeningAddress\r\n    ? \"শুনছি... ঠিকানা বলুন\"\r\n    : voiceReady\r\n    ? \"ভয়েসে ঠিকানা বলুন\"\r\n    : \"এই ডিভাইসে ভয়েস সাপোর্ট নেই\";\r\n  const phoneVoiceHint = isListeningPhone\r\n    ? \"শুনছি... ফোন নম্বর বলুন\"\r\n    : voiceReady\r\n    ? \"ভয়েসে নম্বর বলুন\"\r\n    : \"এই ডিভাইসে ভয়েস সাপোর্ট নেই\";\r\n\r\n  function persistTemplates(next: ShopTemplate[]) {\n    setTemplates(next);\n    safeLocalStorageSet(SHOP_TEMPLATE_KEY, JSON.stringify(next));\n  }\n\r\n  function updateCachedShops(\r\n    updater: (prev: Array<Record<string, any>>) => Array<Record<string, any>>\r\n  ) {\r\n    if (typeof window === \"undefined\") return;\n    try {\n      const raw = safeLocalStorageGet(cacheKey);\n      const parsed = raw ? JSON.parse(raw) : [];\n      const base = Array.isArray(parsed) ? parsed : [];\n      const next = updater(base);\n      safeLocalStorageSet(cacheKey, JSON.stringify(next));\n    } catch {\n      // ignore cache errors\n    }\n  }\n\r\n  async function updatePendingCreate(clientId: string, data: Record<string, any>) {\r\n    try {\r\n      const items = await db.queue.where(\"type\").equals(\"admin\").toArray();\r\n      const matches = items.filter(\r\n        (item) =>\r\n          item.payload?.action === \"shop_create\" &&\r\n          item.payload?.data?.clientId === clientId\r\n      );\r\n      await Promise.all(\r\n        matches.map((item) =>\r\n          item.id\r\n            ? db.queue.update(item.id, {\r\n                payload: {\r\n                  ...item.payload,\r\n                  data: { ...item.payload.data, ...data },\r\n                },\r\n              })\r\n            : Promise.resolve()\r\n        )\r\n      );\r\n    } catch (err) {\r\n      handlePermissionError(err);\r\n      console.error(\"Update pending shop create failed\", err);\r\n    }\r\n  }\r\n\r\n  function applyTemplate(t: ShopTemplate) {\r\n    setName(t.name);\r\n    setAddress(t.address || \"\");\r\n    setPhone(t.phone || \"\");\r\n    setBusinessType(t.businessType || \"tea_stall\");\r\n  }\r\n\r\n  function startVoice(field: \"name\" | \"address\" | \"phone\") {\r\n    if (listeningField === field) return;\r\n    if (listeningField) stopVoice();\r\n    const SpeechRecognitionImpl =\r\n      typeof window !== \"undefined\"\r\n        ? ((window as any).SpeechRecognition ||\r\n            (window as any).webkitSpeechRecognition)\r\n        : null;\r\n\r\n    if (!SpeechRecognitionImpl) {\r\n      setVoiceReady(false);\r\n      setVoiceError(\"ব্রাউজার মাইক্রোফোন সমর্থন দিচ্ছে না\");\r\n      return;\r\n    }\r\n\r\n    const recognition: SpeechRecognitionInstance = new SpeechRecognitionImpl();\r\n    recognition.lang = \"bn-BD\";\r\n    recognition.interimResults = false;\r\n    recognition.continuous = false;\r\n    recognition.onerror = () => {\r\n      setListeningField(null);\r\n      setVoiceError(\"মাইক্রোফোন অ্যাক্সেস পাওয়া যায়নি\");\r\n    };\r\n    recognition.onend = () => setListeningField(null);\r\n    recognition.onresult = (event: any) => {\r\n      const spoken: string | undefined = event?.results?.[0]?.[0]?.transcript;\r\n      if (spoken) {\r\n        if (field === \"name\") {\r\n          const parsed = parseSpokenNameAndPhone(spoken);\r\n          if (parsed.name) setName(parsed.name);\r\n          if (parsed.phone) setPhone(parsed.phone);\r\n        } else if (field === \"address\") {\r\n          setAddress(spoken);\r\n        } else if (field === \"phone\") {\r\n          const parsedPhone = parsePhone(spoken);\r\n          if (parsedPhone) setPhone(parsedPhone);\r\n        }\r\n      }\r\n      setListeningField(null);\r\n    };\r\n\r\n    recognitionRef.current = recognition;\r\n    setVoiceError(null);\r\n    setListeningField(field);\r\n    recognition.start();\r\n  }\r\n\r\n  function stopVoice() {\r\n    recognitionRef.current?.stop?.();\r\n    setListeningField(null);\r\n  }\r\n\r\n  async function handleSubmit(e: React.FormEvent<HTMLFormElement>) {\r\n    e.preventDefault();\r\n    const form = new FormData(e.currentTarget);\r\n    setSubmitError(null);\r\n\r\n    if (ownerOptions && !hasOwnerOptions) {\r\n      setSubmitError(\"কোনো owner পাওয়া যায়নি\");\r\n      return;\r\n    }\r\n\r\n    if (ownerOptions && !selectedOwnerId) {\r\n      setSubmitError(\"Owner নির্বাচন করতে হবে\");\r\n      return;\r\n    }\r\n\r\n    const payloadName = ((form.get(\"name\") as string) || name).trim();\r\n    const payloadAddress = ((form.get(\"address\") as string) || address).trim();\r\n    const payloadPhone = ((form.get(\"phone\") as string) || phone).trim();\r\n    const payloadBusinessType = (form.get(\"businessType\") as string) || businessType;\r\n\r\n    form.set(\"name\", payloadName);\r\n    form.set(\"address\", payloadAddress);\r\n    form.set(\"phone\", payloadPhone);\r\n    form.set(\"businessType\", payloadBusinessType);\r\n    if (ownerOptions) {\r\n      form.set(\"ownerId\", selectedOwnerId);\r\n    }\r\n\r\n    const template: ShopTemplate = {\r\n      name: payloadName,\r\n      address: payloadAddress,\r\n      phone: payloadPhone,\r\n      businessType: payloadBusinessType,\r\n      count: 1,\r\n      lastUsed: Date.now(),\r\n    };\r\n    persistTemplates(mergeTemplates(templates, template));\r\n\r\n    try {\r\n      if (!online) {\r\n        const payload = {\r\n          name: payloadName,\r\n          address: payloadAddress || null,\r\n          phone: payloadPhone || null,\r\n          businessType: payloadBusinessType,\r\n          ownerId: ownerOptions ? selectedOwnerId || null : null,\r\n        };\r\n\r\n        if (shopId) {\r\n          if (shopId.startsWith(\"offline-\")) {\r\n            await updatePendingCreate(shopId, payload);\r\n          } else {\r\n            await queueAdminAction(\"shop_update\", { id: shopId, ...payload });\r\n          }\r\n          updateCachedShops((prev) =>\r\n            prev.map((shop) =>\r\n              shop.id === shopId\r\n                ? { ...shop, ...payload, pending: true }\r\n                : shop\r\n            )\r\n          );\r\n          alert(\"অফলাইন: দোকানের পরিবর্তন কিউ হয়েছে, অনলাইনে গেলে সিঙ্ক হবে।\");\r\n          router.push(backHref);\r\n          return;\r\n        }\r\n\r\n        const clientId = `offline-${crypto.randomUUID()}`;\r\n        await queueAdminAction(\"shop_create\", { ...payload, clientId });\r\n        updateCachedShops((prev) => [\r\n          {\r\n            id: clientId,\r\n            name: payloadName,\r\n            address: payloadAddress,\r\n            phone: payloadPhone,\r\n            pending: true,\r\n          },\r\n          ...prev,\r\n        ]);\r\n        alert(\"অফলাইন: দোকান তৈরি কিউ হয়েছে, অনলাইনে গেলে সিঙ্ক হবে।\");\r\n        router.push(backHref);\r\n        return;\r\n      }\r\n\r\n      await action(form);\r\n      router.push(backHref);\r\n    } catch (err) {\r\n      handlePermissionError(err);\r\n      setSubmitError(\r\n        err instanceof Error ? err.message : \"Shop তৈরি করতে ব্যর্থ\"\r\n      );\r\n    }\r\n  }\r\n\r\n  return (\r\n    <form onSubmit={handleSubmit} className=\"rounded-2xl border border-border bg-card p-4 sm:p-6 space-y-4 shadow-sm\">\r\n      {ownerOptions ? (\r\n        <div className=\"space-y-2\">\r\n          <label className=\"block text-sm font-semibold text-foreground\">মালিক নির্বাচন করুন *</label>\r\n          <select\r\n            name=\"ownerId\"\r\n            value={selectedOwnerId}\r\n            onChange={(e) => setSelectedOwnerId(e.target.value)}\r\n            className=\"w-full h-11 rounded-xl border border-border bg-card px-4 text-base text-foreground shadow-sm focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary\"\r\n            required\r\n          >\r\n            {ownerOptions.length === 0 ? (\r\n              <option value=\"\">কোনো মালিক পাওয়া যায়নি</option>\r\n            ) : (\r\n              ownerOptions.map((owner) => (\r\n                <option key={owner.id} value={owner.id}>\r\n                  {owner.name || owner.email || \"Unknown owner\"}\r\n                </option>\r\n              ))\r\n            )}\r\n          </select>\r\n          <p className=\"text-sm text-muted-foreground\">এই দোকানটি কোন মালিকের অধীনে হবে তা নির্বাচন করুন</p>\r\n        </div>\r\n      ) : null}\r\n\r\n      {/* Shop Name */}\r\n      <div className=\"space-y-2\">\r\n        <label className=\"block text-sm font-semibold text-foreground\">দোকানের নাম *</label>\r\n        <div className=\"relative\">\r\n          <input\r\n            name=\"name\"\r\n            value={name}\r\n            onChange={(e) => setName(e.target.value)}\r\n            className=\"w-full h-12 rounded-xl border border-border bg-card px-4 pr-16 text-base text-foreground shadow-sm focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary\"\r\n            placeholder=\"যেমন: নিউ মদিনা স্টোর\"\r\n            required\r\n            autoComplete=\"off\"\r\n          />\r\n          <button\r\n            type=\"button\"\r\n            onClick={isListeningName ? stopVoice : () => startVoice(\"name\")}\r\n            disabled={!voiceReady}\r\n            aria-label={isListeningName ? \"ভয়েস বন্ধ করুন\" : \"ভয়েস ইনপুট চালু করুন\"}\r\n            className={`absolute right-2 top-1/2 -translate-y-1/2 inline-flex h-9 items-center justify-center rounded-lg border px-3 text-sm font-semibold transition ${\r\n              isListeningName\r\n                ? \"bg-primary-soft text-primary border-primary/40 animate-pulse\"\r\n                : \"bg-primary-soft text-primary border-primary/30 active:scale-95\"\r\n            } ${!voiceReady ? \"opacity-60 cursor-not-allowed\" : \"\"}`}\r\n          >\r\n            {isListeningName ? \"🔴\" : \"🎤\"}\r\n          </button>\r\n        </div>\r\n        <p className=\"text-xs text-muted-foreground\">\r\n          {nameVoiceHint}{\" \"}\r\n          {voiceErrorText ? <span className=\"text-danger\">{voiceErrorText}</span> : null}\r\n        </p>\r\n        {smartNameSuggestions.length > 0 && (\r\n          <div className=\"flex flex-wrap gap-2 pt-1\">\r\n            {smartNameSuggestions.map((title) => (\r\n              <button\r\n                key={title}\r\n                type=\"button\"\r\n                onClick={() => {\r\n                  const found = templates.find((t) => t.name === title);\r\n                  if (found) applyTemplate(found);\r\n                  else setName(title);\r\n                }}\r\n                className=\"h-9 px-3 rounded-full border border-primary/30 text-primary bg-primary-soft text-xs font-semibold hover:border-primary/50\"\r\n              >\r\n                {title}\r\n              </button>\r\n            ))}\r\n          </div>\r\n        )}\r\n        <p className=\"text-sm text-muted-foreground\">বলুন: “মদিনা স্টোর 017xxxxxxx” → নাম + ফোন</p>\r\n      </div>\r\n\r\n      {/* Address */}\r\n      <div className=\"space-y-2\">\r\n        <label className=\"block text-sm font-semibold text-foreground\">ঠিকানা (ঐচ্ছিক)</label>\r\n        <div className=\"relative\">\r\n          <input\r\n            name=\"address\"\r\n            value={address}\r\n            onChange={(e) => setAddress(e.target.value)}\r\n            className=\"w-full h-12 rounded-xl border border-border bg-card px-4 pr-16 text-base text-foreground shadow-sm focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary\"\r\n            placeholder=\"যেমন: ১২/বি প্রধান সড়ক, ঢাকা\"\r\n          />\r\n          <button\r\n            type=\"button\"\r\n            onClick={isListeningAddress ? stopVoice : () => startVoice(\"address\")}\r\n            disabled={!voiceReady}\r\n            aria-label={isListeningAddress ? \"ভয়েস বন্ধ করুন\" : \"ভয়েস ইনপুট চালু করুন\"}\r\n            className={`absolute right-2 top-1/2 -translate-y-1/2 inline-flex h-9 items-center justify-center rounded-lg border px-3 text-sm font-semibold transition ${\r\n              isListeningAddress\r\n                ? \"bg-primary-soft text-primary border-primary/40 animate-pulse\"\r\n                : \"bg-primary-soft text-primary border-primary/30 active:scale-95\"\r\n            } ${!voiceReady ? \"opacity-60 cursor-not-allowed\" : \"\"}`}\r\n          >\r\n            {isListeningAddress ? \"🔴\" : \"🎤\"}\r\n          </button>\r\n        </div>\r\n        <p className=\"text-xs text-muted-foreground\">\r\n          {addressVoiceHint}{\" \"}\r\n          {voiceErrorText ? <span className=\"text-danger\">{voiceErrorText}</span> : null}\r\n        </p>\r\n      </div>\r\n\r\n      {/* Phone */}\r\n      <div className=\"space-y-2\">\r\n        <label className=\"block text-sm font-semibold text-foreground\">মোবাইল নাম্বার (ঐচ্ছিক)</label>\r\n        <div className=\"relative\">\r\n          <input\r\n            name=\"phone\"\r\n            value={phone}\r\n            onChange={(e) => setPhone(parsePhone(e.target.value))}\r\n            className=\"w-full h-11 rounded-xl border border-border bg-card px-4 text-base text-foreground shadow-sm focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary\"\r\n            placeholder=\"যেমন: 01700000000\"\r\n          />\r\n          <button\r\n            type=\"button\"\r\n            onClick={isListeningPhone ? stopVoice : () => startVoice(\"phone\")}\r\n            disabled={!voiceReady}\r\n            aria-label={isListeningPhone ? \"ভয়েস বন্ধ করুন\" : \"ভয়েস ইনপুট চালু করুন\"}\r\n            className={`absolute right-2 top-1/2 -translate-y-1/2 inline-flex h-9 items-center justify-center rounded-lg border px-3 text-sm font-semibold transition ${\r\n              isListeningPhone\r\n                ? \"bg-primary-soft text-primary border-primary/40 animate-pulse\"\r\n                : \"bg-primary-soft text-primary border-primary/30 active:scale-95\"\r\n            } ${!voiceReady ? \"opacity-60 cursor-not-allowed\" : \"\"}`}\r\n          >\r\n            {isListeningPhone ? \"🔴\" : \"🎤\"}\r\n          </button>\r\n        </div>\r\n        <p className=\"text-xs text-muted-foreground\">\r\n          {phoneVoiceHint}{\" \"}\r\n          {voiceErrorText ? <span className=\"text-danger\">{voiceErrorText}</span> : null}\r\n        </p>\r\n        <p className=\"text-sm text-muted-foreground\">সংখ্যা বললে/পেস্ট করলে অটো ক্লিন হবে</p>\r\n      </div>\r\n\r\n      {/* Business Type */}\r\n      <div className=\"space-y-2\">\r\n        <label className=\"block text-sm font-semibold text-foreground\">ব্যবসার ধরন</label>\r\n        <div className=\"flex flex-wrap gap-2\">\r\n          {sortedBusinessOptions.slice(0, 6).map((b) => (\r\n            <button\r\n              key={b.id}\r\n              type=\"button\"\r\n              onClick={() => setBusinessType(b.id)}\r\n              className={`px-3 py-2 rounded-full border text-sm ${\r\n                businessType === b.id\r\n                  ? \"bg-primary-soft border-primary/50 text-primary\"\r\n                  : \"bg-card border-border text-foreground hover:border-primary/30\"\r\n              }`}\r\n            >\r\n              {b.label}\r\n            </button>\r\n          ))}\r\n        </div>\r\n        <select\r\n          name=\"businessType\"\r\n          value={businessType}\r\n          onChange={(e) => setBusinessType(e.target.value)}\r\n          className=\"w-full h-11 rounded-xl border border-border bg-card px-4 text-base text-foreground shadow-sm focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary\"\r\n          required\r\n        >\r\n          {availableBusinessTypes.map((b) => (\r\n            <option key={b.id} value={b.id}>\r\n              {b.label}\r\n            </option>\r\n          ))}\r\n        </select>\r\n        <p className=\"text-sm text-muted-foreground\">সর্বশেষ ব্যবহারকৃত টাইপগুলো উপরে দেখাচ্ছে</p>\r\n      </div>\r\n\r\n      {/* Recent Templates */}\r\n      {recentTemplates.length > 0 && (\r\n        <div className=\"rounded-2xl border border-primary/20 bg-primary-soft p-4 space-y-2 shadow-sm\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <h3 className=\"text-base font-semibold text-primary\">রিসেন্ট দোকান</h3>\r\n            <span className=\"text-xs text-primary\">এক ট্যাপে অটো-ফিল</span>\r\n          </div>\r\n          <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-2\">\r\n            {recentTemplates.slice(0, 4).map((t) => (\r\n              <button\r\n                key={`${t.name}-${t.lastUsed}`}\r\n                type=\"button\"\r\n                onClick={() => applyTemplate(t)}\r\n                className=\"flex items-center justify-between gap-3 bg-card border border-primary/20 rounded-xl px-3 py-2 text-left hover:border-primary/50 transition-colors\"\r\n              >\r\n                <div>\r\n                  <p className=\"font-semibold text-foreground\">{t.name}</p>\r\n                  <p className=\"text-xs text-muted-foreground\">\r\n                    {t.address || \"ঠিকানা নেই\"} • {t.phone || \"ফোন নেই\"}\r\n                  </p>\r\n                </div>\r\n                <span className=\"text-xs text-primary\">\r\n                  {availableBusinessTypes.find((b) => b.id === t.businessType)?.label || t.businessType}\r\n                </span>\r\n              </button>\r\n            ))}\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {submitError ? (\r\n        <div className=\"rounded-xl border border-danger/30 bg-danger-soft px-4 py-3 text-sm text-danger\">\r\n          {submitError}\r\n        </div>\r\n      ) : null}\r\n\r\n      {/* Buttons */}\r\n      <div className=\"flex gap-3 pt-4\">\r\n        <button\r\n          type=\"submit\"\r\n          className=\"flex-1 h-14 sm:h-12 rounded-xl bg-gradient-to-r from-primary to-primary-hover text-primary-foreground border border-primary/40 text-base font-semibold shadow-[0_12px_22px_rgba(22,163,74,0.28)] transition hover:brightness-105 active:scale-[0.99] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/40\"\r\n        >\r\n          {submitLabel}\r\n        </button>\r\n        <Link\r\n          href={backHref}\r\n          className=\"flex-1 h-14 sm:h-12 rounded-xl border border-border text-foreground text-base font-semibold hover:bg-muted transition text-center flex items-center justify-center\"\r\n        >\r\n          পিছনে যান\r\n        </Link>\r\n      </div>\r\n      <p className=\"text-xs text-muted-foreground text-right\">\r\n        মাইক্রোফোনে বলুন: “নিউ রহমান স্টোর 017…” → নাম + ফোন প্রস্তুত\r\n      </p>\r\n    </form>\r\n  );\r\n}\r\n\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\shops\\ShopsClient.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\shops\\[id]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\shops\\new\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\shops\\new\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\shops\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\suppliers\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\suppliers\\statement\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\suppliers\\statement\\statement-client.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\suppliers\\suppliers-client.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\users\\CreateUserDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\users\\DeleteUserDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\users\\EditUserDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\users\\UserManagementClient.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\users\\[userId]\\access\\AccessControlClient.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\pos\\pos-app-supabase\\app\\dashboard\\users\\[userId]\\access\\AccessControlClient.tsx:121:5\n  119 |\n  120 |   useEffect(() => {\n> 121 |     setEnabledIds(new Set(initialEnabled));\n      |     ^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  122 |     setSavedIds(new Set(initialEnabled));\n  123 |   }, [initialEnabled]);\n  124 |","line":121,"column":5,"nodeType":null,"endLine":121,"endColumn":18},{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\pos\\pos-app-supabase\\app\\dashboard\\users\\[userId]\\access\\AccessControlClient.tsx:188:7\n  186 |   useEffect(() => {\n  187 |     if (hasChanges) {\n> 188 |       setFeedback(null);\n      |       ^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  189 |     }\n  190 |   }, [hasChanges]);\n  191 |","line":188,"column":7,"nodeType":null,"endLine":188,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useMemo, useState, useTransition } from \"react\";\r\nimport Link from \"next/link\";\r\nimport { updateStaffPermissions } from \"@/app/actions/user-management\";\r\nimport { useOnlineStatus } from \"@/lib/sync/net-status\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { handlePermissionError } from \"@/lib/permission-toast\";\r\nimport {\r\n  moduleLabels,\r\n  permissionMeta,\r\n  type ModuleKey,\r\n  type PermissionMeta,\r\n} from \"@/app/dashboard/admin/rbac/RolesPermissionsPanel\";\r\n\r\ntype PermissionOption = {\r\n  id: string;\r\n  name: string;\r\n  description: string | null;\r\n  enabled: boolean;\r\n};\r\n\r\ntype StaffUserSummary = {\r\n  id: string;\r\n  name: string | null;\r\n  email: string | null;\r\n  roles: { id: string; name: string }[];\r\n  shopName: string | null;\r\n};\r\n\r\ntype GroupedPermission = PermissionOption & { meta: PermissionMeta };\r\n\r\ntype AccessControlClientProps = {\r\n  user: StaffUserSummary;\r\n  permissions: PermissionOption[];\r\n};\r\n\r\nconst presetDefinitions = [\r\n  {\r\n    key: \"pos-basic\",\r\n    label: \"POS বেসিক\",\r\n    description: \"বিক্রি + কাস্টমার + বকেয়া ম্যানেজ\",\r\n    permissionNames: [\n      \"view_dashboard_summary\",\n      \"view_products\",\n      \"view_purchases\",\n      \"create_purchase\",\n      \"view_suppliers\",\n      \"create_supplier\",\n      \"create_purchase_payment\",\n      \"view_sales\",\n      \"view_sale_details\",\n      \"create_sale\",\n      \"create_due_sale\",\r\n      \"take_due_payment_from_sale\",\r\n      \"view_customers\",\r\n      \"create_customer\",\r\n      \"view_due_summary\",\r\n      \"view_customer_due\",\r\n      \"take_due_payment\",\r\n      \"use_offline_pos\",\r\n      \"sync_offline_data\",\r\n    ],\r\n  },\r\n  {\r\n    key: \"pos-reports\",\r\n    label: \"POS + রিপোর্ট\",\r\n    description: \"বিক্রি + রিপোর্ট দেখার অনুমতি\",\r\n    permissionNames: [\n      \"view_dashboard_summary\",\n      \"view_products\",\n      \"view_purchases\",\n      \"create_purchase\",\n      \"view_suppliers\",\n      \"create_supplier\",\n      \"create_purchase_payment\",\n      \"view_sales\",\n      \"view_sale_details\",\r\n      \"create_sale\",\r\n      \"create_due_sale\",\r\n      \"take_due_payment_from_sale\",\r\n      \"view_customers\",\r\n      \"create_customer\",\r\n      \"view_due_summary\",\r\n      \"view_customer_due\",\r\n      \"take_due_payment\",\r\n      \"view_reports\",\r\n      \"view_sales_report\",\r\n      \"view_expense_report\",\r\n      \"view_cashbook_report\",\r\n      \"view_profit_report\",\r\n      \"view_payment_method_report\",\r\n      \"view_top_products_report\",\r\n      \"view_low_stock_report\",\r\n      \"export_reports\",\r\n      \"use_offline_pos\",\r\n      \"sync_offline_data\",\r\n    ],\r\n  },\r\n];\r\n\r\nexport default function AccessControlClient({\r\n  user,\r\n  permissions,\r\n}: AccessControlClientProps) {\r\n  const online = useOnlineStatus();\r\n  const readOnly = !online;\r\n  const [saving, startSaving] = useTransition();\r\n  const [feedback, setFeedback] = useState<{ type: \"error\" | \"success\"; message: string } | null>(\r\n    null,\r\n  );\r\n\r\n  const initialEnabled = useMemo(\r\n    () => new Set(permissions.filter((p) => p.enabled).map((p) => p.id)),\r\n    [permissions],\r\n  );\r\n  const [enabledIds, setEnabledIds] = useState<Set<string>>(initialEnabled);\r\n  const [savedIds, setSavedIds] = useState<Set<string>>(initialEnabled);\r\n\r\n  useEffect(() => {\r\n    setEnabledIds(new Set(initialEnabled));\r\n    setSavedIds(new Set(initialEnabled));\r\n  }, [initialEnabled]);\r\n\r\n  const permissionIdByName = useMemo(() => {\r\n    const map = new Map<string, string>();\r\n    permissions.forEach((p) => {\r\n      map.set(p.name, p.id);\r\n    });\r\n    return map;\r\n  }, [permissions]);\r\n\r\n  const groupedPermissions = useMemo(() => {\r\n    const modulesMap = new Map<\r\n      ModuleKey,\r\n      { key: ModuleKey; label: string; items: GroupedPermission[] }\r\n    >();\r\n\r\n    permissions.forEach((permission) => {\r\n      const meta =\r\n        permissionMeta[permission.name] ?? ({\r\n          label: permission.name,\r\n          module: \"other\",\r\n        } as PermissionMeta);\r\n\r\n      const key = meta.module;\r\n      const existing =\r\n        modulesMap.get(key) ??\r\n        ({\r\n          key,\r\n          label: moduleLabels[key] ?? moduleLabels.other,\r\n          items: [],\r\n        } as { key: ModuleKey; label: string; items: GroupedPermission[] });\r\n\r\n      existing.items.push({ ...permission, meta });\r\n      modulesMap.set(key, existing);\r\n    });\r\n\r\n    return Array.from(modulesMap.values())\r\n      .map((group) => ({\r\n        ...group,\r\n        items: group.items.sort((a, b) =>\r\n          a.meta.label.localeCompare(b.meta.label, \"bn\"),\r\n        ),\r\n      }))\r\n      .sort((a, b) => a.label.localeCompare(b.label, \"bn\"));\r\n  }, [permissions]);\r\n\r\n  const totalPermissions = permissions.length;\r\n  const enabledCount = enabledIds.size;\r\n  const disabledCount = totalPermissions - enabledCount;\r\n  const isDefault = disabledCount === 0;\r\n\r\n  const changedCount = useMemo(() => {\r\n    let count = 0;\r\n    permissions.forEach((permission) => {\r\n      const current = enabledIds.has(permission.id);\r\n      const saved = savedIds.has(permission.id);\r\n      if (current !== saved) count += 1;\r\n    });\r\n    return count;\r\n  }, [permissions, enabledIds, savedIds]);\r\n\r\n  const hasChanges = changedCount > 0;\r\n\r\n  useEffect(() => {\r\n    if (hasChanges) {\r\n      setFeedback(null);\r\n    }\r\n  }, [hasChanges]);\r\n\r\n  const updateEnabled = (updater: (next: Set<string>) => void) => {\r\n    setEnabledIds((prev) => {\r\n      const next = new Set(prev);\r\n      updater(next);\r\n      return next;\r\n    });\r\n  };\r\n\r\n  const togglePermission = (id: string) => {\r\n    updateEnabled((next) => {\r\n      if (next.has(id)) next.delete(id);\r\n      else next.add(id);\r\n    });\r\n  };\r\n\r\n  const setAll = (enabled: boolean) => {\r\n    if (enabled) {\r\n      setEnabledIds(new Set(permissions.map((p) => p.id)));\r\n    } else {\r\n      setEnabledIds(new Set());\r\n    }\r\n  };\r\n\r\n  const setGroup = (ids: string[], enabled: boolean) => {\r\n    updateEnabled((next) => {\r\n      ids.forEach((id) => {\r\n        if (enabled) next.add(id);\r\n        else next.delete(id);\r\n      });\r\n    });\r\n  };\r\n\r\n  const applyPreset = (permissionNames: string[]) => {\r\n    const resolved = permissionNames\r\n      .map((name) => permissionIdByName.get(name))\r\n      .filter((id): id is string => Boolean(id));\r\n    if (resolved.length === 0) {\r\n      return;\r\n    }\r\n    setEnabledIds(new Set(resolved));\r\n  };\r\n\r\n  const handleReset = () => {\r\n    setEnabledIds(new Set(savedIds));\r\n    setFeedback(null);\r\n  };\r\n\r\n  const handleSave = () => {\r\n    if (readOnly || saving) return;\r\n    setFeedback(null);\r\n    startSaving(async () => {\r\n      try {\r\n        await updateStaffPermissions(user.id, Array.from(enabledIds));\r\n        setSavedIds(new Set(enabledIds));\r\n        setFeedback({ type: \"success\", message: \"স্টাফ অ্যাকসেস সংরক্ষণ হয়েছে।\" });\r\n      } catch (err) {\r\n        handlePermissionError(err);\r\n        setFeedback({\r\n          type: \"error\",\r\n          message: err instanceof Error ? err.message : \"সংরক্ষণ ব্যর্থ হয়েছে।\",\r\n        });\r\n      }\r\n    });\r\n  };\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <div className=\"bg-card border border-border rounded-xl p-5 shadow-sm\">\r\n        <div className=\"flex flex-wrap items-center justify-between gap-3\">\r\n          <div>\r\n            <Link\r\n              href=\"/dashboard/users\"\r\n              className=\"text-xs font-semibold text-muted-foreground hover:text-foreground\"\r\n            >\r\n              ← ব্যবহারকারী তালিকায় ফিরুন\r\n            </Link>\r\n            <h1 className=\"text-2xl font-bold text-foreground mt-2\">\r\n              স্টাফ অ্যাকসেস কন্ট্রোল\r\n            </h1>\r\n            <p className=\"text-sm text-muted-foreground mt-1\">\r\n              স্টাফের কাজ অনুযায়ী অনুমতি সেট করুন। ডিফল্টে সব অনুমতি চালু থাকে।\r\n            </p>\r\n          </div>\r\n          <div className=\"flex items-center gap-2 text-xs\">\r\n            <span\r\n              className={cn(\r\n                \"rounded-full px-3 py-1 font-semibold\",\r\n                online\r\n                  ? \"bg-success-soft text-success\"\r\n                  : \"bg-danger-soft text-danger\",\r\n              )}\r\n            >\r\n              {online ? \"অনলাইন\" : \"অফলাইন\"}\r\n            </span>\r\n            <span className=\"rounded-full bg-muted px-3 py-1 font-semibold text-muted-foreground\">\r\n              মোট অনুমতি: {totalPermissions}\r\n            </span>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"mt-4 flex flex-wrap gap-2 text-xs\">\r\n          <span className=\"inline-flex items-center rounded-full bg-muted px-3 py-1 text-muted-foreground\">\r\n            নাম: {user.name ?? \"নাম নেই\"}\r\n          </span>\r\n          <span className=\"inline-flex items-center rounded-full bg-muted px-3 py-1 text-muted-foreground\">\r\n            ইমেইল: {user.email ?? \"ইমেইল নেই\"}\r\n          </span>\r\n          <span className=\"inline-flex items-center rounded-full bg-muted px-3 py-1 text-muted-foreground\">\r\n            দোকান: {user.shopName ?? \"অজানা\"}\r\n          </span>\r\n        </div>\r\n      </div>\r\n\r\n      {readOnly && (\r\n        <div className=\"rounded-lg border border-warning/30 bg-warning-soft text-warning text-xs font-semibold px-3 py-2\">\r\n          অফলাইন মোডে অ্যাকসেস পরিবর্তন করা যাবে না। অনলাইনে এসে আবার চেষ্টা করুন।\r\n        </div>\r\n      )}\r\n\r\n      <div className=\"bg-card border border-border rounded-xl p-5 shadow-sm space-y-4\">\r\n        <div className=\"flex flex-wrap items-center justify-between gap-3\">\r\n          <div>\r\n            <h2 className=\"text-base font-semibold text-foreground\">\r\n              ডিফল্ট বনাম কাস্টম\r\n            </h2>\r\n            <p className=\"text-xs text-muted-foreground mt-1\">\r\n              ডিফল্ট = স্টাফ রোলের সব অনুমতি চালু। কাস্টম করলে নির্দিষ্ট কিছু বন্ধ করতে পারবেন।\r\n            </p>\r\n          </div>\r\n          <div className=\"flex items-center gap-2 text-xs\">\r\n            <button\r\n              type=\"button\"\r\n              onClick={() => setAll(true)}\r\n              disabled={readOnly}\r\n              className={cn(\r\n                \"rounded-lg border px-3 py-1.5 font-semibold\",\r\n                isDefault\r\n                  ? \"border-success/40 bg-success-soft text-success\"\r\n                  : \"border-border text-muted-foreground hover:text-foreground hover:bg-muted\",\r\n                readOnly && \"opacity-60 cursor-not-allowed\",\r\n              )}\r\n            >\r\n              ডিফল্ট (সব চালু)\r\n            </button>\r\n            <button\r\n              type=\"button\"\r\n              onClick={handleReset}\r\n              disabled={readOnly || !hasChanges}\r\n              className={cn(\r\n                \"rounded-lg border border-border px-3 py-1.5 font-semibold text-muted-foreground hover:text-foreground hover:bg-muted\",\r\n                (readOnly || !hasChanges) && \"opacity-60 cursor-not-allowed\",\r\n              )}\r\n            >\r\n              আগের অবস্থায় ফিরুন\r\n            </button>\r\n          </div>\r\n        </div>\r\n\r\n        <div>\r\n          <div className=\"text-xs font-semibold text-muted-foreground mb-2\">\r\n            দ্রুত প্রিসেট\r\n          </div>\r\n          <div className=\"grid gap-3 md:grid-cols-3\">\r\n            {presetDefinitions.map((preset) => (\r\n              <button\r\n                key={preset.key}\r\n                type=\"button\"\r\n                disabled={readOnly}\r\n                onClick={() => applyPreset(preset.permissionNames)}\r\n                className={cn(\r\n                  \"rounded-xl border border-border bg-card p-3 text-left shadow-sm hover:bg-muted\",\r\n                  readOnly && \"opacity-60 cursor-not-allowed\",\r\n                )}\r\n              >\r\n                <div className=\"text-sm font-semibold text-foreground\">\r\n                  {preset.label}\r\n                </div>\r\n                <div className=\"text-xs text-muted-foreground mt-1\">\r\n                  {preset.description}\r\n                </div>\r\n              </button>\r\n            ))}\r\n            <button\r\n              type=\"button\"\r\n              disabled={readOnly}\r\n              onClick={() => setAll(true)}\r\n              className={cn(\r\n                \"rounded-xl border border-border bg-card p-3 text-left shadow-sm hover:bg-muted\",\r\n                readOnly && \"opacity-60 cursor-not-allowed\",\r\n              )}\r\n            >\r\n              <div className=\"text-sm font-semibold text-foreground\">\r\n                ফুল স্টাফ অ্যাকসেস\r\n              </div>\r\n              <div className=\"text-xs text-muted-foreground mt-1\">\r\n                স্টাফ রোলের সব অনুমতি চালু করুন\r\n              </div>\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"bg-card border border-border rounded-xl shadow-sm overflow-hidden\">\r\n        <div className=\"flex flex-wrap items-center justify-between gap-3 px-5 py-4 border-b border-border bg-muted/40\">\r\n          <div>\r\n            <h2 className=\"text-base font-semibold text-foreground\">\r\n              মডিউলভিত্তিক অনুমতি\r\n            </h2>\r\n            <p className=\"text-xs text-muted-foreground mt-1\">\r\n              চালু: {enabledCount} / {totalPermissions} · বন্ধ: {disabledCount}\r\n            </p>\r\n          </div>\r\n          <div className=\"flex items-center gap-2 text-xs\">\r\n            <span\r\n              className={cn(\r\n                \"rounded-full px-3 py-1 font-semibold\",\r\n                hasChanges\r\n                  ? \"bg-warning-soft text-warning\"\r\n                  : \"bg-muted text-muted-foreground\",\r\n              )}\r\n            >\r\n              পরিবর্তন: {changedCount}\r\n            </span>\r\n            <button\r\n              type=\"button\"\r\n              onClick={handleSave}\r\n              disabled={readOnly || !hasChanges}\r\n              className={cn(\r\n                \"rounded-lg bg-primary-soft text-primary border border-primary/30 px-4 py-1.5 font-semibold shadow-sm hover:bg-primary/15 hover:border-primary/40\",\r\n                (readOnly || !hasChanges) && \"opacity-60 cursor-not-allowed\",\r\n              )}\r\n            >\r\n              {saving ? \"সংরক্ষণ হচ্ছে...\" : \"সংরক্ষণ করুন\"}\r\n            </button>\r\n          </div>\r\n        </div>\r\n\r\n        {feedback ? (\r\n          <div\r\n            className={cn(\r\n              \"px-5 py-3 text-xs font-semibold border-b\",\r\n              feedback.type === \"success\"\r\n                ? \"bg-success-soft text-success border-success/20\"\r\n                : \"bg-danger-soft text-danger border-danger/20\",\r\n            )}\r\n          >\r\n            {feedback.message}\r\n          </div>\r\n        ) : null}\r\n\r\n        <div className=\"divide-y divide-border\">\r\n          {groupedPermissions.length === 0 ? (\r\n            <div className=\"p-5 text-sm text-muted-foreground\">\r\n              এই স্টাফের জন্য কোনো অনুমতি পাওয়া যায়নি।\r\n            </div>\r\n          ) : (\r\n            groupedPermissions.map((module) => {\r\n              const ids = module.items.map((item) => item.id);\r\n              const enabledInGroup = module.items.filter((item) =>\r\n                enabledIds.has(item.id),\r\n              ).length;\r\n              const allEnabled = enabledInGroup === module.items.length;\r\n              const noneEnabled = enabledInGroup === 0;\r\n\r\n              return (\r\n                <div key={module.key} className=\"px-5 py-4\">\r\n                  <div className=\"flex flex-wrap items-center justify-between gap-3\">\r\n                    <div>\r\n                      <div className=\"text-sm font-semibold text-foreground\">\r\n                        {module.label}\r\n                      </div>\r\n                      <div className=\"text-xs text-muted-foreground mt-1\">\r\n                        চালু: {enabledInGroup}/{module.items.length}\r\n                      </div>\r\n                    </div>\r\n                    <div className=\"flex items-center gap-2 text-xs\">\r\n                      <button\r\n                        type=\"button\"\r\n                        onClick={() => setGroup(ids, true)}\r\n                        disabled={readOnly || allEnabled}\r\n                        className={cn(\r\n                          \"rounded-md border border-border px-2.5 py-1 font-semibold text-muted-foreground hover:text-foreground hover:bg-muted\",\r\n                          (readOnly || allEnabled) && \"opacity-60 cursor-not-allowed\",\r\n                        )}\r\n                      >\r\n                        সব চালু\r\n                      </button>\r\n                      <button\r\n                        type=\"button\"\r\n                        onClick={() => setGroup(ids, false)}\r\n                        disabled={readOnly || noneEnabled}\r\n                        className={cn(\r\n                          \"rounded-md border border-border px-2.5 py-1 font-semibold text-muted-foreground hover:text-foreground hover:bg-muted\",\r\n                          (readOnly || noneEnabled) && \"opacity-60 cursor-not-allowed\",\r\n                        )}\r\n                      >\r\n                        সব বন্ধ\r\n                      </button>\r\n                    </div>\r\n                  </div>\r\n\r\n                  <div className=\"mt-3 grid grid-cols-1 gap-2\">\r\n                    {module.items.map((permission) => {\r\n                      const checked = enabledIds.has(permission.id);\r\n                      return (\r\n                        <label\r\n                          key={permission.id}\r\n                          className={cn(\r\n                            \"flex items-start gap-3 rounded-lg border border-border bg-card px-3 py-2 text-xs sm:text-sm shadow-sm\",\r\n                            !readOnly && \"cursor-pointer hover:bg-muted\",\r\n                            readOnly && \"opacity-80\",\r\n                          )}\r\n                        >\r\n                          <input\r\n                            type=\"checkbox\"\r\n                            className=\"mt-0.5 h-4 w-4 rounded border-border text-primary focus:ring-primary/30\"\r\n                            checked={checked}\r\n                            onChange={() => togglePermission(permission.id)}\r\n                            disabled={readOnly}\r\n                          />\r\n                          <div className=\"flex-1\">\r\n                            <div className=\"flex flex-wrap items-center gap-2\">\r\n                              <span className=\"text-sm font-semibold text-foreground\">\r\n                                {permission.meta.label}\r\n                              </span>\r\n                              {permission.meta.critical ? (\r\n                                <span className=\"text-[10px] font-semibold text-warning bg-warning-soft border border-warning/30 rounded-full px-2 py-0.5\">\r\n                                  Critical\r\n                                </span>\r\n                              ) : null}\r\n                              <span className=\"text-[11px] font-mono text-muted-foreground\">\r\n                                {permission.name}\r\n                              </span>\r\n                            </div>\r\n                            {permission.description ?? permission.meta.description ? (\r\n                              <div className=\"text-[11px] text-muted-foreground mt-1\">\r\n                                {permission.description ?? permission.meta.description}\r\n                              </div>\r\n                            ) : null}\r\n                          </div>\r\n                        </label>\r\n                      );\r\n                    })}\r\n                  </div>\r\n                </div>\r\n              );\r\n            })\r\n          )}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\users\\[userId]\\access\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\users\\[userId]\\access\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\dashboard\\users\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\manifest.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\offline\\conflicts\\ConflictsClient.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\offline\\conflicts\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\offline\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\owner\\dashboard\\OwnerDashboardClient.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\owner\\dashboard\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\owner\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\service-worker.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\service-worker\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\staff\\dashboard\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\staff\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\super-admin\\dashboard\\SuperAdminDashboardClient.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\super-admin\\dashboard\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\super-admin\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\super-admin\\system-settings\\SystemSettingsClient.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\pos\\pos-app-supabase\\app\\super-admin\\system-settings\\SystemSettingsClient.tsx:43:7\n  41 |   useEffect(() => {\n  42 |     if (online) {\n> 43 |       setSupport(initialSupport);\n     |       ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  44 |       setCacheMissing(false);\n  45 |       setQueued(false);\n  46 |       try {","line":43,"column":7,"nodeType":null,"endLine":43,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// app/super-admin/system-settings/SystemSettingsClient.tsx\r\n\r\n\"use client\";\r\n\r\nimport { type FormEvent, useEffect, useMemo, useRef, useState } from \"react\";\nimport { useRouter } from \"next/navigation\";\nimport { useOnlineStatus } from \"@/lib/sync/net-status\";\nimport { useSyncStatus } from \"@/lib/sync/sync-status\";\nimport { queueAdminAction } from \"@/lib/sync/queue\";\nimport { safeLocalStorageGet, safeLocalStorageSet } from \"@/lib/storage\";\n\r\ntype SupportContact = {\r\n  supportPhone?: string | null;\r\n  supportWhatsapp?: string | null;\r\n};\r\n\r\ntype Props = {\r\n  saved: boolean;\r\n  initialSupport: SupportContact;\r\n  onUpdate: (formData: FormData) => void | Promise<void>;\r\n};\r\n\r\nexport default function SystemSettingsClient({\r\n  saved,\r\n  initialSupport,\r\n  onUpdate,\r\n}: Props) {\r\n  const online = useOnlineStatus();\r\n  const router = useRouter();\r\n  const { pendingCount, syncing, lastSyncAt } = useSyncStatus();\r\n  const [support, setSupport] = useState<SupportContact>(initialSupport);\n  const [cacheMissing, setCacheMissing] = useState(false);\n  const [queued, setQueued] = useState(false);\n  const refreshInFlightRef = useRef(false);\n  const lastRefreshAtRef = useRef(0);\n  const REFRESH_MIN_INTERVAL_MS = 15_000;\n  const serverSnapshotRef = useRef({ support: initialSupport, saved });\n\r\n  const cacheKey = useMemo(() => \"super-admin:system-settings\", []);\r\n\r\n  useEffect(() => {\r\n    if (online) {\r\n      setSupport(initialSupport);\n      setCacheMissing(false);\n      setQueued(false);\n      try {\n        safeLocalStorageSet(cacheKey, JSON.stringify(initialSupport));\n      } catch {\n        // ignore cache errors\n      }\n      return;\n    }\n\n    try {\n      const raw = safeLocalStorageGet(cacheKey);\n      if (!raw) {\n        setCacheMissing(true);\n        return;\n      }\n      const parsed = JSON.parse(raw) as SupportContact;\r\n      setSupport(parsed || {});\r\n      setCacheMissing(false);\r\n    } catch {\r\n      setCacheMissing(true);\r\n    }\r\n  }, [online, initialSupport, cacheKey]);\r\n\r\n  useEffect(() => {\r\n    if (\r\n      serverSnapshotRef.current.support !== initialSupport ||\r\n      serverSnapshotRef.current.saved !== saved\r\n    ) {\r\n      serverSnapshotRef.current = { support: initialSupport, saved };\r\n      refreshInFlightRef.current = false;\r\n    }\r\n  }, [initialSupport, saved]);\r\n\r\n  useEffect(() => {\n    if (!online || !lastSyncAt || syncing || pendingCount > 0) return;\n    if (refreshInFlightRef.current) return;\n    const now = Date.now();\n    if (now - lastRefreshAtRef.current < REFRESH_MIN_INTERVAL_MS) return;\n    lastRefreshAtRef.current = now;\n    refreshInFlightRef.current = true;\n    router.refresh();\n  }, [online, lastSyncAt, syncing, pendingCount, router]);\n\r\n  const handleSubmit = async (event: FormEvent<HTMLFormElement>) => {\r\n    if (online) return;\r\n    event.preventDefault();\r\n    const formData = new FormData(event.currentTarget);\r\n    const supportPhone =\r\n      (formData.get(\"supportPhone\") as string | null)?.trim() || null;\r\n    const supportWhatsapp =\r\n      (formData.get(\"supportWhatsapp\") as string | null)?.trim() || null;\r\n\r\n    const payload = { supportPhone, supportWhatsapp };\n    setSupport(payload);\n    try {\n      safeLocalStorageSet(cacheKey, JSON.stringify(payload));\n    } catch {\n      // ignore cache errors\n    }\n    await queueAdminAction(\"system_settings_update_support\", payload);\r\n    setQueued(true);\r\n    alert(\"Offline: system settings update queued.\");\r\n  };\r\n\r\n  return (\r\n    <div className=\"space-y-6 section-gap\">\r\n      {!online && (\r\n        <div className=\"rounded-lg border border-warning/30 bg-warning-soft px-3 py-2 text-xs font-semibold text-warning\">\r\n          Offline: showing cached system settings data.\r\n        </div>\r\n      )}\r\n      {!online && cacheMissing && (\r\n        <div className=\"rounded-lg border border-border bg-card px-3 py-2 text-xs text-muted-foreground\">\r\n          Offline: cached system settings data not available.\r\n        </div>\r\n      )}\r\n      <div className=\"bg-card border border-border rounded-xl p-5 shadow-sm\">\r\n        <h1 className=\"text-2xl font-bold text-foreground\">\r\n          System Settings - Support Contact\r\n        </h1>\r\n        <p className=\"text-sm text-muted-foreground mt-1\">\r\n          Update support phone and WhatsApp contact details for shops.\r\n        </p>\r\n        {saved ? (\r\n          <div\r\n            className=\"mt-3 inline-flex items-center gap-2 px-3 py-2 rounded-md bg-success-soft border border-success/30 text-sm text-success\"\r\n            role=\"status\"\r\n            aria-live=\"polite\"\r\n          >\r\n            Settings updated successfully.\r\n          </div>\r\n        ) : null}\r\n        {queued ? (\r\n          <div\r\n            className=\"mt-3 inline-flex items-center gap-2 px-3 py-2 rounded-md bg-warning-soft border border-warning/30 text-sm text-warning\"\r\n            role=\"status\"\r\n            aria-live=\"polite\"\r\n          >\r\n            Offline update queued for sync.\r\n          </div>\r\n        ) : null}\r\n      </div>\r\n\r\n      <div className=\"bg-card border border-border rounded-xl p-6 shadow-sm\">\r\n        <form action={onUpdate} onSubmit={handleSubmit} className=\"space-y-4 max-w-xl\">\r\n          <div className=\"space-y-2\">\r\n            <label htmlFor=\"supportPhone\" className=\"text-sm font-medium text-foreground\">\r\n              Support phone\r\n            </label>\r\n            <input\r\n              id=\"supportPhone\"\r\n              name=\"supportPhone\"\r\n              type=\"text\"\r\n              value={support.supportPhone ?? \"\"}\r\n              onChange={(event) =>\r\n                setSupport((prev) => ({ ...prev, supportPhone: event.target.value }))\r\n              }\r\n              placeholder=\"01700-XXXXXX\"\r\n              className=\"w-full border border-border rounded-lg px-4 py-2.5 text-sm bg-card text-foreground focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n            />\r\n          </div>\r\n\r\n          <div className=\"space-y-2\">\r\n            <label htmlFor=\"supportWhatsapp\" className=\"text-sm font-medium text-foreground\">\r\n              WhatsApp number\r\n            </label>\r\n            <input\r\n              id=\"supportWhatsapp\"\r\n              name=\"supportWhatsapp\"\r\n              type=\"text\"\r\n              value={support.supportWhatsapp ?? \"\"}\r\n              onChange={(event) =>\r\n                setSupport((prev) => ({\r\n                  ...prev,\r\n                  supportWhatsapp: event.target.value,\r\n                }))\r\n              }\r\n              placeholder=\"01700-YYYYYY\"\r\n              className=\"w-full border border-border rounded-lg px-4 py-2.5 text-sm bg-card text-foreground focus:outline-none focus:ring-2 focus:ring-primary/30\"\r\n            />\r\n          </div>\r\n\r\n          <p className=\"text-xs text-muted-foreground\">\r\n            Changes apply to support contact shown on the shop pages.\r\n          </p>\r\n\r\n          <button\r\n            type=\"submit\"\r\n            className=\"inline-flex items-center justify-center gap-2 px-5 py-2.5 bg-primary-soft text-primary border border-primary/30 rounded-lg text-sm font-semibold hover:bg-primary/15 hover:border-primary/40 transition-colors\"\r\n          >\r\n            Save\r\n          </button>\r\n        </form>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\app\\super-admin\\system-settings\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\components\\LogoutButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\components\\admin-hierarchy-drilldown-client.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\components\\agent-hierarchy-drilldown-client.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\components\\confirm-dialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\components\\css-health-guard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\components\\metric-card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\components\\offline-capability-guard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\components\\offline-conflict-banner.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\components\\offline-session-guard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\components\\owner-staff-drilldown-client.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\pos\\pos-app-supabase\\components\\owner-staff-drilldown-client.tsx:139:5\n  137 |\n  138 |   useEffect(() => {\n> 139 |     setOpenOwners({});\n      |     ^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  140 |   }, [activeQuery, activeFromDate, activeToDate]);\n  141 |\n  142 |   if (owners.length === 0) {","line":139,"column":5,"nodeType":null,"endLine":139,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { Fragment, useEffect, useMemo, useState } from \"react\";\r\n\r\ntype StaffEntry = {\r\n  id: string;\r\n  name: string | null;\r\n  email: string | null;\r\n  createdAt: string;\r\n  shopName: string | null;\r\n};\r\n\r\ntype OwnerEntry = {\r\n  id: string;\r\n  name: string | null;\r\n  email: string | null;\r\n  createdAt: string;\r\n  shopCount: number;\r\n  staff: StaffEntry[];\r\n};\r\n\r\ntype OwnerWithFilteredStaff = OwnerEntry & {\r\n  filteredStaff: StaffEntry[];\r\n};\r\n\r\ntype DrilldownFilters = {\r\n  query: string;\r\n  fromDate: string;\r\n  toDate: string;\r\n};\r\n\r\ntype OwnerStaffDrilldownProps = {\r\n  owners: OwnerEntry[];\r\n  emptyMessage?: string;\r\n  filters?: DrilldownFilters;\r\n  showFilters?: boolean;\r\n};\r\n\r\nconst formatCount = (value: number) => new Intl.NumberFormat(\"en-US\").format(value);\r\nconst formatDate = (value: string) => {\r\n  const date = new Date(value);\r\n  if (Number.isNaN(date.getTime())) return \"-\";\r\n  return new Intl.DateTimeFormat(\"en-US\", { dateStyle: \"medium\" }).format(date);\r\n};\r\n\r\nconst toStartOfDay = (value: string) => new Date(`${value}T00:00:00`);\r\nconst toEndOfDay = (value: string) => new Date(`${value}T23:59:59.999`);\r\n\r\nexport default function OwnerStaffDrilldownClient({\r\n  owners,\r\n  emptyMessage = \"No owners found.\",\r\n  filters,\r\n  showFilters,\r\n}: OwnerStaffDrilldownProps) {\r\n  const [query, setQuery] = useState(\"\");\r\n  const [fromDate, setFromDate] = useState(\"\");\r\n  const [toDate, setToDate] = useState(\"\");\r\n  const [openOwners, setOpenOwners] = useState<Record<string, boolean>>({});\r\n\r\n  const isControlled = Boolean(filters);\r\n  const activeQuery = isControlled ? filters?.query ?? \"\" : query;\r\n  const activeFromDate = isControlled ? filters?.fromDate ?? \"\" : fromDate;\r\n  const activeToDate = isControlled ? filters?.toDate ?? \"\" : toDate;\r\n  const shouldShowFilters = showFilters ?? !isControlled;\r\n\r\n  const hasFilters =\r\n    activeQuery.trim().length > 0 ||\r\n    Boolean(activeFromDate) ||\r\n    Boolean(activeToDate);\r\n\r\n  const filteredOwners = useMemo(() => {\r\n    if (owners.length === 0) return [];\r\n    const normalizedQuery = activeQuery.trim().toLowerCase();\r\n    const hasQuery = normalizedQuery.length > 0;\r\n    const from = activeFromDate ? toStartOfDay(activeFromDate) : null;\r\n    const to = activeToDate ? toEndOfDay(activeToDate) : null;\r\n\r\n    const matchesDate = (value: string) => {\r\n      if (!from && !to) return true;\r\n      const createdTime = new Date(value).getTime();\r\n      if (Number.isNaN(createdTime)) return false;\r\n      if (from && createdTime < from.getTime()) return false;\r\n      if (to && createdTime > to.getTime()) return false;\r\n      return true;\r\n    };\r\n\r\n    return owners.reduce<OwnerWithFilteredStaff[]>((acc, owner) => {\r\n      const ownerText = `${owner.name ?? \"\"} ${owner.email ?? \"\"}`\r\n        .trim()\r\n        .toLowerCase();\r\n      const ownerMatches =\r\n        matchesDate(owner.createdAt) &&\r\n        (!hasQuery || ownerText.includes(normalizedQuery));\r\n\r\n      const filteredStaff = owner.staff.filter((staff) => {\r\n        if (!matchesDate(staff.createdAt)) return false;\r\n        if (!hasQuery) return true;\r\n        if (ownerMatches) return true;\r\n\r\n        const staffText = `${staff.name ?? \"\"} ${staff.email ?? \"\"}`\r\n          .trim()\r\n          .toLowerCase();\r\n        return staffText.includes(normalizedQuery);\r\n      });\r\n\r\n      const includeOwner =\r\n        !hasFilters || ownerMatches || filteredStaff.length > 0;\r\n      if (!includeOwner) return acc;\r\n\r\n      acc.push({\r\n        ...owner,\r\n        filteredStaff: hasFilters ? filteredStaff : owner.staff,\r\n      });\r\n      return acc;\r\n    }, []);\r\n  }, [owners, activeQuery, activeFromDate, activeToDate, hasFilters]);\r\n\r\n  const totalStaff = useMemo(\r\n    () =>\r\n      filteredOwners.reduce(\r\n        (sum, owner) => sum + owner.filteredStaff.length,\r\n        0,\r\n      ),\r\n    [filteredOwners],\r\n  );\r\n\r\n  const toggleOwner = (ownerId: string) => {\r\n    setOpenOwners((prev) => ({ ...prev, [ownerId]: !prev[ownerId] }));\r\n  };\r\n\r\n  const clearFilters = () => {\r\n    if (isControlled) return;\r\n    setQuery(\"\");\r\n    setFromDate(\"\");\r\n    setToDate(\"\");\r\n  };\r\n\r\n  useEffect(() => {\r\n    setOpenOwners({});\r\n  }, [activeQuery, activeFromDate, activeToDate]);\r\n\r\n  if (owners.length === 0) {\r\n    return (\r\n      <div className=\"rounded-lg border border-dashed border-border bg-muted/30 px-4 py-4 text-center text-sm text-muted-foreground\">\r\n        {emptyMessage}\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-3\">\r\n      {shouldShowFilters ? (\r\n        <div className=\"flex flex-wrap items-end gap-3\">\r\n          <label className=\"flex flex-col text-xs font-semibold text-muted-foreground\">\r\n            Search\r\n            <input\r\n              type=\"search\"\r\n              className=\"mt-1 h-9 w-56 rounded-md border border-input bg-background px-3 text-sm shadow-sm\"\r\n              placeholder=\"Search owner or staff\"\r\n              value={activeQuery}\r\n              onChange={(event) => {\r\n                if (isControlled) return;\r\n                setQuery(event.target.value);\r\n              }}\r\n            />\r\n          </label>\r\n          <label className=\"flex flex-col text-xs font-semibold text-muted-foreground\">\r\n            From\r\n            <input\r\n              type=\"date\"\r\n              className=\"mt-1 h-9 rounded-md border border-input bg-background px-3 text-sm shadow-sm\"\r\n              value={activeFromDate}\r\n              onChange={(event) => {\r\n                if (isControlled) return;\r\n                setFromDate(event.target.value);\r\n              }}\r\n            />\r\n          </label>\r\n          <label className=\"flex flex-col text-xs font-semibold text-muted-foreground\">\r\n            To\r\n            <input\r\n              type=\"date\"\r\n              className=\"mt-1 h-9 rounded-md border border-input bg-background px-3 text-sm shadow-sm\"\r\n              value={activeToDate}\r\n              onChange={(event) => {\r\n                if (isControlled) return;\r\n                setToDate(event.target.value);\r\n              }}\r\n            />\r\n          </label>\r\n          {!isControlled && hasFilters ? (\r\n            <button\r\n              type=\"button\"\r\n              onClick={clearFilters}\r\n              className=\"h-9 rounded-md border border-border bg-muted px-3 text-xs font-semibold text-muted-foreground hover:bg-muted/70\"\r\n            >\r\n              Clear\r\n            </button>\r\n          ) : null}\r\n        </div>\r\n      ) : null}\r\n\r\n      <p className=\"text-xs text-muted-foreground\">\r\n        Showing {formatCount(totalStaff)} staff across{\" \"}\r\n        {formatCount(filteredOwners.length)} owners\r\n      </p>\r\n\r\n      {filteredOwners.length === 0 ? (\r\n        <div className=\"rounded-lg border border-dashed border-border bg-muted/30 px-4 py-4 text-center text-sm text-muted-foreground\">\r\n          No owners matched the current filters.\r\n        </div>\r\n      ) : (\r\n        <div className=\"overflow-x-auto\">\r\n          <table className=\"min-w-full divide-y divide-border text-sm\">\r\n            <thead className=\"bg-muted\">\r\n              <tr>\r\n                <th className=\"px-3 py-2 text-left text-xs font-semibold uppercase tracking-wide text-muted-foreground\">\r\n                  Owner\r\n                </th>\r\n                <th className=\"px-3 py-2 text-left text-xs font-semibold uppercase tracking-wide text-muted-foreground\">\r\n                  Shops\r\n                </th>\r\n                <th className=\"px-3 py-2 text-left text-xs font-semibold uppercase tracking-wide text-muted-foreground\">\r\n                  Staff\r\n                </th>\r\n                <th className=\"px-3 py-2 text-left text-xs font-semibold uppercase tracking-wide text-muted-foreground\">\r\n                  Created\r\n                </th>\r\n              </tr>\r\n            </thead>\r\n            <tbody className=\"divide-y divide-border bg-card\">\r\n              {filteredOwners.map((owner) => {\r\n                const isOpen = openOwners[owner.id] ?? false;\r\n                const staffCount = owner.filteredStaff.length;\r\n                const staffRowId = `staff-${owner.id}`;\r\n\r\n                return (\r\n                  <Fragment key={owner.id}>\r\n                    <tr className=\"hover:bg-muted/50\">\r\n                      <td className=\"px-3 py-2 text-foreground\">\r\n                        <div className=\"flex flex-col\">\r\n                          <span className=\"font-semibold\">\r\n                            {owner.name || \"Unnamed owner\"}\r\n                          </span>\r\n                          <span className=\"text-xs text-muted-foreground\">\r\n                            {owner.email || \"No email\"}\r\n                          </span>\r\n                        </div>\r\n                      </td>\r\n                      <td className=\"px-3 py-2 font-semibold text-foreground\">\r\n                        {formatCount(owner.shopCount ?? 0)}\r\n                      </td>\r\n                      <td className=\"px-3 py-2\">\r\n                        <button\r\n                          type=\"button\"\r\n                          aria-expanded={isOpen}\r\n                          aria-controls={staffRowId}\r\n                          onClick={() => toggleOwner(owner.id)}\r\n                          className=\"inline-flex items-center gap-2 text-sm font-semibold text-primary hover:text-primary-hover\"\r\n                        >\r\n                          {formatCount(staffCount)}\r\n                          <span className=\"text-[11px] font-semibold text-muted-foreground\">\r\n                            {isOpen ? \"Hide\" : \"View\"}\r\n                          </span>\r\n                        </button>\r\n                      </td>\r\n                      <td className=\"px-3 py-2 text-muted-foreground\">\r\n                        {formatDate(owner.createdAt)}\r\n                      </td>\r\n                    </tr>\r\n                    <tr\r\n                      id={staffRowId}\r\n                      className={isOpen ? \"bg-muted/20\" : \"hidden\"}\r\n                    >\r\n                      <td colSpan={4} className=\"px-3 pb-3\">\r\n                        {owner.filteredStaff.length === 0 ? (\r\n                          <div className=\"rounded-lg border border-dashed border-border bg-muted/30 px-3 py-3 text-xs text-muted-foreground\">\r\n                            No staff under this owner for the current filters.\r\n                          </div>\r\n                        ) : (\r\n                          <div className=\"overflow-x-auto\">\r\n                            <table className=\"min-w-full divide-y divide-border text-sm\">\r\n                              <thead className=\"bg-muted\">\r\n                                <tr>\r\n                                  <th className=\"px-3 py-2 text-left text-xs font-semibold uppercase tracking-wide text-muted-foreground\">\r\n                                    Staff\r\n                                  </th>\r\n                                  <th className=\"px-3 py-2 text-left text-xs font-semibold uppercase tracking-wide text-muted-foreground\">\r\n                                    Shop\r\n                                  </th>\r\n                                  <th className=\"px-3 py-2 text-left text-xs font-semibold uppercase tracking-wide text-muted-foreground\">\r\n                                    Created\r\n                                  </th>\r\n                                </tr>\r\n                              </thead>\r\n                              <tbody className=\"divide-y divide-border bg-card\">\r\n                                {owner.filteredStaff.map((staff) => (\r\n                                  <tr key={staff.id} className=\"hover:bg-muted/50\">\r\n                                    <td className=\"px-3 py-2 text-foreground\">\r\n                                      <div className=\"flex flex-col\">\r\n                                        <span className=\"font-semibold\">\r\n                                          {staff.name || \"Unnamed staff\"}\r\n                                        </span>\r\n                                        <span className=\"text-xs text-muted-foreground\">\r\n                                          {staff.email || \"No email\"}\r\n                                        </span>\r\n                                      </div>\r\n                                    </td>\r\n                                    <td className=\"px-3 py-2 text-muted-foreground\">\r\n                                      {staff.shopName || \"Unassigned\"}\r\n                                    </td>\r\n                                    <td className=\"px-3 py-2 text-muted-foreground\">\r\n                                      {formatDate(staff.createdAt)}\r\n                                    </td>\r\n                                  </tr>\r\n                                ))}\r\n                              </tbody>\r\n                            </table>\r\n                          </div>\r\n                        )}\r\n                      </td>\r\n                    </tr>\r\n                  </Fragment>\r\n                );\r\n              })}\r\n            </tbody>\r\n          </table>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\components\\providers\\QueryProvider.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\components\\pwa-install-prompt.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\pos\\pos-app-supabase\\components\\pwa-install-prompt.tsx:63:5\n  61 |     checkIfInstalled();\n  62 |\n> 63 |     setIsSuppressed(getSuppressionState());\n     |     ^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  64 |\n  65 |     // Listen for beforeinstallprompt event\n  66 |     const handleBeforeInstallPrompt = (e: Event) => {","line":63,"column":5,"nodeType":null,"endLine":63,"endColumn":20}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect, useRef } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { safeLocalStorageGet, safeLocalStorageSet } from \"@/lib/storage\";\n\r\ninterface BeforeInstallPromptEvent extends Event {\r\n  readonly platforms: string[];\r\n  readonly userChoice: Promise<{\r\n    outcome: \"accepted\" | \"dismissed\";\r\n    platform: string;\r\n  }>;\r\n  prompt(): Promise<void>;\r\n}\r\n\r\nexport default function PWAInstallPrompt() {\r\n  const [deferredPrompt, setDeferredPrompt] = useState<BeforeInstallPromptEvent | null>(null);\r\n  const [showInstallPrompt, setShowInstallPrompt] = useState(false);\r\n  const [isInstalled, setIsInstalled] = useState(false);\r\n  const [isEngaged, setIsEngaged] = useState(false);\r\n  const [isSuppressed, setIsSuppressed] = useState(false);\r\n  const showTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n  const engagementTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n  const interactionCountRef = useRef(0);\r\n  const engagementReachedRef = useRef(false);\r\n  const autoPromptedRef = useRef(false);\n\n  const getSuppressionState = () => {\n    const dismissed = safeLocalStorageGet(\"pwa-install-dismissed\");\n    if (dismissed) {\n      const dismissedTime = parseInt(dismissed, 10);\n      const weekInMs = 7 * 24 * 60 * 60 * 1000;\n      if (Date.now() - dismissedTime < weekInMs) return true;\n    }\n\n    const later = safeLocalStorageGet(\"pwa-install-later\");\n    if (later) {\n      const laterTime = parseInt(later, 10);\n      const dayInMs = 24 * 60 * 60 * 1000;\n      if (Date.now() - laterTime < dayInMs) return true;\n    }\n\r\n    return false;\r\n  };\r\n\r\n  useEffect(() => {\r\n    // Check if app is already installed\r\n    const checkIfInstalled = () => {\r\n      const isStandalone = window.matchMedia('(display-mode: standalone)').matches;\r\n      const isInWebAppiOS = (window.navigator as any).standalone === true;\r\n      setIsInstalled(isStandalone || isInWebAppiOS);\r\n    };\r\n\r\n    checkIfInstalled();\r\n\r\n    setIsSuppressed(getSuppressionState());\r\n\r\n    // Listen for beforeinstallprompt event\r\n    const handleBeforeInstallPrompt = (e: Event) => {\r\n      e.preventDefault();\r\n      const suppressed = getSuppressionState();\r\n      setIsSuppressed(suppressed);\r\n      setDeferredPrompt(e as BeforeInstallPromptEvent);\r\n    };\r\n\r\n    // Listen for app installed event\r\n    const handleAppInstalled = () => {\r\n      setIsInstalled(true);\r\n      setShowInstallPrompt(false);\r\n      setDeferredPrompt(null);\r\n    };\r\n\r\n    window.addEventListener('beforeinstallprompt', handleBeforeInstallPrompt);\r\n    window.addEventListener('appinstalled', handleAppInstalled);\r\n\r\n    return () => {\r\n      window.removeEventListener('beforeinstallprompt', handleBeforeInstallPrompt);\r\n      window.removeEventListener('appinstalled', handleAppInstalled);\r\n      if (showTimerRef.current) {\r\n        clearTimeout(showTimerRef.current);\r\n      }\r\n      if (engagementTimerRef.current) {\r\n        clearTimeout(engagementTimerRef.current);\r\n      }\r\n    };\r\n  }, [isInstalled]);\r\n\r\n  useEffect(() => {\r\n    if (isInstalled) return;\r\n\r\n    let cleaned = false;\r\n    const handleInteraction = () => {\r\n      if (engagementReachedRef.current) return;\r\n      interactionCountRef.current += 1;\r\n      if (interactionCountRef.current >= 3) {\r\n        markEngaged();\r\n      }\r\n    };\r\n\r\n    const cleanup = () => {\r\n      if (cleaned) return;\r\n      cleaned = true;\r\n      window.removeEventListener(\"pointerdown\", handleInteraction);\r\n      window.removeEventListener(\"keydown\", handleInteraction);\r\n      window.removeEventListener(\"scroll\", handleInteraction);\r\n      if (engagementTimerRef.current) {\r\n        clearTimeout(engagementTimerRef.current);\r\n      }\r\n    };\r\n\r\n    const markEngaged = () => {\r\n      if (engagementReachedRef.current) return;\r\n      engagementReachedRef.current = true;\r\n      setIsEngaged(true);\r\n      cleanup();\r\n    };\r\n\r\n    engagementTimerRef.current = setTimeout(markEngaged, 45_000);\r\n    window.addEventListener(\"pointerdown\", handleInteraction, { passive: true });\r\n    window.addEventListener(\"keydown\", handleInteraction);\r\n    window.addEventListener(\"scroll\", handleInteraction, { passive: true });\r\n\r\n    return cleanup;\r\n  }, [isInstalled]);\r\n\r\n  useEffect(() => {\r\n    if (!deferredPrompt || isInstalled || isSuppressed || !isEngaged) return;\r\n    if (autoPromptedRef.current) return;\r\n    autoPromptedRef.current = true;\r\n    if (showTimerRef.current) {\r\n      clearTimeout(showTimerRef.current);\r\n    }\r\n    showTimerRef.current = setTimeout(() => {\r\n      setShowInstallPrompt(true);\r\n    }, 800);\r\n  }, [deferredPrompt, isInstalled, isSuppressed, isEngaged]);\r\n\r\n  const handleInstallClick = async () => {\r\n    if (!deferredPrompt) return;\r\n\r\n    try {\r\n      await deferredPrompt.prompt();\r\n      const { outcome } = await deferredPrompt.userChoice;\r\n      \r\n      if (outcome === 'accepted') {\r\n        setIsInstalled(true);\r\n      }\r\n      \r\n      setDeferredPrompt(null);\r\n      setShowInstallPrompt(false);\r\n    } catch (error) {\r\n      console.error('Error during installation:', error);\r\n      setShowInstallPrompt(false);\r\n    }\r\n  };\r\n\r\n  const handleDismiss = () => {\n    setShowInstallPrompt(false);\n    // Don't show again for 7 days\n    safeLocalStorageSet(\"pwa-install-dismissed\", Date.now().toString());\n    setIsSuppressed(true);\n  };\n\n  const handleInstallLater = () => {\n    setShowInstallPrompt(false);\n    // Show again after 1 day\n    safeLocalStorageSet(\"pwa-install-later\", Date.now().toString());\n    setIsSuppressed(true);\n  };\n\r\n  const canInstall = Boolean(deferredPrompt) && !isInstalled;\r\n  const showCta = canInstall && isEngaged;\r\n\r\n  if (!canInstall) {\r\n    return null;\r\n  }\r\n\r\n  return (\r\n    <>\r\n      <Dialog open={showInstallPrompt} onOpenChange={setShowInstallPrompt}>\r\n      <DialogContent className=\"sm:max-w-md bg-card border-border shadow-2xl\">\n        <DialogHeader className=\"text-center\">\n          <DialogTitle className=\"text-2xl font-bold text-foreground\">\n            My POS অ্যাপ ইনস্টল করুন\n          </DialogTitle>\n          <DialogDescription className=\"text-base text-muted-foreground mt-2\">\n            দ্রুত অ্যাক্সেস, অফলাইন সাপোর্ট এবং ফুল স্ক্রিন অভিজ্ঞতার জন্য ডিভাইসে ইনস্টল করুন।\n          </DialogDescription>\n        </DialogHeader>\n          \r\n          <div className=\"flex flex-col items-center space-y-4 py-4\">\r\n          <div className=\"w-20 h-20 rounded-2xl border border-primary/20 bg-primary-soft text-primary flex items-center justify-center shadow-sm\">\n            <span className=\"text-2xl font-bold tracking-wide\">POS</span>\n          </div>\n            \r\n            <div className=\"text-center space-y-2\">\r\n              <p className=\"text-sm text-muted-foreground\">\n                - অফলাইন সাপোর্ট<br/>\n                - দ্রুত লোডিং<br/>\n                - ফুল স্ক্রিন মোড<br/>\n                - ব্রাউজার ট্যাব ছাড়াই ব্যবহার\n              </p>\n            </div>\n          </div>\n\n          <div className=\"flex flex-col sm:flex-row gap-3 mt-6\">\n            <Button \n              onClick={handleInstallClick}\n              className=\"flex-1 bg-primary text-primary-foreground hover:bg-primary-hover text-base py-3\"\n              size=\"lg\"\n            >\n              এখনই ইনস্টল\n            </Button>\n            \n            <Button \n              variant=\"outline\" \n              onClick={handleInstallLater}\n              className=\"flex-1 border-border text-foreground/80 hover:bg-muted text-base py-3\"\n              size=\"lg\"\n            >\n              পরে করব\n            </Button>\n            \n            <Button \n              variant=\"ghost\" \n              onClick={handleDismiss}\n              className=\"text-muted-foreground hover:text-foreground text-base py-3\"\n              size=\"lg\"\n            >\n              এখন নয়\n            </Button>\n          </div>\n        </DialogContent>\n      </Dialog>\n      {showCta && !showInstallPrompt ? (\n        <div className=\"fixed bottom-5 right-5 z-40\">\n          <Button\n            onClick={() => setShowInstallPrompt(true)}\n            variant=\"outline\"\n            className=\"w-auto border-border bg-card/95 text-foreground shadow-lg\"\n          >\n            অ্যাপ ইনস্টল\n          </Button>\n        </div>\n      ) : null}\r\n    </>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\components\\realtime\\RealtimeBridge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\components\\service-worker-register.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\components\\shop\\shop-switcher.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\components\\sonner-toaster.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\components\\sync-bootstrap.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\components\\sync-health-banner.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\components\\theme-script.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\components\\theme-toggle.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\pos\\pos-app-supabase\\components\\theme-toggle.tsx:31:5\n  29 |\n  30 |   useEffect(() => {\n> 31 |     setMounted(true);\n     |     ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  32 |     const stored = safeLocalStorageGet(STORAGE_KEY);\n  33 |     const initial = stored === \"light\" || stored === \"dark\" ? stored : \"light\";\n  34 |     setTheme(initial);","line":31,"column":5,"nodeType":null,"endLine":31,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// components/theme-toggle.tsx\r\n\r\n\"use client\";\r\n\r\nimport { useEffect, useMemo, useState } from \"react\";\r\nimport { Moon, Sun } from \"lucide-react\";\r\nimport { cn } from \"@/lib/utils\";\nimport { safeLocalStorageGet, safeLocalStorageSet } from \"@/lib/storage\";\n\r\ntype Theme = \"light\" | \"dark\";\r\n\r\nconst STORAGE_KEY = \"pos.theme\";\r\n\r\nconst applyTheme = (theme: Theme) => {\r\n  const root = document.documentElement;\r\n  root.classList.toggle(\"dark\", theme === \"dark\");\r\n  root.style.colorScheme = theme;\r\n};\r\n\r\nexport function ThemeToggle({\r\n  className,\r\n  iconClassName,\r\n}: {\r\n  className?: string;\r\n  iconClassName?: string;\r\n}) {\r\n  const [theme, setTheme] = useState<Theme | null>(null);\r\n  const [mounted, setMounted] = useState(false);\r\n\r\n  useEffect(() => {\n    setMounted(true);\n    const stored = safeLocalStorageGet(STORAGE_KEY);\n    const initial = stored === \"light\" || stored === \"dark\" ? stored : \"light\";\n    setTheme(initial);\n    applyTheme(initial);\n  }, []);\n\r\n  const isDark = useMemo(() => theme === \"dark\", [theme]);\r\n\r\n  if (!mounted || !theme) return null;\r\n\r\n  const handleToggle = () => {\n    const next = isDark ? \"light\" : \"dark\";\n    setTheme(next);\n    safeLocalStorageSet(STORAGE_KEY, next);\n    applyTheme(next);\n\r\n    const root = document.documentElement;\r\n    root.classList.add(\"theme-switch\");\r\n    window.setTimeout(() => root.classList.remove(\"theme-switch\"), 180);\r\n  };\r\n\r\n  return (\r\n    <button\r\n      type=\"button\"\r\n      onClick={handleToggle}\r\n      aria-label={isDark ? \"Switch to light mode\" : \"Switch to dark mode\"}\r\n      title={isDark ? \"Switch to light mode\" : \"Switch to dark mode\"}\r\n      className={cn(\r\n        \"inline-flex h-10 w-10 items-center justify-center rounded-full border border-border bg-card text-foreground shadow-sm hover:bg-muted focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background\",\r\n        className\r\n      )}\r\n    >\r\n      {isDark ? (\r\n        <Sun className={cn(\"h-4 w-4\", iconClassName)} />\r\n      ) : (\r\n        <Moon className={cn(\"h-4 w-4\", iconClassName)} />\r\n      )}\r\n    </button>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\components\\ui\\button.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\components\\ui\\card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\components\\ui\\dialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\components\\ui\\select.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\components\\ui\\skeleton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\components\\voice\\OwnerSummaryVoice.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\eslint.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\hooks\\use-cart.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\hooks\\use-current-shop.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\hooks\\use-products.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\hooks\\useProductFields.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\hooks\\useRealTimeReports.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\instrumentation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\accounting\\cogs-types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\accounting\\cogs.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\auth-client.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\auth-session.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\auth.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\billing-jobs.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\billing.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\cursor-pagination.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\date-range.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\dexie\\db.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\dhaka-date.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\due\\customer-events.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\events\\reportEvents.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\http\\api-errors.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\http\\etag.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\monitoring.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\offline\\cleanup.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\password.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\permission-toast.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\prisma.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\productFormConfig.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\products\\product-events.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\rate-limit.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\rbac.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\realtime\\errorHandling.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\realtime\\events.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\realtime\\performanceMonitoring.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\realtime\\publisher.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\realtime\\status.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\reporting-config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\reporting-range.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\reports\\cache-tags.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\reports\\cogs.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\reports\\revalidate.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\reports\\today-summary.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\schedule-idle.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\shop-access.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\staff-baseline-permissions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\stock-level.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\storage.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\sync\\conflict-status.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\sync\\net-status.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\sync\\pause.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\sync\\queue.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\sync\\sync-engine.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\sync\\sync-events.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\sync\\sync-status.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\system\\support-contact.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\tracing.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\use-page-visibility.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\user-hierarchy.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\utils\\csv.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\utils\\debounce.ts","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\pos\\pos-app-supabase\\lib\\utils\\debounce.ts:99:7\n   97 |     if (lastUpdatedRef.current === 0) {\n   98 |       lastUpdatedRef.current = Date.now();\n>  99 |       setThrottledValue(value);\n      |       ^^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  100 |       return;\n  101 |     }\n  102 |","line":99,"column":7,"nodeType":null,"endLine":99,"endColumn":24}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// lib/utils/debounce.ts\r\nimport { useState, useEffect, useRef, useCallback } from \"react\";\r\n\r\n/**\r\n * Debounce a function to prevent it from being called too frequently\r\n * @param func The function to debounce\r\n * @param wait The time to wait in milliseconds\r\n * @returns The debounced function\r\n */\r\nexport function debounce<T extends (...args: any[]) => any>(\r\n  func: T,\r\n  wait: number\r\n): (...args: Parameters<T>) => void {\r\n  let timeout: NodeJS.Timeout | null = null;\r\n\r\n  return function executedFunction(...args: Parameters<T>) {\r\n    const later = () => {\r\n      timeout = null;\r\n      func(...args);\r\n    };\r\n\r\n    if (timeout) clearTimeout(timeout);\r\n    timeout = setTimeout(later, wait);\r\n  };\r\n}\r\n\r\n/**\r\n * React hook for debounced values\r\n * Returns a debounced version of the input value\r\n * @param value The value to debounce\r\n * @param delay The delay in milliseconds\r\n * @returns The debounced value\r\n */\r\nexport function useDebouncedValue<T>(value: T, delay: number): T {\r\n  const [debouncedValue, setDebouncedValue] = useState<T>(value);\r\n\r\n  useEffect(() => {\r\n    const handler = setTimeout(() => {\r\n      setDebouncedValue(value);\r\n    }, delay);\r\n\r\n    return () => clearTimeout(handler);\r\n  }, [value, delay]);\r\n\r\n  return debouncedValue;\r\n}\r\n\r\n/**\r\n * React hook for debounced callbacks\r\n * Returns a debounced version of the callback\r\n * @param callback The callback to debounce\r\n * @param delay The delay in milliseconds\r\n * @returns The debounced callback\r\n */\r\nexport function useDebouncedCallback<T extends (...args: any[]) => any>(\r\n  callback: T,\r\n  delay: number\r\n): (...args: Parameters<T>) => void {\r\n  const timeoutRef = useRef<NodeJS.Timeout | null>(null);\r\n\r\n  const debouncedCallback = useCallback(\r\n    (...args: Parameters<T>) => {\r\n      if (timeoutRef.current) {\r\n        clearTimeout(timeoutRef.current);\r\n      }\r\n\r\n      timeoutRef.current = setTimeout(() => {\r\n        callback(...args);\r\n      }, delay);\r\n    },\r\n    [callback, delay]\r\n  );\r\n\r\n  useEffect(() => {\r\n    return () => {\r\n      if (timeoutRef.current) {\r\n        clearTimeout(timeoutRef.current);\r\n      }\r\n    };\r\n  }, []);\r\n\r\n  return debouncedCallback;\r\n}\r\n\r\n/**\r\n * React hook for throttled values\r\n * Returns a throttled version of the input value (updated at most once per interval)\r\n * @param value The value to throttle\r\n * @param interval The interval in milliseconds\r\n * @returns The throttled value\r\n */\r\nexport function useThrottledValue<T>(value: T, interval: number): T {\n  const [throttledValue, setThrottledValue] = useState<T>(value);\n  const lastUpdatedRef = useRef<number>(0);\n\n  useEffect(() => {\n    if (lastUpdatedRef.current === 0) {\n      lastUpdatedRef.current = Date.now();\n      setThrottledValue(value);\n      return;\n    }\n\n    const now = Date.now();\n    if (now >= lastUpdatedRef.current + interval) {\n      lastUpdatedRef.current = now;\n      setThrottledValue(value);\r\n    } else {\r\n      const handler = setTimeout(() => {\r\n        lastUpdatedRef.current = Date.now();\r\n        setThrottledValue(value);\r\n      }, interval - (now - lastUpdatedRef.current));\r\n\r\n      return () => clearTimeout(handler);\r\n    }\r\n  }, [value, interval]);\r\n\r\n  return throttledValue;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\utils\\download.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\validators\\cash.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\validators\\expense.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\lib\\validators\\product.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\middleware.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\next.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\playwright.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\postcss.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\prisma\\seed.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\prisma\\seed\\billing\\seedBilling.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\prisma\\seed\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\prisma\\seed\\pos\\seedCashEntries.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\prisma\\seed\\pos\\seedCustomers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\prisma\\seed\\pos\\seedExpenses.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\prisma\\seed\\pos\\seedProducts.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\prisma\\seed\\pos\\seedSales.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\prisma\\seed\\pos\\seedShops.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\prisma\\seed\\rbac\\constants.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\prisma\\seed\\rbac\\seedRbac.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\prisma\\seed\\reset.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\prisma\\seed\\utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\realtime\\server.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\scripts\\spawn-log.cjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\tailwind.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\pos\\pos-app-supabase\\tests\\e2e\\logout.spec.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]